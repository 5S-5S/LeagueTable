<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domestic League Filters - League Table Statistics</title>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="DomesticEurope.css">
    <script>
        // Device detection and redirect logic
        (function() {
            // Check if user manually requested desktop version
            const urlParams = new URLSearchParams(window.location.search);
            const forceDesktop = urlParams.get('desktop') === 'true';

            if (forceDesktop) {
                return; // Stay on desktop version
            }

            // Mobile detection
            function isMobileDevice() {
                // Screen width detection
                const isSmallScreen = window.innerWidth <= 640;

                // Touch device detection
                const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

                // User agent detection (mobile-specific patterns)
                const mobileUserAgents = [
                    /Android/i,
                    /webOS/i,
                    /iPhone/i,
                    /iPad/i,
                    /iPod/i,
                    /BlackBerry/i,
                    /Windows Phone/i,
                    /Opera Mini/i,
                    /IEMobile/i,
                    /Mobile/i
                ];

                const isMobileUA = mobileUserAgents.some(pattern =>
                    pattern.test(navigator.userAgent)
                );

                // Return true if any mobile criteria are met
                return isSmallScreen || (hasTouchScreen && isMobileUA);
            }

            // Redirect to mobile version if mobile device detected
            if (isMobileDevice()) {
                window.location.href = 'DomesticEuropeMobile.html';
            }
        })();
    </script>
<body>
    <!-- Hamburger Menu Button -->
    <button id="hamburgerBtn" class="hamburger-btn" style="position: fixed; top: 1rem; left: 1rem; z-index: 1001; background: white; border: 1px solid #ccc; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; display: flex; flex-direction: column; gap: 0.25rem;">
        <span class="hamburger-line" style="width: 1.5rem; height: 0.125rem; background: #374151; border-radius: 0.125rem;"></span>
        <span class="hamburger-line" style="width: 1.5rem; height: 0.125rem; background: #374151; border-radius: 0.125rem;"></span>
        <span class="hamburger-line" style="width: 1.5rem; height: 0.125rem; background: #374151; border-radius: 0.125rem;"></span>
    </button>

    <!-- Collapse Controls Arrow Button -->
    <button id="collapseControlsBtn" class="collapse-controls-btn" style="position: fixed; top: 1rem; right: 1rem; z-index: 1001; background: white; border: 1px solid #ccc; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; display: flex; flex-direction: column; gap: 0.25rem;" title="Hide/Show Controls">
        <span style="width: 1.5rem; height: 0.875rem; display: flex; align-items: center; justify-content: center; font-size: 1rem;">‚ñº</span>
    </button>

    <!-- Sidebar Overlay -->
    <div id="menuOverlay" class="menu-overlay hidden"></div>

    <!-- Sidebar Menu -->
    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
            <h2 class="text-xl font-bold text-gray-800">Navigation</h2>
            <button id="closeMenuBtn" class="close-btn">&times;</button>
        </div>
        <nav class="menu-nav">
            <!-- Home Section -->
            <div class="menu-section">
                <a href="index.html" class="menu-item">
                    <span class="menu-icon">üè†</span>
                    <span>Home Page</span>
                </a>
            </div>
            
            <!-- Football Section -->
            <div class="menu-section">
                <h3 class="menu-section-title">Football</h3>
                <a href="#" id="domesticFootballLink" class="menu-item active" data-page="domestic">
                    <span class="menu-icon">‚öΩ</span>
                    <span>Domestic Football - Top 5 Leagues</span>
                </a>
                <a href="ContinentalEurope.html" class="menu-item" data-page="continental">
                    <span class="menu-icon">üèÜ</span>
                    <span>Continental Football - Champions League</span>
                </a>
                <div class="menu-item disabled">
                    <span class="menu-icon">üåç</span>
                    <span>International Football - Coming Soon</span>
                </div>
            </div>

            <!-- Other Sports Section -->
            <div class="menu-section">
                <h3 class="menu-section-title">Other Sports</h3>
                <div class="menu-item disabled">
                    <span class="menu-icon">üèà</span>
                    <span>NFL - Coming Soon</span>
                </div>
                <div class="menu-item disabled">
                    <span class="menu-icon">üèÄ</span>
                    <span>NBA - Coming Soon</span>
                </div>
            </div>

            <!-- Support Section -->
            <div class="menu-section">
                <a href="qa.html" class="menu-item">
                    <span class="menu-icon">‚ùì</span>
                    <span>Q&A</span>
                </a>
                <a href="contact.html" class="menu-item">
                    <span class="menu-icon">üìß</span>
                    <span>Contact & Support</span>
                </a>
            </div>
        </nav>
    </div>

    <div class="league-table-container">
        <div class="main-card">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div>
                        <h1 class="text-4xl font-bold mb-2">Domestic League Filters</h1>
                        <p class="text-lg opacity-90" id="lastDataUpdate">Last Data Update: Loading...</p>
                    </div>
                    <div class="dark-mode-toggle">
                        <input type="checkbox" id="darkModeToggle" class="toggle-checkbox">
                        <label for="darkModeToggle" class="toggle-label">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Controls Section -->
            <div id="controlsSection" class="controls-section hidden">
                
                <!-- Tab Container -->
                <div class="tab-container">
                    <button class="tab-button active" id="leagueFiltersTab" data-mobile-text="Tables & H2H">League Tables & Head to Head Stats</button>
                    <button class="tab-button" id="teamSeasonsTab" data-mobile-text="Team Seasons">Team Seasons</button>
                    <button class="tab-button" id="lastTimeWhenTab" data-mobile-text="Last Time">The Last Time When...</button>
                    <button class="tab-button" id="teamStreaksTab" data-mobile-text="Streaks">Team Streaks</button>
                </div>

                <!-- League Filters Tab Content -->
                <div id="leagueFiltersContent" class="tab-content active">
                    <!-- Description -->
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg collapsible-control">
                        <p class="text-gray-700 text-sm leading-relaxed">
                            Filter and analyze league tables from the major 5 European leagues. Select prior seasons, custom date ranges, and specific teams to find and filter league standings and head-to-head records.
                        </p>
                    </div>

                    <!-- League Selection -->
                    <div class="mb-8 collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Select League:</label>
                        <div class="league-buttons" id="leagueButtons">
                            <!-- League buttons will be populated here -->
                        </div>
                    </div>
                
                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 collapsible-control">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-search mr-2"></span>Season
                        </label>
                        <select id="seasonSelect" class="form-input">
                            <option value="">Select Season</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-calendar mr-2"></span>Start Date (MM/DD/YYYY)
                        </label>
                        <input type="date" id="dateFrom" class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-calendar mr-2"></span>End Date (MM/DD/YYYY)
                        </label>
                        <input type="date" id="dateTo" class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-calendar mr-2"></span>Day of Week
                        </label>
                        <select id="dayOfWeekSelect" class="form-input">
                            <option value="">All Days</option>
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-search mr-2"></span>Team 1
                        </label>
                        <div class="combobox-container" id="team1ComboboxContainer">
                            <input type="text" id="team1ComboboxInput" class="combobox-input" placeholder="All Teams" autocomplete="off">
                            <span class="combobox-arrow">‚ñº</span>
                            <div class="combobox-dropdown" id="team1ComboboxDropdown"></div>
                        </div>
                        <select id="team1Select" class="form-input" style="display: none;">
                            <option value="">All Teams</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-search mr-2"></span>Team 2
                        </label>
                        <div class="combobox-container" id="team2ComboboxContainer">
                            <input type="text" id="team2ComboboxInput" class="combobox-input" placeholder="No Team" autocomplete="off">
                            <span class="combobox-arrow">‚ñº</span>
                            <div class="combobox-dropdown" id="team2ComboboxDropdown"></div>
                        </div>
                        <select id="team2Select" class="form-input" style="display: none;">
                            <option value="">No Team</option>
                        </select>
                    </div>
                </div>
                
                <!-- Match Type and Action Buttons -->
                <div class="flex flex-wrap items-center justify-between gap-4 collapsible-control">
                    <div class="flex items-center gap-6">
                        <span class="text-sm font-semibold text-gray-700">Match Results:</span>
                        
                        <label class="flex items-center cursor-pointer">
                            <div id="homeCheckbox" class="checkbox checked"></div>
                            <span class="icon-home mr-1"></span>
                            <span class="text-sm font-medium">Home</span>
                        </label>
                        
                        <label class="flex items-center cursor-pointer">
                            <div id="awayCheckbox" class="checkbox checked"></div>
                            <span class="icon-plane mr-1"></span>
                            <span class="text-sm font-medium">Away</span>
                        </label>
                        
                        <label class="flex items-center cursor-pointer">
                            <div id="deductionsCheckbox" class="checkbox checked"></div>
                            <span class="icon-alert mr-1" style="color: #6b7280;"></span>
                            <span class="text-sm font-medium">Point Deductions</span>
                        </label>
                        
                        <label class="flex items-center cursor-pointer">
                            <div id="threePointCheckbox" class="checkbox checked"></div>
                            <span class="text-sm font-medium">3 Points for all Wins</span>
                        </label>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="reloadGistsBtn" class="btn btn-blue">
                            <span class="icon-link"></span>Reload Data
                        </button>
                        <button id="resetBtn" class="btn btn-secondary">Reset</button>
                    </div>
                </div>
                </div>

                <!-- Team Seasons Tab Content -->
                <div id="teamSeasonsContent" class="tab-content">
                    <!-- Description -->
                    <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg collapsible-control">
                        <p class="text-gray-700 text-sm leading-relaxed">
                            Select a league and team below to view a list of their top-flight seasons. You can find out how many times a team finished in a particular place or even find something like a list of every 2nd place team. 
                        </p>
                    </div>

                    <!-- League Selection for Team Seasons -->
                    <div class="mb-8 collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Select League:</label>
                        <div class="league-buttons" id="teamSeasonsLeagueButtons">
                            <!-- League buttons will be populated here -->
                        </div>
                    </div>

                    <!-- Team Selection -->
                    <div class="mb-8 collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Select Team:</label>
                        <div class="combobox-container" id="teamSeasonsComboboxContainer">
                            <input type="text" id="teamSeasonsComboboxInput" class="combobox-input" placeholder="Choose a team..." autocomplete="off">
                            <span class="combobox-arrow">‚ñº</span>
                            <div class="combobox-dropdown" id="teamSeasonsComboboxDropdown"></div>
                        </div>
                        <select id="teamSeasonsTeamSelect" class="form-input w-full" style="display: none;">
                            <option value="">Choose a team...</option>
                        </select>
                    </div>

                    <!-- Season Selection (only for Ligue 1 and Premier League) -->
                    <div id="teamSeasonsSeasonContainer" class="mb-8 hidden collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-search mr-2"></span>Season
                        </label>
                        <select id="teamSeasonsSeasonSelect" class="form-input w-full">
                            <option value="">Select Season</option>
                        </select>
                    </div>

                    <!-- Position Filter -->
                    <div id="teamSeasonsPositionContainer" class="mb-8 collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Filter by Position:</label>
                        <select id="teamSeasonsPositionSelect" class="form-input w-full">
                            <option value="">All Positions</option>
                        </select>

                        <!-- Include Better Results Checkbox -->
                        <div id="includeBetterResultsContainer" class="mt-3 flex items-center gap-2 hidden">
                            <label class="flex items-center cursor-pointer">
                                <div id="includeBetterResultsCheckbox" class="checkbox"></div>
                                <span class="text-sm font-medium text-gray-700 ml-2">Include better results</span>
                            </label>
                        </div>

                        <div id="teamSeasonsPositionInfo" class="mt-2 text-sm text-gray-600"></div>

                        <!-- Historic Seasons Toggle Button -->
                        <div id="historicSeasonsContainer" class="mt-4 hidden">
                            <button id="historicSeasonsToggle" class="btn btn-secondary text-sm px-4 py-2">
                                <span class="icon-history mr-2">üìú</span>Include Historic Seasons
                            </button>
                            <div class="mt-2 text-xs text-gray-500">
                                Adds pre-modern era seasons to the results
                            </div>
                        </div>
                    </div>

                    <!-- Team History Table -->
                    <div id="teamHistoryTable" class="mt-8 hidden" style="border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <div class="league-table">
                            <div class="text-center py-4 bg-blue-50 border-b relative">
                                <!-- Back Arrow for Team History -->
                                <div id="teamHistoryBackArrow" class="absolute left-4 top-1/2 transform -translate-y-1/2 hidden">
                                    <button class="flex items-center text-blue-600 hover:text-blue-800 transition-colors cursor-pointer" onclick="goBackToLeagueTables()">
                                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                        </svg>
                                        <span class="text-sm font-medium">Back</span>
                                    </button>
                                </div>
                                <h2 class="text-xl font-semibold text-blue-800 mb-1">üèÜ Team History</h2>
                                <p class="text-sm text-blue-600 font-medium" id="teamHistoryTitle"></p>
                            </div>
                            <table>
                                <thead>
                                    <tr id="teamHistoryHeader">
                                        <!-- Team history headers will be populated -->
                                    </tr>
                                </thead>
                                <tbody id="teamHistoryBody">
                                    <!-- Team history rows will be populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Last Time When Tab Content -->
                <div id="lastTimeWhenContent" class="tab-content">
                    <!-- Description -->
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg collapsible-control">
                        <p class="text-gray-700 text-sm leading-relaxed">
                            This tool allows you to find out the last time a team won, drew, or lost against an opponent. At home or away. On the day of the week too, if you so choose.
                        </p>
                    </div>
                    
                    <!-- League Selection -->
                    <div class="mb-8 collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Select League:</label>
                        <div class="league-buttons" id="lastTimeLeagueButtons">
                            <!-- League buttons will be populated here -->
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6 collapsible-control">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Day of Week</label>
                            <select id="lastTimeDayOfWeekSelect" class="form-input">
                                <option value="">All Days</option>
                                <option value="0">Sunday</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                            <select id="lastTimeLocationSelect" class="form-input">
                                <option value="">Both Home and Away</option>
                                <option value="home">Home</option>
                                <option value="away">Away</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Team 1</label>
                            <div class="combobox-container" id="lastTimeTeam1ComboboxContainer">
                                <input type="text" id="lastTimeTeam1ComboboxInput" class="combobox-input" placeholder="Select Team 1" autocomplete="off">
                                <span class="combobox-arrow">‚ñº</span>
                                <div class="combobox-dropdown" id="lastTimeTeam1ComboboxDropdown"></div>
                            </div>
                            <select id="lastTimeTeam1Select" class="form-input" style="display: none;">
                                <option value="">Select Team 1</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Team 2</label>
                            <div class="combobox-container" id="lastTimeTeam2ComboboxContainer">
                                <input type="text" id="lastTimeTeam2ComboboxInput" class="combobox-input" placeholder="Select Team 2" autocomplete="off">
                                <span class="combobox-arrow">‚ñº</span>
                                <div class="combobox-dropdown" id="lastTimeTeam2ComboboxDropdown"></div>
                            </div>
                            <select id="lastTimeTeam2Select" class="form-input" style="display: none;">
                                <option value="">Select Team 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Results Display -->
                    <div id="lastTimeResults" class="hidden">
                        <h3 class="text-xl font-bold text-gray-700 mb-6 text-center">Days Since Last Match Results</h3>
                        
                        <!-- Team 1 Won at Home -->
                        <div id="team1HomeWinSection" class="mb-8 hidden">
                            <h4 id="team1HomeWinTitle" class="text-lg font-semibold text-green-700 mb-3">Team 1 Won (at Home)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1HomeWinHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1HomeWinBody"></tbody>
                                </table>
                            </div>
                            <p id="team1HomeWinDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Won Away -->
                        <div id="team1AwayWinSection" class="mb-8 hidden">
                            <h4 id="team1AwayWinTitle" class="text-lg font-semibold text-green-700 mb-3">Team 1 Won (Away)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1AwayWinHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1AwayWinBody"></tbody>
                                </table>
                            </div>
                            <p id="team1AwayWinDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Drew at Home -->
                        <div id="team1HomeDrawSection" class="mb-8 hidden">
                            <h4 id="team1HomeDrawTitle" class="text-lg font-semibold text-gray-600 mb-3">Team 1 Drew (at Home)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1HomeDrawHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1HomeDrawBody"></tbody>
                                </table>
                            </div>
                            <p id="team1HomeDrawDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Drew Away -->
                        <div id="team1AwayDrawSection" class="mb-8 hidden">
                            <h4 id="team1AwayDrawTitle" class="text-lg font-semibold text-gray-600 mb-3">Team 1 Drew (Away)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1AwayDrawHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1AwayDrawBody"></tbody>
                                </table>
                            </div>
                            <p id="team1AwayDrawDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Lost at Home -->
                        <div id="team1HomeLossSection" class="mb-8 hidden">
                            <h4 id="team1HomeLossTitle" class="text-lg font-semibold text-red-600 mb-3">Team 1 Lost (at Home)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1HomeLossHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1HomeLossBody"></tbody>
                                </table>
                            </div>
                            <p id="team1HomeLossDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Lost Away -->
                        <div id="team1AwayLossSection" class="mb-8 hidden">
                            <h4 id="team1AwayLossTitle" class="text-lg font-semibold text-red-600 mb-3">Team 1 Lost (Away)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1AwayLossHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1AwayLossBody"></tbody>
                                </table>
                            </div>
                            <p id="team1AwayLossDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>
                    </div>
                </div>

                <!-- Team Streaks Tab Content -->
                <div id="teamStreaksContent" class="tab-content">
                    <!-- Description -->
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg collapsible-control">
                        <p class="text-gray-700 text-sm leading-relaxed">
                            Discover active streaks between clubs and find out the last time your club defeated their rival. Filter between league, location, and streak type.
                        </p>
                    </div>

                    <!-- League Selection -->
                    <div class="mb-8 collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Select League:</label>
                        <div class="league-buttons" id="teamStreaksLeagueButtons">
                            <!-- League buttons will be populated here -->
                        </div>
                    </div>

                    <!-- Status Selection -->
                    <div class="mb-8 collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status:</label>
                        <select id="teamStreaksStatusSelect" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none">
                            <option value="active">Active Streak</option>
                            <option value="historic">Historic Streaks</option>
                        </select>
                    </div>
                    <!-- Location Selection -->
                    <div class="mb-8 collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Location:</label>
                        <select id="teamStreaksLocationSelect" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none">
                            <option value="both">Both Home and Away</option>
                            <option value="home">Home</option>
                            <option value="away">Away</option>
                        </select>
                    </div>

                    <!-- Streak Type Selection -->
                    <div class="mb-8 collapsible-control">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Streak Type:</label>
                        <select id="teamStreaksTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none">
                            <option value="winning">Winning Streak (Wins Only)</option>
                            <option value="unbeaten">Unbeaten Streak (Wins + Draws)</option>
                            <option value="draw">Draw Streak (Draws Only)</option>
                            <option value="winless">Winless Streak (Draws + Losses)</option>
                            <option value="losing">Losing Streak (Losses Only)</option>
                        </select>
                    </div>

                    <!-- Team Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 collapsible-control">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Team 1:</label>
                            <div class="combobox-container" id="teamStreaksTeam1ComboboxContainer">
                                <input type="text" id="teamStreaksTeam1ComboboxInput" class="combobox-input" placeholder="Select Team 1" autocomplete="off">
                                <span class="combobox-arrow">‚ñº</span>
                                <div class="combobox-dropdown" id="teamStreaksTeam1ComboboxDropdown"></div>
                            </div>
                            <select id="teamStreaksTeam1Select" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none" style="display: none;">
                                <option value="">Select Team 1</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Team 2 (Optional):</label>
                            <div class="combobox-container" id="teamStreaksTeam2ComboboxContainer">
                                <input type="text" id="teamStreaksTeam2ComboboxInput" class="combobox-input" placeholder="Select Team 2" autocomplete="off">
                                <span class="combobox-arrow">‚ñº</span>
                                <div class="combobox-dropdown" id="teamStreaksTeam2ComboboxDropdown"></div>
                            </div>
                            <select id="teamStreaksTeam2Select" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none" style="display: none;">
                                <option value="">Select Team 2</option>
                            </select>
                        </div>
                    </div>

                    <!-- Results will be populated here -->
                    <div id="teamStreaksResults" class="hidden">
                        <!-- Team streaks content will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Table Info -->
            <div id="tableInfo" class="text-center py-4 bg-white border-b hidden">
                <span class="text-lg font-semibold text-gray-700" id="tableInfoText"></span>
            </div>

            <!-- Main Table Container (shows above match history when single team selected) -->
            <div id="tableContainer" class="hidden mt-4 mx-8 p-8 bg-gray-100 border-b rounded-xl">
                <div class="league-table">
                    <table>
                        <thead>
                            <tr id="tableHeader">
                                <!-- Headers will be populated -->
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Rows will be populated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Match History Section (Single Team) -->
            <div id="matchHistorySection" class="mt-8 mx-8 p-8 bg-white border-b rounded-xl hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-6">
                        <h3 class="text-lg font-semibold text-gray-700">Match History</h3>

                        <label class="flex items-center cursor-pointer">
                            <div id="matchHistoryHomeCheckbox" class="checkbox checked"></div>
                            <span class="icon-home mr-1"></span>
                            <span class="text-sm font-medium">Home</span>
                        </label>

                        <label class="flex items-center cursor-pointer">
                            <div id="matchHistoryAwayCheckbox" class="checkbox checked"></div>
                            <span class="icon-plane mr-1"></span>
                            <span class="text-sm font-medium">Away</span>
                        </label>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                        <label class="text-sm font-medium text-gray-700">Most Recent Matches</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="recentMatchesSelect" placeholder="Enter number or 'All'" class="px-2 py-1 border border-gray-300 rounded-full focus:border-green-500 focus:outline-none text-xs w-32 text-center">
                            <span class="text-sm text-gray-600" id="matchHistoryMatchCount"></span>
                        </div>
                    </div>
                </div>
                <div id="matchHistoryVisualizations" class="mb-8">
                    <!-- Team Record visualizations will be populated here -->
                </div>

                <!-- Team Statistics Table -->
                <div id="matchHistoryStatsTable" class="mt-8 mb-6 hidden">
                    <div class="league-table">
                        <div class="text-center py-4 bg-gray-50 border-b">
                            <h2 class="text-xl font-semibold text-gray-700 mb-1" id="matchHistoryStatsTitle">Team Statistics</h2>
                        </div>
                        <table>
                            <thead>
                                <tr id="matchHistoryStatsHeader">
                                    <!-- Stats headers will be populated -->
                                </tr>
                            </thead>
                            <tbody id="matchHistoryStatsBody">
                                <!-- Stats rows will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Match History Table -->
                <div id="matchHistoryTable" class="hidden">
                    <div class="league-table mt-8">
                        <div class="text-center py-4 bg-gray-50 border-b">
                            <h2 class="text-xl font-semibold text-gray-700 mb-1">Match History</h2>
                            <p class="text-sm text-gray-600" id="matchHistoryTableTitle"></p>
                        </div>
                        <table>
                            <thead>
                                <tr id="matchHistoryTableHeader">
                                    <!-- Headers will be populated -->
                                </tr>
                            </thead>
                            <tbody id="matchHistoryTableBody">
                                <!-- Rows will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Head-to-Head Section -->
            <div id="h2hSection" class="mt-8 mx-8 p-8 bg-white border-b rounded-xl hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-6">
                        <h3 class="text-lg font-semibold text-gray-700">Head-to-Head Record</h3>

                        <label class="flex items-center cursor-pointer">
                            <div id="h2hHomeCheckbox" class="checkbox checked"></div>
                            <span class="icon-home mr-1"></span>
                            <span class="text-sm font-medium">Home</span>
                        </label>

                        <label class="flex items-center cursor-pointer">
                            <div id="h2hAwayCheckbox" class="checkbox checked"></div>
                            <span class="icon-plane mr-1"></span>
                            <span class="text-sm font-medium">Away</span>
                        </label>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                        <label class="text-sm font-medium text-gray-700">Most Recent Head-to-Head</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="recentH2HSelect" placeholder="Enter number or 'All'" class="px-2 py-1 border border-gray-300 rounded-full focus:border-green-500 focus:outline-none text-xs w-32 text-center">
                            <span class="text-sm text-gray-600" id="h2hMatchCount"></span>
                        </div>
                    </div>
                </div>
                <div id="h2hVisualizations">
                    <!-- H2H visualizations will be populated here -->
                </div>
            </div>
            
            <!-- Table Section -->
            <div class="table-section">

                <div id="errorState" class="text-center text-black hidden">
                    <div class="icon-loading w-16 h-16 mx-auto mb-4" style="font-size: 4rem;"></div>
                    <div class="text-2xl mb-4">Loading Data</div>
                    <div class="text-lg mb-6 text-black" id="errorMessage"></div>
                    <button id="retryBtn" class="px-6 py-3 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-all">
                        Try Again
                    </button>
                </div>

                <!-- Head-to-Head Matches Table -->
                <div id="h2hMatchesTable" class="mt-8 hidden">
                    <div class="league-table">
                        <div class="text-center py-4 bg-gray-50 border-b">
                            <h2 class="text-xl font-semibold text-gray-700 mb-1">Head-to-Head Match History</h2>
                            <p class="text-sm text-gray-600" id="h2hTableTitle"></p>
                        </div>
                        <table>
                            <thead>
                                <tr id="h2hTableHeader">
                                    <!-- H2H headers will be populated -->
                                </tr>
                            </thead>
                            <tbody id="h2hTableBody">
                                <!-- H2H rows will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Pre-configured Gist URLs (Single Base64 Encoded)
        // Updated GIST URLs with single base64 encoding (encoded with new user-provided URLs)
        const GIST_URLS = [
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy85OTg4YTEzMzNjNDMwYWFkNTE4ZWJiNDM4YzVkOGRiMS9yYXcvYjliNTM1MGIzZTY3NGE3ODMwY2I3ZDczOWU2MGZhYjQyYjZkNmZlNC9idW5kZXNsaWdhLmNzdg==',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy83NDM1ZmE2OWY1YTYzZDVmM2NjY2E1M2I0ZDA0OWZkZi9yYXcvOGUxNzRlMTJmMjU5YWJiNmY5ZWFlODcxYzY4NGU4OTk2NGIzYjA3My9sYWxpZ2EuY3N2',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy85NDhlMTMwNTYyMGFmM2ExNzJiNDMzOWFiYmEzMWU2Ny9yYXcvYjI0ZjQ3ZTI2ZTUyMDdiYjFkZTM5YTFhZjZkMzg0OThlN2MxNmYzMi9saWd1ZS5jc3Y=',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy9iZWFhMWNhYzhmYjM3MDlkYzdjMmY0YmIzZDc5OWI0MS9yYXcvMjk1YmM1ZGI5ZWFjNzcxY2Q3MTdlZmRjZjdmM2JlNWMzNzI0YTE3Yy9zZXJpZWEuY3N2',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy9jODk1ZGM3Zjg4MTdiZjM3Y2ZmN2FlOTBjZGEzMWZlMS9yYXcvOTA3OWJkYjZhYWMwNTgzYTM4MGUyYzVhZWNkZDlkNmY5Yjk5OGUzNC9wcmVtLmNzdg==',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy9iMWU1NTcwZTk4NWQ3ZmNhNGRlYWJjYzhhMDA0ZTllMC9yYXcvYTM0ZTEyMmI3MTE2NzQ1OWM1YWM1NjA3NTkwYmZjNGVkZDc5OWZhNS9jaGFtcGlvbnNsZWFndWUyNTI2LmNzdg==',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy8wMzkyOGU0YThlYTE4OTk4MjZmYTg1MDdkZTdhNzc1My9yYXcvZTBlZTBkYzcwNmE4Y2M1MDBmMzRjM2FjMWI3OGNkNDEzNzAxODVmOC8yNTI2bGFsaWdhLmNzdg==',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy9iY2Y2NmE4NzMzMThmODI4NzM2MjE5NGJmNTRlMWM5Yi9yYXcvNzE3YzY1MjYyYWUzNDZiYjdhZjU3NGY3NDdjZDNkYjU5NzZiNTc3Mi8yNTI2c2VyaWVhLmNzdg==',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy84MTc4MDM4ODc0YzgzMjgwNDI1MjdkNDYwYjA2NzdlZC9yYXcvMzE4OTJmZDhmZDU4NmI4ZWQxMDE3NDM3ZTgxMDk2YzI5NGQ3YjA2MS8yNTI2YnVuZGVzbGlnYS5jc3Y=',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy8xZjMyODJmNmYwMjQyMjYyMmM0N2I3YTdhNzUxMmM5MS9yYXcvZDcwNTg3OTNhNmNjOGIyOGM0MGYxYTRjZGExZTY4N2E0NmI2YWYzMy8yNTI2bGlndWUuY3N2'
        ];
        
        // League code mapping for filtering data
        const LEAGUE_CODES = {
            'serie-a': 'I1',
            'premier-league': 'E0',
            'la-liga': 'SP1',
            'bundesliga': 'D1',
            'ligue-1': 'F1'
        };

        // Application state
        const state = {
            data: [],
            teams: [],
            error: '',
            
            // Filter states
            dateFrom: '',
            dateTo: '',
            selectedDayOfWeek: '',
            selectedTeam1: '',
            selectedTeam2: '',
            big6Opponents: null,
            selectedSeason: '',
            homeFilter: true,
            awayFilter: true,
            pointDeductionsEnabled: true,
            threePointSystem: true,
            selectedLeague: 'premier-league',
            sortConfig: { key: null, direction: null },
            teamHistorySortConfig: { key: null, direction: null },
            recentH2HCount: 'All',
            
            // H2H sort config
            h2hSortConfig: { key: 'date', direction: 'desc' },
            
            // Last Time When state
            lastTimeTeam1: '',
            lastTimeTeam2: '',
            lastTimeDayOfWeek: '',
            lastTimeLocation: '',
            
            // Team Seasons state
            teamSeasonsSelectedLeague: 'premier-league',
            teamSeasonsSelectedTeam: '',
            teamSeasonsSelectedSeason: 'all-english-seasons-1888-2025',
            teamSeasonsSelectedPosition: '',
            includeBetterResults: false,
            includeHistoricSeasons: false,
            controlsCollapsed: false,

            // Previous League Tables state (for back navigation)
            previousLeagueTablesState: null,
            
            // Historic Streaks sort state
            historicStreaksSortConfig: { key: null, direction: null },
            lastHistoricStreaksParams: null,

            // Match history state
            matchHistoryHomeFilter: true,
            matchHistoryAwayFilter: true,
            recentMatchesCount: 'All',
            matchHistorySortConfig: { key: null, direction: null }
        };

        // Ranking overrides for historic seasons
        function getRankingOverrides() {
            return [
                // Italy
                ["Pro Vercelli", "I1", "1930-31", 10, 1],
                ["Modena FC", "I1", "1930-31", 10, 2],
                ["ACF Fiorentina", "I1", "1931-32", 4, 1],
                ["AC Milan", "I1", "1931-32", 4, 2],                
                ["Inter", "I1", "1931-32", 6, 1],
                ["US Alessandria 1912", "I1", "1931-32", 6, 2],    
                ["Lazio Roma", "I1", "1931-32", 13, 1],    
                ["US Triestina", "I1", "1931-32", 13, 2],    
                ["Pro Vercelli", "I1", "1931-32", 13, 3],   
                ["Bologna FC", "I1", "1932-33", 3, 1],   
                ["SSC Napoli", "I1", "1932-33", 3, 2],   
                ["AS Roma", "I1", "1932-33", 5, 1],   
                ["ACF Fiorentina", "I1", "1932-33", 5, 2],   
                ["Genoa CFC", "I1", "1932-33", 8, 1],   
                ["US Triestina", "I1", "1932-33", 8, 2],   
                ["Pro Vercelli", "I1", "1932-33", 12, 1],   
                ["Palermo FC", "I1", "1932-33", 12, 2],   
                ["Calcio Padova", "I1", "1932-33", 14, 1],   
                ["US Alessandria 1912", "I1", "1932-33", 14, 2],   
                ["Pro Vercelli", "I1", "1933-34", 7, 1],   
                ["AS Livorno", "I1", "1933-34", 7, 2],   
                ["Brescia Calcio", "I1", "1933-34", 12, 1],   
                ["Torino FC", "I1", "1933-34", 12, 2],   
                ["US Alessandria 1912", "I1", "1933-34", 12, 3],   
                ["Palermo FC", "I1", "1933-34", 12, 4],   
                ["SSC Napoli", "I1", "1934-35", 7, 1],   
                ["US Alessandria 1912", "I1", "1934-35", 7, 2],   
                ["Palermo FC", "I1", "1934-35", 7, 3],   
                ["AC Milan", "I1", "1934-35", 10, 1],   
                ["US Triestina", "I1", "1934-35", 10, 2],   
                ["Brescia Calcio", "I1", "1934-35", 10, 3],   
                ["AC Milan", "I1", "1935-36", 8, 1],   
                ["SSC Napoli", "I1", "1935-36", 8, 2],   
                ["US Alessandria 1912", "I1", "1935-36", 8, 3],   
                ["Genoa CFC", "I1", "1935-36", 8, 4],   
                ["ACF Fiorentina", "I1", "1935-36", 12, 1],   
                ["Sampierdarenese", "I1", "1935-36", 12, 2],   
                ["Inter", "I1", "1936-37", 7, 1],   
                ["Lucchese", "I1", "1936-37", 7, 2],   
                ["AS Roma", "I1", "1936-37", 10, 1],   
                ["SSC Bari", "I1", "1936-37", 10, 2],
                ["Genoa CFC", "I1", "1937-38", 3],
                ["US Triestina", "I1", "1937-38", 6, 1],
                ["AS Roma", "I1", "1937-38", 6, 2],
                ["Lazio Roma", "I1", "1937-38", 8, 1],
                ["Torino FC", "I1", "1937-38", 8, 2],
                ["AC Liguria", "I1", "1937-38", 11, 1],
                ["AS Livorno", "I1", "1937-38", 11, 2],
                ["Genoa CFC", "I1", "1940-41", 10],
                ["AS Roma", "I1", "1940-41", 11],
                ["Genoa CFC", "I1", "1941-42", 4],
                ["Lazio Roma", "I1", "1941-42", 5],
                ["Juventus", "I1", "1941-42", 6],
                ["Bologna FC", "I1", "1942-43", 6, 1],
                ["ACF Fiorentina", "I1", "1942-43", 6, 2],
                ["AC Milan", "I1", "1942-43", 6, 3],
                ["Lazio Roma", "I1", "1942-43", 9, 1],
                ["Atalanta", "I1", "1942-43", 9, 2],
                ["AS Roma", "I1", "1942-43", 9, 3],
                ["Bologna FC", "I1", "1946-47", 5, 1],
                ["L.R. Vicenza", "I1", "1946-47", 5, 2],
                ["Inter", "I1", "1946-47", 10, 1],
                ["Sampdoria", "I1", "1946-47", 10, 2],
                ["Genoa CFC", "I1", "1946-47", 10, 3],
                ["Lazio Roma", "I1", "1946-47", 10, 4],
                ["AS Livorno", "I1", "1946-47", 15, 1],
                ["AS Roma", "I1", "1946-47", 15, 2],
                ["Atalanta", "I1", "1947-48", 5, 1],
                ["Modena FC", "I1", "1947-48", 5, 2],
                ["Aurora Pro Patria", "I1", "1947-48", 8, 1],
                ["Bologna FC", "I1", "1947-48", 8, 2],
                ["Inter", "I1", "1947-48", 12, 1],
                ["Genoa CFC", "I1", "1947-48", 12, 2],
                ["Sampdoria", "I1", "1947-48", 14, 1],
                ["AS Livorno", "I1", "1947-48", 14, 2],
                ["Lucchese", "I1", "1947-48", 14, 3],
                ["Sampdoria", "I1", "1948-49", 5, 1],
                ["Bologna FC", "I1", "1948-49", 5, 2],
                ["Lucchese", "I1", "1948-49", 8, 1],
                ["US Triestina", "I1", "1948-49", 8, 2],
                ["ACF Fiorentina", "I1", "1948-49", 8, 3],
                ["Palermo FC", "I1", "1948-49", 11, 1],
                ["Calcio Padova", "I1", "1948-49", 11, 2],
                ["Novara Calcio", "I1", "1948-49", 15, 1],
                ["Atalanta", "I1", "1948-49", 15, 2],
                ["Aurora Pro Patria", "I1", "1948-49", 17, 1],
                ["SSC Bari", "I1", "1948-49", 17, 2],
                ["Torino FC", "I1", "1949-50", 6, 1],
                ["Como 1907", "I1", "1949-50", 6, 2],
                ["Atalanta", "I1", "1949-50", 8, 1],
                ["US Triestina", "I1", "1949-50", 8, 2],
                ["Aurora Pro Patria", "I1", "1949-50", 11, 1],
                ["Genoa CFC", "I1", "1949-50", 11, 2],
                ["Sampdoria", "I1", "1949-50", 13, 1],
                ["Palermo FC", "I1", "1949-50", 13, 2],
                ["Bologna FC", "I1", "1949-50", 15, 1],
                ["Lucchese", "I1", "1949-50", 15, 2],
                ["Novara Calcio", "I1", "1949-50", 17, 1],
                ["AS Roma", "I1", "1949-50", 17, 2],
                ["SSC Napoli", "I1", "1950-51", 6, 1],
                ["Bologna FC", "I1", "1950-51", 6, 2],
                ["Palermo FC", "I1", "1950-51", 10, 1],
                ["Aurora Pro Patria", "I1", "1950-51", 10, 2],
                ["Novara Calcio", "I1", "1950-51", 12, 1],
                ["Sampdoria", "I1", "1950-51", 12, 2],
                ["Lucchese", "I1", "1950-51", 15, 1],
                ["US Triestina", "I1", "1950-51", 15, 2],
                ["Torino FC", "I1", "1950-51", 15, 3],
                ["ACF Fiorentina", "I1", "1951-52", 4, 1],
                ["Lazio Roma", "I1", "1951-52", 4, 2],
                ["SPAL 2013 Ferrara", "I1", "1951-52", 9, 1],
                ["Aurora Pro Patria", "I1", "1951-52", 9, 2],
                ["Atalanta", "I1", "1951-52", 12, 1],
                ["Como 1907", "I1", "1951-52", 12, 2],
                ["Udinese Calcio", "I1", "1951-52", 12, 3],
                ["Torino FC", "I1", "1951-52", 12, 4],
                ["Lucchese", "I1", "1951-52", 18],
                ["SPAL 2013 Ferrara", "I1", "1952-53", 8, 1],
                ["Atalanta", "I1", "1952-53", 8, 2],
                ["Torino FC", "I1", "1952-53", 10, 1],
                ["Lazio Roma", "I1", "1952-53", 10, 2],
                ["Sampdoria", "I1", "1952-53", 10, 3],
                ["Novara Calcio", "I1", "1952-53", 10, 4],
                ["Udinese Calcio", "I1", "1952-53", 10, 5],
                ["US Triestina", "I1", "1952-53", 15, 1],
                ["Palermo FC", "I1", "1952-53", 15, 2],
                ["AC Milan", "I1", "1953-54", 3, 1],
                ["ACF Fiorentina", "I1", "1953-54", 3, 2],
                ["Genoa CFC", "I1", "1953-54", 12, 1],
                ["US Triestina", "I1", "1953-54", 12, 2],
                ["Sampdoria", "I1", "1954-55", 9, 1],
                ["Torino FC", "I1", "1954-55", 9, 2],
                ["Calcio Catania", "I1", "1954-55", 12, 1],
                ["Lazio Roma", "I1", "1954-55", 12, 2],
                ["US Triestina", "I1", "1954-55", 12, 3],
                ["Atalanta", "I1", "1954-55", 15, 1],
                ["Novara Calcio", "I1", "1954-55", 15, 2],
                ["Inter", "I1", "1955-56", 3, 1],
                ["Lazio Roma", "I1", "1955-56", 3, 2],
                ["AS Roma", "I1", "1955-56", 6, 1],
                ["Sampdoria", "I1", "1955-56", 6, 2],
                ["SPAL 2013 Ferrara", "I1", "1955-56", 9, 1],
                ["Genoa CFC", "I1", "1955-56", 9, 2],
                ["Torino FC", "I1", "1955-56", 9, 3],
                ["Juventus", "I1", "1955-56", 9, 4],
                ["L.R. Vicenza", "I1", "1955-56", 9, 5],
                ["Inter", "I1", "1956-57", 5, 1],
                ["Bologna FC", "I1", "1956-57", 5, 2],
                ["Torino FC", "I1", "1956-57", 5, 3],
                ["Sampdoria", "I1", "1956-57", 5, 4],
                ["Juventus", "I1", "1956-57", 9, 1],
                ["SPAL 2013 Ferrara", "I1", "1956-57", 9, 2],
                ["L.R. Vicenza", "I1", "1956-57", 11, 1],
                ["SSC Napoli", "I1", "1956-57", 11, 2],
                ["Calcio Padova", "I1", "1956-57", 11, 3],
                ["AS Roma", "I1", "1956-57", 14, 1],
                ["Atalanta", "I1", "1956-57", 14, 2],
                ["L.R. Vicenza", "I1", "1957-58", 7, 1],
                ["Torino FC", "I1", "1957-58", 7, 2],
                ["AC Milan", "I1", "1957-58", 9, 1],
                ["Udinese Calcio", "I1", "1957-58", 9, 2],
                ["Inter", "I1", "1957-58", 9, 3],
                ["Genoa CFC", "I1", "1957-58", 12, 1],
                ["Sampdoria", "I1", "1957-58", 12, 2],
                ["US Alessandria 1912", "I1", "1957-58", 12, 3],
                ["Lazio Roma", "I1", "1957-58", 12, 4],
                ["SPAL 2013 Ferrara", "I1", "1957-58", 12, 5],
                ["L.R. Vicenza", "I1", "1958-59", 7, 1],
                ["Calcio Padova", "I1", "1958-59", 7, 2],
                ["SSC Napoli", "I1", "1958-59", 7, 3],
                ["SSC Bari", "I1", "1958-59", 11, 1],
                ["Genoa CFC", "I1", "1958-59", 11, 2],
                ["Lazio Roma", "I1", "1958-59", 11, 3],
                ["US Triestina", "I1", "1958-59", 17, 1],
                ["Torino FC", "I1", "1958-59", 17, 2],
                ["Bologna FC", "I1", "1959-60", 5, 1],
                ["Calcio Padova", "I1", "1959-60", 5, 2],
                ["SPAL 2013 Ferrara", "I1", "1959-60", 5, 3],
                ["SSC Bari", "I1", "1959-60", 13, 1],
                ["SSC Napoli", "I1", "1959-60", 13, 2],
                ["Bologna FC", "I1", "1960-61", 9, 1],
                ["Atalanta", "I1", "1960-61", 9, 3],
                ["L.R. Vicenza", "I1", "1960-61", 9, 3],
                ["Torino FC", "I1", "1960-61", 12, 1],
                ["SPAL 2013 Ferrara", "I1", "1960-61", 12, 2],
                ["Calcio Lecco 1912", "I1", "1960-61", 14],
                ["SSC Bari", "I1", "1960-61", 16],
                ["Sampdoria", "I1", "1961-62", 10, 1],
                ["Calcio Catania", "I1", "1961-62", 10, 2],
                ["Venezia FC", "I1", "1961-62", 12, 1],
                ["Juventus", "I1", "1961-62", 12, 2],
                ["L.R. Vicenza", "I1", "1961-62", 14, 1],
                ["SPAL 2013 Ferrara", "I1", "1961-62", 14, 2],
                ["Calcio Padova", "I1", "1961-62", 16, 1],
                ["Calcio Lecco 1912", "I1", "1961-62", 16, 2],
                ["Atalanta", "I1", "1962-63", 8, 1],
                ["SPAL 2013 Ferrara", "I1", "1962-63", 8, 2],
                ["Torino FC", "I1", "1962-63", 8, 3],
                ["Sampdoria", "I1", "1962-63", 11, 1],
                ["Modena FC", "I1", "1962-63", 11, 2],
                ["Mantova 1911 SSD", "I1", "1962-63", 11, 3],
                ["Calcio Catania", "I1", "1962-63", 11, 4],
                ["ACF Fiorentina", "I1", "1963-64", 4, 1],
                ["Juventus", "I1", "1963-64", 4, 2],
                ["Genoa CFC", "I1", "1963-64", 8, 1],
                ["Lazio Roma", "I1", "1963-64", 8, 2],
                ["Calcio Catania", "I1", "1963-64", 8, 3],
                ["Atalanta", "I1", "1963-64", 8, 4],
                ["AS Roma", "I1", "1963-64", 12, 1],
                ["Mantova 1911 SSD", "I1", "1963-64", 12, 2],
                ["ACF Fiorentina", "I1", "1964-65", 4, 1],
                ["Juventus", "I1", "1964-65", 4, 2],
                ["Bologna FC", "I1", "1964-65", 6, 1],
                ["Cagliari Calcio", "I1", "1964-65", 6, 2],
                ["Foggia Calcio", "I1", "1964-65", 9, 1],
                ["AS Roma", "I1", "1964-65", 9, 2],
                ["AS Varese 1910", "I1", "1964-65", 11, 1],
                ["L.R. Vicenza", "I1", "1964-65", 11, 2],
                ["Atalanta", "I1", "1964-65", 11, 3],
                ["Lazio Roma", "I1", "1964-65", 14, 1],
                ["Sampdoria", "I1", "1964-65", 14, 2],
                ["Foggia Calcio", "I1", "1965-66", 12, 1],
                ["Lazio Roma", "I1", "1965-66", 12, 2],
                ["Atalanta", "I1", "1965-66", 12, 3],
                ["L.R. Vicenza", "I1", "1966-67", 13, 1],
                ["Brescia Calcio", "I1", "1966-67", 13, 2],
                ["Venezia FC", "I1", "1966-67", 17, 1],
                ["Calcio Lecco 1912", "I1", "1966-67", 17, 2],
                ["Inter", "I1", "1967-68", 5, 1],
                ["Bologna FC", "I1", "1967-68", 5, 2],
                ["Torino FC", "I1", "1967-68", 7, 1],
                ["AS Varese 1910", "I1", "1967-68", 7, 2],
                ["Sampdoria", "I1", "1967-68", 10, 1],
                ["AS Roma", "I1", "1967-68", 10, 2],
                ["L.R. Vicenza", "I1", "1967-68", 12, 1],
                ["Atalanta", "I1", "1967-68", 12, 2],
                ["SPAL 2013 Ferrara", "I1", "1967-68", 14, 1],
                ["Brescia Calcio", "I1", "1967-68", 14, 2],
                ["AC Milan", "I1", "1969-70", 4, 1],
                ["ACF Fiorentina", "I1", "1969-70", 4, 2],
                ["Lazio Roma", "I1", "1969-70", 8, 1],
                ["L.R. Vicenza", "I1", "1969-70", 8, 2],
                ["Hellas Verona", "I1", "1973-74", 16],
                ["AC Milan", "I1", "1979-80", 15],
                ["Lazio Roma", "I1", "1979-80", 16],
                ["Brescia Calcio", "I1", "1980-81", 14],
                ["Como 1907", "I1", "1980-81", 13],
                ["Udinese Calcio", "I1", "1980-81", 12],
                ["Ascoli Calcio", "I1", "1980-81", 11],
                ["AC Milan", "I1", "1983-84", 6],
                ["Sampdoria", "I1", "1983-84", 7],
                ["Hellas Verona", "I1", "1983-84", 8],
                ["SSC Napoli", "I1", "1983-84", 11],
                ["US Avellino", "I1", "1983-84", 12],
                ["Lazio Roma", "I1", "1983-84", 13],
                ["AC Milan", "I1", "1984-85", 5],
                ["Udinese Calcio", "I1", "1984-85", 12],
                ["Como 1907", "I1", "1984-85", 11],
                ["Lazio Roma", "I1", "1984-85", 15],
                ["Torino FC", "I1", "1985-86", 4],
                ["Sampdoria", "I1", "1985-86", 12],
                ["AC Milan", "I1", "1986-87", 5],
                ["ACF Fiorentina", "I1", "1992-93", 16],
                ["Lazio Roma", "I1", "1993-94", 3],
                ["Parma Calcio 1913", "I1", "1994-95", 2],
                ["Genoa CFC", "I1", "1994-95", 15],
                ["Piacenza Calcio", "I1", "1996-97", 14],
                ["Empoli FC", "I1", "1997-98", 13],
                ["Udinese Calcio", "I1", "1998-99", 6],
                ["Cagliari Calcio", "I1", "1998-99", 13],
                ["Hellas Verona", "I1", "2000-01", 14],
                ["Modena FC", "I1", "2002-03", 12],
                ["Empoli FC", "I1", "2002-03", 13],
                ["Reggina 1914", "I1", "2002-03", 14],
                ["ACN Siena 1904", "I1", "2003-04", 14],
                ["Reggina 1914", "I1", "2004-05", 10],
                ["US Lecce", "I1", "2004-05", 11],
                ["Cagliari Calcio", "I1", "2004-05", 12],
                ["Lazio Roma", "I1", "2004-05", 13],
                ["Bologna FC", "I1", "2004-05", 18],
                ["Parma Calcio 1913", "I1", "2005-06", 7],
                ["Juventus", "I1", "2005-06", 20],
                ["Palermo FC", "I1", "2006-07", 5],
                ["Torino FC", "I1", "2006-07", 16],
                ["Juventus", "I1", "2008-09", 2],
                ["ACF Fiorentina", "I1", "2008-09", 4],
                ["Chievo Verona", "I1", "2009-10", 14],
                ["Udinese Calcio", "I1", "2009-10", 15],
                ["Cagliari Calcio", "I1", "2009-10", 16],
                ["Empoli FC", "I1", "2015-16", 10],
                ["Palermo FC", "I1", "2015-16", 16],
                ["Udinese Calcio", "I1", "2017-18", 14],
                ["Parma Calcio 1913", "I1", "2018-19", 14],
                ["Cagliari Calcio", "I1", "2018-19", 15],
                ["ACF Fiorentina", "I1", "2018-19", 16],
                ["Hellas Verona", "I1", "2019-20", 9],
                ["Spezia Calcio", "I1", "2022-23", 17],
                ["Torino FC", "I1", "2023-24", 9],
                ["Cagliari Calcio", "I1", "2023-24", 16],
                ["Cagliari Calcio", "I1", "2024-25", 15],

                // Germany
                ["MSV Duisburg", "D1", "1963-64", 2],
                ["Fortuna D√ºsseldorf", "D1", "1966-67", 17],
                ["1. FC K√∂ln", "D1", "1968-69", 13],

                // Spain
                ["CD Alav√©s", "SP1", "1930-31", 8],
                ["CD Alav√©s", "SP1", "1931-32", 9],
                ["Real Sociedad", "SP1", "1933-34", 5],
                ["Valencia CF", "SP1", "1933-34", 7],
                ["Espanyol Barcelona", "SP1", "1934-35", 8],
                ["Real Zaragoza", "SP1", "1939-40", 7],
                ["FC Barcelona", "SP1", "1939-40", 9],
                ["Valencia CF", "SP1", "1940-41", 3],
                ["Sevilla FC", "SP1", "1941-42", 6],
                ["CD Castell√≥n", "SP1", "1941-42", 8],
                ["CE Sabadell", "SP1", "1943-44", 9],
                ["Real Murcia", "SP1", "1944-45", 11],
                ["CE Sabadell", "SP1", "1944-45", 13],
                ["Valencia CF", "SP1", "1946-47", 1],
                ["Real Madrid", "SP1", "1946-47", 7],
                ["Athletic Club", "SP1", "1948-49", 6],
                ["Real Valladolid", "SP1", "1950-51", 6],
                ["Deportivo La Coru√±a", "SP1", "1950-51", 12],
                ["Racing Santander", "SP1", "1950-51", 10],
                ["Deportivo La Coru√±a", "SP1", "1951-52", 11],
                ["Racing Santander", "SP1", "1951-52", 14],
                ["Sporting Gij√≥n", "SP1", "1952-53", 7],
                ["Sevilla FC", "SP1", "1953-54", 5],
                ["Real Sociedad", "SP1", "1953-54", 9],
                ["RC Celta", "SP1", "1953-54", 10],
                ["Real Valladolid", "SP1", "1954-55", 9],
                ["CD Alav√©s", "SP1", "1954-55", 10],
                ["Real Sociedad", "SP1", "1955-56", 8],
                ["Sevilla FC", "SP1", "1956-57", 2],
                ["UD Las Palmas", "SP1", "1956-57", 10],
                ["Granada CF", "SP1", "1957-58", 13],
                ["CA Osasuna", "SP1", "1958-59", 8],
                ["Real Zaragoza", "SP1", "1958-59", 9],
                ["Sevilla FC", "SP1", "1958-59", 12],
                ["Real Oviedo", "SP1", "1959-60", 6],
                ["Elche CF", "SP1", "1960-61", 14],
                ["Real Betis", "SP1", "1960-61", 6],
                ["Real Oviedo", "SP1", "1961-62", 10],
                ["FC Barcelona", "SP1", "1962-63", 6],
                ["Real Betis", "SP1", "1962-63", 9],
                ["Sevilla FC", "SP1", "1962-63", 11],
                ["CE Sabadell", "SP1", "1965-66", 14],
                ["Espanyol Barcelona", "SP1", "1965-66", 12],
                ["Sevilla FC", "SP1", "1965-66", 8],
                ["Elche CF", "SP1", "1966-67", 9],
                ["Elche CF", "SP1", "1967-68", 10],
                ["Granada CF", "SP1", "1968-69", 8],
                ["Athletic Club", "SP1", "1968-69", 11],
                ["Sevilla FC", "SP1", "1969-70", 3],
                ["FC Barcelona", "SP1", "1969-70", 4],
                ["Elche CF", "SP1", "1969-70", 11],
                ["Valencia CF", "SP1", "1970-71", 1],
                ["Granada CF", "SP1", "1970-71", 10],
                ["Real Sociedad", "SP1", "1971-72", 8],
                ["Real Betis", "SP1", "1971-72", 13],
                ["Real Sociedad", "SP1", "1972-73", 7],
                ["Athletic Club", "SP1", "1972-73", 9],
                ["Granada CF", "SP1", "1972-73", 13],
                ["Sporting Gij√≥n", "SP1", "1972-73", 14],
                ["Elche CF", "SP1", "1974-75", 8],
                ["Granada CF", "SP1", "1974-75", 15],
                ["UD Las Palmas", "SP1", "1975-76", 13],
                ["UD Las Palmas", "SP1", "1976-77", 4],
                ["Real Betis", "SP1", "1976-77", 5],
                ["Espanyol Barcelona", "SP1", "1976-77", 6],
                ["Burgos CF", "SP1", "1976-77", 14],
                ["Sevilla FC", "SP1", "1977-78", 8],
                ["Rayo Vallecano", "SP1", "1977-78", 10],
                ["Espanyol Barcelona", "SP1", "1977-78", 14],
                ["Real Betis", "SP1", "1977-78", 16],
                ["Real Betis", "SP1", "1979-80", 5],
                ["Real Zaragoza", "SP1", "1979-80", 11],
                ["Real Sociedad", "SP1", "1980-81", 1],
                ["Real Madrid", "SP1", "1980-81", 2],
                ["Atl√©tico Madrid", "SP1", "1980-81", 3],
                ["Valencia", "SP1", "1980-81", 4],
                ["Atl√©tico Madrid", "SP1", "1981-82", 8],
                ["Real Valladolid", "SP1", "1981-82", 9],
                ["CA Osasuna", "SP1", "1981-82", 10],
                ["Real Zaragoza", "SP1", "1981-82", 11],
                ["Racing Santander", "SP1", "1981-82", 12],
                ["Espanyol Barcelona", "SP1", "1981-82", 13],
                ["M√°laga CF", "SP1", "1982-83", 10],
                ["CA Osasuna", "SP1", "1984-85", 6],
                ["UD Las Palmas", "SP1", "1985-86", 13],
                ["Sporting Gij√≥n", "SP1", "1986-87", 4],
                ["Real Zaragoza", "SP1", "1986-87", 5],
                ["RCD Mallorca", "SP1", "1986-87", 6],
                ["Atl√©tico Madrid", "SP1", "1986-87", 7],
                ["Real Valladolid", "SP1", "1986-87", 10],
                ["Real Murcia", "SP1", "1986-87", 11],
                ["Sevilla FC", "SP1", "1986-87", 12],
                ["CE Sabadell", "SP1", "1986-87", 15],
                ["CD Logro√±√©s", "SP1", "1987-88", 13],
                ["Real Zaragoza", "SP1", "1988-89", 5],
                ["Real Oviedo", "SP1", "1988-89", 12],
                ["CA Osasuna", "SP1", "1989-90", 8],
                ["C√°diz CF", "SP1", "1989-90", 15],
                ["Burgos CF", "SP1", "1990-91", 11],
                ["Athletic Club", "SP1", "1990-91", 12],
                ["RCD Mallorca", "SP1", "1990-91", 15],
                ["CD Logro√±√©s", "SP1", "1991-92", 10],
                ["Athletic Club", "SP1", "1991-92", 14],
                ["Real Valladolid", "SP1", "1991-92", 19],
                ["Sporting Gij√≥n", "SP1", "1992-93", 12],
                ["Sevilla FC", "SP1", "1994-95", 5],
                ["Valencia CF", "SP1", "1994-95", 10],
                ["Real Zaragoza", "SP1", "1995-96", 13],
                ["Athletic Club", "SP1", "1995-96", 15],
                ["Albacete", "SP1", "1995-96", 20],
                ["Deportivo La Coru√±a", "SP1", "1996-97", 3],
                ["Atl√©tico Madrid", "SP1", "1997-98", 7],
                ["UD Salamanca", "SP1", "1997-98", 15],
                ["Espanyol Barcelona", "SP1", "1999-00", 14],
                ["Real Oviedo", "SP1", "1999-00", 16],
                ["Athletic Club", "SP1", "2000-01", 12],
                ["Rayo Vallecano", "SP1", "2000-01", 14],
                ["CA Osasuna", "SP1", "2000-01", 15],
                ["Real Valladolid", "SP1", "2000-01", 16],
                ["M√°laga CF", "SP1", "2001-02", 10],
                ["CA Osasuna", "SP1", "2002-03", 11],
                ["M√°laga CF", "SP1", "2002-03", 13],
                ["Real Zaragoza", "SP1", "2003-04", 12],
                ["Deportivo La Coru√±a", "SP1", "2004-05", 8],
                ["CA Osasuna", "SP1", "2005-06",4],
                ["Real Sociedad", "SP1", "2005-06", 16],
                ["Real Madrid", "SP1", "2006-07", 1],
                ["Espanyol Barcelona", "SP1", "2006-07", 11],
                ["Atl√©tico Madrid", "SP1", "2007-08", 4],
                ["UD Almer√≠a", "SP1", "2007-08", 8],
                ["Real Betis", "SP1", "2007-08", 13],
                ["UD Almer√≠a", "SP1", "2008-09", 11],
                ["Sporting Gij√≥n", "SP1", "2008-09", 14],
                ["CA Osasuna", "SP1", "2008-09", 15],
                ["Sevilla FC", "SP1", "2010-11", 5],
                ["Athletic Club", "SP1", "2010-11", 6],
                ["Real Zaragoza", "SP1", "2010-11", 13],
                ["Getafe CF", "SP1", "2011-12", 11],
                ["Getafe CF", "SP1", "2013-14", 13],
                ["Levante UD", "SP1", "2014-15", 14],
                ["SD Eibar", "SP1", "2014-15", 18],
                ["UD Las Palmas", "SP1", "2015-16", 11],
                ["Espanyol Barcelona", "SP1", "2015-16", 13],
                ["Granada CF", "SP1", "2015-16", 16],
                ["Espanyol Barcelona", "SP1", "2017-18", 11],
                ["Getafe CF", "SP1", "2018-19", 5],
                ["Real Valladolid", "SP1", "2018-19", 16],
                ["Granada CF", "SP1", "2020-21", 9],
                ["RCD Mallorca", "SP1", "2021-22", 16],
                ["Rayo Vallecano", "SP1", "2022-23", 11],
                ["C√°diz CF", "SP1", "2022-23", 14],
                ["Getafe CF", "SP1", "2022-23", 15],
                ["RC Celta", "SP1", "2023-24", 13],
                ["Rayo Vallecano", "SP1", "2024-25", 8],
                ["Real Sociedad", "SP1", "2024-25", 11],
                ["Espanyol Barcelona", "SP1", "2024-25", 14],
                ["Girona FC", "SP1", "2024-25", 16],

                // England
                ["Burnley FC", "E0", "1891-92", 7],
                ["Sheffield United", "E0", "1896-97", 2],
                ["Aston Villa", "E0", "1897-98", 6],
                ["Middlesbrough FC", "E0", "1904-05", 15],
                ["Bradford City", "E0", "1914-15", 11],
                ["Huddersfield Town", "E0", "1923-24", 1],
                ["Birmingham City", "E0", "1936-37", 11],
                ["Bolton Wanderers", "E0", "1948-49", 14],
                ["Bolton Wanderers", "E0", "1949-50", 16],
                ["Sunderland AFC", "E0", "1950-51", 12],
                ["Fulham FC", "E0", "1950-51", 18],
                ["Manchester United", "E0", "1953-54", 4],
                ["Blackpool FC", "E0", "1955-56", 2],
                ["Chelsea FC", "E0", "1956-57", 13],
                ["Leicester City", "E0", "1964-65", 18],
                ["Aston Villa", "E0", "1965-66", 16],
                ["Nottingham Forest", "E0", "1966-67", 2],
                ["Burnley FC", "E0", "1966-67", 14],
                ["Nottingham Forest", "E0", "1971-72", 21],
                ["Liverpool FC", "E0", "1974-75", 2],

                // France
                // Add ranking overrides here as needed
                ["Olympique Lillois Lille", "F1", "1932-33", 1],
                ["AS Cannes", "F1", "1932-33", 2],
                ["Olympique Marseille", "F1", "1934-35", 9],
                ["FC Sochaux", "F1", "1938-39", 6],
                ["SC S√®te", "F1", "1948-49", 14],
                ["Olympique Marseille", "F1", "1955-56", 5],
                ["AS Monaco", "F1", "1957-58", 3],
                ["RC Strasbourg", "F1", "1959-60", 18],
                ["Stade de Reims", "F1", "1961-62", 1],
                ["FC Rouen 1899", "F1", "1961-62", 9],
                ["Stade Fran√ßais", "F1", "1961-62", 10],
                ["FC Metz", "F1", "2023-24", 16]


            ];
        }

        // Apply ranking overrides for historic seasons
        function applyRankingOverrides(tableArray, selectedLeague, selectedSeason) {
            // Only apply overrides for historic season filters
            if (!selectedSeason) return tableArray;
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const selectedDiv = leagueMapping[selectedLeague];
            const overrides = getRankingOverrides().filter(override => 
                override[1] === selectedDiv && override[2] === selectedSeason
            );
            
            if (overrides.length === 0) return tableArray;
            
            // Create a copy of the array to work with
            let result = [...tableArray];
            
            // Separate teams with overrides from those without
            const teamsWithOverrides = [];
            const teamsWithoutOverrides = [];
            
            overrides.forEach(override => {
                const [teamName, , , overridePosition, subOrder] = override;
                const teamIndex = result.findIndex(team => team.team === teamName);
                if (teamIndex !== -1) {
                    const team = result[teamIndex];
                    team.sharedPosition = parseInt(overridePosition);
                    team.subOrder = subOrder || 1;
                    teamsWithOverrides.push(team);
                }
            });
            
            // Get teams without overrides
            result.forEach(team => {
                const hasOverride = teamsWithOverrides.some(overrideTeam => overrideTeam.team === team.team);
                if (!hasOverride) {
                    teamsWithoutOverrides.push(team);
                }
            });
            
            // Sort teams with overrides by position, then by sub-order
            teamsWithOverrides.sort((a, b) => {
                if (a.sharedPosition !== b.sharedPosition) return a.sharedPosition - b.sharedPosition;
                return a.subOrder - b.subOrder;
            });
            
            // Build final result by filling positions
            const finalResult = [];
            const overridePositions = new Set(teamsWithOverrides.map(t => t.sharedPosition));
            
            let nonOverrideIndex = 0;
            for (let position = 1; position <= tableArray.length; position++) {
                if (overridePositions.has(position)) {
                    // Fill with override teams at this position
                    const overrideTeamsAtThisPosition = teamsWithOverrides.filter(t => t.sharedPosition === position);
                    finalResult.push(...overrideTeamsAtThisPosition);
                } else {
                    // Fill with next non-override team
                    if (nonOverrideIndex < teamsWithoutOverrides.length) {
                        finalResult.push(teamsWithoutOverrides[nonOverrideIndex]);
                        nonOverrideIndex++;
                    }
                }
            }
            
            return finalResult;
        }

        // Team colors for head-to-head visualizations
        function getTeamColors() {
            return {
                // Premier League
                'premier-league': [
                    ['Liverpool FC', '#D10022', 550],                    
                    ['Arsenal FC', '#EF0107', 555],
                    ['Everton FC', '#0052CC', 560],                    
                    ['Manchester United', '#D9020D', 543],
                    ['Aston Villa', '#670E36', 559],
                    ['Manchester City', '#84BBFF', 750],
                    ['Chelsea FC', '#004793', 544],
                    ['Tottenham Hotspur', '#001C58', 552],
                    ['Newcastle United', '#000000', 546],
                    ['Sunderland AFC', '#EB172C', 547],
                    ['West Bromwich Albion', '#000080', 748],
                    ['Wolverhampton Wanderers', '#FDB913', 749],
                    ['Blackburn Rovers', '#009ee0', 557],
                    ['Bolton Wanderers', '#263c7e', 554],
                    ['Sheffield Wednesday', '#4681cf', 745],
                    ['West Ham United', '#660033', 553],
                    ['Derby County', '#000000', 542],
                    ['Sheffield United', '#EC2227', 2309], 
                    ['Leeds United', '#FFE100', 541],
                    ['Burnley FC', '#660808', 3185],                    
                    ['Nottingham Forest', '#C8102E', 743],
                    ['Middlesbrough FC', '#FF0000', 548],
                    ['Stoke City', '#FF0033', 2807],
                    ['Leicester City', '#0053A0', 549],
                    ['Birmingham City', '#0000FF', 2244],
                    ['Preston North End', '#002156', 2249],     
                    ['Southampton FC', '#FF0033', 545],
                    ['Huddersfield Town', '#0072CE', 3017],                    
                    ['Portsmouth FC', '#0754ED', 2220],
                    ['Coventry City', '#059DD9', 2240],
                    ['Blackpool FC', '#FF8C00', 2873],
                    ['Ipswich Town', '#3a64a3', 556],
                    ['Fulham FC', '#000000', 558],
                    ['Charlton Athletic', '#D6011D', 551],
                    ['Notts County', '#000000', 3106],
                    ['Norwich City', '#009900', 744],
                    ['Queens Park Rangers', '#0066FF', 746],
                    ['Crystal Palace', '#1B458F', 2242],
                    ['Bury FC', '#032AF0', 2238],
                    ['Cardiff City', '#0070B5', 3182],
                    ['Luton Town', '#2E1C94', 3123],
                    ['Wimbledon FC', '#0000FF', 37530],
                    ['Watford FC', '#FFF71C', 747],
                    ['Oldham Athletic', '#004A97', 2897],
                    ['Grimsby Town', '#000000', 3180],
                    ['Bradford City', '#990033', 2241],
                    ['Brighton & Hove Albion', '#0054A6', 3050],
                    ['Brentford FC', '#FF0000', 3271],
                    ['Bristol City', '#E21A23', 3277],
                    ['Swansea City', '#000000', 3183],
                    ['AFC Bournemouth', '#BF0C10', 2248],
                    ['Wigan Athletic', '#1d59af', 3116],
                    ['Hull City', '#F5A12D', 3111],
                    ['Bradford Park Avenue', '#FB090B', 4195],
                    ['Accrington FC', '#FF0000', 418],
                    ['Reading FC', '#0000FF', 3285],
                    ['Oxford United', '#FFFF00', 3272],
                    ['Millwall FC', '#00194A', 2250],
                    ['Northampton Town', '#990000', 3184],
                    ['Carlisle United', '#1F47BF', 3118],
                    ['Darwen', '#FF0000', 4245],
                    ['Barnsley FC', '#D71921', 3181],
                    ['Swindon Town', '#FF0000', 2237],
                    ['Leyton Orient', '#FF0000', 3121],
                    ['Glossop North End', '#002156', 4243]
                ],
                
                // Serie A
                'serie-a': [
                    ['Juventus', '#000000', 511],
                    ['Inter', '#010E80', 507],
                    ['AC Milan', '#FB090B', 514],
                    ['AS Roma', '#8E1F2F', 520],
                    ['ACF Fiorentina', '#482E92', 3021],
                    ['Lazio Roma', '#87D8F7', 505],
                    ['SSC Napoli', '#12A0D7', 732],
                    ['Torino FC', '#8A1E03', 734],
                    ['Bologna FC', '#1A2F48', 503],
                    ['Sampdoria', '#1B5497', 731],
                    ['Atalanta', '#1E71B8', 504],
                    ['Udinese Calcio', '#000000', 517],
                    ['Genoa CFC', '#05232F', 735],
                    ['Cagliari Calcio', '#002350', 733],
                    ['Parma Calcio 1913', '#1B4094', 516],
                    ['Hellas Verona', '#FFE74A', 519],
                    ['Palermo FC', '#F7B7D3', 2831],
                    ['L.R. Vicenza', '#FF0003', 2219],
                    ['SSC Bari', '#F03030', 2734],
                    ['US Triestina', '#FF0000', 2837],
                    ['Brescia Calcio', '#007FFF', 513],
                    ['Chievo Verona', '#F0F027', 510],
                    ['SPAL 2013 Ferrara', '#0470C2', 2833],
                    ['AS Livorno', '#853138', 2841],
                    ['Calcio Padova', '#FF0000', 2821],
                    ['Calcio Catania', '#E03636', 2826],
                    ['US Lecce', '#E80000', 515],
                    ['Empoli FC', '#175EEB', 2729],
                    ['Ascoli Calcio', '#030000', 2757],
                    ['US Alessandria 1912', '#808080', 2836],
                    ['Modena FC', '#1616CC', 2727],
                    ['Sassuolo Calcio', '#099902', 5843],
                    ['AC Perugia', '#D91515', 508],
                    ['Como 1907', '#007FFF', 2726],
                    ['Novara Calcio', '#007FFF', 2839],
                    ['Aurora Pro Patria', '#122AFF', 2838],
                    ['Venezia FC', '#FF8000', 512],
                    ['Foggia Calcio', '#BD0B0B', 2211],
                    ['Cesena FC', '#080808', 2824],
                    ['ACN Siena 1904', '#000000', 2843],
                    ['Reggina 1914', '#6B1111', 2728],
                    ['US Avellino', '#0C6912', 2825],
                    ['Lucchese', '#D13636', 2740],
                    ['Piacenza Calcio', '#FF0000', 506],
                    ['Pro Vercelli', '#000000', 2848],
                    ['US Cremonese', '#FF0000', 2822],
                    ['Mantova 1911 SSD', '#FF0000', 2832],
                    ['Pisa SC', '#100778', 2210],
                    ['US Catanzaro', '#FFE226', 2827],
                    ['AS Varese 1910', '#FF0000', 2830],
                    ['US Salernitana 1919', '#831D1C', 2820],
                    ['AC Liguria', '#FB090B', 418],
                    ['ACR Messina', '#C70808', 2834],
                    ['Delfino Pescara', '#59A9E6', 2823],
                    ['Casale', '#030303', 2849],
                    ['AC Monza', '#FF0000', 3012],
                    ['Spezia Calcio', '#6C93BA', 3128],
                    ['Sampierdarenese', '#515EE8', 2845],
                    ['Calcio Lecco 1912', '#0E0EC7', 2835],
                    ['FC Crotone', '#D43333', 3980],
                    ['Frosinone Calcio', '#FFDD00', 5633],
                    ['AC Reggiana', '#821D1C', 2789],
                    ['Legnano', '#C1C4E0', 2840],
                    ['Benevento Calcio', '#F0CA0E', 4180],
                    ['Ternana Calcio', '#E01D1D', 2829],
                    ['AC Carpi', '#DE1616', 4820],
                    ['AC Ancona', '#FB090B', 2262],
                    ['US Pistoiese', '#BD6615', 2828],
                    ['ACD Treviso', '#D4EFFC', 5225],
                    ['Novese', '#000000', 8086]
                ],
                
                // La Liga
                'la-liga': [
                    ['Real Madrid', '#FEBE10', 532],
                    ['FC Barcelona', '#A60042', 530],
                    ['Atl√©tico Madrid', '#212B61', 737],
                    ['Athletic Club', '#FF0000', 528],
                    ['Valencia CF', '#000000', 531],
                    ['Sevilla FC', '#FF0000', 529],
                    ['Espanyol Barcelona', '#007FC8', 525],
                    ['Real Sociedad', '#0000FF', 527],
                    ['Real Betis', '#00954C', 540],
                    ['RC Celta', '#99CCFF', 536],
                    ['Real Zaragoza', '#ff0000', 526],
                    ['Deportivo La Coru√±a', '#57175E', 523],
                    ['Real Valladolid', '#921B88', 524],                    
                    ['CA Osasuna', '#0A346F', 738],
                    ['Sporting Gij√≥n', '#FF0000', 739],
                    ['Racing Santander', '#009900', 2287],
                    ['Real Oviedo', '#0066FF', 2193],
                    ['M√°laga CF', '#3399FF', 539],
                    ['RCD Mallorca', '#FF0000', 521],
                    ['Villarreal CF', '#FFE135', 538],
                    ['UD Las Palmas', '#FFFF00', 522],
                    ['Granada CF', '#FF0000', 3192],
                    ['Rayo Vallecano', '#FF0000', 537],
                    ['Getafe CF', '#0000FF', 3689],
                    ['Elche CF', '#00CC33', 3190],
                    ['CD Alav√©s', '#048FD9', 534],
                    ['H√©rcules CF', '#242EFC', 2870],
                    ['Levante UD', '#0000CC', 2809],
                    ['C√°diz CF', '#FFFF00', 3188],
                    ['CD Tenerife', '#0000FF', 533],
                    ['Real Murcia', '#EB0707', 3140],
                    ['CE Sabadell', '#100DDB', 3191],
                    ['UD Salamanca', '#000000', 3754],
                    ['CD Castell√≥n', '#F6D70D', 3189],
                    ['CD Logro√±√©s', '#FF0000', 2887],
                    ['Burgos CF', '#000000', 3015],
                    ['C√≥rdoba CF', '#009933', 3078],
                    ['Albacete', '#000000', 2394],
                    ['UD Almer√≠a', '#EE1119', 3194],
                    ['SD Eibar', '#E01212', 3569],
                    ['Girona FC', '#FF0000', 5264],
                    ['Pontevedra CF', '#FF0000', 3193],
                    ['SD Compostela', '#66CCFF', 2731],
                    ['CD Legan√©s', '#0000FF', 3668],
                    ['Recreativo Huelva', '#205081', 2448],
                    ['Arenas de Getxo', '#000000', 742],
                    ['CD Numancia', '#FF0000', 2308],
                    ['Gimn√†stic de Tarragona', '#DD2430', 3199],
                    ['CD Alcoyano', '#2596BE', 6336],
                    ['Real Ja√©n', '#9900CC', 2776],
                    ['CF Extremadura', '#800000', 2305],
                    ['M√©rida AD', '#000000', 3186],
                    ['Real Uni√≥n', '#000000', 741],
                    ['AD Almer√≠a', '#EE1119', 418],
                    ['SD Huesca', '#CF122D', 9659],
                    ['CE Europa', '#2596BE', 3200],
                    ['Lleida Esportiu', '#76B5C5', 3112],
                    ['Xerez CD', '#0033FF', 2813],
                    ['CD Condal', '#1E81B0', 3195],
                    ['Atl√©tico Tetu√°n', '#FF0000', 3197],
                    ['Cultural Leonesa', '#FF0000', 3196]
                ],
                
                // Bundesliga
                'bundesliga': [
                    ['Bayern M√ºnchen', '#DB072D', 222],
                    ['Borussia Dortmund', '#FDE100', 210],
                    ['Werder Bremen', '#00924A', 202],
                    ['VfB Stuttgart', '#FF0000', 215],
                    ['Bor. M√∂nchengladbach', '#000000', 221],
                    ['Hamburger SV', '#014495', 211],
                    ['Eintracht Frankfurt', '#FF0000', 205],
                    ['FC Schalke 04', '#025FAC', 206],
                    ['Bayer Leverkusen', '#FF0000', 236],
                    ['1. FC K√∂ln', '#ED1C23', 213],
                    ['1. FC Kaiserslautern', '#F50505', 214],
                    ['Hertha BSC', '#004CFF', 209],
                    ['VfL Bochum', '#2B579E', 229],
                    ['VfL Wolfsburg', '#0C4011', 246],
                    ['1. FC N√ºrnberg', '#990000', 212],                    
                    ['Hannover 96', '#009932', 218],
                    ['MSV Duisburg', '#3C4E99', 216],
                    ['SC Freiburg', '#FF0000', 245],
                    ['Fortuna D√ºsseldorf', '#FF0000', 223],
                    ['Karlsruher SC', '#0033CC', 208],
                    ['Eintracht Braunschweig', '#025FAC', 217],
                    ['TSV 1860 M√ºnchen', '#5D9AF5', 204],
                    ['1. FSV Mainz 05', '#FF0000', 337],
                    ['1899 Hoffenheim', '#0033CC', 442],
                    ['Arminia Bielefeld', '#0000FF', 228],
                    ['RB Leipzig', '#DD0741', 13247],
                    ['FC Augsburg', '#BB3532', 342],
                    ['KFC Uerdingen 05', '#004FED', 233],
                    ['Hansa Rostock', '#0033CC', 243],
                    ['FC St. Pauli', '#8B4513', 234],
                    ['1. FC Union Berlin', '#E40019', 330],
                    ['Waldhof Mannheim', '#004292', 338],
                    ['Kickers Offenbach', '#FF0000', 226],
                    ['Rot-Weiss Essen', '#FF0000', 224],
                    ['Energie Cottbus', '#FF0000', 249],
                    ['Alemannia Aachen', '#FFFF00', 225],
                    ['SG Wattenscheid 09', '#000000', 241],
                    ['1. FC Saarbr√ºcken', '#0033FF', 203],
                    ['Dynamo Dresden', '#FFFF00', 242],
                    ['Rot-Wei√ü Oberhausen', '#E72D33', 336],
                    ['SV Darmstadt 98', '#6796C6', 235],
                    ['Wuppertaler SV', '#FF0000', 230],
                    ['Borussia Neunkirchen', '#000000', 219],
                    ['FC 08 Homburg', '#0C4011', 238],
                    ['SpVgg Unterhaching', '#BA1111', 248],
                    ['Stuttgarter Kickers', '#0BB1DB', 240],
                    ['FC Ingolstadt 04', '#FF0000', 4856],
                    ['1. FC Heidenheim 1846', '#003B79', 4497],
                    ['SC Paderborn 07', '#2B429C', 422],
                    ['TeBe Berlin', '#5B1A73', 356],
                    ['SpVgg Greuther F√ºrth', '#009933', 331],
                    ['SSV Ulm 1846', '#1F1D1D', 368],
                    ['Fortuna K√∂ln', '#E80000', 231],
                    ['Preu√üen M√ºnster', '#000000', 207],
                    ['Holstein Kiel', '#0F5787', 385],
                    ['Blau-Wei√ü 90 Berlin', '#1709DB', 239],
                    ['1. FC Lok Leipzig', '#1F357F', 244],
                    ['SV Tasmania Berlin', '#0000FF', 688],
                    ['Dresdner SC', '#000000', 431],
                    ['Rapid Wien', '#000000', 583],
                    ['Viktoria Berlin', '#000000', 727],
                    ['Freiburger FC', '#000000', 362],
                    ['Karlsruher FV', '#000000', 730]

                ],
                
                // Ligue 1
                'ligue-1': [
                    ['Olympique Marseille', '#099FFF', 576],
                    ['AS Monaco', '#FF0000', 562],
                    ['Girondins Bordeaux', '#000979', 565],
                    ['AS Saint-√âtienne', '#40B848', 757],
                    ['Olympique Lyonnais', '#003781', 567],
                    ['Lille OSC', '#F20505', 577],
                    ['Paris Saint-Germain', '#00093F', 563],
                    ['OGC Nice', '#ED1C24', 774],
                    ['Stade Rennais', '#E13327', 570],
                    ['FC Nantes', '#FCD405', 574],
                    ['FC Sochaux', '#034A97', 564],
                    ['RC Lens', '#FFDF00', 568],
                    ['RC Strasbourg', '#009FE3', 752],
                    ['FC Metz', '#6E0F12', 569],
                    ['Stade de Reims', '#EE2223', 776],
                    ['Montpellier HSC', '#344575', 572],
                    ['AJ Auxerre', '#1C4F9C', 571],   
                    ['Toulouse FC', '#8D42D4', 755],  
                    ['N√Æmes Olympique', '#E40613', 784],    
                    ['SC Bastia', '#0053A1', 566],    
                    ['Racing Club de France', '#78ACE4', 772],
                    ['Valenciennes FC', '#D91920', 3036],                    
                    ['Angers SCO', '#000000', 2234],                    
                    ['AS Nancy Lorraine', '#FF0000', 783],
                    ['CS Sedan', '#008006', 578],
                    ['Havre AC', '#11A4D9', 760],
                    ['AS Cannes', '#F4141C', 753],
                    ['FC Rouen 1899', '#FF0000', 773],
                    ['Stade Brestois 29', '#ED1C24', 3306],
                    ['SM Caen', '#26355D', 754],
                    ['FC Lorient', '#F58113', 575],
                    ['Toulouse FC (old)', '#EA0046', 69609],
                    ['SC S√®te', '#2D7A09', 771],
                    ['FC Nancy', '#123163', 9704],
                    ['Stade Fran√ßais', '#EB5195', 769],
                    ['Stade Lavallois', '#EC6608', 756],
                    ['ESTAC Troyes', '#006EB2', 573],
                    ['EA Guingamp', '#ED1C24', 561],
                    ['Red Star FC', '#32D181', 775],
                    ['AC Ajaccio', '#E3272C', 2410],
                    ['SC Toulon', '#FFCC00', 3035],
                    ['CO Roubaix-Tourcoing', '#003781', 779],
                    ['Olympique Lillois Lille', '#FF0000', 768],
                    ['Excelsior Roubaix', '#000000', 3348],
                    ['SC Fives Lille', '#24216A', 4027],
                    ['Le Mans FC', '#BE081A', 3401],
                    ['FC Antibes', '#003781', 7419],
                    ['Dijon FCO', '#D3072A', 5121],
                    ['FC Mulhouse', '#3300FF', 770],
                    ['Thonon √âvian GGFC', '#123163', 5726],
                    ['Tours FC', '#099FFF', 3307],
                    ['Olympique Al√®s', '#003781', 3098],
                    ['Grenoble Foot 38', '#014898', 2236],
                    ['Limoges FC', '#FF0000', 5753],
                    ['Paris FC', '#00093F', 6723],
                    ['Angoul√™me CFC', '#003781', 3995],
                    ['Clermont Foot 63', '#C50C46', 4383],
                    ['FC Martigues', '#FF0000', 2316],
                    ['Amiens SC', '#000000', 3349],
                    ['RC Roubaix (old)', '#000000', 761],
                    ['Troyes AF', '#00A0E4', 69591],
                    ['SC N√Æmes', '#FF0000', 70035],
                    ['Chamois Niortais', '#005CB9', 4130],
                    ['SR Colmar', '#32D181', 7418],
                    ['CA Paris (old)', '#FF0000', 767],
                    ['Lyon OU', '#FF0000', 69513],
                    ['FC Gueugnon', '#FFEE00', 751],
                    ['Gaz√©lec FC Ajaccio', '#FF0000', 4325],
                    ['AS B√©ziers (old)', '#FF0000', 70137],
                    ['FC Istres', '#8D42D4', 3518],
                    ['LB Ch√¢teauroux', '#00458E', 3269],
                    ['US Boulogne', '#E2001A', 9329],
                    ['Avenir Club Avignonnais', '#000000', 6936],
                    ['AS Aix-en-Provence', '#3D84FF', 7416],
                    ['AC Arles-Avignon', '#0033FF', 11030],
                    ['Club Francais Paris', '#FF0000', 759],
                    ['Hy√®res FC', '#9C824A', 7420]
                ]
            };
        }

        // Get team color for H2H visualization
        function getTeamColor(teamName, league) {
            const teamColors = getTeamColors();
            const leagueColors = teamColors[league] || [];
            
            const teamColorEntry = leagueColors.find(([name, color]) => name === teamName);
            return teamColorEntry ? teamColorEntry[1] : null;
        }

        // Get team logo number
        function getTeamLogoNumber(teamName, league) {
            const teamColors = getTeamColors();
            const leagueColors = teamColors[league] || [];
            
            const teamColorEntry = leagueColors.find(([name, color, logoNum]) => name === teamName);
            return teamColorEntry ? teamColorEntry[2] : null;
        }

        // Get team logo URL
        function getTeamLogoUrl(teamName, league) {
            const logoNumber = getTeamLogoNumber(teamName, league);
            return logoNumber ? `https://s.hs-data.com/bilder/wappen/mittel/${logoNumber}.gif?fallback=png` : null;
        }

        // Get contrasting text color (white or black) based on background color
        function getContrastColor(hexColor) {
            // Remove # if present
            const hex = hexColor.replace('#', '');
            
            // Convert to RGB
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return black for light colors, white for dark colors
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }

        // Stripped Champions data - entries that should be hidden when position filtering is involved
        const strippedChampions = [
            ["Juventus", "I1", "2004-05", 1],
            ["Olympique Marseille", "F1", "1992-93", 1],
            ["Arminia Bielefeld", "E1", "1971-72", 18]

            // Add more entries as needed: [teamName, leagueDiv, season, position]
        ];

        // Check if an entry should be filtered out due to stripped champion rules
        function isStrippedChampion(teamName, leagueDiv, season, position, hasTeamFilter, hasPositionFilter) {
            // Only apply filtering when position is involved in the filter
            if (!hasPositionFilter) {
                return false; // Show everything when no position filter is active
            }

            // Check if this entry matches any stripped champion record
            return strippedChampions.some(([team, league, seasonStr, pos]) => {
                return team === teamName && 
                       league === leagueDiv && 
                       seasonStr === season && 
                       pos === position;
            });
        }

        // Point deductions data
        const pointDeductions = [
            { team: 'Genoa CFC', points: 18, startDate: '1959-09-20', endDate: '1960-06-05', league: 'I1' },
            { team: 'Foggia Calcio', points: 6, startDate: '1973-10-07', endDate: '1974-05-19', league: 'I1' },
            { team: 'Sampdoria', points: 3, startDate: '1973-10-07', endDate: '1974-05-19', league: 'I1' },
            { team: 'SSC Napoli', points: 1, startDate: '1976-10-03', endDate: '1977-05-22', league: 'I1' },
            { team: 'Bologna FC', points: 5, startDate: '1980-09-14', endDate: '1981-05-24', league: 'I1' },
            { team: 'US Avellino', points: 5, startDate: '1980-09-14', endDate: '1981-05-24', league: 'I1' },
            { team: 'AC Perugia', points: 5, startDate: '1980-09-14', endDate: '1981-05-24', league: 'I1' },
            { team: 'Udinese Calcio', points: 9, startDate: '1986-09-14', endDate: '1987-05-17', league: 'I1' },
            { team: 'Empoli FC', points: 5, startDate: '1987-09-13', endDate: '1988-05-15', league: 'I1' },
            { team: 'Empoli FC', points: 2, startDate: '1998-09-12', endDate: '1999-05-23', league: 'I1' },
            { team: 'AC Milan', points: 30, startDate: '2005-08-27', endDate: '2006-05-14', league: 'I1' },
            { team: 'Lazio Roma', points: 30, startDate: '2005-08-27', endDate: '2006-05-14', league: 'I1' },
            { team: 'ACF Fiorentina', points: 30, startDate: '2005-08-27', endDate: '2006-05-14', league: 'I1' },
            { team: 'ACN Siena 1904', points: 1, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'ACF Fiorentina', points: 15, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'Reggina 1914', points: 11, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'AC Milan', points: 8, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'Lazio Roma', points: 3, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'Bologna FC', points: 3, startDate: '2010-08-28', endDate: '2011-05-22', league: 'I1' },
            { team: 'Atalanta', points: 6, startDate: '2011-09-09', endDate: '2012-05-13', league: 'I1' },
            { team: 'Sampdoria', points: 1, startDate: '2012-08-25', endDate: '2013-05-19', league: 'I1' },
            { team: 'Torino FC', points: 1, startDate: '2012-08-25', endDate: '2013-05-19', league: 'I1' },
            { team: 'Atalanta', points: 2, startDate: '2012-08-25', endDate: '2013-05-19', league: 'I1' },
            { team: 'ACN Siena 1904', points: 6, startDate: '2012-08-25', endDate: '2013-05-19', league: 'I1' },
            { team: 'Parma Calcio 1913', points: 7, startDate: '2014-08-30', endDate: '2015-05-31', league: 'I1' },
            { team: 'Lazio Roma', points: 1, startDate: '2017-08-19', endDate: '2018-05-20', league: 'I1' },
            { team: 'Lazio Roma', points: 2, startDate: '2018-08-18', endDate: '2019-05-26', league: 'I1' },
            { team: 'Chievo Verona', points: 3, startDate: '2018-08-18', endDate: '2019-05-26', league: 'I1' },
            { team: 'Juventus', points: 10, startDate: '2022-08-13', endDate: '2023-06-04', league: 'I1' },
            
            // Other leagues deductions...
            { team: '1. FC Kaiserslautern', points: 3, startDate: '2003-08-01', endDate: '2004-05-22', league: 'D1' },
            { team: 'Eintracht Frankfurt', points: 2, startDate: '1999-08-13', endDate: '2000-05-20', league: 'D1' },
            { team: 'Dynamo Dresden', points: 4, startDate: '1993-08-06', endDate: '1994-05-07', league: 'D1' },
            { team: 'Sunderland AFC', points: 2, startDate: '1890-08-01', endDate: '1891-05-31', league: 'E0' },
            { team: 'Arsenal FC', points: 2, startDate: '1990-08-01', endDate: '1991-05-31', league: 'E0' },
            { team: 'Manchester United', points: 1, startDate: '1990-08-01', endDate: '1991-05-31', league: 'E0' },
            { team: 'Middlesbrough FC', points: 3, startDate: '1996-08-17', endDate: '1997-05-11', league: 'E0' },
            { team: 'Portsmouth FC', points: 9, startDate: '2009-08-15', endDate: '2010-05-09', league: 'E0' },
            { team: 'Everton FC', points: 6, startDate: '2023-08-11', endDate: '2024-05-19', league: 'E0' },
            { team: 'Nottingham Forest', points: 4, startDate: '2023-08-11', endDate: '2024-05-19', league: 'E0' },
            { team: 'Olympique Marseille', points: 1, startDate: '1992-08-08', endDate: '1993-06-02', league: 'F1' },
            { team: 'Valenciennes FC', points: 1, startDate: '1992-08-08', endDate: '1993-06-02', league: 'F1' },
            { team: 'FC Metz', points: 1, startDate: '2007-08-04', endDate: '2008-05-17', league: 'F1' },
            { team: 'AC Ajaccio', points: 2, startDate: '2012-08-10', endDate: '2013-05-26', league: 'F1' },
            { team: 'OGC Nice', points: 1, startDate: '2021-08-06', endDate: '2022-05-21', league: 'F1' },
            { team: 'Olympique Lyonnais', points: 1, startDate: '2021-08-06', endDate: '2022-05-21', league: 'F1' },
            { team: 'Montpellier HSC', points: 1, startDate: '2023-07-01', endDate: '2024-06-30', league: 'F1' },
            { team: 'UD Almer√≠a', points: 3, startDate: '2014-08-23', endDate: '2015-05-23', league: 'SP1' },
            { team: 'Racing Santander', points: 1, startDate: '2003-08-30', endDate: '2004-05-23', league: 'SP1' },
            { team: 'M√°laga CF', points: 3, startDate: '1979-07-01', endDate: '1980-06-30', league: 'SP1' }
        ];

        // Season mappings
        const seasons = {
            'serie-a': {
                '2025-26': { start: '2025-08-01', end: '2026-06-30' },
                '2024-25': { start: '2024-08-01', end: '2025-06-30' },
                '2023-24': { start: '2023-08-01', end: '2024-06-30' },
                '2022-23': { start: '2022-08-01', end: '2023-06-30' },
                '2021-22': { start: '2021-08-01', end: '2022-06-30' },
                '2020-21': { start: '2020-09-14', end: '2021-06-04' }, // Extended by 5 days each side
                '2019-20': { start: '2019-08-19', end: '2020-08-10' }, // Extended by 5 days each side
            },
            'premier-league': {
                '2020-21': { start: '2020-09-07', end: '2021-05-28' }, // Extended by 5 days each side
                '2019-20': { start: '2019-07-31', end: '2020-07-31' }, // Extended by 5 days each side
                '1946-47': { start: '1946-07-01', end: '1947-07-31' }, // Extended range for post-war season
            },
            'la-liga': {
                '2020-21': { start: '2020-09-07', end: '2021-05-28' }, // Extended by 5 days each side
                '2019-20': { start: '2019-08-11', end: '2020-07-24' }, // Extended by 5 days each side
                '1929-30': { start: '1929-12-01', end: '1930-03-30' }, // Historical early La Liga season
                '1928-29': { start: '1929-02-02', end: '1929-06-30' }, // Historical early La Liga season
            },
        };

        // Generate seasons for all leagues
        function generateSeasons() {
            // Serie A seasons - comprehensive historical coverage
            seasons['serie-a']['1929-30'] = { start: '1929-10-06', end: '1930-08-06' };
            seasons['serie-a']['1930-31'] = { start: '1930-09-28', end: '1931-06-30' };
            seasons['serie-a']['1931-32'] = { start: '1931-09-05', end: '1932-06-16' };
            seasons['serie-a']['1932-33'] = { start: '1932-09-18', end: '1933-06-26' };
            seasons['serie-a']['1933-34'] = { start: '1933-09-10', end: '1934-05-30' };
            seasons['serie-a']['1934-35'] = { start: '1934-09-30', end: '1935-06-05' };
            seasons['serie-a']['1935-36'] = { start: '1935-09-22', end: '1936-05-17' };
            seasons['serie-a']['1936-37'] = { start: '1936-09-13', end: '1937-05-30' };
            seasons['serie-a']['1937-38'] = { start: '1937-09-12', end: '1938-05-30' };
            seasons['serie-a']['1938-39'] = { start: '1938-09-18', end: '1939-06-05' };
            seasons['serie-a']['1939-40'] = { start: '1939-09-17', end: '1940-06-05' };
            seasons['serie-a']['1940-41'] = { start: '1940-10-06', end: '1941-05-11' };
            seasons['serie-a']['1941-42'] = { start: '1941-10-26', end: '1942-06-30' };
            seasons['serie-a']['1942-43'] = { start: '1942-10-04', end: '1943-05-30' };
            seasons['serie-a']['1946-47'] = { start: '1946-09-22', end: '1947-07-10' };
            seasons['serie-a']['1947-48'] = { start: '1947-09-14', end: '1948-07-05' };
            seasons['serie-a']['1948-49'] = { start: '1948-09-19', end: '1949-06-15' };
            seasons['serie-a']['1949-50'] = { start: '1949-09-11', end: '1950-06-05' };
            
            // Generate standard seasons 1950-2018
            for (let year = 1950; year <= 2018; year++) {
                const seasonName = `${year}-${(year + 1).toString().slice(2)}`;
                seasons['serie-a'][seasonName] = {
                    start: `${year}-08-01`,
                    end: `${year + 1}-06-30`
                };
            }

            // Premier League and English First Division seasons
            for (let year = 1888; year <= 2025; year++) {
                if (year === 2019 || year === 2020) continue; // Skip COVID seasons
                
                // Skip WWI seasons: 1915-16, 1916-17, 1917-18, 1918-19
                if (year === 1915 || year === 1916 || year === 1917 || year === 1918) continue;
                
                // Skip WWII seasons: 1940-41, 1941-42, 1942-43, 1943-44, 1944-45, 1945-46
                if (year >= 1939 && year <= 1945) continue;
                
                const seasonName = `${year}-${(year + 1).toString().slice(2)}`;
                if (!seasons['premier-league']) seasons['premier-league'] = {};
                
                // Different start dates for different eras
                let startDate, endDate;
                if (year < 1992) {
                    // Special case for 1946-47 season
                    if (year === 1946) {
                        startDate = `${year}-08-01`;
                        endDate = `${year + 1}-06-30`;
                    } else {
                        // English First Division era - seasons typically started earlier
                        startDate = `${year}-08-01`;
                        endDate = `${year + 1}-05-31`;
                    }
                } else {
                    // Premier League era
                    startDate = `${year}-08-01`;
                    endDate = `${year + 1}-06-30`;
                }
                
                seasons['premier-league'][seasonName] = {
                    start: startDate,
                    end: endDate
                };
            }

            // Add other leagues
            ['bundesliga', 'la-liga', 'ligue-1'].forEach(league => {
                seasons[league] = seasons[league] || {};
                const startYear = league === 'bundesliga' ? 1963 : league === 'la-liga' ? 1928 : 1932;
                for (let year = startYear; year <= 2025; year++) {
                    if (league === 'la-liga' && year >= 1936 && year <= 1938) continue;
                    if (league === 'la-liga' && (year === 2019 || year === 2020)) continue; // Skip COVID seasons
                    if (league === 'ligue-1' && year >= 1939 && year <= 1944) continue;
                    const seasonName = `${year}-${(year + 1).toString().slice(2)}`;
                    
                    // Special cases for Ligue 1 seasons
                    let startDate, endDate;
                    if (league === 'ligue-1' && year === 1967) {
                        startDate = `${year}-07-01`;
                        endDate = `${year + 1}-07-06`;
                    } else if (league === 'ligue-1' && year === 1968) {
                        startDate = `${year}-07-15`;
                        endDate = `${year + 1}-06-30`;
                    } else {
                        startDate = `${year}-07-01`;
                        endDate = `${year + 1}-06-30`;
                    }
                    
                    seasons[league][seasonName] = {
                        start: startDate,
                        end: endDate
                    };
                }
            });
        }

        // Initialize seasons
        generateSeasons();

        // DOM elements
        const elements = {
            lastDataUpdate: document.getElementById('lastDataUpdate'),
            controlsSection: document.getElementById('controlsSection'),
            reloadGistsBtn: document.getElementById('reloadGistsBtn'),
            errorState: document.getElementById('errorState'),
            errorMessage: document.getElementById('errorMessage'),
            tableContainer: document.getElementById('tableContainer'),
            tableInfo: document.getElementById('tableInfo'),
            tableInfoText: document.getElementById('tableInfoText'),
            tableHeader: document.getElementById('tableHeader'),
            tableBody: document.getElementById('tableBody'),
            leagueButtons: document.getElementById('leagueButtons'),
            seasonSelect: document.getElementById('seasonSelect'),
            dateFrom: document.getElementById('dateFrom'),
            dateTo: document.getElementById('dateTo'),
            dayOfWeekSelect: document.getElementById('dayOfWeekSelect'),
            team1Select: document.getElementById('team1Select'),
            team2Select: document.getElementById('team2Select'),
            team1ComboboxContainer: document.getElementById('team1ComboboxContainer'),
            team1ComboboxInput: document.getElementById('team1ComboboxInput'),
            team1ComboboxDropdown: document.getElementById('team1ComboboxDropdown'),
            team2ComboboxContainer: document.getElementById('team2ComboboxContainer'),
            team2ComboboxInput: document.getElementById('team2ComboboxInput'),
            team2ComboboxDropdown: document.getElementById('team2ComboboxDropdown'),
            teamSeasonsComboboxContainer: document.getElementById('teamSeasonsComboboxContainer'),
            teamSeasonsComboboxInput: document.getElementById('teamSeasonsComboboxInput'),
            teamSeasonsComboboxDropdown: document.getElementById('teamSeasonsComboboxDropdown'),
            lastTimeTeam1ComboboxContainer: document.getElementById('lastTimeTeam1ComboboxContainer'),
            lastTimeTeam1ComboboxInput: document.getElementById('lastTimeTeam1ComboboxInput'),
            lastTimeTeam1ComboboxDropdown: document.getElementById('lastTimeTeam1ComboboxDropdown'),
            lastTimeTeam2ComboboxContainer: document.getElementById('lastTimeTeam2ComboboxContainer'),
            lastTimeTeam2ComboboxInput: document.getElementById('lastTimeTeam2ComboboxInput'),
            lastTimeTeam2ComboboxDropdown: document.getElementById('lastTimeTeam2ComboboxDropdown'),
            teamStreaksTeam1ComboboxContainer: document.getElementById('teamStreaksTeam1ComboboxContainer'),
            teamStreaksTeam1ComboboxInput: document.getElementById('teamStreaksTeam1ComboboxInput'),
            teamStreaksTeam1ComboboxDropdown: document.getElementById('teamStreaksTeam1ComboboxDropdown'),
            teamStreaksTeam2ComboboxContainer: document.getElementById('teamStreaksTeam2ComboboxContainer'),
            teamStreaksTeam2ComboboxInput: document.getElementById('teamStreaksTeam2ComboboxInput'),
            teamStreaksTeam2ComboboxDropdown: document.getElementById('teamStreaksTeam2ComboboxDropdown'),
            homeCheckbox: document.getElementById('homeCheckbox'),
            awayCheckbox: document.getElementById('awayCheckbox'),
            deductionsCheckbox: document.getElementById('deductionsCheckbox'),
            threePointCheckbox: document.getElementById('threePointCheckbox'),
            resetBtn: document.getElementById('resetBtn'),
            retryBtn: document.getElementById('retryBtn'),
            h2hSection: document.getElementById('h2hSection'),
            h2hHomeCheckbox: document.getElementById('h2hHomeCheckbox'),
            h2hAwayCheckbox: document.getElementById('h2hAwayCheckbox'),
            recentH2HSelect: document.getElementById('recentH2HSelect'),
            h2hMatchCount: document.getElementById('h2hMatchCount'),
            h2hVisualizations: document.getElementById('h2hVisualizations'),
            h2hMatchesTable: document.getElementById('h2hMatchesTable'),
            h2hTableTitle: document.getElementById('h2hTableTitle'),
            h2hTableHeader: document.getElementById('h2hTableHeader'),
            h2hTableBody: document.getElementById('h2hTableBody'),
            matchHistorySection: document.getElementById('matchHistorySection'),
            matchHistoryHomeCheckbox: document.getElementById('matchHistoryHomeCheckbox'),
            matchHistoryAwayCheckbox: document.getElementById('matchHistoryAwayCheckbox'),
            matchHistoryMatchCount: document.getElementById('matchHistoryMatchCount'),
            matchHistoryStatsTable: document.getElementById('matchHistoryStatsTable'),
            matchHistoryStatsTitle: document.getElementById('matchHistoryStatsTitle'),
            matchHistoryStatsHeader: document.getElementById('matchHistoryStatsHeader'),
            matchHistoryStatsBody: document.getElementById('matchHistoryStatsBody'),
            matchHistoryTable: document.getElementById('matchHistoryTable'),
            matchHistoryTableTitle: document.getElementById('matchHistoryTableTitle'),
            matchHistoryTableHeader: document.getElementById('matchHistoryTableHeader'),
            matchHistoryTableBody: document.getElementById('matchHistoryTableBody'),
            recentMatchesSelect: document.getElementById('recentMatchesSelect'),
            matchHistoryVisualizations: document.getElementById('matchHistoryVisualizations'),
            lastTimeLeagueButtons: document.getElementById('lastTimeLeagueButtons'),
            lastTimeDayOfWeekSelect: document.getElementById('lastTimeDayOfWeekSelect'),
            lastTimeLocationSelect: document.getElementById('lastTimeLocationSelect'),
            lastTimeTeam1Select: document.getElementById('lastTimeTeam1Select'),
            lastTimeTeam2Select: document.getElementById('lastTimeTeam2Select'),
            lastTimeResults: document.getElementById('lastTimeResults'),
            // Table sections
            team1HomeWinSection: document.getElementById('team1HomeWinSection'),
            team1AwayWinSection: document.getElementById('team1AwayWinSection'),
            team1HomeDrawSection: document.getElementById('team1HomeDrawSection'),
            team1AwayDrawSection: document.getElementById('team1AwayDrawSection'),
            team1HomeLossSection: document.getElementById('team1HomeLossSection'),
            team1AwayLossSection: document.getElementById('team1AwayLossSection'),
            // Table bodies
            team1HomeWinBody: document.getElementById('team1HomeWinBody'),
            team1AwayWinBody: document.getElementById('team1AwayWinBody'),
            team1HomeDrawBody: document.getElementById('team1HomeDrawBody'),
            team1AwayDrawBody: document.getElementById('team1AwayDrawBody'),
            team1HomeLossBody: document.getElementById('team1HomeLossBody'),
            team1AwayLossBody: document.getElementById('team1AwayLossBody'),
            // Day counters
            team1HomeWinDays: document.getElementById('team1HomeWinDays'),
            team1AwayWinDays: document.getElementById('team1AwayWinDays'),
            team1HomeDrawDays: document.getElementById('team1HomeDrawDays'),
            team1AwayDrawDays: document.getElementById('team1AwayDrawDays'),
            team1HomeLossDays: document.getElementById('team1HomeLossDays'),
            team1AwayLossDays: document.getElementById('team1AwayLossDays'),
            // Titles
            team1HomeWinTitle: document.getElementById('team1HomeWinTitle'),
            team1AwayWinTitle: document.getElementById('team1AwayWinTitle'),
            team1HomeDrawTitle: document.getElementById('team1HomeDrawTitle'),
            team1AwayDrawTitle: document.getElementById('team1AwayDrawTitle'),
            team1HomeLossTitle: document.getElementById('team1HomeLossTitle'),
            team1AwayLossTitle: document.getElementById('team1AwayLossTitle'),
            teamHistoryTable: document.getElementById('teamHistoryTable'),
            teamHistoryTitle: document.getElementById('teamHistoryTitle'),
            teamHistoryHeader: document.getElementById('teamHistoryHeader'),
            teamHistoryBody: document.getElementById('teamHistoryBody'),
            teamHistoryBackArrow: document.getElementById('teamHistoryBackArrow'),
            teamSeasonsLeagueButtons: document.getElementById('teamSeasonsLeagueButtons'),
            teamSeasonsTeamSelect: document.getElementById('teamSeasonsTeamSelect'),
            teamSeasonsSeasonContainer: document.getElementById('teamSeasonsSeasonContainer'),
            teamSeasonsSeasonSelect: document.getElementById('teamSeasonsSeasonSelect'),
            teamSeasonsPositionContainer: document.getElementById('teamSeasonsPositionContainer'),
            teamSeasonsPositionSelect: document.getElementById('teamSeasonsPositionSelect'),
            includeBetterResultsContainer: document.getElementById('includeBetterResultsContainer'),
            includeBetterResultsCheckbox: document.getElementById('includeBetterResultsCheckbox'),
            teamSeasonsPositionInfo: document.getElementById('teamSeasonsPositionInfo'),
            historicSeasonsContainer: document.getElementById('historicSeasonsContainer'),
            historicSeasonsToggle: document.getElementById('historicSeasonsToggle'),
            collapseControlsBtn: document.getElementById('collapseControlsBtn'),
            // Team Streaks elements
            teamStreaksLeagueButtons: document.getElementById('teamStreaksLeagueButtons'),
            teamStreaksStatusSelect: document.getElementById('teamStreaksStatusSelect'),
            teamStreaksLocationSelect: document.getElementById('teamStreaksLocationSelect'),
            teamStreaksTypeSelect: document.getElementById('teamStreaksTypeSelect'),
            teamStreaksTeam1Select: document.getElementById('teamStreaksTeam1Select'),
            teamStreaksTeam2Select: document.getElementById('teamStreaksTeam2Select'),
            teamStreaksResults: document.getElementById('teamStreaksResults')
        };

        // Historic Seasons Data Structure
        // Format: [season, leagueId, position, teamName, gamesPlayed, wins, draws, losses, goalsFor, goalsAgainst, goalDifference, points]
        const historicSeasonsData = [
            // Example entries - replace with actual historic data
            ["1928-29", "I1", 1, "Bologna FC", 30, 22, 5, 3, 84, 32, 52, 49],
            ["1927-28", "I1", 1, "Torino FC", 34, 22, 5, 7, 111, 37, 74, 49],
            ["1925-26", "I1", 1, "Juventus", 24, 19, 3, 2, 80, 15, 65, 41],
            ["1924-25", "I1", 1, "Bologna FC", 24, 15, 4, 5, 53, 22, 31, 34],
            ["1923-24", "I1", 1, "Genoa CFC", 22, 14, 5, 3, 50, 13, 37, 33],
            ["1922-23", "I1", 1, "Genoa CFC", 22, 17, 5, 0, 61, 18, 43, 39],
            ["1921-22", "I1", 1, "Pro Vercelli", 22, 17, 2, 3, 61, 14, 47, 36],
            ["1921-22", "I1", 1, "Novese", 8, 6, 2, 0, 18, 1, 17, 14],
            ["1920-21", "I1", 1, "Pro Vercelli", 16, 11, 1, 4, 37, 14, 23, 23],
            ["1919-20", "I1", 1, "Inter", 22, 16, 5, 1, 81, 26, 55, 37],
            ["1914-15", "I1", 1, "Genoa CFC", 21, 17, 1, 3, 99, 21, 78, 35],
            ["1913-14", "I1", 1, "Casale", 28, 23, 1, 4, 80, 17, 63, 47],
            ["1912-13", "I1", 1, "Pro Vercelli", 20, 17, 3, 0, 60, 3, 57, 37],
            ["1911-12", "I1", 1, "Pro Vercelli", 18, 15, 2, 1, 50, 12, 38, 32],
            ["1910-11", "I1", 1, "Pro Vercelli", 16, 12, 3, 1, 44, 8, 36, 27],
            ["1909-10", "I1", 1, "Inter", 16, 12, 1, 3, 55, 26, 29, 25],
            ["1909", "I1", 1, "Pro Vercelli", 6, 4, 2, 0, 11, 6, 5, 10],
            ["1908", "I1", 1, "Pro Vercelli", 4, 2, 2, 0, 4, 2, 2, 6],
            ["1907", "I1", 1, "AC Milan", 4, 2, 2, 0, 10, 3, 7, 6],
            ["1906", "I1", 1, "AC Milan", 4, 2, 1, 1, 7, 4, 3, 5],
            ["1905", "I1", 1, "Juventus", 4, 2, 2, 0, 9, 3, 6, 6],
            ["1904", "I1", 1, "Genoa CFC", 1, 1, 0, 0, 1, 0, 1, 2],
            ["1903", "I1", 1, "Genoa CFC", 1, 1, 0, 0, 3, 0, 3, 2],
            ["1902", "I1", 1, "Genoa CFC", 4, 4, 0, 0, 11, 4, 7, 8],
            ["1901", "I1", 1, "AC Milan", 3, 3, 0, 0, 8, 2, 6, 6],
            ["1900", "I1", 1, "Genoa CFC", 2, 2, 0, 0, 10, 1, 9, 4],
            ["1899", "I1", 1, "Genoa CFC", 1, 1, 0, 0, 3, 1, 2, 2],
            ["1898", "I1", 1, "Genoa CFC", 2, 1, 0, 0, 4, 1, 3, 4],

            ["1963", "D1", 1, "Borussia Dortmund", 4, 2, 1, 1, 15, 7, 8, 3],
            ["1962", "D1", 1, "1. FC K√∂ln", 3, 3, 0, 0, 14, 1, 13, 6],
            ["1961", "D1", 1, "1. FC N√ºrnberg", 6, 4, 2, 0, 18, 9, 9, 10],
            ["1960", "D1", 1, "Hamburger SV", 6, 4, 1, 1, 22, 11, 11, 9],
            ["1959", "D1", 1, "Eintracht Frankfurt", 6, 6, 0, 0, 26, 11, 15, 12],
            ["1958", "D1", 1, "FC Schalke 04", 3, 3, 0, 0, 16, 1, 15, 6],
            ["1957", "D1", 1, "Borussia Dortmund", 3, 3, 0, 0, 7, 4, 3, 6],
            ["1956", "D1", 1, "Borussia Dortmund", 6, 4, 1, 1, 19, 4, 15, 9],
            ["1955", "D1", 1, "Rot-Weiss Essen", 6, 4, 2, 0, 16, 5, 11, 10],
            ["1954", "D1", 1, "Hannover 96", 2, 2, 0, 0, 5, 2, 3, 4],
            ["1953", "D1", 1, "1. FC Kaiserslautern", 6, 5, 1, 0, 16, 7, 9, 11],
            ["1952", "D1", 1, "VfB Stuttgart", 6, 3, 2, 1, 14, 8, 6, 8],
            ["1951", "D1", 1, "1. FC Kaiserslautern", 6, 4, 1, 1, 14, 8, 6, 9],
            ["1950", "D1", 1, "VfB Stuttgart", 4, 4, 0, 0, 13, 5, 8, 8],
            ["1949", "D1", 1, "Waldhof Mannheim", 3, 3, 0, 0, 10, 3, 7, 6],
            ["1948", "D1", 1, "1. FC N√ºrnberg", 2, 2, 0, 0, 5, 3, 2, 4],
            ["1944", "D1", 1, "Dresdner SC", 5, 5, 0, 0, 28, 7, 21, 10],
            ["1943", "D1", 1, "Dresdner SC", 5, 5, 0, 0, 16, 2, 14, 10],
            ["1942", "D1", 1, "FC Schalke 04", 5, 5, 0, 0, 25, 3, 22, 10],
            ["1941", "D1", 1, "Rapid Wien", 8, 6, 1, 1, 30, 7, 23, 13],
            ["1940", "D1", 1, "FC Schalke 04", 8, 6, 2, 0, 39, 6, 33, 14],
            ["1939", "D1", 1, "FC Schalke 04", 8, 7, 0, 1, 31, 8, 3, 14],
            ["1938", "D1", 1, "Hannover 96", 8, 8, 0, 0, 26, 13, 13, 16],
            ["1937", "D1", 1, "FC Schalke 04", 8, 7, 1, 0, 37, 7, 30, 15],
            ["1936", "D1", 1, "1. FC N√ºrnberg", 8, 7, 1, 0, 23, 5, 18, 15],
            ["1935", "D1", 1, "FC Schalke 04", 8, 7, 0, 1, 36, 12, 24, 14],
            ["1934", "D1", 1, "FC Schalke 04", 8, 6, 0, 2, 23, 10, 13, 12],
            ["1933", "D1", 1, "Fortuna D√ºsseldorf", 4, 4, 0, 0, 19, 0, 19, 8],

            ["1932", "D1", 1, "Bayern M√ºnchen", 4, 4, 0, 0, 11, 4, 7, 8],
            ["1931", "D1", 1, "Hertha BSC", 4, 4, 0, 0, 14, 7, 7, 8],
            ["1930", "D1", 1, "Hertha BSC", 4, 4, 0, 0, 23, 11, 12, 8],
            ["1929", "D1", 1, "SpVgg Greuther F√ºrth", 4, 4, 0, 0, 16, 4, 12, 8],
            ["1928", "D1", 1, "Hamburger SV", 4, 4, 0, 0, 21, 6, 15, 8],
            ["1927", "D1", 1, "1. FC N√ºrnberg", 4, 4, 0, 0, 15, 3, 12, 8],
            ["1926", "D1", 1, "SpVgg Greuther F√ºrth", 4, 4, 0, 0, 16, 2, 14, 8],
            ["1925", "D1", 1, "1. FC N√ºrnberg", 4, 4, 0, 0, 10, 1, 9, 8],
            ["1924", "D1", 1, "1. FC N√ºrnberg", 3, 3, 0, 0, 11, 2, 9, 6],
            ["1923", "D1", 1, "Hamburger SV", 3, 3, 0, 0, 8, 2, 6, 6],
            ["1921", "D1", 1, "1. FC N√ºrnberg", 2, 2, 0, 0, 10, 1, 9, 4],
            ["1920", "D1", 1, "1. FC N√ºrnberg", 3, 3, 0, 0, 7, 0, 7, 6],
            ["1914", "D1", 1, "SpVgg Greuther F√ºrth", 3, 3, 0, 0, 8, 6, 2, 6],
            ["1913", "D1", 1, "1. FC Lok Leipzig", 3, 3, 0, 0, 11, 2, 9, 6],
            ["1912", "D1", 1, "Holstein Kiel", 3, 3, 0, 0, 5, 1, 4, 6],
            ["1911", "D1", 1, "Viktoria Berlin", 2, 2, 0, 0, 7, 1, 6, 4],
            ["1910", "D1", 1, "Karlsruher FV", 3, 3, 0, 0, 4, 1, 3, 6],
            ["1909", "D1", 1, "Karlsruher SC", 3, 3, 0, 0, 18, 3, 15, 6],
            ["1908", "D1", 1, "Viktoria Berlin", 3, 3, 0, 0, 14, 1, 13, 6],
            ["1907", "D1", 1, "Freiburger FC", 2, 2, 0, 0, 6, 3, 3, 4],
            ["1906", "D1", 1, "1. FC Lok Leipzig", 3, 3, 0, 0, 14, 4, 10, 6],
            ["1905", "D1", 1, "Blau-Wei√ü 90 Berlin", 3, 3, 0, 0, 11, 3, 8, 6],
            ["1903", "D1", 1, "1. FC Lok Leipzig", 3, 3, 0, 0, 16, 6, 10, 6],



            // Add more historic seasons here...
        ];

        // Create Team Streaks league buttons
        function createTeamStreaksLeagueButtons() {
            const leagues = [
                { id: 'premier-league', name: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League' },
                { id: 'la-liga', name: 'üá™üá∏ La Liga' },
                { id: 'serie-a', name: 'üáÆüáπ Serie A' },
                { id: 'bundesliga', name: 'üá©üá™ Bundesliga' },
                { id: 'ligue-1', name: 'üá´üá∑ Ligue 1' }
            ];

            const leagueButtonsHTML = leagues.map(league => `
                <label class="league-button ${state.selectedLeague === league.id ? 'active' : ''}" data-league="${league.id}">
                    <div class="radio-dot ${state.selectedLeague === league.id ? 'active' : ''}"></div>
                    <span class="text-sm font-medium ${state.selectedLeague === league.id ? 'text-green-700' : 'text-gray-700'}">
                        ${league.name}
                    </span>
                </label>
            `).join('');
            
            elements.teamStreaksLeagueButtons.innerHTML = leagueButtonsHTML;
        }

        // Update Team Streaks team dropdowns
        function updateTeamStreaksSelects() {
            const leagueTeams = getLeagueTeams(state.selectedLeague);
            
            const teamOptions = ['<option value="">Select Team</option>']
                .concat(leagueTeams.map(team => `<option value="${team}">${team}</option>`))
                .join('');
            
            elements.teamStreaksTeam1Select.innerHTML = teamOptions;
            updateTeamStreaksTeam2Options();
        }

        // Handle Team Streaks league change
        async function handleTeamStreaksLeagueChange(newLeague) {
            state.selectedLeague = newLeague;

            // Reset Team Streaks state when changing leagues
            elements.teamStreaksTeam1Select.value = '';
            elements.teamStreaksTeam2Select.value = '';
            elements.teamStreaksStatusSelect.value = 'active';
            elements.teamStreaksLocationSelect.value = 'both';
            elements.teamStreaksTypeSelect.value = 'winning';
            elements.teamStreaksResults.classList.add('hidden');
            state.teamStreaksBig6Opponents = null;
            state.historicStreaksSortConfig = { key: null, direction: null };

            // Load league data if not already loaded
            if (!state.loadedLeagues || !state.loadedLeagues.has(newLeague)) {
                await loadLeagueDataForDevice(newLeague);
            } else {
                // If already loaded, just filter/update UI
                filterDataForCurrentLeague(newLeague);
            }

            createTeamStreaksLeagueButtons();
            updateTeamStreaksSelects();
        }

        // Handle Team Streaks status change
        function handleTeamStreaksStatusChange(status) {
            calculateTeamStreaks();
        }
        // Handle Team Streaks location change
        function handleTeamStreaksLocationChange(location) {
            calculateTeamStreaks();
        }

        // Handle Team Streaks type change
        function handleTeamStreaksTypeChange(type) {
            calculateTeamStreaks();
        }

        // Handle Team Streaks Team 1 selection
        function handleTeamStreaksTeam1Change(team) {
            // If Team 2 is currently Big 6, update the Big 6 opponents for the new Team 1
            // but DON'T reset Team 2 selection
            if (elements.teamStreaksTeam2Select.value === 'BIG_6') {
                state.teamStreaksBig6Opponents = getBig6Opponents(team);
                updateTeamStreaksTeam2Options(); // Refresh options but keep Big 6 selected
            } else {
                // Reset Team 2 selection and refresh its options (to show/hide Big 6)
                elements.teamStreaksTeam2Select.value = '';
                updateTeamStreaksTeam2Options();
            }

            calculateTeamStreaks();
        }

        // Handle Team Streaks Team 2 selection
        function handleTeamStreaksTeam2Change(team) {
            // Handle Big 6 selection
            if (team === 'BIG_6') {
                state.teamStreaksBig6Opponents = getBig6Opponents(elements.teamStreaksTeam1Select.value);
            } else {
                state.teamStreaksBig6Opponents = null;
            }
            calculateTeamStreaks();
        }

        // Update Team Streaks Team 2 options to include Big 6 if applicable
        function updateTeamStreaksTeam2Options() {
            const leagueTeams = getLeagueTeams(state.selectedLeague);
            const currentTeam2 = elements.teamStreaksTeam2Select.value; // Save current value before clearing
            let team2Options = ['<option value="">Select Team 2</option>'];

            // Add Big 6 option if Team 1 is selected and we're in Premier League
            if (elements.teamStreaksTeam1Select.value && state.selectedLeague === 'premier-league') {
                team2Options.push('<option value="BIG_6">Big 6</option>');
            }

            // Add all other teams
            team2Options = team2Options.concat(leagueTeams.map(team => `<option value="${team}">${team}</option>`));

            elements.teamStreaksTeam2Select.innerHTML = team2Options.join('');

            // Restore the current selection if it's still valid
            if (currentTeam2) {
                elements.teamStreaksTeam2Select.value = currentTeam2;
            }
        }

        // Calculate and display team streaks
        function calculateTeamStreaks() {
            const team1 = elements.teamStreaksTeam1Select.value;
            const team2 = elements.teamStreaksTeam2Select.value;
            const status = elements.teamStreaksStatusSelect.value;
            const location = elements.teamStreaksLocationSelect.value;
            const streakType = elements.teamStreaksTypeSelect.value;
            
            if (!team1) {
                elements.teamStreaksResults.classList.add('hidden');
                return;
            }
            
            // Handle different status modes
            if (status === 'active') {
                calculateActiveStreaks(team1, team2, location, streakType);
            } else if (status === 'historic') {
                calculateHistoricStreaks(team1, team2, location, streakType);
            }
        }
        
        // Calculate active streaks (original logic)
        function calculateActiveStreaks(team1, team2, location, streakType) {

            // Get league mapping
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };

            // Filter matches by league
            let matches = state.data.filter(row => row.Div === leagueMapping[state.selectedLeague]);

            // Filter by teams
            if (team2) {
                if (team2 === 'BIG_6' && state.teamStreaksBig6Opponents) {
                    // Big 6 mode: filter for matches where Team 1 played against any Big 6 opponent
                    matches = matches.filter(row =>
                        (row.HomeTeam === team1 && state.teamStreaksBig6Opponents.includes(row.AwayTeam)) ||
                        (row.AwayTeam === team1 && state.teamStreaksBig6Opponents.includes(row.HomeTeam))
                    );
                } else {
                    // Regular head-to-head matches only
                    matches = matches.filter(row =>
                        (row.HomeTeam === team1 && row.AwayTeam === team2) ||
                        (row.HomeTeam === team2 && row.AwayTeam === team1)
                    );
                }
            } else {
                // One team selected - matches against all opponents
                matches = matches.filter(row => 
                    row.HomeTeam === team1 || row.AwayTeam === team1
                );
            }

            // Filter by location
            if (location === 'home') {
                matches = matches.filter(row => row.HomeTeam === team1);
            } else if (location === 'away') {
                matches = matches.filter(row => row.AwayTeam === team1);
            }
            // 'both' requires no additional filtering

            // Sort matches by date (most recent first)
            matches.sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj));

            // Calculate streak based on type
            const streak = calculateStreak(matches, team1, streakType);
            
            // Display results
            displayStreakResults(streak, team1, team2, streakType, location);
        }
        
        // Calculate historic streaks - find all streaks of 3+ games throughout history
        function calculateHistoricStreaks(team1, team2, location, streakType) {
            // Check if data is loaded
            if (!state.data || state.data.length === 0) {
                elements.teamStreaksResults.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-600">Loading data...</p>
                    </div>
                `;
                elements.teamStreaksResults.classList.remove('hidden');
                return;
            }
            
            // Reset sort config when parameters change (except when called from sort handler)
            const currentParams = `${team1}-${team2}-${location}-${streakType}`;
            if (!state.lastHistoricStreaksParams || state.lastHistoricStreaksParams !== currentParams) {
                state.historicStreaksSortConfig = { key: null, direction: null };
                state.lastHistoricStreaksParams = currentParams;
            }
            
            // Get league mapping
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };

            // Filter matches by league
            let matches = state.data.filter(row => row.Div === leagueMapping[state.selectedLeague]);
            
            // Filter by teams
            if (team2) {
                if (team2 === 'BIG_6' && state.teamStreaksBig6Opponents) {
                    // Big 6 mode: filter for matches where Team 1 played against any Big 6 opponent
                    matches = matches.filter(row =>
                        (row.HomeTeam === team1 && state.teamStreaksBig6Opponents.includes(row.AwayTeam)) ||
                        (row.AwayTeam === team1 && state.teamStreaksBig6Opponents.includes(row.HomeTeam))
                    );
                } else {
                    // Regular head-to-head matches only
                    matches = matches.filter(row =>
                        (row.HomeTeam === team1 && row.AwayTeam === team2) ||
                        (row.HomeTeam === team2 && row.AwayTeam === team1)
                    );
                }
            } else {
                // One team selected - matches against all opponents
                matches = matches.filter(row => 
                    row.HomeTeam === team1 || row.AwayTeam === team1
                );
            }

            // Filter by location
            if (location === 'home') {
                matches = matches.filter(row => row.HomeTeam === team1);
            } else if (location === 'away') {
                matches = matches.filter(row => row.AwayTeam === team1);
            }

            // Sort matches by date (oldest first for historic analysis)
            matches.sort((a, b) => new Date(a.dateObj) - new Date(b.dateObj));

            // Find all historic streaks
            const allStreaks = findAllHistoricStreaks(matches, team1, streakType);
            
            // Filter streaks to only include those with 3+ games
            const significantStreaks = allStreaks.filter(streak => streak.count >= 3);
            
            // Display results
            displayHistoricStreaksResults(significantStreaks, team1, team2, streakType, location);
        }
        
        // Find all historic streaks throughout the data
        function findAllHistoricStreaks(matches, team, streakType) {
            if (matches.length === 0) return [];
            
            const allStreaks = [];
            let currentStreak = [];
            
            for (const match of matches) {
                const isHome = match.HomeTeam === team;
                const teamScore = isHome ? parseInt(match.FTHG) || 0 : parseInt(match.FTAG) || 0;
                const opponentScore = isHome ? parseInt(match.FTAG) || 0 : parseInt(match.FTHG) || 0;
                
                let result;
                if (teamScore > opponentScore) {
                    result = 'win';
                } else if (teamScore === opponentScore) {
                    result = 'draw';
                } else {
                    result = 'loss';
                }

                // Check if this match continues the current streak
                const continuesStreak = checkStreakContinuation(result, streakType);
                
                if (continuesStreak) {
                    currentStreak.push({
                        ...match,
                        result: result,
                        teamScore: teamScore,
                        opponentScore: opponentScore,
                        isHome: isHome
                    });
                } else {
                    // Current streak ends, save it if it exists
                    if (currentStreak.length > 0) {
                        const startDate = currentStreak[0].dateObj;
                        const endDate = match.dateObj; // Use the match that broke the streak as the end date
                        const lengthInDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                        
                        allStreaks.push({
                            matches: [...currentStreak],
                            count: currentStreak.length,
                            startDate: startDate,
                            endDate: endDate,
                            lengthInDays: lengthInDays,
                            streakType: streakType
                        });
                    }
                    
                    // Reset current streak since this match doesn't continue it
                    currentStreak = [];
                }
            }
            
            // Don't forget the last streak if it exists
            if (currentStreak.length > 0) {
                const startDate = currentStreak[0].dateObj;
                const endDate = currentStreak[currentStreak.length - 1].dateObj;
                const lengthInDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                
                allStreaks.push({
                    matches: [...currentStreak],
                    count: currentStreak.length,
                    startDate: startDate,
                    endDate: endDate,
                    lengthInDays: lengthInDays,
                    streakType: streakType
                });
            }
            
            return allStreaks;
        }
        
        // Get sort icon for historic streaks columns
        function getSortIcon(columnKey) {
            if (state.historicStreaksSortConfig.key !== columnKey) {
                return ' ‚ÜïÔ∏è'; // Up-down arrows when not sorted (sortable indicator)
            }
            
            switch (state.historicStreaksSortConfig.direction) {
                case 'desc': return ' ‚Üì';
                case 'asc': return ' ‚Üë';
                default: return ' ‚ÜïÔ∏è';
            }
        }
        
        // Handle historic streaks table sorting
        function handleHistoricStreaksSort(columnKey) {
            // Determine next sort direction (tri-state: desc ‚Üí asc ‚Üí reset)
            let nextDirection;
            if (state.historicStreaksSortConfig.key !== columnKey || state.historicStreaksSortConfig.direction === null) {
                nextDirection = 'desc'; // First click: descending (largest/most recent first)
            } else if (state.historicStreaksSortConfig.direction === 'desc') {
                nextDirection = 'asc';  // Second click: ascending (smallest/oldest first)
            } else {
                nextDirection = null;   // Third click: reset to original order
            }
            
            // Update sort config
            state.historicStreaksSortConfig.key = nextDirection ? columnKey : null;
            state.historicStreaksSortConfig.direction = nextDirection;
            
            // Re-trigger the calculation to refresh the display with new sorting
            calculateTeamStreaks();
        }
        
        // Display historic streaks results in table format
        function displayHistoricStreaksResults(streaks, team1, team2, streakType, location) {
            if (streaks.length === 0) {
                elements.teamStreaksResults.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-600">No historic ${streakType.replace('-', ' ')} streaks of 3+ games found for the selected criteria.</p>
                    </div>
                `;
                elements.teamStreaksResults.classList.remove('hidden');
                return;
            }

            // Apply custom sorting if requested, otherwise use default sorting
            if (state.historicStreaksSortConfig.key && state.historicStreaksSortConfig.direction) {
                const sortKey = state.historicStreaksSortConfig.key;
                const sortDirection = state.historicStreaksSortConfig.direction;
                
                streaks.sort((a, b) => {
                    let aVal = a[sortKey];
                    let bVal = b[sortKey];
                    
                    // Handle date sorting
                    if (sortKey === 'startDate' || sortKey === 'endDate') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    // Sort based on direction
                    if (sortDirection === 'desc') {
                        return bVal > aVal ? 1 : bVal < aVal ? -1 : 0;
                    } else {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    }
                });
            } else {
                // Default sorting: by count (longest first), then by end date (most recent first)
                streaks.sort((a, b) => {
                    if (b.count !== a.count) return b.count - a.count;
                    return new Date(b.endDate) - new Date(a.endDate);
                });
            }

            // Create title
            const streakName = getStreakDisplayName(streakType);
            const locationText = location === 'both' ? '' : ` (${location.charAt(0).toUpperCase() + location.slice(1)})`;
            const team1Color = getTeamColor(team1, state.selectedLeague);
            const team2Color = team2 === 'BIG_6' ? '#1e3a8a' : (team2 ? getTeamColor(team2, state.selectedLeague) : null);

            let title;
            if (team2) {
                const team2DisplayName = getTeamDisplayName(team2);
                title = `Historic ${streakName}s${locationText}: <span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span> vs <span style="color: ${team2Color || '#374151'}; font-weight: bold;">${team2DisplayName}</span>`;
            } else {
                title = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>'s Historic ${streakName}s${locationText}`;
            }

            // Create table headers based on mode (single team vs head-to-head)
            let tableHeaders;
            if (team2) {
                // Head-to-head mode
                tableHeaders = `
                    <th class="text-center">Team 1</th>
                    <th class="text-center">Team 2</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('startDate')">Start Date ${getSortIcon('startDate')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('endDate')">End Date ${getSortIcon('endDate')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('count')">Count ${getSortIcon('count')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('lengthInDays')">Length (Days) ${getSortIcon('lengthInDays')}</th>
                `;
            } else {
                // Single team mode - adjust header based on location
                let teamColumnHeader;
                if (location === 'home') {
                    teamColumnHeader = 'Home Team';
                } else if (location === 'away') {
                    teamColumnHeader = 'Away Team';
                } else {
                    teamColumnHeader = 'Team';
                }
                
                tableHeaders = `
                    <th class="text-center">${teamColumnHeader}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('startDate')">Start Date ${getSortIcon('startDate')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('endDate')">End Date ${getSortIcon('endDate')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('count')">Count ${getSortIcon('count')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('lengthInDays')">Length (Days) ${getSortIcon('lengthInDays')}</th>
                `;
            }

            // Create table rows
            const tableRows = streaks.map(streak => {
                const startDateStr = streak.startDate.toLocaleDateString('en-US');
                const endDateStr = streak.endDate.toLocaleDateString('en-US');
                
                if (team2) {
                    // Head-to-head mode
                    const team1Logo = getTeamLogoUrl(team1, state.selectedLeague);
                    const team2Logo = team2 === 'BIG_6' ? null : getTeamLogoUrl(team2, state.selectedLeague);
                    const team2DisplayName = getTeamDisplayName(team2);

                    return `
                        <tr>
                            <td class="text-center">
                                <div class="flex items-center justify-center">
                                    ${team1Logo ? `<img src="${team1Logo}" alt="${team1}" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                    <span class="team1-highlight" style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="flex items-center justify-center">
                                    ${team2Logo ? `<img src="${team2Logo}" alt="${team2DisplayName}" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                    <span class="team2-highlight" style="color: ${team2Color || '#374151'}; font-weight: bold;">${team2DisplayName}</span>
                                </div>
                            </td>
                            <td class="text-center">${startDateStr}</td>
                            <td class="text-center">${endDateStr}</td>
                            <td class="text-center font-bold">${streak.count}</td>
                            <td class="text-center">${streak.lengthInDays}</td>
                        </tr>
                    `;
                } else {
                    // Single team mode - show team name with logo
                    const teamName = team1;
                    const teamLogo = getTeamLogoUrl(teamName, state.selectedLeague);
                    const teamColor = getTeamColor(teamName, state.selectedLeague);
                    
                    return `
                        <tr>
                            <td class="text-center">
                                <div class="flex items-center justify-center">
                                    ${teamLogo ? `<img src="${teamLogo}" alt="${teamName}" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                    <span class="team1-highlight" style="color: ${teamColor || '#374151'}; font-weight: bold;">${teamName}</span>
                                </div>
                            </td>
                            <td class="text-center">${startDateStr}</td>
                            <td class="text-center">${endDateStr}</td>
                            <td class="text-center font-bold">${streak.count}</td>
                            <td class="text-center">${streak.lengthInDays}</td>
                        </tr>
                    `;
                }
            }).join('');

            const tableHTML = `
                <div class="league-table">
                    <div class="text-center py-4 bg-white border-b">
                        <h2 class="text-xl font-semibold text-gray-700 mb-1">${title}</h2>
                        <p class="text-sm text-gray-600">${streaks.length} streak${streaks.length === 1 ? '' : 's'} of 3+ games found</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                ${tableHeaders}
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;

            elements.teamStreaksResults.innerHTML = tableHTML;
            elements.teamStreaksResults.classList.remove('hidden');
        }

        // Calculate streak based on type and team
        function calculateStreak(matches, team, streakType) {
            if (matches.length === 0) return [];

            const streak = [];
            
            for (const match of matches) {
                const isHome = match.HomeTeam === team;
                const teamScore = isHome ? parseInt(match.FTHG) || 0 : parseInt(match.FTAG) || 0;
                const opponentScore = isHome ? parseInt(match.FTAG) || 0 : parseInt(match.FTHG) || 0;
                
                let result;
                if (teamScore > opponentScore) {
                    result = 'win';
                } else if (teamScore === opponentScore) {
                    result = 'draw';
                } else {
                    result = 'loss';
                }

                // Check if this match continues the streak
                const continuesStreak = checkStreakContinuation(result, streakType);
                
                if (continuesStreak) {
                    streak.push({
                        ...match,
                        result: result,
                        teamScore: teamScore,
                        opponentScore: opponentScore,
                        isHome: isHome
                    });
                } else {
                    // Streak ends here
                    break;
                }
            }

            return streak;
        }

        // Check if a result continues the current streak type
        function checkStreakContinuation(result, streakType) {
            switch (streakType) {
                case 'winning':
                    return result === 'win';
                case 'unbeaten':
                    return result === 'win' || result === 'draw';
                case 'draw':
                    return result === 'draw';
                case 'winless':
                    return result === 'draw' || result === 'loss';
                case 'losing':
                    return result === 'loss';
                default:
                    return false;
            }
        }

        // Display streak results in table format
        function displayStreakResults(streak, team1, team2, streakType, location) {
            if (streak.length === 0) {
                elements.teamStreaksResults.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-600">No current ${streakType.replace('-', ' ')} streak found for the selected criteria.</p>
                    </div>
                `;
                elements.teamStreaksResults.classList.remove('hidden');
                return;
            }

            // Find the opposite result match
            const oppositeMatch = findOppositeResultMatch(team1, team2, streakType, location);

            // Create title with team colors
            const streakLength = streak.length;
            const streakName = getStreakDisplayName(streakType);
            const locationText = location === 'both' ? '' : ` (${location.charAt(0).toUpperCase() + location.slice(1)})`;
            
            // Get team colors
            const team1Color = getTeamColor(team1, state.selectedLeague);
            const team2Color = team2 === 'BIG_6' ? '#1e3a8a' : (team2 ? getTeamColor(team2, state.selectedLeague) : null);

            let title;
            if (team2) {
                // Two-team mode: Both teams with their colors
                const team2DisplayName = getTeamDisplayName(team2);
                title = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>'s Current ${streakName}${locationText} vs <span style="color: ${team2Color || '#374151'}; font-weight: bold;">${team2DisplayName}</span>: ${streakLength} ${streakLength === 1 ? 'match' : 'matches'}`;
            } else {
                // Single-team mode: Just Team 1 with color
                title = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>'s Current ${streakName}${locationText}: ${streakLength} ${streakLength === 1 ? 'match' : 'matches'}`;
            }

            // Calculate days since streak started (oldest match in streak)
            const streakStartDate = streak[streak.length - 1].dateObj;
            const daysSinceStreakStart = Math.floor((new Date() - streakStartDate) / (1000 * 60 * 60 * 24));

            // Create main streak table
            let tableHTML = `
                <div class="league-table mb-4">
                    <div class="text-center py-4 bg-white border-b">
                        <h2 class="text-xl font-semibold text-gray-700 mb-1">${title}</h2>
                        <p class="text-sm text-gray-600">Most recent matches first</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th class="text-center cursor-pointer">Date</th>
                                <th class="text-center cursor-pointer">Home Team</th>
                                <th class="text-center cursor-pointer">Home Score</th>
                                <th class="text-center cursor-pointer">Away Team</th>
                                <th class="text-center cursor-pointer">Away Score</th>
                                <th class="text-center cursor-pointer">Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${streak.map(match => createStreakTableRow(match, team1)).join('')}
                        </tbody>
                    </table>
                </div>
                <p class="text-center text-sm text-gray-600 mb-8">This streak started: ${daysSinceStreakStart} days ago</p>
            `;

            // Add opposite result table if found
            if (oppositeMatch) {
                const oppositeResultName = getOppositeResultDisplayName(streakType);
                
                // Create opposite title with team colors
                let oppositeTitle;
                if (team2) {
                    // Two-team mode: Both teams with their colors
                    oppositeTitle = `Last ${oppositeResultName} Result${locationText} (<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span> vs <span style="color: ${team2Color || '#374151'}; font-weight: bold;">${getTeamDisplayName(team2)}</span>)`;
                } else {
                    // Single-team mode: Just Team 1 with color
                    oppositeTitle = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>'s Last ${oppositeResultName} Result${locationText}`;
                }
                
                // Calculate days since opposite result
                const daysSinceOpposite = Math.floor((new Date() - oppositeMatch.dateObj) / (1000 * 60 * 60 * 24));

                tableHTML += `
                    <div class="league-table mb-4">
                        <div class="text-center py-4 bg-gray-50 border-b">
                            <h2 class="text-xl font-semibold text-gray-700 mb-1">${oppositeTitle}</h2>
                            <p class="text-sm text-gray-600">The match that ended the previous streak</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th class="text-center cursor-pointer">Date</th>
                                    <th class="text-center cursor-pointer">Home Team</th>
                                    <th class="text-center cursor-pointer">Home Score</th>
                                    <th class="text-center cursor-pointer">Away Team</th>
                                    <th class="text-center cursor-pointer">Away Score</th>
                                    <th class="text-center cursor-pointer">Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${createStreakTableRow(oppositeMatch, team1)}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-center text-sm text-gray-600">The last time the opposite happened was: ${daysSinceOpposite} days ago</p>
                `;
            } else {
                tableHTML += `<p class="text-center text-sm text-gray-600">No previous opposite result found in available data</p>`;
            }

            elements.teamStreaksResults.innerHTML = tableHTML;
            elements.teamStreaksResults.classList.remove('hidden');
        }

        // Find the specific match that ended the current streak
        function findStreakEndingMatch(streak, team1, team2, streakType, location) {
            if (streak.length === 0) return null;

            // We need to re-run the same filtering logic that was used to build the streak
            // to find the match that would have broken the streak

            // Get league mapping
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };

            // Filter matches by league
            let matches = state.data.filter(row => row.Div === leagueMapping[state.selectedLeague]);

            // Filter by teams (same logic as in calculateActiveStreaks)
            if (team2) {
                if (team2 === 'BIG_6') {
                    // Big 6 filtering logic
                    const big6Opponents = state.teamStreaksBig6Opponents || [];
                    matches = matches.filter(row => {
                        const homeTeam = row.HomeTeam;
                        const awayTeam = row.AwayTeam;

                        return (homeTeam === team1 && big6Opponents.includes(awayTeam)) ||
                               (awayTeam === team1 && big6Opponents.includes(homeTeam));
                    });
                } else {
                    matches = matches.filter(row =>
                        (row.HomeTeam === team1 && row.AwayTeam === team2) ||
                        (row.HomeTeam === team2 && row.AwayTeam === team1)
                    );
                }
            } else {
                matches = matches.filter(row =>
                    row.HomeTeam === team1 || row.AwayTeam === team1
                );
            }

            // Filter by location (same logic as in calculateActiveStreaks)
            if (location === 'home') {
                matches = matches.filter(row => row.HomeTeam === team1);
            } else if (location === 'away') {
                matches = matches.filter(row => row.AwayTeam === team1);
            }

            // Sort by date (most recent first) - same as in calculateActiveStreaks
            matches.sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj));

            // Now iterate through matches just like calculateStreak does
            // to find the match that would break the streak
            let streakMatchCount = 0;

            for (const match of matches) {
                const isHome = match.HomeTeam === team1;
                const teamScore = isHome ? parseInt(match.FTHG) || 0 : parseInt(match.FTAG) || 0;
                const opponentScore = isHome ? parseInt(match.FTAG) || 0 : parseInt(match.FTHG) || 0;

                let result;
                if (teamScore > opponentScore) {
                    result = 'win';
                } else if (teamScore === opponentScore) {
                    result = 'draw';
                } else {
                    result = 'loss';
                }

                // Check if this match continues the streak
                const continuesStreak = checkStreakContinuation(result, streakType);

                if (continuesStreak) {
                    streakMatchCount++;
                } else {
                    // This is the match that breaks/broke the streak
                    // But only if we've seen the same number of streak matches as in our current streak
                    if (streakMatchCount === streak.length) {
                        return match;
                    } else {
                        // Reset and continue looking for the current streak
                        streakMatchCount = 0;
                    }
                }
            }

            return null;
        }

        // Find the match where the opposite result occurred
        function findOppositeResultMatch(team1, team2, streakType, location) {
            // Get league mapping
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };

            // Filter matches by league
            let matches = state.data.filter(row => row.Div === leagueMapping[state.selectedLeague]);
            
            // Filter by teams
            if (team2) {
                if (team2 === 'BIG_6') {
                    // Big 6 filtering logic
                    const big6Opponents = state.teamStreaksBig6Opponents || [];
                    matches = matches.filter(row => {
                        const homeTeam = row.HomeTeam;
                        const awayTeam = row.AwayTeam;

                        return (homeTeam === team1 && big6Opponents.includes(awayTeam)) ||
                               (awayTeam === team1 && big6Opponents.includes(homeTeam));
                    });
                } else {
                    matches = matches.filter(row =>
                        (row.HomeTeam === team1 && row.AwayTeam === team2) ||
                        (row.HomeTeam === team2 && row.AwayTeam === team1)
                    );
                }
            } else {
                matches = matches.filter(row =>
                    row.HomeTeam === team1 || row.AwayTeam === team1
                );
            }

            // Filter by location
            if (location === 'home') {
                matches = matches.filter(row => row.HomeTeam === team1);
            } else if (location === 'away') {
                matches = matches.filter(row => row.AwayTeam === team1);
            }

            // Sort matches by date (most recent first)
            matches.sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj));

            // Find the first match that doesn't continue the current streak
            for (const match of matches) {
                const isHome = match.HomeTeam === team1;
                const teamScore = isHome ? parseInt(match.FTHG) || 0 : parseInt(match.FTAG) || 0;
                const opponentScore = isHome ? parseInt(match.FTAG) || 0 : parseInt(match.FTHG) || 0;
                
                let result;
                if (teamScore > opponentScore) {
                    result = 'win';
                } else if (teamScore === opponentScore) {
                    result = 'draw';
                } else {
                    result = 'loss';
                }

                // Check if this is an opposite result
                const isOppositeResult = checkOppositeResult(result, streakType);
                
                if (isOppositeResult) {
                    return match;
                }
            }

            return null;
        }

        // Check if a result is opposite to the current streak type
        function checkOppositeResult(result, streakType) {
            switch (streakType) {
                case 'winning':
                    return result === 'draw' || result === 'loss'; // Non-win
                case 'unbeaten':
                    return result === 'loss'; // Loss
                case 'draw':
                    return result === 'win' || result === 'loss'; // Non-draw
                case 'winless':
                    return result === 'win'; // Win
                case 'losing':
                    return result === 'draw' || result === 'win'; // Non-loss
                default:
                    return false;
            }
        }

        // Get display name for opposite result
        function getOppositeResultDisplayName(streakType) {
            switch (streakType) {
                case 'winning': return 'Non-Win (Draw/Loss)';
                case 'unbeaten': return 'Loss';
                case 'draw': return 'Non-Draw (Win/Loss)';
                case 'winless': return 'Win';
                case 'losing': return 'Non-Loss (Draw/Win)';
                default: return 'Opposite';
            }
        }

        // Get display name for streak type
        function getStreakDisplayName(streakType) {
            switch (streakType) {
                case 'winning': return 'Winning Streak';
                case 'unbeaten': return 'Unbeaten Streak';
                case 'draw': return 'Draw Streak';
                case 'winless': return 'Winless Streak';
                case 'losing': return 'Losing Streak';
                default: return 'Streak';
            }
        }

        // Create table row for streak display (similar to Head-to-Head format)
        function createStreakTableRow(match, focusTeam) {
            const homeScore = parseInt(match.FTHG) || 0;
            const awayScore = parseInt(match.FTAG) || 0;
            
            // Get team colors and logos
            const homeTeamColor = getTeamColor(match.HomeTeam, state.selectedLeague);
            const awayTeamColor = getTeamColor(match.AwayTeam, state.selectedLeague);
            const homeLogoUrl = getTeamLogoUrl(match.HomeTeam, state.selectedLeague);
            const awayLogoUrl = getTeamLogoUrl(match.AwayTeam, state.selectedLeague);
            
            // Determine winner and highlighting
            let homeScoreClass = '';
            let awayScoreClass = '';
            let resultStyle = '';
            let winnerTeam = '';
            
            if (homeScore > awayScore) {
                winnerTeam = match.HomeTeam;
                homeScoreClass = 'font-bold win-score';
                awayScoreClass = 'text-red-600 font-bold';
                resultStyle = homeTeamColor ? 
                    `color: ${homeTeamColor} !important; font-weight: bold;` : 
                    'color: #059669 !important; font-weight: bold;';
            } else if (awayScore > homeScore) {
                winnerTeam = match.AwayTeam;
                homeScoreClass = 'text-red-600 font-bold';
                awayScoreClass = 'font-bold win-score';
                resultStyle = awayTeamColor ? 
                    `color: ${awayTeamColor} !important; font-weight: bold;` : 
                    'color: #059669 !important; font-weight: bold;';
            } else {
                winnerTeam = 'Draw';
                homeScoreClass = 'text-gray-400 font-bold draw-score';
                awayScoreClass = 'text-gray-400 font-bold draw-score';
                resultStyle = 'color: #9ca3af !important; font-weight: bold;';
            }

            // Get selected teams for highlighting
            const team1 = elements.teamStreaksTeam1Select.value;
            const team2 = elements.teamStreaksTeam2Select.value;

            // Team highlighting based on selected teams (same as Head-to-Head)
            const isHomeTeam1 = match.HomeTeam === team1;
            const isHomeTeam2 = team2 && match.HomeTeam === team2;
            const isAwayTeam1 = match.AwayTeam === team1;
            const isAwayTeam2 = team2 && match.AwayTeam === team2;
            
            const homeTeamClass = isHomeTeam1 ? 'team1-highlight' : 
                                isHomeTeam2 ? 'team2-highlight' : '';
            const awayTeamClass = isAwayTeam1 ? 'team1-highlight' : 
                                isAwayTeam2 ? 'team2-highlight' : '';
            
            // Winner logo for result column
            const winnerLogoUrl = winnerTeam !== 'Draw' ? getTeamLogoUrl(winnerTeam, state.selectedLeague) : null;
            
            // Result highlighting for winner (if it's one of the selected teams)
            let resultClass = '';
            if (winnerTeam !== 'Draw') {
                if (winnerTeam === team1) {
                    resultClass = 'team1-highlight';
                } else if (team2 && winnerTeam === team2) {
                    resultClass = 'team2-highlight';
                }
            }
            
            // Team styling
            const homeTeamStyle = homeTeamColor ? `color: ${homeTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
            const awayTeamStyle = awayTeamColor ? `color: ${awayTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
            
            return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="text-center text-sm">${match.dateObj.toLocaleDateString('en-US')}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${homeLogoUrl ? `<img src="${homeLogoUrl}" alt="${match.HomeTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${homeTeamClass}" style="${homeTeamStyle}">${match.HomeTeam}</span>
                        </div>
                    </td>
                    <td class="text-center text-lg ${homeScoreClass}" >${homeScore}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${awayLogoUrl ? `<img src="${awayLogoUrl}" alt="${match.AwayTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${awayTeamClass}" style="${awayTeamStyle}">${match.AwayTeam}</span>
                        </div>
                    </td>
                    <td class="text-center text-lg ${awayScoreClass}" >${awayScore}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${winnerLogoUrl ? `<img src="${winnerLogoUrl}" alt="${winnerTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${resultClass}" style="${resultStyle}">${winnerTeam}</span>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Initialize the application
        function init() {
            setupEventListeners();
            createLeagueButtons();
            createTeamSeasonsLeagueButtons();
            updateUI();
            // Auto-load data on page load
            loadGistData();
        }

        // Decode base64 encoded URL with backward compatibility for double encoding
        function decodeSingleBase64Url(encodedUrl) {
            try {
                // Validate input
                if (!encodedUrl || typeof encodedUrl !== 'string') {
                    console.warn('Invalid encoded URL provided');
                    return null;
                }
                
                // Clean the input
                const cleanedInput = encodedUrl.trim().replace(/\s/g, '');
                
                // Try single decode first
                let decoded;
                try {
                    decoded = atob(cleanedInput);
                } catch (atobError) {
                    console.error('Base64 decode failed:', atobError.message);
                    return null;
                }
                
                // Check if the result is a valid URL (single encoding)
                if (decoded && decoded.startsWith('https://gist.githubusercontent.com')) {
                    // Successfully decoded single base64 URL
                    return decoded;
                }
                
                // If not a valid URL, try double decode (backward compatibility)
                try {
                    const doubleDecoded = atob(decoded);
                    if (doubleDecoded && doubleDecoded.startsWith('https://gist.githubusercontent.com')) {
                        // Successfully decoded double base64 URL
                        return doubleDecoded;
                    }
                } catch (error) {
                    // Ignore double decode errors
                }
                
                console.warn('Could not decode URL as single or double base64:', encodedUrl.substring(0, 50) + '...');
                return null;
                
            } catch (error) {
                console.error('Error in decodeSingleBase64Url:', error);
                console.error('Stack trace:', error.stack);
                return null;
            }
        }

        // Mobile device detection
        function isMobileDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const screenWidth = window.innerWidth;
            
            // Check for explicit mobile indicators (excluding just 'chrome' to avoid false positives)
            const mobileKeywords = ['android', 'iphone', 'ipad', 'ipod', 'tablet', 'phone', 'mobile'];
            const hasMobileUA = mobileKeywords.some(keyword => userAgent.includes(keyword));
            
            // Check for small screen size (less than 768px typically indicates mobile/tablet)
            const hasSmallScreen = screenWidth < 768;
            
            // Touch device detection (more accurate for mobile)
            const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            // Only consider mobile if we have explicit mobile UA AND (small screen OR touch)
            return hasMobileUA && (hasSmallScreen || hasTouchScreen);
        }
        
        // Load data from GitHub Gists - now uses league-specific loading for all devices
        async function loadGistData() {
            // Using league-specific loading for optimal performance
            await loadLeagueDataForDevice(state.selectedLeague);
        }
        
        // Universal league-specific loading for all devices
        async function loadLeagueDataForDevice(leagueId) {
            // Loading data for league
            
            // Check if already loaded
            if (state.loadedLeagues && state.loadedLeagues.has(leagueId)) {
                // League already loaded, filtering existing data
                filterDataForCurrentLeague(leagueId);
                return;
            }
            
            // Initialize loadedLeagues if not exists
            if (!state.loadedLeagues) {
                state.loadedLeagues = new Set();
            }
            
            // Initialize allLeagueData to store all data if not exists
            if (!state.allLeagueData) {
                state.allLeagueData = [];
            }
            
            // Prevent double loading
            if (state.currentlyLoadingLeague === leagueId) {
                // League already loading, please wait
                return;
            }
            
            state.currentlyLoadingLeague = leagueId;
            state.error = '';
            
            // Show loading indicator
            const leagueName = getLeagueName(leagueId);
            state.error = `‚öΩ Loading ${leagueName} data...`;
            updateUI();
            
            try {
                // Load ALL gist URLs since each contains data for all leagues
                const gistUrls = GIST_URLS;
                
                // Fetching files (contains all leagues)
                const allData = [];
                
                for (let i = 0; i < gistUrls.length; i++) {
                    const encodedUrl = gistUrls[i];
                    
                    try {
                        const url = decodeSingleBase64Url(encodedUrl);
                        if (!url) {
                            console.warn(`Skipping invalid URL at index ${i}`);
                            continue;
                        }
                        
                        // Check for obviously malformed URLs
                        if (!url.startsWith('http')) {
                            console.warn(`Skipping malformed URL at index ${i}: ${url.substring(0, 50)}...`);
                            continue;
                        }
                        
                        // Fetching URL
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000);
                        
                        const response = await fetch(url, { 
                            signal: controller.signal,
                            headers: { 'Accept': 'text/csv,text/plain,*/*' }
                        });
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const text = await response.text();
                        if (!text || text.length === 0) {
                            throw new Error('Empty response from server');
                        }
                        
                        const parsed = Papa.parse(text, { 
                            header: true, 
                            dynamicTyping: false,
                            skipEmptyLines: true,
                            transformHeader: (header) => header.trim().replace(/\r/g, ''),
                            transform: (value) => typeof value === 'string' ? value.trim().replace(/\r/g, '') : value
                        });
                        
                        if (parsed.errors && parsed.errors.length > 0) {
                            console.warn('CSV parsing errors:', parsed.errors);
                        }
                        
                        if (parsed.data && parsed.data.length > 0) {
                            // Successfully parsed rows
                            allData.push(...parsed.data);
                        }
                        
                        // Update progress
                        const progress = Math.round(((i + 1) / gistUrls.length) * 100);
                        state.error = `‚öΩ Loading data... ${progress}%`;
                        updateUI();
                        
                        // Small delay to keep UI responsive
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                    } catch (fileError) {
                        console.warn(`Failed to load file ${i}:`, fileError.message);
                    }
                }
                
                // Process all the raw data
                // Processing all league data
                const cleanedData = processRawData(allData);
                
                if (cleanedData.length === 0) {
                    throw new Error(`No valid match data found`);
                }
                
                // Store all data for future league switches
                state.allLeagueData = cleanedData;
                
                // Mark all leagues as loaded since we loaded everything
                state.loadedLeagues.add('serie-a');
                state.loadedLeagues.add('premier-league');
                state.loadedLeagues.add('la-liga');
                state.loadedLeagues.add('bundesliga');
                state.loadedLeagues.add('ligue-1');
                
                state.currentlyLoadingLeague = null;
                state.error = '';
                
                // Filter data for the requested league
                filterDataForCurrentLeague(leagueId);
                
                // All data loaded successfully
                updateLastDataUpdate();
            } catch (error) {
                console.error(`Error loading data:`, error);
                state.error = `Failed to load data: ${error.message}`;
                state.currentlyLoadingLeague = null;
                updateUI();
            }
        }
        
        // Get human-readable league name
        function getLeagueName(leagueId) {
            const leagueMap = {
                'serie-a': 'Serie A',
                'premier-league': 'Premier League',
                'la-liga': 'La Liga',
                'bundesliga': 'Bundesliga',
                'ligue-1': 'Ligue 1'
            };
            return leagueMap[leagueId] || leagueId;
        }
        
        // Filter existing data for current league (when switching between loaded leagues)
        function filterDataForCurrentLeague(leagueId) {
            if (!state.allLeagueData || state.allLeagueData.length === 0) return;
            
            const leagueCode = LEAGUE_CODES[leagueId];
            if (!leagueCode) {
                console.warn(`Unknown league ID: ${leagueId}`);
                return;
            }
            
            // Filter data for the specific league
            const filteredData = state.allLeagueData.filter(row => row.Div === leagueCode);
            
            // Filtered matches for league
            
            // Update state with filtered data
            state.data = filteredData;
            
            // Update teams list for this league
            const allTeams = [...new Set([
                ...filteredData.map(row => row.HomeTeam),
                ...filteredData.map(row => row.AwayTeam)
            ])].filter(team => team && team.length > 1).sort();
            
            state.teams = allTeams;
            
            // Update date range for this league
            if (filteredData.length > 0) {
                const dates = filteredData.map(row => row.dateObj);
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                state.dateFrom = minDate.toISOString().split('T')[0];
                state.dateTo = maxDate.toISOString().split('T')[0];
            }
            
            // Update the UI with filtered data
            updateUI();
            updateTeamSelects();
            updateTeamSeasonsTeamSelect();
            updateSeasonOptions();
            updateLastDataUpdate();
            updateTable();
        }
        
        // Chunked loading for desktop browsers (prevents stack overflow)
        async function loadGistDataChunked() {
            const gistUrls = GIST_URLS;
            
            state.error = '';
            // Starting chunked data load

            try {
                const allData = [];
                let loadedGists = 0;
                
                // Process files in smaller batches to prevent stack overflow
                const batchSize = 5; // Process 5 files at a time
                
                for (let batchStart = 0; batchStart < gistUrls.length; batchStart += batchSize) {
                    const batchEnd = Math.min(batchStart + batchSize, gistUrls.length);
                    // Processing batch
                    
                    // Process batch of files
                    for (let i = batchStart; i < batchEnd; i++) {
                    const encodedUrl = gistUrls[i];
                    // Processing URL
                    
                    const url = decodeSingleBase64Url(encodedUrl);
                    
                    // Skip if URL decoding failed
                    if (!url) {
                        console.warn(`Skipping invalid URL at index ${i}`);
                        continue;
                    }
                    
                    try {
                        // Fetching URL
                        
                        // Add timeout to fetch
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                        
                        const response = await fetch(url, { 
                            signal: controller.signal,
                            headers: {
                                'Accept': 'text/csv,text/plain,*/*'
                            }
                        });
                        clearTimeout(timeoutId);
                        if (!response.ok) {
                            if (response.status === 404) {
                                console.warn(`File not found (404) at index ${i}, skipping: ${url.substring(url.lastIndexOf('/') + 1)}`);
                                continue;
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const text = await response.text();
                        // Received CSV data
                        
                        if (!text || text.length === 0) {
                            throw new Error('Empty response from server');
                        }
                        
                        const parsed = Papa.parse(text, { 
                            header: true, 
                            dynamicTyping: false,
                            skipEmptyLines: true,
                            transformHeader: (header) => header.trim().replace(/\r/g, ''),
                            transform: (value) => typeof value === 'string' ? value.trim().replace(/\r/g, '') : value
                        });
                        
                        if (parsed.errors && parsed.errors.length > 0) {
                            console.warn('CSV parsing errors:', parsed.errors);
                        }
                        
                        if (parsed.data && parsed.data.length > 0) {
                            // Successfully parsed rows from file
                            
                            // Always use chunked processing for desktop stability
                            if (parsed.data.length > 500) {
                                // Process in chunks for all browsers
                                const chunkSize = 300;
                                for (let i = 0; i < parsed.data.length; i += chunkSize) {
                                    const chunk = parsed.data.slice(i, i + chunkSize);
                                    allData.push(...chunk);
                                    
                                    // Small delay to prevent stack overflow
                                    if (i + chunkSize < parsed.data.length) {
                                        await new Promise(resolve => setTimeout(resolve, 25));
                                    }
                                }
                            } else {
                                allData.push(...parsed.data);
                            }
                            loadedGists++;
                        } else {
                            console.warn('No data found in parsed CSV');
                        }
                    } catch (gistError) {
                        console.warn(`Failed to load ${url}:`, gistError.message);
                    }
                    
                    // Small delay between files within batch
                    if (i < batchEnd - 1) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                    }
                    
                    // Delay between batches to prevent stack overflow  
                    if (batchEnd < gistUrls.length) {
                        const progress = Math.round((batchEnd / gistUrls.length) * 100);
                        state.error = `üîÑ Loading data... ${progress}% complete (${loadedGists} files processed)`;
                        updateUI();
                        // Batch complete
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                if (loadedGists === 0) {
                    throw new Error('No valid data could be loaded from any Gist');
                }
                
                // Clear loading message and show processing status
                state.error = '‚öôÔ∏è Processing data...';
                updateUI();
                
                // Process the data
                // Starting data processing
                const cleanedData = processRawData(allData);
                // Data processing completed
                
                if (cleanedData.length === 0) {
                    throw new Error('No valid match data found in the loaded Gists');
                }
                
                const allTeams = [...new Set([
                    ...cleanedData.map(row => row.HomeTeam), 
                    ...cleanedData.map(row => row.AwayTeam)
                ])]
                    .filter(team => team && team.length > 1)
                    .sort();
                
                const dates = cleanedData.map(row => row.dateObj);
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                state.data = cleanedData;
                state.teams = allTeams;
                state.dateFrom = minDate.toISOString().split('T')[0];
                state.dateTo = maxDate.toISOString().split('T')[0];
                state.error = ''; // Clear loading message
                
                // Data loaded successfully
                updateUI();
                updateTeamSelects();
                updateTeamSeasonsTeamSelect();
                updateSeasonOptions();
                updateTable();
                
            } catch (error) {
                console.error('Error loading Gist data:', error);
                state.error = error.message;
            } finally {
                updateUI();
            }
        }

        // Process raw CSV data
        function processRawData(allData) {
            return allData
                .filter(row => {
                    return row && 
                           row.HomeTeam && 
                           row.AwayTeam && 
                           row.Date &&
                           row.Div &&
                           typeof row.HomeTeam === 'string' &&
                           typeof row.AwayTeam === 'string' &&
                           row.HomeTeam.length > 0 &&
                           row.AwayTeam.length > 0 &&
                           row.Div.length > 0;
                })
                .map(row => {
                    try {
                        let dateStr = String(row.Date).trim().replace(/\r/g, '');
                        let dateObj;
                        
                        if (dateStr.includes('/')) {
                            const parts = dateStr.split('/');
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]);
                                let year = parseInt(parts[2]);
                                
                                if (year < 100) {
                                    year = year <= 30 ? 2000 + year : 1900 + year;
                                }
                                
                                dateObj = new Date(year, month - 1, day);
                            }
                        } else if (dateStr.includes('-')) {
                            dateObj = new Date(dateStr);
                        }
                        
                        if (!dateObj || isNaN(dateObj.getTime())) {
                            return null;
                        }
                        
                        dateObj.setHours(0, 0, 0, 0);
                        
                        let homeGoals = 0;
                        let awayGoals = 0;
                        
                        if (row.FTHG !== undefined && row.FTHG !== null && row.FTHG !== '') {
                            homeGoals = parseInt(String(row.FTHG)) || 0;
                        }
                        if (row.FTAG !== undefined && row.FTAG !== null && row.FTAG !== '') {
                            awayGoals = parseInt(String(row.FTAG)) || 0;
                        }
                        
                        return {
                            ...row,
                            dateObj: dateObj,
                            HomeTeam: String(row.HomeTeam).trim().replace(/\r/g, ''),
                            AwayTeam: String(row.AwayTeam).trim().replace(/\r/g, ''),
                            FTHG: homeGoals,
                            FTAG: awayGoals,
                            Div: String(row.Div || '').trim().replace(/\r/g, '')
                        };
                    } catch (parseError) {
                        return null;
                    }
                })
                .filter(row => row !== null);
        }

        // Create league selection buttons
        function createLeagueButtons() {
            const leagues = [
                { id: 'premier-league', name: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League' },
                { id: 'la-liga', name: 'üá™üá∏ La Liga' },
                { id: 'serie-a', name: 'üáÆüáπ Serie A' },
                { id: 'bundesliga', name: 'üá©üá™ Bundesliga' },
                { id: 'ligue-1', name: 'üá´üá∑ Ligue 1' }
            ];

            const leagueButtonsHTML = leagues.map(league => `
                <label class="league-button ${state.selectedLeague === league.id ? 'active' : ''}" data-league="${league.id}">
                    <div class="radio-dot ${state.selectedLeague === league.id ? 'active' : ''}"></div>
                    <span class="text-sm font-medium ${state.selectedLeague === league.id ? 'text-green-700' : 'text-gray-700'}">
                        ${league.name}
                    </span>
                </label>
            `).join('');
            
            elements.leagueButtons.innerHTML = leagueButtonsHTML;
            elements.lastTimeLeagueButtons.innerHTML = leagueButtonsHTML;
        }

        // Set Recent H2H input value
        function setRecentH2HValue() {
            // Removed to show placeholder text instead of pre-filled 'All'
        }

        // Create league buttons for Team Seasons tab
        function createTeamSeasonsLeagueButtons() {
            const leagues = [
                { id: 'premier-league', name: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League' },
                { id: 'la-liga', name: 'üá™üá∏ La Liga' },
                { id: 'serie-a', name: 'üáÆüáπ Serie A' },
                { id: 'bundesliga', name: 'üá©üá™ Bundesliga' },
                { id: 'ligue-1', name: 'üá´üá∑ Ligue 1' }
            ];

            const leagueButtonsHTML = leagues.map(league => `
                <label class="league-button ${state.teamSeasonsSelectedLeague === league.id ? 'active' : ''}" data-league="${league.id}">
                    <div class="radio-dot ${state.teamSeasonsSelectedLeague === league.id ? 'active' : ''}"></div>
                    <span class="text-sm font-medium ${state.teamSeasonsSelectedLeague === league.id ? 'text-green-700' : 'text-gray-700'}">
                        ${league.name}
                    </span>
                </label>
            `).join('');
            
            elements.teamSeasonsLeagueButtons.innerHTML = leagueButtonsHTML;
        }

        // Update team seasons team dropdown
        function updateTeamSeasonsTeamSelect() {
            const leagueTeams = getLeagueTeams(state.teamSeasonsSelectedLeague);

            const teamOptions = '<option value="">Choose a team...</option>' +
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');

            elements.teamSeasonsTeamSelect.innerHTML = teamOptions;
            elements.teamSeasonsTeamSelect.value = state.teamSeasonsSelectedTeam;

            // Update the combobox options as well
            if (teamSeasonsCombobox) {
                const teamComboOptions = [
                    { value: '', text: 'Choose a team...' },
                    ...leagueTeams.map(team => ({ value: team, text: team }))
                ];
                teamSeasonsCombobox.setOptions(teamComboOptions);

                // Set the current selection if any
                if (state.teamSeasonsSelectedTeam) {
                    teamSeasonsCombobox.setValue(state.teamSeasonsSelectedTeam, state.teamSeasonsSelectedTeam);
                }
            }
        }

        // Update team seasons season select
        function updateTeamSeasonsSeasonSelect() {
            if (state.teamSeasonsSelectedLeague !== 'ligue-1' && state.teamSeasonsSelectedLeague !== 'premier-league') {
                return; // No season dropdown for other leagues
            }
            
            let seasonOptions = '<option value="">Select Season</option>';
            
            if (state.teamSeasonsSelectedLeague === 'premier-league') {
                // Only show era seasons for Premier League
                seasonOptions += `
                    <option value="premier-league-era-1992-2025">Premier League Era (1992-2025)</option>
                    <option value="english-first-division-era-1888-1992">English First Division Era (1888-1992)</option>
                    <option value="all-english-seasons-1888-2025">All English Seasons (1888-2025)</option>
                `;
            } else if (state.teamSeasonsSelectedLeague === 'ligue-1') {
                // Only show era seasons for Ligue 1
                seasonOptions += `
                    <option value="ligue-1-era-2002-2025">Ligue 1 Era (2002-2025)</option>
                    <option value="french-division-1-1932-2002">French Division 1 (1932-2002)</option>
                    <option value="all-french-seasons-1932-2025">All French Seasons (1932-2025)</option>
                `;
            }
            
            elements.teamSeasonsSeasonSelect.innerHTML = seasonOptions;
            elements.teamSeasonsSeasonSelect.value = state.teamSeasonsSelectedSeason;
        }

        // Handle team seasons league change
        async function handleTeamSeasonsLeagueChange(newLeague) {
            state.teamSeasonsSelectedLeague = newLeague;
            // Also update the global league state so other tabs use the new league
            state.selectedLeague = newLeague;
            state.teamSeasonsSelectedTeam = '';
            // Set default season for leagues that support season filtering
            if (newLeague === 'premier-league') {
                state.teamSeasonsSelectedSeason = 'all-english-seasons-1888-2025';
            } else if (newLeague === 'ligue-1') {
                state.teamSeasonsSelectedSeason = 'all-french-seasons-1932-2025';
            } else {
                state.teamSeasonsSelectedSeason = '';
            }
            state.teamSeasonsSelectedPosition = '';
            state.includeBetterResults = false;
            state.includeHistoricSeasons = false;

            // Load league data if not already loaded
            if (!state.loadedLeagues || !state.loadedLeagues.has(newLeague)) {
                await loadLeagueDataForDevice(newLeague);
            } else {
                // If already loaded, just filter/update UI
                filterDataForCurrentLeague(newLeague);
            }
            
            createTeamSeasonsLeagueButtons();
            updateTeamSeasonsTeamSelect();
            updateTeamSeasonsSeasonSelect();
            updateTeamSeasonsPositionSelect();
            
            // Clear the table and reset UI
            elements.teamHistoryTable.classList.add('hidden');
            elements.teamSeasonsPositionInfo.textContent = '';

            // Reset dropdown values
            elements.teamSeasonsTeamSelect.value = '';
            elements.teamSeasonsSeasonSelect.value = '';
            elements.teamSeasonsPositionSelect.value = '';

            // Reset Include Better Results checkbox and hide it
            if (elements.includeBetterResultsCheckbox) {
                elements.includeBetterResultsCheckbox.className = 'checkbox';
            }
            if (elements.includeBetterResultsContainer) {
                elements.includeBetterResultsContainer.classList.add('hidden');
                elements.includeBetterResultsContainer.style.display = 'none';
            }

            // Reset Historic Seasons toggle and hide it
            state.includeHistoricSeasons = false;
            updateHistoricSeasonsToggleButton();
            if (elements.historicSeasonsContainer) {
                elements.historicSeasonsContainer.classList.add('hidden');
            }
            
            // Clear stored team history data and name
            window.currentTeamHistoryData = null;
            window.currentTeamHistoryName = null;
            
            // Show/hide season dropdown for Ligue 1 and Premier League
            if (newLeague === 'ligue-1' || newLeague === 'premier-league') {
                elements.teamSeasonsSeasonContainer.classList.remove('hidden');
            } else {
                elements.teamSeasonsSeasonContainer.classList.add('hidden');
            }
            
            // Hide team history table until team is selected
            elements.teamHistoryTable.classList.add('hidden');
        }

        // Helper function to get ordinal numbers (1st, 2nd, 3rd, etc.)
        function getOrdinal(num) {
            const suffixes = ["th", "st", "nd", "rd"];
            const v = num % 100;
            return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        // Update Historic Seasons toggle visibility
        function updateHistoricSeasonsVisibility() {
            const shouldShow = state.teamSeasonsSelectedTeam ||
                              (state.teamSeasonsSelectedPosition && !state.teamSeasonsSelectedTeam);

            if (shouldShow) {
                elements.historicSeasonsContainer.classList.remove('hidden');
            } else {
                elements.historicSeasonsContainer.classList.add('hidden');
                // Reset toggle state when hiding
                state.includeHistoricSeasons = false;
                updateHistoricSeasonsToggleButton();
            }
        }

        // Update Historic Seasons toggle button appearance
        function updateHistoricSeasonsToggleButton() {
            if (state.includeHistoricSeasons) {
                elements.historicSeasonsToggle.textContent = 'üìú Hide Historic Seasons';
                elements.historicSeasonsToggle.classList.remove('btn-secondary');
                elements.historicSeasonsToggle.classList.add('btn-primary');
            } else {
                elements.historicSeasonsToggle.textContent = 'üìú Include Historic Seasons';
                elements.historicSeasonsToggle.classList.remove('btn-primary');
                elements.historicSeasonsToggle.classList.add('btn-secondary');
            }
        }

        // Handle Historic Seasons toggle
        function handleHistoricSeasonsToggle() {
            state.includeHistoricSeasons = !state.includeHistoricSeasons;
            updateHistoricSeasonsToggleButton();

            // Refresh the current view with or without historic seasons
            if (state.teamSeasonsSelectedTeam) {
                showTeamHistory(state.teamSeasonsSelectedTeam, state.teamSeasonsSelectedLeague);

                // Preserve Include Better Results checkbox if it should be visible
                // (when team is selected AND position is selected)
                if (state.teamSeasonsSelectedPosition) {
                    setTimeout(() => {
                        if (elements.includeBetterResultsContainer) {
                            elements.includeBetterResultsContainer.className = 'mt-3 flex items-center gap-2';
                            elements.includeBetterResultsContainer.removeAttribute('style');
                            elements.includeBetterResultsContainer.style.display = 'flex';
                        }
                    }, 100);
                }
            } else if (state.teamSeasonsSelectedPosition) {
                showAllTeamsAtPosition(state.teamSeasonsSelectedPosition, state.teamSeasonsSelectedLeague);
            }
        }

        // Toggle controls collapse
        function toggleControlsCollapse() {
            state.controlsCollapsed = !state.controlsCollapsed;
            updateControlsVisibility();
        }

        // Update controls visibility based on collapsed state
        function updateControlsVisibility() {
            // Update button appearance
            if (state.controlsCollapsed) {
                elements.collapseControlsBtn.querySelector('span').innerHTML = '‚ñ≤';
                elements.collapseControlsBtn.title = 'Show Controls';
            } else {
                elements.collapseControlsBtn.querySelector('span').innerHTML = '‚ñº';
                elements.collapseControlsBtn.title = 'Hide Controls';
            }

            // Use CSS approach - add/remove a body class that controls visibility via CSS
            if (state.controlsCollapsed) {
                document.body.classList.add('controls-collapsed');
            } else {
                document.body.classList.remove('controls-collapsed');
            }
        }

        // Get historic seasons data for a specific team or position
        function getHistoricSeasonsData(teamName = null, position = null, league = null) {
            if (!state.includeHistoricSeasons) return [];

            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };

            const targetLeagueId = leagueMapping[league];
            if (!targetLeagueId) return [];

            return historicSeasonsData
                .filter(entry => {
                    const [season, leagueId, pos, team] = entry;

                    // Filter by league
                    if (leagueId !== targetLeagueId) return false;

                    // Filter by team if specified
                    if (teamName && team !== teamName) return false;

                    // Filter by position if specified
                    if (position && pos !== parseInt(position)) return false;

                    return true;
                })
                .map(entry => {
                    const [season, leagueId, pos, team, gp, w, d, l, gf, ga, gd, pts] = entry;
                    return {
                        season: season,
                        team: team,
                        position: pos,
                        played: gp,
                        won: w,
                        drawn: d,
                        lost: l,
                        goalsFor: gf,
                        goalsAgainst: ga,
                        goalDifference: gd,
                        points: pts,
                        isHistoric: true // Flag to identify historic data
                    };
                });
        }

        // Update team seasons position select
        function updateTeamSeasonsPositionSelect() {
            let positionOptions = '<option value="">All Positions</option>';
            for (let i = 1; i <= 24; i++) {
                positionOptions += `<option value="${i}">${i}</option>`;
            }
            elements.teamSeasonsPositionSelect.innerHTML = positionOptions;
            elements.teamSeasonsPositionSelect.value = state.teamSeasonsSelectedPosition;
        }

        // Handle team seasons season selection
        function handleTeamSeasonsSeasonChange(selectedSeason) {
            state.teamSeasonsSelectedSeason = selectedSeason;
            
            // If a team is already selected, refresh the team history with the new season filter
            if (state.teamSeasonsSelectedTeam) {
                showTeamHistory(state.teamSeasonsSelectedTeam, state.teamSeasonsSelectedLeague);
            }
        }

        // Handle team seasons position selection
        function handleTeamSeasonsPositionChange(selectedPosition) {
            state.teamSeasonsSelectedPosition = selectedPosition;

            // Reset Historic Seasons toggle state when changing position
            state.includeHistoricSeasons = false;
            updateHistoricSeasonsToggleButton();

            if (state.teamSeasonsSelectedTeam) {
                // If a team is selected, refresh the team history with the new position filter
                showTeamHistory(state.teamSeasonsSelectedTeam, state.teamSeasonsSelectedLeague);

                // Show/hide checkbox AFTER showTeamHistory runs (to avoid being overridden)
                setTimeout(() => {
                    if (selectedPosition) {
                        if (elements.includeBetterResultsContainer) {
                            // Clear all conflicting styles and classes
                            elements.includeBetterResultsContainer.className = 'mt-3 flex items-center gap-2';
                            elements.includeBetterResultsContainer.removeAttribute('style');
                            elements.includeBetterResultsContainer.style.display = 'flex';
                        }
                    } else {
                        if (elements.includeBetterResultsContainer) {
                            elements.includeBetterResultsContainer.classList.add('hidden');
                        }
                    }
                }, 100);
            } else if (selectedPosition) {
                // If no team selected but position is selected, show all teams at that position
                // Reset team selection to ensure clean position-only view
                state.teamSeasonsSelectedTeam = '';
                elements.teamSeasonsTeamSelect.value = '';

                // Show Historic Seasons toggle when any position is selected
                updateHistoricSeasonsVisibility();

                showAllTeamsAtPosition(selectedPosition, state.teamSeasonsSelectedLeague);
            } else {
                // Clear the table if no filters are selected
                elements.teamHistoryTable.classList.add('hidden');
                elements.teamSeasonsPositionInfo.textContent = '';

                // Hide Historic Seasons toggle when no position selected
                updateHistoricSeasonsVisibility();
            }
        }

        // Show all teams that finished at a specific position
        function showAllTeamsAtPosition(position, league) {
            const selectedPos = parseInt(position);
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const divCode = leagueMapping[league];
            if (!divCode) return;
            
            const availableSeasons = getAvailableSeasons(league);
            const allPositionData = [];

            // Filter seasons based on Team Seasons selection (if any)
            let seasonsToProcess = availableSeasons;
            if (state.teamSeasonsSelectedSeason) {
                // For era seasons, filter individual seasons to only those within the era date range
                if (state.teamSeasonsSelectedSeason.includes('all-') || state.teamSeasonsSelectedSeason.includes('-era-') || state.teamSeasonsSelectedSeason.includes('french-division-1')) {
                    const originalSelectedLeague = state.selectedLeague;
                    state.selectedLeague = league;
                    const eraSeasonDates = getSeasonDateRange(state.teamSeasonsSelectedSeason);
                    state.selectedLeague = originalSelectedLeague;

                    if (eraSeasonDates) {
                        const eraStart = new Date(eraSeasonDates.start);
                        const eraEnd = new Date(eraSeasonDates.end);

                        // Filter individual seasons to only those that fall within the era
                        seasonsToProcess = availableSeasons.filter(season => {
                            // Skip era seasons themselves in this filtering
                            if (season.includes('all-') || season.includes('-era-') || season.includes('french-division-1')) {
                                return false;
                            }

                            const originalSelectedLeague2 = state.selectedLeague;
                            state.selectedLeague = league;
                            const seasonDates = getSeasonDateRange(season);
                            state.selectedLeague = originalSelectedLeague2;

                            if (!seasonDates) return false;

                            const seasonStart = new Date(seasonDates.start);
                            const seasonEnd = new Date(seasonDates.end);

                            // Include season if it starts on or after era start and ends before or on era end
                            return seasonStart >= eraStart && seasonEnd <= eraEnd;
                        });
                    }
                } else {
                    // For individual seasons (shouldn't happen in Team Seasons but keeping for safety)
                    seasonsToProcess = [state.teamSeasonsSelectedSeason];
                }
            }

            // Process each season to build complete league tables
            seasonsToProcess.forEach(seasonFilter => {
                // Skip special seasons
                if (seasonFilter.includes('all-') || seasonFilter.includes('-era-') || seasonFilter.includes('french-division-1')) {
                    return;
                }
                
                // Get season date range
                const originalSelectedLeague = state.selectedLeague;
                state.selectedLeague = league;
                const seasonDates = getSeasonDateRange(seasonFilter);
                state.selectedLeague = originalSelectedLeague;
                
                if (!seasonDates) return;
                
                // Filter data for this season
                const seasonStart = new Date(seasonDates.start);
                seasonStart.setUTCHours(0, 0, 0, 0);
                const seasonEnd = new Date(seasonDates.end);
                seasonEnd.setUTCHours(23, 59, 59, 999);
                
                const seasonData = state.data.filter(match => 
                    match.Div === divCode &&
                    match.dateObj >= seasonStart &&
                    match.dateObj <= seasonEnd
                );
                
                if (seasonData.length === 0) return;
                
                // Build complete league table for this season
                const teams = [...new Set([
                    ...seasonData.map(row => row.HomeTeam),
                    ...seasonData.map(row => row.AwayTeam)
                ])].filter(team => team && team.length > 1);
                
                const seasonTable = teams.map(team => {
                    const stats = { played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0 };
                    
                    seasonData.forEach(match => {
                        if (match.HomeTeam === team || match.AwayTeam === team) {
                            const isHome = match.HomeTeam === team;
                            const teamScore = isHome ? match.FTHG : match.FTAG;
                            const opponentScore = isHome ? match.FTAG : match.FTHG;
                            
                            if (teamScore !== undefined && opponentScore !== undefined) {
                                stats.played++;
                                stats.goalsFor += teamScore;
                                stats.goalsAgainst += opponentScore;
                                
                                if (teamScore > opponentScore) stats.won++;
                                else if (teamScore === opponentScore) stats.drawn++;
                                else stats.lost++;
                            }
                        }
                    });
                    
                    const pointsPerWin = getHistoricalPointSystem(seasonFilter, league);
                    let teamPoints = stats.won * pointsPerWin + stats.drawn;
                    
                    // Apply point deductions for this team and season
                    if (seasonDates) {
                        const seasonStart = new Date(seasonDates.start);
                        const seasonEnd = new Date(seasonDates.end);
                        
                        pointDeductions.forEach(deduction => {
                            if (deduction.team === team && deduction.league === divCode) {
                                const deductionStart = new Date(deduction.startDate);
                                const deductionEnd = new Date(deduction.endDate);
                                
                                const hasOverlap = (seasonStart <= deductionEnd) && (seasonEnd >= deductionStart);
                                if (hasOverlap && state.pointDeductionsEnabled) {
                                    teamPoints -= deduction.points;
                                }
                            }
                        });
                    }
                    
                    return {
                        team,
                        ...stats,
                        goalDifference: stats.goalsFor - stats.goalsAgainst,
                        points: teamPoints
                    };
                });
                
                // Sort table by points, goal difference, goals for
                seasonTable.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                    return b.goalsFor - a.goalsFor;
                });
                
                // Apply ranking overrides
                const overriddenTable = applyRankingOverrides(seasonTable, league, seasonFilter);
                
                // Extract all teams at the requested position (handle shared positions)
                if (overriddenTable.length >= selectedPos) {
                    // Find all teams that share the same position or have sharedPosition property
                    const teamsAtPosition = [];
                    
                    // First, check if there are teams with sharedPosition matching our target
                    overriddenTable.forEach((team, index) => {
                        if (team.sharedPosition === selectedPos) {
                            teamsAtPosition.push(team);
                        }
                    });
                    
                    // If no shared positions found, get the team at the array index
                    if (teamsAtPosition.length === 0) {
                        const teamAtIndex = overriddenTable[selectedPos - 1];
                        if (teamAtIndex) {
                            teamsAtPosition.push(teamAtIndex);
                            
                            // Check for other teams with the same points/stats (tied positions)
                            overriddenTable.forEach((team, index) => {
                                if (index !== selectedPos - 1 && 
                                    team.points === teamAtIndex.points && 
                                    team.goalDifference === teamAtIndex.goalDifference &&
                                    team.goalsFor === teamAtIndex.goalsFor) {
                                    // Check if this tied team would be in the same position range
                                    const teamActualPosition = index + 1;
                                    if (Math.abs(teamActualPosition - selectedPos) < teamsAtPosition.length) {
                                        teamsAtPosition.push(team);
                                    }
                                }
                            });
                        }
                    }
                    
                    // Process each team at this position
                    teamsAtPosition.forEach(teamAtPosition => {
                        // Check if this season should be included (34+ games or historical incomplete season)
                        const shouldInclude = teamAtPosition.played >= 34 || seasonFilter !== '2025-26';
                        
                        // Check for stripped champions (position-only filtering, no team filter)
                        const isStripped = isStrippedChampion(teamAtPosition.team, divCode, seasonFilter, selectedPos, false, true);
                        
                        if (shouldInclude && !isStripped) {
                            allPositionData.push({
                                season: seasonFilter,
                                team: teamAtPosition.team,
                                position: selectedPos,
                                played: teamAtPosition.played,
                                won: teamAtPosition.won,
                                drawn: teamAtPosition.drawn,
                                lost: teamAtPosition.lost,
                                goalsFor: teamAtPosition.goalsFor,
                                goalsAgainst: teamAtPosition.goalsAgainst,
                                goalDifference: teamAtPosition.goalDifference,
                                points: teamAtPosition.points
                            });
                        }
                    });
                }
            });

            // Add historic seasons data if enabled
            if (state.includeHistoricSeasons) {
                const historicData = getHistoricSeasonsData(null, selectedPos, league);
                allPositionData.push(...historicData);
            }

            // Sort by season (most recent first), then by team name
            allPositionData.sort((a, b) => {
                const yearA = parseInt(a.season.split('-')[0]);
                const yearB = parseInt(b.season.split('-')[0]);
                if (yearB !== yearA) return yearB - yearA;
                return a.team.localeCompare(b.team);
            });
            
            // Add count column - count chronologically from oldest to most recent
            const teamCounts = {};
            // First sort by oldest to count chronologically
            const chronologicalData = [...allPositionData].sort((a, b) => {
                const yearA = parseInt(a.season.split('-')[0]);
                const yearB = parseInt(b.season.split('-')[0]);
                return yearA - yearB; // oldest first for counting
            });
            
            // Assign count numbers chronologically
            chronologicalData.forEach(season => {
                if (!teamCounts[season.team]) {
                    teamCounts[season.team] = 0;
                }
                teamCounts[season.team]++;
                season.count = teamCounts[season.team];
            });
            
            // Update position info
            const ordinalPosition = getOrdinal(selectedPos);
            const totalCount = allPositionData.length;
            const countText = totalCount === 1 ? 'time' : 'times';
            elements.teamSeasonsPositionInfo.textContent = `${totalCount} teams finished ${ordinalPosition} a total of ${totalCount} ${countText}`;
            
            // Display the results
            displayAllTeamsAtPosition(allPositionData, selectedPos, league);
        }


        // Render position-only table without recalculating data (for sorting)
        function renderPositionOnlyTable(allPositionData, selectedPos, league) {
            if (!allPositionData || allPositionData.length === 0) {
                elements.teamHistoryTable.classList.add('hidden');
                return;
            }
            
            // Show table
            elements.teamHistoryTable.classList.remove('hidden');
            
            // Update title for position-only view with medal styling
            const ordinalPosition = getOrdinal(selectedPos);
            const medalStyle = selectedPos === 1 ? 'color: #d97706; font-weight: bold;' : selectedPos === 2 ? 'color: #374151; font-weight: bold;' : selectedPos === 3 ? 'color: #b45309; font-weight: bold;' : 'color: #374151; font-weight: bold;';
            elements.teamHistoryTitle.innerHTML = `All teams (Position <span style="${medalStyle}">${selectedPos}</span>) - ${ordinalPosition} Place Finishes`;
            
            // Update headers for multi-team view
            const headers = [
                { key: 'season', label: 'Season' },
                { key: 'count', label: 'Count' },
                { key: 'team', label: 'Team' },
                { key: 'played', label: 'P' },
                { key: 'won', label: 'W' },
                { key: 'drawn', label: 'D' },
                { key: 'lost', label: 'L' },
                { key: 'goalsFor', label: 'GF' },
                { key: 'goalsAgainst', label: 'GA' },
                { key: 'goalDifference', label: 'GD' },
                { key: 'points', label: 'Pts' }
            ];
            
            // In position-only mode, make ALL columns sortable (including team)
            elements.teamHistoryHeader.innerHTML = headers.map(header => `
                <th class="px-3 py-4 text-center font-bold text-sm cursor-pointer hover:bg-gray-600" 
                    onclick="handleTeamHistorySort('${header.key}')"
                    style="text-align: ${(header.key === 'season' || header.key === 'team') ? 'left' : 'center'}">
                    ${header.label}${getTeamHistorySortIndicator(header.key)}
                </th>
            `).join('');
            
            // Create table rows
            elements.teamHistoryBody.innerHTML = allPositionData.map((season, index) => {
                const rowBackgroundClass = index % 2 === 1 ? 'bg-gray-100' : 'bg-gray-50';
                const logoUrl = getTeamLogoUrl(season.team, league);
                
                return `
                    <tr class="border-b hover:bg-gray-50 ${rowBackgroundClass}">
                        <td class="px-3 py-4 font-semibold text-left">
                            ${season.season}
                            ${season.isHistoric ? '<span class="ml-2 px-2 py-1 text-xs bg-amber-100 text-amber-800 rounded-full">Historic</span>' : ''}
                        </td>
                        <td class="px-3 py-4 text-center font-semibold">${season.count}</td>
                        <td class="px-4 py-4 font-semibold text-gray-900">
                            <div class="flex items-center">
                                ${logoUrl ? `<img src="${logoUrl}" alt="${season.team} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="cursor-pointer hover:text-blue-600" onclick="handleTeamClick('${season.team}')">${season.team}</span>
                            </div>
                        </td>
                        <td class="px-3 py-4 text-center">${season.played}</td>
                        <td class="px-3 py-4 text-center">${season.won}</td>
                        <td class="px-3 py-4 text-center">${season.drawn}</td>
                        <td class="px-3 py-4 text-center">${season.lost}</td>
                        <td class="px-3 py-4 text-center">${season.goalsFor}</td>
                        <td class="px-3 py-4 text-center">${season.goalsAgainst}</td>
                        <td class="px-3 py-4 text-center ${season.goalDifference >= 0 ? 'text-green-600' : 'text-red-600'}">${season.goalDifference > 0 ? '+' : ''}${season.goalDifference}</td>
                        <td class="px-3 py-4 text-center">
                            <span class="points-badge">
                                ${season.points}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Display all teams at specific position
        function displayAllTeamsAtPosition(allPositionData, selectedPos, league) {
            // Clear any previous team-specific data first
            window.currentTeamHistoryData = null;
            window.currentTeamHistoryName = null;
            
            // Just call the render function
            renderPositionOnlyTable(allPositionData, selectedPos, league);
            
            // Store data for potential sorting
            window.currentTeamHistoryData = allPositionData;
            window.currentTeamHistoryName = `All teams (Position ${selectedPos})`;
        }

        // Handle team seasons team selection
        function handleTeamSeasonsTeamChange(selectedTeam) {
            // handleTeamSeasonsTeamChange called
            state.teamSeasonsSelectedTeam = selectedTeam;
            state.teamSeasonsSelectedPosition = ''; // Reset position filter
            state.includeBetterResults = false;
            state.includeHistoricSeasons = false;
            updateHistoricSeasonsToggleButton();

            if (selectedTeam) {
                // Reset position dropdown UI when team is selected
                elements.teamSeasonsPositionSelect.value = '';

                // Team selected but no position = hide checkbox
                elements.includeBetterResultsContainer.classList.add('hidden');

                // Show Historic Seasons toggle when team is selected
                updateHistoricSeasonsVisibility();

                showTeamHistory(selectedTeam, state.teamSeasonsSelectedLeague);
            } else {
                // Team unselected - clear everything
                elements.teamHistoryTable.classList.add('hidden');
                elements.teamSeasonsPositionInfo.textContent = '';
                elements.teamHistoryTitle.textContent = '';
                elements.includeBetterResultsContainer.classList.add('hidden');

                // Hide Historic Seasons toggle when no team selected
                updateHistoricSeasonsVisibility();

                // Clear stored team history data and name to prevent contamination
                window.currentTeamHistoryData = null;
                window.currentTeamHistoryName = null;
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Store the current league before switching
            let preservedLeague = state.selectedLeague;
            
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            if (tabName === 'league-filters') {
                document.getElementById('leagueFiltersTab').classList.add('active');
                document.getElementById('leagueFiltersContent').classList.add('active');

                // Preserve league selection
                state.selectedLeague = preservedLeague;

                // Reset Team Seasons state when switching away
                state.teamSeasonsSelectedTeam = '';
                state.teamSeasonsSelectedSeason = '';
                state.teamSeasonsSelectedPosition = '';
                state.includeBetterResults = false;
                state.includeHistoricSeasons = false;

                // Reset Historic Seasons toggle button and hide it
                updateHistoricSeasonsToggleButton();
                if (elements.historicSeasonsContainer) {
                    elements.historicSeasonsContainer.classList.add('hidden');
                }

                // Reset Last Time When state
                state.lastTimeTeam1 = '';
                state.lastTimeTeam2 = '';
                state.lastTimeDayOfWeek = '';
                state.lastTimeLocation = '';
                elements.lastTimeTeam1Select.value = '';
                elements.lastTimeTeam2Select.value = '';
                elements.lastTimeDayOfWeekSelect.value = '';
                elements.lastTimeLocationSelect.value = '';
                elements.lastTimeResults.classList.add('hidden');
                
                // Show league table and related sections
                elements.tableContainer.classList.remove('hidden');
                elements.h2hSection.classList.remove('hidden');
                
                // Update league buttons and table
                createLeagueButtons();
                updateTable();
                
            } else if (tabName === 'team-seasons') {
                document.getElementById('teamSeasonsTab').classList.add('active');
                document.getElementById('teamSeasonsContent').classList.add('active');

                // Always sync Team Seasons league with the current league when switching tabs
                state.teamSeasonsSelectedLeague = preservedLeague;

                // Reset both other tab states
                state.selectedTeam1 = '';
                state.selectedTeam2 = '';
                state.selectedSeason = '';
                state.selectedDayOfWeek = '';
                state.lastTimeTeam1 = '';
                state.lastTimeTeam2 = '';
                state.lastTimeDayOfWeek = '';
                elements.team1Select.value = '';
                elements.team2Select.value = '';
                elements.seasonSelect.value = '';
                elements.dayOfWeekSelect.value = '';
                elements.lastTimeTeam1Select.value = '';
                elements.lastTimeTeam2Select.value = '';
                elements.lastTimeDayOfWeekSelect.value = '';
                elements.lastTimeLocationSelect.value = '';

                // Hide other tab sections
                elements.tableContainer.classList.add('hidden');
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
                elements.tableInfo.classList.add('hidden');
                elements.lastTimeResults.classList.add('hidden');
                elements.matchHistorySection.classList.add('hidden');

                // Ensure checkbox is hidden when switching TO Team Seasons tab
                if (elements.includeBetterResultsContainer) {
                    elements.includeBetterResultsContainer.classList.add('hidden');
                    elements.includeBetterResultsContainer.style.display = 'none';
                }
                const containerByIdLocal = document.getElementById('includeBetterResultsContainer');
                if (containerByIdLocal) {
                    containerByIdLocal.classList.add('hidden');
                    containerByIdLocal.style.display = 'none';
                }

                // Clear Team Seasons visual elements to match cleared state
                elements.teamHistoryTable.classList.add('hidden');
                elements.teamSeasonsPositionInfo.textContent = '';
                elements.teamSeasonsTeamSelect.value = '';
                // Don't reset season dropdown - keep the current season selection
                // elements.teamSeasonsSeasonSelect.value = '';
                elements.teamSeasonsPositionSelect.value = '';
                // Reset checkbox and ensure it's hidden when no team is selected
                if (elements.includeBetterResultsCheckbox) {
                    elements.includeBetterResultsCheckbox.className = 'checkbox';
                }
                if (elements.includeBetterResultsContainer) {
                    elements.includeBetterResultsContainer.classList.add('hidden');
                    elements.includeBetterResultsContainer.style.display = 'none';
                }
                // Also force hide using ID selector to catch any stale references
                const containerById2 = document.getElementById('includeBetterResultsContainer');
                if (containerById2) {
                    containerById2.classList.add('hidden');
                    containerById2.style.display = 'none';
                }

                // Show/hide season dropdown based on current league (same logic as handleTeamSeasonsLeagueChange)
                if (state.teamSeasonsSelectedLeague === 'ligue-1' || state.teamSeasonsSelectedLeague === 'premier-league') {
                    elements.teamSeasonsSeasonContainer.classList.remove('hidden');
                } else {
                    elements.teamSeasonsSeasonContainer.classList.add('hidden');
                }

                // Initialize Team Seasons controls with preserved league
                createTeamSeasonsLeagueButtons();
                updateTeamSeasonsTeamSelect();
                updateTeamSeasonsSeasonSelect();

                // Ensure default season is set for leagues that support season filtering
                if (preservedLeague === 'premier-league' && !state.teamSeasonsSelectedSeason) {
                    state.teamSeasonsSelectedSeason = 'all-english-seasons-1888-2025';
                } else if (preservedLeague === 'ligue-1' && !state.teamSeasonsSelectedSeason) {
                    state.teamSeasonsSelectedSeason = 'all-french-seasons-1932-2025';
                }

                // Set the season dropdown to the current state value
                elements.teamSeasonsSeasonSelect.value = state.teamSeasonsSelectedSeason;
                updateTeamSeasonsPositionSelect();
                
            } else if (tabName === 'last-time-when') {
                document.getElementById('lastTimeWhenTab').classList.add('active');
                document.getElementById('lastTimeWhenContent').classList.add('active');

                // Simple approach: just set the league and update
                state.selectedLeague = preservedLeague;

                // Reset League Filters state
                state.selectedTeam1 = '';
                state.selectedTeam2 = '';
                state.selectedSeason = '';
                state.selectedDayOfWeek = '';
                elements.team1Select.value = '';
                elements.team2Select.value = '';
                elements.seasonSelect.value = '';
                elements.dayOfWeekSelect.value = '';
                
                // Hide league table and related sections
                elements.tableContainer.classList.add('hidden');
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
                elements.tableInfo.classList.add('hidden');
                elements.matchHistorySection.classList.add('hidden');

                // Clear Team Seasons visual elements when switching away
                elements.teamHistoryTable.classList.add('hidden');
                elements.teamSeasonsPositionInfo.textContent = '';
                elements.teamSeasonsTeamSelect.value = '';
                elements.teamSeasonsSeasonSelect.value = '';
                elements.teamSeasonsPositionSelect.value = '';
                // Force hide checkbox using multiple methods
                if (elements.includeBetterResultsContainer) {
                    elements.includeBetterResultsContainer.classList.add('hidden');
                    elements.includeBetterResultsContainer.style.display = 'none';
                }
                if (elements.includeBetterResultsCheckbox) {
                    elements.includeBetterResultsCheckbox.className = 'checkbox';
                }
                // Also try to find it by ID in case the reference is stale
                const containerByIdLocal = document.getElementById('includeBetterResultsContainer');
                if (containerByIdLocal) {
                    containerByIdLocal.classList.add('hidden');
                    containerByIdLocal.style.display = 'none';
                }

                // Update league buttons and team selects for Last Time When
                createLeagueButtons(); // This will update the league buttons with correct selection
                updateTeamSelects();
                
            } else if (tabName === 'team-streaks') {
                document.getElementById('teamStreaksTab').classList.add('active');
                document.getElementById('teamStreaksContent').classList.add('active');

                // Simple approach: just set the league and update
                state.selectedLeague = preservedLeague;

                // Reset other tab states
                state.selectedTeam1 = '';
                state.selectedTeam2 = '';
                state.selectedSeason = '';
                state.selectedDayOfWeek = '';
                state.lastTimeTeam1 = '';
                state.lastTimeTeam2 = '';
                state.lastTimeDayOfWeek = '';
                elements.team1Select.value = '';
                elements.team2Select.value = '';
                elements.seasonSelect.value = '';
                elements.dayOfWeekSelect.value = '';
                elements.lastTimeTeam1Select.value = '';
                elements.lastTimeTeam2Select.value = '';
                elements.lastTimeDayOfWeekSelect.value = '';
                elements.lastTimeLocationSelect.value = '';

                // Hide other tab sections
                elements.tableContainer.classList.add('hidden');
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
                elements.tableInfo.classList.add('hidden');
                elements.lastTimeResults.classList.add('hidden');
                elements.matchHistorySection.classList.add('hidden');

                // Clear Team Seasons visual elements when switching away
                elements.teamHistoryTable.classList.add('hidden');
                elements.teamSeasonsPositionInfo.textContent = '';
                elements.teamSeasonsTeamSelect.value = '';
                elements.teamSeasonsSeasonSelect.value = '';
                elements.teamSeasonsPositionSelect.value = '';
                // Force hide checkbox using multiple methods
                if (elements.includeBetterResultsContainer) {
                    elements.includeBetterResultsContainer.classList.add('hidden');
                    elements.includeBetterResultsContainer.style.display = 'none';
                }
                if (elements.includeBetterResultsCheckbox) {
                    elements.includeBetterResultsCheckbox.className = 'checkbox';
                }
                // Also try to find it by ID in case the reference is stale
                const containerByIdLocal = document.getElementById('includeBetterResultsContainer');
                if (containerByIdLocal) {
                    containerByIdLocal.classList.add('hidden');
                    containerByIdLocal.style.display = 'none';
                }

                // Clear Team Streaks visual elements to match cleared state
                elements.teamStreaksResults.classList.add('hidden');
                elements.teamStreaksStatusSelect.value = 'active'; // Reset to default
                elements.teamStreaksLocationSelect.value = 'both'; // Reset to default
                elements.teamStreaksTypeSelect.value = 'winning'; // Reset to default
                elements.teamStreaksTeam1Select.value = '';
                elements.teamStreaksTeam2Select.value = '';

                // Initialize Team Streaks controls with correct league selected
                createTeamStreaksLeagueButtons();
                updateTeamStreaksSelects();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.getElementById('leagueFiltersTab').addEventListener('click', () => switchTab('league-filters'));
            document.getElementById('teamSeasonsTab').addEventListener('click', () => switchTab('team-seasons'));
            document.getElementById('lastTimeWhenTab').addEventListener('click', () => switchTab('last-time-when'));
            document.getElementById('teamStreaksTab').addEventListener('click', () => switchTab('team-streaks'));
            
            // Gist loading
            elements.reloadGistsBtn.addEventListener('click', loadGistData);
            
            // League selection
            elements.leagueButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.league-button');
                if (button) {
                    handleLeagueChange(button.dataset.league);
                }
            });
            
            // Last Time When league selection
            elements.lastTimeLeagueButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.league-button');
                if (button) {
                    handleLeagueChange(button.dataset.league);
                }
            });

            // Filter controls
            elements.seasonSelect.addEventListener('change', (e) => handleSeasonChange(e.target.value));
            elements.dateFrom.addEventListener('change', (e) => {
                state.dateFrom = e.target.value;
                // Reset season selection when custom date range is applied
                state.selectedSeason = '';
                elements.seasonSelect.value = '';
                // Set 3-point system to ON for custom date ranges
                state.threePointSystem = true;
                elements.threePointCheckbox.className = 'checkbox checked';
                // Disable point deductions for custom date ranges
                state.pointDeductionsEnabled = false;
                elements.deductionsCheckbox.className = 'checkbox';
                updateTable();
            });
            elements.dateTo.addEventListener('change', (e) => {
                state.dateTo = e.target.value;
                // Reset season selection when custom date range is applied
                state.selectedSeason = '';
                elements.seasonSelect.value = '';
                // Set 3-point system to ON for custom date ranges
                state.threePointSystem = true;
                elements.threePointCheckbox.className = 'checkbox checked';
                // Disable point deductions for custom date ranges
                state.pointDeductionsEnabled = false;
                elements.deductionsCheckbox.className = 'checkbox';
                updateTable();
            });
            elements.dayOfWeekSelect.addEventListener('change', (e) => { state.selectedDayOfWeek = e.target.value; updateTable(); });
            elements.team1Select.addEventListener('change', (e) => { 
                state.selectedTeam1 = e.target.value; 
                checkAndDisablePointDeductions();
                updateTable(); 
            });
            elements.team2Select.addEventListener('change', (e) => { 
                state.selectedTeam2 = e.target.value; 
                checkAndDisablePointDeductions();
                updateTable(); 
            });
            
            // Checkboxes
            elements.homeCheckbox.addEventListener('click', () => {
                state.homeFilter = !state.homeFilter;
                // Sync match history home filter
                state.matchHistoryHomeFilter = state.homeFilter;

                // Update all three checkboxes
                elements.homeCheckbox.className = `checkbox ${state.homeFilter ? 'checked' : ''}`;
                elements.matchHistoryHomeCheckbox.className = `checkbox ${state.matchHistoryHomeFilter ? 'checked' : ''}`;
                elements.h2hHomeCheckbox.className = `checkbox ${state.homeFilter ? 'checked' : ''}`;

                updateTable();
            });

            elements.awayCheckbox.addEventListener('click', () => {
                state.awayFilter = !state.awayFilter;
                // Sync match history away filter
                state.matchHistoryAwayFilter = state.awayFilter;

                // Update all three checkboxes
                elements.awayCheckbox.className = `checkbox ${state.awayFilter ? 'checked' : ''}`;
                elements.matchHistoryAwayCheckbox.className = `checkbox ${state.matchHistoryAwayFilter ? 'checked' : ''}`;
                elements.h2hAwayCheckbox.className = `checkbox ${state.awayFilter ? 'checked' : ''}`;

                updateTable();
            });

            // H2H Home/Away checkboxes (sync with main checkboxes)
            elements.h2hHomeCheckbox.addEventListener('click', () => {
                state.homeFilter = !state.homeFilter;
                // Sync match history home filter
                state.matchHistoryHomeFilter = state.homeFilter;

                // Update all three checkboxes
                elements.homeCheckbox.className = `checkbox ${state.homeFilter ? 'checked' : ''}`;
                elements.matchHistoryHomeCheckbox.className = `checkbox ${state.matchHistoryHomeFilter ? 'checked' : ''}`;
                elements.h2hHomeCheckbox.className = `checkbox ${state.homeFilter ? 'checked' : ''}`;

                updateTable();
            });

            elements.h2hAwayCheckbox.addEventListener('click', () => {
                state.awayFilter = !state.awayFilter;
                // Sync match history away filter
                state.matchHistoryAwayFilter = state.awayFilter;

                // Update all three checkboxes
                elements.awayCheckbox.className = `checkbox ${state.awayFilter ? 'checked' : ''}`;
                elements.matchHistoryAwayCheckbox.className = `checkbox ${state.matchHistoryAwayFilter ? 'checked' : ''}`;
                elements.h2hAwayCheckbox.className = `checkbox ${state.awayFilter ? 'checked' : ''}`;

                updateTable();
            });

            elements.deductionsCheckbox.addEventListener('click', () => {
                state.pointDeductionsEnabled = !state.pointDeductionsEnabled;
                elements.deductionsCheckbox.className = `checkbox ${state.pointDeductionsEnabled ? 'checked' : ''}`;
                updateTable();
                
                // Also refresh Team Seasons data if currently displayed
                if (state.teamSeasonsSelectedTeam) {
                    // Refresh single team view
                    showTeamHistory(state.teamSeasonsSelectedTeam, state.teamSeasonsSelectedLeague);
                } else if (state.teamSeasonsSelectedPosition) {
                    // Refresh position-only view
                    showAllTeamsAtPosition(state.teamSeasonsSelectedPosition, state.teamSeasonsSelectedLeague);
                }
            });
            
            elements.threePointCheckbox.addEventListener('click', () => {
                state.threePointSystem = !state.threePointSystem;
                elements.threePointCheckbox.className = `checkbox ${state.threePointSystem ? 'checked' : ''}`;
                updateTable();
            });

            // Match history checkboxes
            elements.matchHistoryHomeCheckbox.addEventListener('click', () => {
                state.matchHistoryHomeFilter = !state.matchHistoryHomeFilter;
                // Sync main home filter
                state.homeFilter = state.matchHistoryHomeFilter;

                // Update all three checkboxes
                elements.matchHistoryHomeCheckbox.className = `checkbox ${state.matchHistoryHomeFilter ? 'checked' : ''}`;
                elements.homeCheckbox.className = `checkbox ${state.homeFilter ? 'checked' : ''}`;
                elements.h2hHomeCheckbox.className = `checkbox ${state.homeFilter ? 'checked' : ''}`;

                if (state.selectedTeam1 && !state.selectedTeam2) {
                    // Update match history display
                    const matchHistoryResult = calculateMatchHistory();
                    updateMatchHistoryDisplay(matchHistoryResult);

                    // Also update the main table to reflect filters
                    const tableResult = calculateTable();
                    updateTableDisplay(tableResult);
                    updateTableInfo(tableResult);
                }
            });

            elements.matchHistoryAwayCheckbox.addEventListener('click', () => {
                state.matchHistoryAwayFilter = !state.matchHistoryAwayFilter;
                // Sync main away filter
                state.awayFilter = state.matchHistoryAwayFilter;

                // Update all three checkboxes
                elements.matchHistoryAwayCheckbox.className = `checkbox ${state.matchHistoryAwayFilter ? 'checked' : ''}`;
                elements.awayCheckbox.className = `checkbox ${state.awayFilter ? 'checked' : ''}`;
                elements.h2hAwayCheckbox.className = `checkbox ${state.awayFilter ? 'checked' : ''}`;

                if (state.selectedTeam1 && !state.selectedTeam2) {
                    // Update match history display
                    const matchHistoryResult = calculateMatchHistory();
                    updateMatchHistoryDisplay(matchHistoryResult);

                    // Also update the main table to reflect filters
                    const tableResult = calculateTable();
                    updateTableDisplay(tableResult);
                    updateTableInfo(tableResult);
                }
            });

            elements.recentMatchesSelect.addEventListener('input', (e) => {
                let value = e.target.value.trim();

                // Allow empty input temporarily (user might be typing)
                if (value === '') {
                    // Don't update state or UI yet, let user continue typing
                    return;
                } else if (value.toLowerCase() === 'all') {
                    state.recentMatchesCount = 'All';
                } else {
                    // Validate numeric input
                    const numValue = parseInt(value);
                    if (!isNaN(numValue) && numValue > 0) {
                        state.recentMatchesCount = numValue.toString();
                    } else {
                        // Invalid input, don't update anything but don't revert either
                        return;
                    }
                }

                if (state.selectedTeam1 && !state.selectedTeam2) {
                    // Update match history display
                    const matchHistoryResult = calculateMatchHistory();
                    updateMatchHistoryDisplay(matchHistoryResult);

                    // Also update the main table to reflect filters
                    const tableResult = calculateTable();
                    updateTableDisplay(tableResult);
                    updateTableInfo(tableResult);
                }
            });

            // Add blur event to handle when user leaves the field empty
            elements.recentMatchesSelect.addEventListener('blur', (e) => {
                let value = e.target.value.trim();
                if (value === '') {
                    // If field is empty when user leaves, set to "All"
                    state.recentMatchesCount = 'All';
                    e.target.value = 'All';

                    if (state.selectedTeam1 && !state.selectedTeam2) {
                        const matchHistoryResult = calculateMatchHistory();
                        updateMatchHistoryDisplay(matchHistoryResult);
                        const tableResult = calculateTable();
                        updateTableDisplay(tableResult);
                        updateTableInfo(tableResult);
                    }
                }
            });

            // Buttons
            elements.resetBtn.addEventListener('click', clearFilters);
            
            // Last Time When controls
            elements.lastTimeTeam1Select.addEventListener('change', (e) => {
                state.lastTimeTeam1 = e.target.value;

                // If Team 2 is currently Big 6, update the Big 6 opponents for the new Team 1
                // but DON'T reset Team 2 selection
                if (state.lastTimeTeam2 === 'BIG_6') {
                    state.lastTimeBig6Opponents = getBig6Opponents(state.lastTimeTeam1);
                    updateLastTimeTeam2Options(); // Refresh options but keep Big 6 selected
                } else {
                    // Reset Team 2 selection and refresh its options (to show/hide Big 6)
                    state.lastTimeTeam2 = '';
                    elements.lastTimeTeam2Select.value = '';
                    updateLastTimeTeam2Options();
                }

                calculateLastTimeWhen();
            });
            
            elements.lastTimeTeam2Select.addEventListener('change', (e) => {
                // Handle Big 6 selection
                if (e.target.value === 'BIG_6') {
                    state.lastTimeTeam2 = 'BIG_6';
                    state.lastTimeBig6Opponents = getBig6Opponents(state.lastTimeTeam1);
                } else {
                    state.lastTimeTeam2 = e.target.value;
                    state.lastTimeBig6Opponents = null;
                }
                calculateLastTimeWhen();
            });
            
            elements.lastTimeDayOfWeekSelect.addEventListener('change', (e) => {
                state.lastTimeDayOfWeek = e.target.value;
                calculateLastTimeWhen();
            });
            
            elements.lastTimeLocationSelect.addEventListener('change', (e) => {
                // Location dropdown changed
                state.lastTimeLocation = e.target.value;
                // State updated
                calculateLastTimeWhen();
            });
            elements.retryBtn.addEventListener('click', () => {
                state.error = '';
                loadGistData();
            });

            // H2H controls
            elements.recentH2HSelect.addEventListener('input', (e) => {
                let value = e.target.value.trim();

                // Allow empty input temporarily (user might be typing)
                if (value === '') {
                    // Don't update state or UI yet, let user continue typing
                    return;
                } else if (value.toLowerCase() === 'all') {
                    state.recentH2HCount = 'All';
                } else {
                    // Validate numeric input
                    const numValue = parseInt(value);
                    if (!isNaN(numValue) && numValue > 0) {
                        state.recentH2HCount = numValue.toString();
                    } else {
                        // Invalid input, don't update anything but don't revert either
                        return;
                    }
                }

                updateTable();
            });

            // Add blur event to handle when user leaves the field empty
            elements.recentH2HSelect.addEventListener('blur', (e) => {
                let value = e.target.value.trim();
                if (value === '') {
                    // If field is empty when user leaves, set to "All"
                    state.recentH2HCount = 'All';
                    e.target.value = 'All';
                    updateTable();
                }
            });
            
            // Team Seasons controls
            elements.teamSeasonsLeagueButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.league-button');
                if (button) {
                    handleTeamSeasonsLeagueChange(button.dataset.league);
                }
            });
            
            elements.teamSeasonsTeamSelect.addEventListener('change', (e) => {
                handleTeamSeasonsTeamChange(e.target.value);
            });
            
            elements.teamSeasonsSeasonSelect.addEventListener('change', (e) => {
                handleTeamSeasonsSeasonChange(e.target.value);
            });
            
            elements.teamSeasonsPositionSelect.addEventListener('change', (e) => {
                handleTeamSeasonsPositionChange(e.target.value);
            });

            elements.includeBetterResultsCheckbox.addEventListener('click', () => {
                state.includeBetterResults = !state.includeBetterResults;
                elements.includeBetterResultsCheckbox.className = `checkbox ${state.includeBetterResults ? 'checked' : ''}`;

                // Refresh the current view
                if (state.teamSeasonsSelectedTeam) {
                    showTeamHistory(state.teamSeasonsSelectedTeam, state.teamSeasonsSelectedLeague);

                    // Re-show checkbox after showTeamHistory runs (same as position change logic)
                    setTimeout(() => {
                        if (state.teamSeasonsSelectedPosition) {
                            if (elements.includeBetterResultsContainer) {
                                elements.includeBetterResultsContainer.className = 'mt-3 flex items-center gap-2';
                                elements.includeBetterResultsContainer.removeAttribute('style');
                                elements.includeBetterResultsContainer.style.display = 'flex';

                                // Apply proper checkbox styling
                                if (state.includeBetterResults) {
                                    elements.includeBetterResultsCheckbox.style.backgroundColor = '#059669';
                                    elements.includeBetterResultsCheckbox.style.borderColor = '#059669';
                                    elements.includeBetterResultsCheckbox.style.border = '2px solid #059669';
                                    elements.includeBetterResultsCheckbox.innerHTML = '<div style="width: 0.5rem; height: 0.75rem; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); margin-top: -1px;"></div>';
                                } else {
                                    elements.includeBetterResultsCheckbox.style.backgroundColor = '';
                                    elements.includeBetterResultsCheckbox.style.borderColor = '#d1d5db';
                                    elements.includeBetterResultsCheckbox.style.border = '2px solid #d1d5db';
                                    elements.includeBetterResultsCheckbox.innerHTML = '';
                                }
                            }
                        }
                    }, 100);
                }
            });

            // Historic Seasons toggle event listener
            elements.historicSeasonsToggle.addEventListener('click', handleHistoricSeasonsToggle);

            // Collapse controls toggle event listener
            elements.collapseControlsBtn.addEventListener('click', toggleControlsCollapse);

            // Team Streaks controls
            elements.teamStreaksLeagueButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.league-button');
                if (button) {
                    handleTeamStreaksLeagueChange(button.dataset.league);
                }
            });
            
            elements.teamStreaksStatusSelect.addEventListener('change', (e) => {
                handleTeamStreaksStatusChange(e.target.value);
            });
            
            elements.teamStreaksLocationSelect.addEventListener('change', (e) => {
                handleTeamStreaksLocationChange(e.target.value);
            });
            
            elements.teamStreaksTypeSelect.addEventListener('change', (e) => {
                handleTeamStreaksTypeChange(e.target.value);
            });
            
            elements.teamStreaksTeam1Select.addEventListener('change', (e) => {
                handleTeamStreaksTeam1Change(e.target.value);
            });
            
            elements.teamStreaksTeam2Select.addEventListener('change', (e) => {
                handleTeamStreaksTeam2Change(e.target.value);
            });
        }

        // Intelligent point deductions logic based on team selection
        function checkAndDisablePointDeductions() {
            if (state.selectedTeam1 || state.selectedTeam2) {
                // 1 or 2 teams selected - disable point deductions
                state.pointDeductionsEnabled = false;
                elements.deductionsCheckbox.className = 'checkbox';
            } else {
                // No teams selected - enable point deductions by default
                state.pointDeductionsEnabled = true;
                elements.deductionsCheckbox.className = 'checkbox checked';
            }
        }

        // Handle league change
        async function handleLeagueChange(newLeague) {
            state.selectedLeague = newLeague;
            state.selectedTeam1 = '';
            state.selectedTeam2 = '';
            state.selectedSeason = '';
            
            // Load league data if not already loaded
            if (!state.loadedLeagues || !state.loadedLeagues.has(newLeague)) {
                await loadLeagueDataForDevice(newLeague);
            } else {
                // If already loaded, just filter/update UI
                filterDataForCurrentLeague(newLeague);
            }
            
            // Reset Last Time When state
            state.lastTimeTeam1 = '';
            state.lastTimeTeam2 = '';
            state.lastTimeDayOfWeek = '';
            state.lastTimeLocation = '';
            
            // Reset Last Time When UI elements
            if (elements.lastTimeTeam1Select) elements.lastTimeTeam1Select.value = '';
            if (elements.lastTimeTeam2Select) elements.lastTimeTeam2Select.value = '';
            if (elements.lastTimeDayOfWeekSelect) elements.lastTimeDayOfWeekSelect.value = '';
            if (elements.lastTimeLocationSelect) elements.lastTimeLocationSelect.value = '';
            
            // Hide Last Time When results
            if (elements.lastTimeResults) elements.lastTimeResults.classList.add('hidden');
            hideAllLastTimeSections();
            
            createLeagueButtons();
            updateTeamSelects();
            updateTeamSeasonsTeamSelect();
            updateSeasonOptions();
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1', 
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            // Set default date ranges for specific leagues
            if (newLeague === 'premier-league') {
                state.dateFrom = '1992-08-01';
                state.dateTo = '2026-06-30';
            } else if (newLeague === 'ligue-1') {
                state.dateFrom = '2002-07-01';
                state.dateTo = '2026-06-30';
            } else {
                // For other leagues, use the full data range
                const leagueData = state.data.filter(row => row.Div === leagueMapping[newLeague]);
                if (leagueData.length > 0) {
                    const dates = leagueData.map(row => row.dateObj);
                    const minDate = new Date(Math.min(...dates));
                    const maxDate = new Date(Math.max(...dates));
                    state.dateFrom = minDate.toISOString().split('T')[0];
                    state.dateTo = maxDate.toISOString().split('T')[0];
                }
            }
            
            elements.dateFrom.value = state.dateFrom;
            elements.dateTo.value = state.dateTo;
            
            updateTable();
        }

        // Handle season change
        function handleSeasonChange(seasonKey) {
            state.selectedSeason = seasonKey;

            // Automatically set 3-point system based on season type
            if (seasonKey === '' || !seasonKey) {
                // No season selected (custom date range) - keep 3-point system ON
                state.threePointSystem = true;
            } else if (seasonKey.includes('-era-') || seasonKey.includes('all-') || seasonKey.includes('french-division-1')) {
                // Era filters - keep 3-point system ON
                state.threePointSystem = true;
            } else {
                // Individual season - turn 3-point system OFF (use historical)
                state.threePointSystem = false;
            }

            // Update checkbox UI
            elements.threePointCheckbox.className = `checkbox ${state.threePointSystem ? 'checked' : ''}`;

            // Set point deductions based on season type
            if (seasonKey === '' || !seasonKey) {
                // No season selected (custom date range) - disable point deductions
                state.pointDeductionsEnabled = false;
                elements.deductionsCheckbox.className = 'checkbox';
            } else {
                // Season or era filter selected - enable point deductions by default
                state.pointDeductionsEnabled = true;
                elements.deductionsCheckbox.className = 'checkbox checked';
            }

            const seasonData = getSeasonDateRange(seasonKey);
            if (seasonData) {
                state.dateFrom = seasonData.start;
                state.dateTo = seasonData.end;
                elements.dateFrom.value = state.dateFrom;
                elements.dateTo.value = state.dateTo;
                updateTable();
            }
        }

        // Get season date range
        function getSeasonDateRange(seasonKey) {
            if (seasonKey === 'ligue-1-era-2002-2025') {
                return { start: '2002-07-01', end: '2026-06-30' };
            }
            if (seasonKey === 'french-division-1-1932-2002') {
                return { start: '1932-07-01', end: '2002-06-30' };
            }
            if (seasonKey === 'all-french-seasons-1932-2025') {
                return { start: '1932-07-01', end: '2026-06-30' };
            }
            if (seasonKey === 'premier-league-era-1992-2025') {
                return { start: '1992-08-01', end: '2026-06-30' };
            }
            if (seasonKey === 'english-first-division-era-1888-1992') {
                return { start: '1888-09-08', end: '1992-05-25' };
            }
            if (seasonKey === 'all-english-seasons-1888-2025') {
                return { start: '1888-08-01', end: '2026-06-30' };
            }
            if (seasonKey === 'all-spanish-seasons-1928-2025') {
                return { start: '1929-01-01', end: '2026-06-30' };
            }
            if (seasonKey === 'all-italian-seasons-1929-2025') {
                return { start: '1929-07-01', end: '2026-06-30' };
            }
            if (seasonKey === 'all-german-seasons-1963-2025') {
                return { start: '1963-07-01', end: '2026-06-30' };
            }
            
            if (seasons[state.selectedLeague] && seasons[state.selectedLeague][seasonKey]) {
                return seasons[state.selectedLeague][seasonKey];
            }
            return null;
        }

        // Combobox functionality
        class Combobox {
            constructor(containerId, inputId, dropdownId, placeholder, onSelect) {
                this.containerId = containerId;
                this.container = document.getElementById(containerId);
                this.input = document.getElementById(inputId);
                this.dropdown = document.getElementById(dropdownId);
                this.placeholder = placeholder;
                this.onSelect = onSelect;
                this.options = [];
                this.filteredOptions = [];
                this.selectedIndex = -1;
                this.isOpen = false;

                this.init();
            }

            init() {
                // Input events
                this.input.addEventListener('focus', () => this.open());
                this.input.addEventListener('blur', () => {
                    // Delay close to allow for option click
                    setTimeout(() => this.close(), 150);
                });
                this.input.addEventListener('input', (e) => this.filterOptions(e.target.value));
                this.input.addEventListener('keydown', (e) => this.handleKeyDown(e));

                // Click arrow to toggle
                this.container.querySelector('.combobox-arrow').addEventListener('click', () => {
                    if (this.isOpen) {
                        this.close();
                    } else {
                        this.input.focus();
                        this.open();
                    }
                });

                // Click outside to close
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.close();
                    }
                });
            }

            setOptions(options) {
                this.options = options;
                this.filteredOptions = [...options];
                this.renderOptions();
            }

            filterOptions(query) {
                const lowerQuery = query.toLowerCase();
                this.filteredOptions = this.options.filter(option =>
                    option.text.toLowerCase().includes(lowerQuery)
                );
                this.selectedIndex = -1;
                this.renderOptions();

                // If user empties the field, select the empty option
                if (query === '') {
                    const emptyOption = this.options.find(opt => opt.value === '');
                    if (emptyOption && this.onSelect) {
                        this.onSelect(emptyOption.value, emptyOption.text);
                    }
                }

                if (!this.isOpen) {
                    this.open();
                }
            }

            renderOptions() {
                if (this.filteredOptions.length === 0) {
                    this.dropdown.innerHTML = '<div class="combobox-no-results">No teams found</div>';
                    return;
                }

                this.dropdown.innerHTML = this.filteredOptions.map((option, index) => {
                    // Get team logo if this is a team option (not empty option)
                    const logoHtml = option.value && option.value !== '' ? (() => {
                        // Determine which league to use based on the combobox container
                        let leagueToUse = state.selectedLeague;
                        if (this.containerId === 'teamSeasonsComboboxContainer') {
                            leagueToUse = state.teamSeasonsSelectedLeague || state.selectedLeague;
                        } else if (this.containerId === 'lastTimeTeam1ComboboxContainer' || this.containerId === 'lastTimeTeam2ComboboxContainer') {
                            leagueToUse = state.selectedLeague;
                        } else if (this.containerId === 'teamStreaksTeam1ComboboxContainer' || this.containerId === 'teamStreaksTeam2ComboboxContainer') {
                            leagueToUse = state.selectedLeague;
                        }

                        const logoUrl = getTeamLogoUrl(option.value, leagueToUse);
                        return logoUrl ? `<img src="${logoUrl}" alt="${option.value} logo" class="combobox-team-logo" onerror="this.style.display='none'">` : '';
                    })() : '';

                    return `<div class="combobox-option ${index === this.selectedIndex ? 'highlighted' : ''}"
                              data-value="${option.value}" data-index="${index}">
                            ${logoHtml}
                            <span class="combobox-option-text">${option.text}</span>
                         </div>`;
                }).join('');

                // Add click events to options
                this.dropdown.querySelectorAll('.combobox-option').forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectOption(option.dataset.value, option.querySelector('.combobox-option-text').textContent.trim());
                    });
                });
            }

            handleKeyDown(e) {
                if (!this.isOpen) return;

                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.selectedIndex = Math.min(this.selectedIndex + 1, this.filteredOptions.length - 1);
                        this.updateHighlight();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                        this.updateHighlight();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.selectedIndex >= 0) {
                            const option = this.filteredOptions[this.selectedIndex];
                            this.selectOption(option.value, option.text);
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        this.close();
                        break;
                }
            }

            updateHighlight() {
                this.dropdown.querySelectorAll('.combobox-option').forEach((option, index) => {
                    option.classList.toggle('highlighted', index === this.selectedIndex);
                });
            }

            selectOption(value, text) {
                this.input.value = text;
                this.close();
                if (this.onSelect) {
                    this.onSelect(value, text);
                }
            }

            open() {
                this.isOpen = true;
                this.container.classList.add('open');
                this.renderOptions();
            }

            close() {
                this.isOpen = false;
                this.container.classList.remove('open');
                this.selectedIndex = -1;
            }

            setValue(value, text) {
                this.input.value = text || this.placeholder;
            }
        }

        // Initialize comboboxes
        let team1Combobox, team2Combobox, teamSeasonsCombobox, lastTimeTeam1Combobox, lastTimeTeam2Combobox, teamStreaksTeam1Combobox, teamStreaksTeam2Combobox;

        // Update team selects
        function updateTeamSelects() {
            const leagueTeams = getLeagueTeams();

            const team1Options = '<option value="">All Teams</option>' +
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');
            const team2Options = '<option value="">No Team</option>' +
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');

            elements.team1Select.innerHTML = team1Options;
            elements.team2Select.innerHTML = team2Options;

            // Initialize comboboxes if they don't exist
            if (!team1Combobox) {
                team1Combobox = new Combobox(
                    'team1ComboboxContainer',
                    'team1ComboboxInput',
                    'team1ComboboxDropdown',
                    'All Teams',
                    (value, text) => {
                        state.selectedTeam1 = value;
                        elements.team1Select.value = value;

                        // Reset Team 2 selection and refresh its options (to show/hide Big 6)
                        state.selectedTeam2 = '';
                        state.big6Opponents = null;
                        elements.team2Select.value = '';
                        team2Combobox.input.value = 'No Team';
                        updateTeamSelects(); // This will refresh Team 2 options with/without Big 6

                        // Trigger same logic as original dropdown
                        updateTable();
                    }
                );
            }

            if (!team2Combobox) {
                team2Combobox = new Combobox(
                    'team2ComboboxContainer',
                    'team2ComboboxInput',
                    'team2ComboboxDropdown',
                    'No Team',
                    (value, text) => {
                        // Handle Big 6 selection
                        if (value === 'BIG_6') {
                            state.selectedTeam2 = 'BIG_6';
                            state.big6Opponents = getBig6Opponents(state.selectedTeam1);
                        } else {
                            state.selectedTeam2 = value;
                            state.big6Opponents = null;
                        }
                        elements.team2Select.value = value;
                        // Trigger same logic as original dropdown
                        updateTable();
                    }
                );
            }

            // Populate combobox options
            const team1ComboOptions = [
                { value: '', text: 'All Teams' },
                ...leagueTeams.map(team => ({ value: team, text: team }))
            ];

            // Build Team 2 options with conditional Big 6 option
            let team2ComboOptions = [{ value: '', text: 'No Team' }];

            // Add Big 6 option if Team 1 is selected and we're in Premier League
            if (state.selectedTeam1 && state.selectedLeague === 'premier-league') {
                team2ComboOptions.push({ value: 'BIG_6', text: 'Big 6' });
            }

            // Add all regular teams
            team2ComboOptions.push(...leagueTeams.map(team => ({ value: team, text: team })));

            team1Combobox.setOptions(team1ComboOptions);
            team2Combobox.setOptions(team2ComboOptions);

            // Initialize Team Seasons combobox
            if (!teamSeasonsCombobox) {
                teamSeasonsCombobox = new Combobox(
                    'teamSeasonsComboboxContainer',
                    'teamSeasonsComboboxInput',
                    'teamSeasonsComboboxDropdown',
                    'Choose a team...',
                    (value, text) => {
                        handleTeamSeasonsTeamChange(value);
                    }
                );
            }

            // Initialize Last Time When comboboxes
            if (!lastTimeTeam1Combobox) {
                lastTimeTeam1Combobox = new Combobox(
                    'lastTimeTeam1ComboboxContainer',
                    'lastTimeTeam1ComboboxInput',
                    'lastTimeTeam1ComboboxDropdown',
                    'Select Team 1',
                    (value, text) => {
                        // If Team 2 is currently Big 6, update the Big 6 opponents for the new Team 1
                        // but DON'T reset the combobox selection
                        if (state.lastTimeTeam2 === 'BIG_6') {
                            state.lastTimeBig6Opponents = getBig6Opponents(value);
                        }

                        elements.lastTimeTeam1Select.value = value;
                        elements.lastTimeTeam1Select.dispatchEvent(new Event('change'));

                        // Update Team 2 combobox options to show/hide Big 6
                        let updatedTeam2Options = [
                            { value: '', text: 'Select Team 2' }
                        ];

                        // Add Big 6 option if Team 1 is selected and we're in Premier League
                        if (value && state.selectedLeague === 'premier-league') {
                            updatedTeam2Options.push({ value: 'BIG_6', text: 'Big 6' });
                        }

                        // Add all other teams
                        const leagueTeams = getLeagueTeams(state.selectedLeague);
                        updatedTeam2Options = updatedTeam2Options.concat(leagueTeams.map(team => ({ value: team, text: team })));
                        lastTimeTeam2Combobox.setOptions(updatedTeam2Options);

                        // If Team 2 was Big 6, restore the selection in the combobox
                        if (state.lastTimeTeam2 === 'BIG_6') {
                            lastTimeTeam2Combobox.setValue('BIG_6', 'Big 6');
                        }
                    }
                );
            }

            if (!lastTimeTeam2Combobox) {
                lastTimeTeam2Combobox = new Combobox(
                    'lastTimeTeam2ComboboxContainer',
                    'lastTimeTeam2ComboboxInput',
                    'lastTimeTeam2ComboboxDropdown',
                    'Select Team 2',
                    (value, text) => {
                        elements.lastTimeTeam2Select.value = value;
                        elements.lastTimeTeam2Select.dispatchEvent(new Event('change'));
                    }
                );
            }

            // Initialize Team Streaks comboboxes
            if (!teamStreaksTeam1Combobox) {
                teamStreaksTeam1Combobox = new Combobox(
                    'teamStreaksTeam1ComboboxContainer',
                    'teamStreaksTeam1ComboboxInput',
                    'teamStreaksTeam1ComboboxDropdown',
                    'Select Team 1',
                    (value, text) => {
                        // If Team 2 is currently Big 6, update the Big 6 opponents for the new Team 1
                        // but DON'T reset the combobox selection
                        if (elements.teamStreaksTeam2Select.value === 'BIG_6') {
                            state.teamStreaksBig6Opponents = getBig6Opponents(value);
                        }

                        elements.teamStreaksTeam1Select.value = value;
                        elements.teamStreaksTeam1Select.dispatchEvent(new Event('change'));

                        // Update Team 2 regular dropdown options too
                        updateTeamStreaksTeam2Options();

                        // Update Team 2 combobox options to show/hide Big 6
                        let updatedTeam2Options = [
                            { value: '', text: 'Select Team 2' }
                        ];

                        // Add Big 6 option if Team 1 is selected and we're in Premier League
                        if (value && state.selectedLeague === 'premier-league') {
                            updatedTeam2Options.push({ value: 'BIG_6', text: 'Big 6' });
                        }

                        // Add all other teams
                        const leagueTeams = getLeagueTeams(state.selectedLeague);
                        updatedTeam2Options = updatedTeam2Options.concat(leagueTeams.map(team => ({ value: team, text: team })));
                        teamStreaksTeam2Combobox.setOptions(updatedTeam2Options);

                        // If Team 2 was Big 6, restore the selection in the combobox
                        if (elements.teamStreaksTeam2Select.value === 'BIG_6') {
                            teamStreaksTeam2Combobox.setValue('BIG_6', 'Big 6');
                        }
                    }
                );
            }

            if (!teamStreaksTeam2Combobox) {
                teamStreaksTeam2Combobox = new Combobox(
                    'teamStreaksTeam2ComboboxContainer',
                    'teamStreaksTeam2ComboboxInput',
                    'teamStreaksTeam2ComboboxDropdown',
                    'Select Team 2',
                    (value, text) => {
                        elements.teamStreaksTeam2Select.value = value;
                        elements.teamStreaksTeam2Select.dispatchEvent(new Event('change'));
                    }
                );
            }

            // Populate all combobox options
            const currentLeagueTeams = getLeagueTeams(state.selectedLeague);
            const teamSeasonsLeagueTeams = getLeagueTeams(state.teamSeasonsSelectedLeague || state.selectedLeague);
            const teamComboOptions = [
                { value: '', text: 'Choose a team...' },
                ...teamSeasonsLeagueTeams.map(team => ({ value: team, text: team }))
            ];
            const lastTimeTeam1ComboOptions = [
                { value: '', text: 'Select Team 1' },
                ...currentLeagueTeams.map(team => ({ value: team, text: team }))
            ];
            let lastTimeTeam2ComboOptions = [
                { value: '', text: 'Select Team 2' }
            ];

            // Add Big 6 option if Team 1 is selected and we're in Premier League
            if (state.lastTimeTeam1 && state.selectedLeague === 'premier-league') {
                lastTimeTeam2ComboOptions.push({ value: 'BIG_6', text: 'Big 6' });
            }

            // Add all other teams
            lastTimeTeam2ComboOptions = lastTimeTeam2ComboOptions.concat(currentLeagueTeams.map(team => ({ value: team, text: team })));
            const teamStreaksTeam1ComboOptions = [
                { value: '', text: 'Select Team 1' },
                ...currentLeagueTeams.map(team => ({ value: team, text: team }))
            ];
            let teamStreaksTeam2ComboOptions = [
                { value: '', text: 'Select Team 2' }
            ];

            // Add Big 6 option if Team 1 is selected and we're in Premier League
            if (elements.teamStreaksTeam1Select.value && state.selectedLeague === 'premier-league') {
                teamStreaksTeam2ComboOptions.push({ value: 'BIG_6', text: 'Big 6' });
            }

            // Add all other teams
            teamStreaksTeam2ComboOptions = teamStreaksTeam2ComboOptions.concat(currentLeagueTeams.map(team => ({ value: team, text: team })));

            teamSeasonsCombobox.setOptions(teamComboOptions);
            lastTimeTeam1Combobox.setOptions(lastTimeTeam1ComboOptions);
            lastTimeTeam2Combobox.setOptions(lastTimeTeam2ComboOptions);
            teamStreaksTeam1Combobox.setOptions(teamStreaksTeam1ComboOptions);
            teamStreaksTeam2Combobox.setOptions(teamStreaksTeam2ComboOptions);

            // Also populate Last Time When team selects (for backward compatibility)
            const lastTimeTeam1Options = '<option value="">Select Team 1</option>' +
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');

            elements.lastTimeTeam1Select.innerHTML = lastTimeTeam1Options;
            updateLastTimeTeam2Options();

            elements.team1Select.value = state.selectedTeam1;
            elements.team2Select.value = state.selectedTeam2;

            // Update combobox values
            const team1Text = state.selectedTeam1 || 'All Teams';
            const team2Text = state.selectedTeam2 || 'No Team';
            team1Combobox.setValue(state.selectedTeam1, team1Text);
            team2Combobox.setValue(state.selectedTeam2, team2Text);

            // Update other combobox values
            const teamSeasonsText = state.teamSeasonsSelectedTeam || 'Choose a team...';
            teamSeasonsCombobox.setValue(state.teamSeasonsSelectedTeam, teamSeasonsText);

            // Set default values for Last Time When and Team Streaks comboboxes
            lastTimeTeam1Combobox.setValue('', 'Select Team 1');
            lastTimeTeam2Combobox.setValue('', 'Select Team 2');
            teamStreaksTeam1Combobox.setValue('', 'Select Team 1');
            teamStreaksTeam2Combobox.setValue('', 'Select Team 2');
        }

        // Helper function to hide all Last Time sections
        function hideAllLastTimeSections() {
            elements.team1HomeWinSection.classList.add('hidden');
            elements.team1AwayWinSection.classList.add('hidden');
            elements.team1HomeDrawSection.classList.add('hidden');
            elements.team1AwayDrawSection.classList.add('hidden');
            elements.team1HomeLossSection.classList.add('hidden');
            elements.team1AwayLossSection.classList.add('hidden');
        }

        // Helper function to create match table row (matching Head-to-Head format)
        function createMatchTableRow(match) {
            const homeTeamColor = getTeamColor(match.HomeTeam, state.selectedLeague);
            const awayTeamColor = getTeamColor(match.AwayTeam, state.selectedLeague);
            
            const homeScore = parseInt(match.FTHG) || 0;
            const awayScore = parseInt(match.FTAG) || 0;
            
            // Determine winner and apply highlighting like Head-to-Head tables
            let homeScoreClass = '';
            let awayScoreClass = '';
            let resultStyle = '';
            let winnerTeam = '';
            
            if (homeScore > awayScore) {
                // Home team wins
                winnerTeam = match.HomeTeam;
                homeScoreClass = 'font-bold win-score';
                awayScoreClass = 'text-red-600 font-bold';
                resultStyle = homeTeamColor ? 
                    `color: ${homeTeamColor} !important; font-weight: bold;` : 
                    'color: #059669 !important; font-weight: bold;';
            } else if (awayScore > homeScore) {
                // Away team wins
                winnerTeam = match.AwayTeam;
                homeScoreClass = 'text-red-600 font-bold';
                awayScoreClass = 'font-bold win-score';
                resultStyle = awayTeamColor ? 
                    `color: ${awayTeamColor} !important; font-weight: bold;` : 
                    'color: #059669 !important; font-weight: bold;';
            } else {
                // Draw
                winnerTeam = 'Draw';
                homeScoreClass = 'text-gray-400 font-bold draw-score';
                awayScoreClass = 'text-gray-400 font-bold draw-score';
                resultStyle = 'color: #9ca3af !important; font-weight: bold;';
            }

            // Add team highlights - Team 1 green, Team 2 blue (like Head-to-Head)
            const isHomeTeam1 = match.HomeTeam === state.lastTimeTeam1;
            const isHomeTeam2 = match.HomeTeam === state.lastTimeTeam2;
            const isAwayTeam1 = match.AwayTeam === state.lastTimeTeam1;
            const isAwayTeam2 = match.AwayTeam === state.lastTimeTeam2;
            
            const homeTeamClass = isHomeTeam1 ? 'team1-highlight' : 
                                isHomeTeam2 ? 'team2-highlight' : '';
            const awayTeamClass = isAwayTeam1 ? 'team1-highlight' : 
                                isAwayTeam2 ? 'team2-highlight' : '';

            // Team styling (matching Head-to-Head format)
            const homeTeamStyle = homeTeamColor ? `color: ${homeTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
            const awayTeamStyle = awayTeamColor ? `color: ${awayTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
            
            // Result highlighting for winner
            let resultClass = '';
            if (winnerTeam !== 'Draw') {
                if (winnerTeam === state.lastTimeTeam1) {
                    resultClass = 'team1-highlight';
                } else if (winnerTeam === state.lastTimeTeam2) {
                    resultClass = 'team2-highlight';
                }
            }
            
            // Get team logos
            const homeLogoUrl = getTeamLogoUrl(match.HomeTeam, state.selectedLeague);
            const awayLogoUrl = getTeamLogoUrl(match.AwayTeam, state.selectedLeague);
            
            // Get winner logo for result column (if not a draw)
            const winnerLogoUrl = winnerTeam !== 'Draw' ? getTeamLogoUrl(winnerTeam, state.selectedLeague) : null;
            
            return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="text-center text-sm">${match.dateObj.toLocaleDateString('en-US')}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${homeLogoUrl ? `<img src="${homeLogoUrl}" alt="${match.HomeTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${homeTeamClass}" style="${homeTeamStyle}">${match.HomeTeam}</span>
                        </div>
                    </td>
                    <td class="text-center text-lg ${homeScoreClass}" >${homeScore}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${awayLogoUrl ? `<img src="${awayLogoUrl}" alt="${match.AwayTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${awayTeamClass}" style="${awayTeamStyle}">${match.AwayTeam}</span>
                        </div>
                    </td>
                    <td class="text-center text-lg ${awayScoreClass}" >${awayScore}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${winnerLogoUrl ? `<img src="${winnerLogoUrl}" alt="${winnerTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${resultClass}" style="${resultStyle}">${winnerTeam}</span>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Helper function to populate a result section
        function populateResultSection(sectionElement, bodyElement, daysElement, titleElement, result, team1Name, team2Name, resultType, isHome) {
            if (result) {
                sectionElement.classList.remove('hidden');
                bodyElement.innerHTML = createMatchTableRow(result);
                
                const daysSince = Math.floor((new Date() - result.dateObj) / (1000 * 60 * 60 * 24));
                daysElement.textContent = `${daysSince} days ago`;
                
                const location = isHome ? 'at Home' : 'Away';
                const color = resultType === 'Won' ? 'text-green-700' : resultType === 'Drew' ? 'text-gray-600' : 'text-red-600';
                titleElement.className = `text-lg font-semibold ${color} mb-3`;
                
                // Get team colors
                const team1Color = getTeamColor(team1Name, state.selectedLeague);
                const team2Color = team2Name === 'BIG_6' ? '#1e3a8a' : (team2Name ? getTeamColor(team2Name, state.selectedLeague) : null);
                
                // Use different title format for single-team vs two-team mode
                if (team2Name && team2Name !== team1Name) {
                    // Two-team mode: Last [Result] [Location] vs [Team2]
                    const resultWord = resultType === 'Won' ? 'Win' : resultType === 'Drew' ? 'Draw' : 'Loss';
                    const team2DisplayName = getTeamDisplayName(team2Name);
                    titleElement.innerHTML = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1Name}</span> Last ${resultWord} ${location} vs <span style="color: ${team2Color || '#374151'}; font-weight: bold;">${team2DisplayName}</span>`;
                } else {
                    // Single-team mode: simple format
                    const resultWord = resultType === 'Won' ? 'Win' : resultType === 'Drew' ? 'Draw' : 'Loss';
                    titleElement.innerHTML = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1Name}</span> Last ${resultWord} ${location}`;
                }
            }
        }

        // Update Last Time When Team 2 options to include Big 6 if applicable
        function updateLastTimeTeam2Options() {
            const leagueTeams = getLeagueTeams(state.selectedLeague);
            let team2Options = ['<option value="">Select Team 2</option>'];

            // Add Big 6 option if Team 1 is selected and we're in Premier League
            if (state.lastTimeTeam1 && state.selectedLeague === 'premier-league') {
                team2Options.push('<option value="BIG_6">Big 6</option>');
            }

            // Add all other teams
            team2Options = team2Options.concat(leagueTeams.map(team => `<option value="${team}">${team}</option>`));

            elements.lastTimeTeam2Select.innerHTML = team2Options.join('');

            // Restore the current selection if it's still valid
            if (state.lastTimeTeam2) {
                elements.lastTimeTeam2Select.value = state.lastTimeTeam2;
            }
        }

        // Calculate last time when results
        function calculateLastTimeWhen() {
            if (!state.lastTimeTeam1) {
                elements.lastTimeResults.classList.add('hidden');
                return;
            }
            
            // Handle single team scenario (Team 1 only selected)
            if (!state.lastTimeTeam2) {
                calculateSingleTeamResults();
                return;
            }
            
            if (state.lastTimeTeam1 === state.lastTimeTeam2) {
                elements.lastTimeResults.classList.add('hidden');
                return;
            }
            
            // Hide all sections initially
            hideAllLastTimeSections();
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1', 
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            let matches;
            if (state.lastTimeTeam2 === 'BIG_6' && state.lastTimeBig6Opponents) {
                // Filter for matches where Team 1 played against any Big 6 opponent
                matches = state.data.filter(row =>
                    row.Div === leagueMapping[state.selectedLeague] &&
                    ((row.HomeTeam === state.lastTimeTeam1 && state.lastTimeBig6Opponents.includes(row.AwayTeam)) ||
                     (row.AwayTeam === state.lastTimeTeam1 && state.lastTimeBig6Opponents.includes(row.HomeTeam)))
                );
            } else {
                // Regular head-to-head matches
                matches = state.data.filter(row =>
                    row.Div === leagueMapping[state.selectedLeague] &&
                    ((row.HomeTeam === state.lastTimeTeam1 && row.AwayTeam === state.lastTimeTeam2) ||
                     (row.HomeTeam === state.lastTimeTeam2 && row.AwayTeam === state.lastTimeTeam1))
                );
            }
            
            // Apply day of week filter if selected
            if (state.lastTimeDayOfWeek !== '') {
                matches = matches.filter(row => {
                    const dayOfWeek = row.dateObj.getDay();
                    return dayOfWeek.toString() === state.lastTimeDayOfWeek;
                });
            }
            
            // Apply location filter if selected
            // Location filter state
            // Matches before location filter
            if (state.lastTimeLocation !== '') {
                matches = matches.filter(row => {
                    if (state.lastTimeLocation === 'home') {
                        // Only show matches where Team 1 was playing at home
                        // Filtering for home matches
                        return row.HomeTeam === state.lastTimeTeam1;
                    } else if (state.lastTimeLocation === 'away') {
                        // Only show matches where Team 1 was playing away
                        // Filtering for away matches
                        return row.AwayTeam === state.lastTimeTeam1;
                    }
                    // If 'Both Home and Away' or empty, show all matches (no filtering)
                    return true;
                });
                // Matches after location filter
            }
            
            // Sort matches by date (most recent first)
            matches.sort((a, b) => b.dateObj - a.dateObj);
            
            // Find last occurrence of each result type
            const results = {
                team1HomeWin: null,    // Team 1 won at home
                team1AwayWin: null,    // Team 1 won away
                team1HomeDraw: null,   // Team 1 drew at home
                team1AwayDraw: null,   // Team 1 drew away
                team1HomeLoss: null,   // Team 1 lost at home
                team1AwayLoss: null    // Team 1 lost away
            };
            
            matches.forEach(match => {
                const homeScore = parseInt(match.FTHG) || 0;
                const awayScore = parseInt(match.FTAG) || 0;

                // Determine if this match involves Team 1 and the opponent(s)
                let isTeam1Home = false;
                let isTeam1Away = false;

                if (state.lastTimeTeam2 === 'BIG_6' && state.lastTimeBig6Opponents) {
                    // Big 6 mode: check if Team 1 played against any Big 6 opponent
                    isTeam1Home = match.HomeTeam === state.lastTimeTeam1 && state.lastTimeBig6Opponents.includes(match.AwayTeam);
                    isTeam1Away = match.AwayTeam === state.lastTimeTeam1 && state.lastTimeBig6Opponents.includes(match.HomeTeam);
                } else {
                    // Regular mode: exact team match
                    isTeam1Home = match.HomeTeam === state.lastTimeTeam1 && match.AwayTeam === state.lastTimeTeam2;
                    isTeam1Away = match.HomeTeam === state.lastTimeTeam2 && match.AwayTeam === state.lastTimeTeam1;
                }

                if (isTeam1Home) {
                    // Team 1 is home
                    if (homeScore > awayScore && !results.team1HomeWin) {
                        results.team1HomeWin = match;
                    } else if (homeScore === awayScore && !results.team1HomeDraw) {
                        results.team1HomeDraw = match;
                    } else if (homeScore < awayScore && !results.team1HomeLoss) {
                        results.team1HomeLoss = match;
                    }
                } else if (isTeam1Away) {
                    // Team 1 is away
                    if (awayScore > homeScore && !results.team1AwayWin) {
                        results.team1AwayWin = match;
                    } else if (homeScore === awayScore && !results.team1AwayDraw) {
                        results.team1AwayDraw = match;
                    } else if (homeScore > awayScore && !results.team1AwayLoss) {
                        results.team1AwayLoss = match;
                    }
                }
            });
            
            // Populate the 6 result sections
            populateResultSection(
                elements.team1HomeWinSection, elements.team1HomeWinBody, elements.team1HomeWinDays,
                elements.team1HomeWinTitle, results.team1HomeWin, state.lastTimeTeam1, state.lastTimeTeam2, 'Won', true
            );
            
            populateResultSection(
                elements.team1AwayWinSection, elements.team1AwayWinBody, elements.team1AwayWinDays,
                elements.team1AwayWinTitle, results.team1AwayWin, state.lastTimeTeam1, state.lastTimeTeam2, 'Won', false
            );
            
            populateResultSection(
                elements.team1HomeDrawSection, elements.team1HomeDrawBody, elements.team1HomeDrawDays,
                elements.team1HomeDrawTitle, results.team1HomeDraw, state.lastTimeTeam1, state.lastTimeTeam2, 'Drew', true
            );
            
            populateResultSection(
                elements.team1AwayDrawSection, elements.team1AwayDrawBody, elements.team1AwayDrawDays,
                elements.team1AwayDrawTitle, results.team1AwayDraw, state.lastTimeTeam1, state.lastTimeTeam2, 'Drew', false
            );
            
            populateResultSection(
                elements.team1HomeLossSection, elements.team1HomeLossBody, elements.team1HomeLossDays,
                elements.team1HomeLossTitle, results.team1HomeLoss, state.lastTimeTeam1, state.lastTimeTeam2, 'Lost', true
            );
            
            populateResultSection(
                elements.team1AwayLossSection, elements.team1AwayLossBody, elements.team1AwayLossDays,
                elements.team1AwayLossTitle, results.team1AwayLoss, state.lastTimeTeam1, state.lastTimeTeam2, 'Lost', false
            );
            
            // Show results
            elements.lastTimeResults.classList.remove('hidden');
        }

        // Calculate single team results (Team 1 vs all opponents)
        function calculateSingleTeamResults() {
            // Hide all sections initially
            hideAllLastTimeSections();
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1', 
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            let matches = state.data.filter(row => 
                row.Div === leagueMapping[state.selectedLeague] &&
                (row.HomeTeam === state.lastTimeTeam1 || row.AwayTeam === state.lastTimeTeam1)
            );
            
            // Apply day of week filter if selected
            if (state.lastTimeDayOfWeek !== '') {
                matches = matches.filter(row => {
                    const dayOfWeek = row.dateObj.getDay();
                    return dayOfWeek.toString() === state.lastTimeDayOfWeek;
                });
            }
            
            // Apply location filter if selected
            // Single team - Location filter state
            // Single team - Matches before location filter
            if (state.lastTimeLocation !== '') {
                matches = matches.filter(row => {
                    if (state.lastTimeLocation === 'home') {
                        // Only show matches where Team 1 was playing at home
                        // Single team - Filtering for home matches
                        return row.HomeTeam === state.lastTimeTeam1;
                    } else if (state.lastTimeLocation === 'away') {
                        // Only show matches where Team 1 was playing away
                        // Single team - Filtering for away matches
                        return row.AwayTeam === state.lastTimeTeam1;
                    }
                    // If 'Both Home and Away' or empty, show all matches (no filtering)
                    return true;
                });
                // Single team - Matches after location filter
            }
            
            // Sort matches by date (most recent first)
            matches.sort((a, b) => b.dateObj - a.dateObj);
            
            const today = new Date();
            
            // Find last occurrence of each result type
            const results = {
                team1HomeWin: null,
                team1HomeDraw: null,
                team1HomeLoss: null,
                team1AwayWin: null,
                team1AwayDraw: null,
                team1AwayLoss: null
            };
            
            matches.forEach(match => {
                const homeScore = parseInt(match.FTHG) || 0;
                const awayScore = parseInt(match.FTAG) || 0;
                
                if (match.HomeTeam === state.lastTimeTeam1) {
                    // Team 1 is home
                    if (homeScore > awayScore && !results.team1HomeWin) {
                        results.team1HomeWin = match;
                    } else if (homeScore === awayScore && !results.team1HomeDraw) {
                        results.team1HomeDraw = match;
                    } else if (homeScore < awayScore && !results.team1HomeLoss) {
                        results.team1HomeLoss = match;
                    }
                } else if (match.AwayTeam === state.lastTimeTeam1) {
                    // Team 1 is away
                    if (awayScore > homeScore && !results.team1AwayWin) {
                        results.team1AwayWin = match;
                    } else if (homeScore === awayScore && !results.team1AwayDraw) {
                        results.team1AwayDraw = match;
                    } else if (homeScore > awayScore && !results.team1AwayLoss) {
                        results.team1AwayLoss = match;
                    }
                }
            });
            
            // For single team, we get opponent team names from the matches
            function getSingleTeamOpponentName(match) {
                return match.HomeTeam === state.lastTimeTeam1 ? match.AwayTeam : match.HomeTeam;
            }
            
            // Populate the 6 result sections for single team
            if (results.team1HomeWin) {
                populateResultSection(
                    elements.team1HomeWinSection, elements.team1HomeWinBody, elements.team1HomeWinDays,
                    elements.team1HomeWinTitle, results.team1HomeWin, state.lastTimeTeam1, 
                    null, 'Won', true
                );
            }
            
            if (results.team1AwayWin) {
                populateResultSection(
                    elements.team1AwayWinSection, elements.team1AwayWinBody, elements.team1AwayWinDays,
                    elements.team1AwayWinTitle, results.team1AwayWin, state.lastTimeTeam1, 
                    null, 'Won', false
                );
            }
            
            if (results.team1HomeDraw) {
                populateResultSection(
                    elements.team1HomeDrawSection, elements.team1HomeDrawBody, elements.team1HomeDrawDays,
                    elements.team1HomeDrawTitle, results.team1HomeDraw, state.lastTimeTeam1, 
                    null, 'Drew', true
                );
            }
            
            if (results.team1AwayDraw) {
                populateResultSection(
                    elements.team1AwayDrawSection, elements.team1AwayDrawBody, elements.team1AwayDrawDays,
                    elements.team1AwayDrawTitle, results.team1AwayDraw, state.lastTimeTeam1, 
                    null, 'Drew', false
                );
            }
            
            if (results.team1HomeLoss) {
                populateResultSection(
                    elements.team1HomeLossSection, elements.team1HomeLossBody, elements.team1HomeLossDays,
                    elements.team1HomeLossTitle, results.team1HomeLoss, state.lastTimeTeam1, 
                    null, 'Lost', true
                );
            }
            
            if (results.team1AwayLoss) {
                populateResultSection(
                    elements.team1AwayLossSection, elements.team1AwayLossBody, elements.team1AwayLossDays,
                    elements.team1AwayLossTitle, results.team1AwayLoss, state.lastTimeTeam1, 
                    null, 'Lost', false
                );
            }
            
            // Show results
            elements.lastTimeResults.classList.remove('hidden');
        }

        // Get teams for selected league
        function getLeagueTeams(league = null) {
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const selectedDiv = leagueMapping[league || state.selectedLeague];
            const leagueData = state.data.filter(row => row.Div === selectedDiv);
            const leagueTeams = [...new Set([
                ...leagueData.map(row => row.HomeTeam), 
                ...leagueData.map(row => row.AwayTeam)
            ])]
                .filter(team => team && team.length > 1)
                .sort();
            
            return leagueTeams;
        }

        // Update season options
        function updateSeasonOptions() {
            const availableSeasons = getAvailableSeasons();
            const options = '<option value="">Select Season</option>' + 
                availableSeasons.map(season => {
                    let label = season;
                    if (season === 'ligue-1-era-2002-2025') label = 'Ligue 1 Era (2002-2025)';
                    if (season === 'french-division-1-1932-2002') label = 'French Division 1 (1932-2002)';
                    if (season === 'all-french-seasons-1932-2025') label = 'All French Seasons (1932-2025)';
                    if (season === 'premier-league-era-1992-2025') label = 'Premier League Era (1992-2025)';
                    if (season === 'english-first-division-era-1888-1992') label = 'English First Division Era (1888-1992)';
                    if (season === 'all-english-seasons-1888-2025') label = 'All English Seasons (1888-2025)';
                    if (season === 'all-spanish-seasons-1928-2025') label = 'All Spanish Seasons (1928-2025)';
                    if (season === 'all-italian-seasons-1929-2025') label = 'All Italian Seasons (1929-2025)';
                    if (season === 'all-german-seasons-1963-2025') label = 'All German Seasons (1963-2025)';
                    return `<option value="${season}">${label}</option>`;
                }).join('');
            
            elements.seasonSelect.innerHTML = options;
            elements.seasonSelect.value = state.selectedSeason;
        }

        // Get available seasons
        function getAvailableSeasons(league = null) {
            const leagueToUse = league || state.selectedLeague;
            if (!seasons[leagueToUse]) return [];
            
            const seasonsList = Object.keys(seasons[leagueToUse]).sort().reverse();
            
            if (leagueToUse === 'ligue-1') {
                return ['ligue-1-era-2002-2025', 'french-division-1-1932-2002', 'all-french-seasons-1932-2025', ...seasonsList];
            }
            
            if (leagueToUse === 'premier-league') {
                return ['premier-league-era-1992-2025', 'english-first-division-era-1888-1992', 'all-english-seasons-1888-2025', ...seasonsList];
            }
            
            if (leagueToUse === 'la-liga') {
                return ['all-spanish-seasons-1928-2025', ...seasonsList];
            }
            
            if (leagueToUse === 'serie-a') {
                return ['all-italian-seasons-1929-2025', ...seasonsList];
            }
            
            if (leagueToUse === 'bundesliga') {
                return ['all-german-seasons-1963-2025', ...seasonsList];
            }
            
            return seasonsList;
        }

        // Apply point deductions
        function applyPointDeductions(tableArray, filteredMatches, selectedLeagueDiv) {
            if (pointDeductions.length === 0 || !state.pointDeductionsEnabled) return tableArray;
            
            if (filteredMatches.length === 0) return tableArray;
            
            const matchDates = filteredMatches.map(match => match.dateObj);
            const filterStartDate = new Date(Math.min(...matchDates));
            const filterEndDate = new Date(Math.max(...matchDates));
            
            return tableArray.map(team => {
                let adjustedPoints = team.points;
                
                pointDeductions.forEach(deduction => {
                    if (deduction.team === team.team && deduction.league === selectedLeagueDiv) {
                        const deductionStart = new Date(deduction.startDate);
                        const deductionEnd = new Date(deduction.endDate);
                        
                        const hasOverlap = (filterStartDate <= deductionEnd) && (filterEndDate >= deductionStart);
                        
                        if (hasOverlap) {
                            adjustedPoints -= deduction.points;
                        }
                    }
                });
                
                return {
                    ...team,
                    points: Math.max(0, adjustedPoints),
                    originalPoints: team.points
                };
            });
        }

        // Calculate table (abbreviated - same logic as original)
        function calculateTable() {
            let filtered = [...state.data];
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const selectedDiv = leagueMapping[state.selectedLeague];
            filtered = filtered.filter(row => row.Div === selectedDiv);
            
            // Date filters
            if (state.dateFrom) {
                filtered = filtered.filter(row => {
                    const matchDateStr = new Date(row.dateObj).toISOString().split('T')[0];
                    return matchDateStr >= state.dateFrom;
                });
            }
            
            if (state.dateTo) {
                filtered = filtered.filter(row => {
                    const matchDateStr = new Date(row.dateObj).toISOString().split('T')[0];
                    return matchDateStr <= state.dateTo;
                });
            }
            
            // Day of week filter
            if (state.selectedDayOfWeek !== '') {
                filtered = filtered.filter(row => {
                    const dayOfWeek = row.dateObj.getDay();
                    return dayOfWeek.toString() === state.selectedDayOfWeek;
                });
            }
            
            if (state.selectedTeam1 && state.selectedTeam2) {
                // Handle Big 6 selection
                if (state.selectedTeam2 === 'BIG_6' && state.big6Opponents) {
                    // Filter for matches where Team 1 played against any Big 6 opponent
                    filtered = filtered.filter(row =>
                        (row.HomeTeam === state.selectedTeam1 && state.big6Opponents.includes(row.AwayTeam)) ||
                        (row.AwayTeam === state.selectedTeam1 && state.big6Opponents.includes(row.HomeTeam))
                    );
                } else {
                    // Regular H2H matches
                    filtered = filtered.filter(row =>
                        (row.HomeTeam === state.selectedTeam1 && row.AwayTeam === state.selectedTeam2) ||
                        (row.HomeTeam === state.selectedTeam2 && row.AwayTeam === state.selectedTeam1)
                    );
                }
                
                // Apply home/away filtering based on state (same logic as calculateHeadToHead)
                if (state.homeFilter && !state.awayFilter) {
                    // Show only matches where Team 1 is home
                    filtered = filtered.filter(row => row.HomeTeam === state.selectedTeam1);
                } else if (state.awayFilter && !state.homeFilter) {
                    // Show only matches where Team 1 is away
                    filtered = filtered.filter(row => row.AwayTeam === state.selectedTeam1);
                }
                // If both are checked or both unchecked, show all H2H matches
                
                // Apply recent H2H filter if specified
                if (state.recentH2HCount !== 'All') {
                    // Sort by date (most recent first) and take the specified number
                    filtered = filtered
                        .sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj))
                        .slice(0, parseInt(state.recentH2HCount));
                }
            } else if (state.selectedTeam1) {
                // Single team selected - apply match history filters
                filtered = filtered.filter(row => row.HomeTeam === state.selectedTeam1 || row.AwayTeam === state.selectedTeam1);

                // Apply match history home/away filtering
                if (!state.matchHistoryHomeFilter) {
                    // Filter out matches where selected team is home
                    filtered = filtered.filter(row => row.HomeTeam !== state.selectedTeam1);
                }
                if (!state.matchHistoryAwayFilter) {
                    // Filter out matches where selected team is away
                    filtered = filtered.filter(row => row.AwayTeam !== state.selectedTeam1);
                }

                // Apply recent matches count filter if specified
                if (state.recentMatchesCount !== 'All') {
                    // Sort by date (most recent first) and take the specified number
                    filtered = filtered
                        .sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj))
                        .slice(0, parseInt(state.recentMatchesCount));
                }
            }
            
            // Determine teams to show
            let teamsToShow;
            if (state.selectedTeam1 && state.selectedTeam2) {
                teamsToShow = [state.selectedTeam1, state.selectedTeam2];
            } else if (state.selectedTeam1) {
                teamsToShow = [state.selectedTeam1];
            } else {
                teamsToShow = [...new Set([
                    ...filtered.map(row => row.HomeTeam),
                    ...filtered.map(row => row.AwayTeam)
                ])];
            }
            
            const table = {};
            teamsToShow.forEach(team => {
                table[team] = {
                    team: team,
                    played: 0,
                    won: 0,
                    drawn: 0,
                    lost: 0,
                    goalsFor: 0,
                    goalsAgainst: 0,
                    goalDifference: 0,
                    points: 0
                };
            });
            
            // Process matches with historical point systems
            filtered.forEach(match => {
                const homeTeam = table[match.HomeTeam];
                const awayTeam = table[match.AwayTeam];
                
                const homeGoals = parseInt(match.FTHG) || 0;
                const awayGoals = parseInt(match.FTAG) || 0;
                
                // Determine points system based on league and date
                let winPoints = 3;
                
                // If 3-point system is enabled, always use 3 points for wins
                if (state.threePointSystem) {
                    winPoints = 3;
                } else {
                    // Use historical point system
                    if (match.Div === 'I1' && match.dateObj <= new Date('1994-06-30')) {
                        winPoints = 2;
                    } else if (match.Div === 'SP1' && match.dateObj <= new Date('1995-06-30')) {
                        winPoints = 2;
                    } else if (match.Div === 'D1' && match.dateObj <= new Date('1995-06-30')) {
                        winPoints = 2;
                    } else if (match.Div === 'F1' && match.dateObj <= new Date('1994-06-30')) {
                        // Special case: 1988-89 season uses 3 points
                        if (match.dateObj >= new Date('1988-07-01') && match.dateObj <= new Date('1989-06-30')) {
                            winPoints = 3;
                        } else {
                            winPoints = 2;
                        }
                    } else if (match.Div === 'E0' && match.dateObj <= new Date('1981-06-30')) {
                        winPoints = 2;
                    }
                }
                
                // Home team stats
                if (homeTeam && (state.homeFilter || (state.selectedTeam1 && state.selectedTeam2))) {
                    homeTeam.played++;
                    homeTeam.goalsFor += homeGoals;
                    homeTeam.goalsAgainst += awayGoals;
                    
                    if (homeGoals > awayGoals) {
                        homeTeam.won++;
                        homeTeam.points += winPoints;
                    } else if (homeGoals < awayGoals) {
                        homeTeam.lost++;
                    } else {
                        homeTeam.drawn++;
                        homeTeam.points += 1;
                    }
                }
                
                // Away team stats
                if (awayTeam && (state.awayFilter || (state.selectedTeam1 && state.selectedTeam2))) {
                    awayTeam.played++;
                    awayTeam.goalsFor += awayGoals;
                    awayTeam.goalsAgainst += homeGoals;
                    
                    if (awayGoals > homeGoals) {
                        awayTeam.won++;
                        awayTeam.points += winPoints;
                    } else if (awayGoals < homeGoals) {
                        awayTeam.lost++;
                    } else {
                        awayTeam.drawn++;
                        awayTeam.points += 1;
                    }
                }
            });
            
            let tableArray = Object.values(table)
                .filter(team => team.played > 0)
                .map(team => ({
                    ...team,
                    goalDifference: team.goalsFor - team.goalsAgainst
                }));
            
            tableArray = applyPointDeductions(tableArray, filtered, selectedDiv);
            
            // First, sort by points to establish the base ranking
            let pointsSortedArray = [...tableArray].sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                return b.goalsFor - a.goalsFor;
            });
            
            // Apply ranking overrides for historic seasons to the points-sorted array
            if (!state.sortConfig.key) {
                pointsSortedArray = applyRankingOverrides(pointsSortedArray, state.selectedLeague, state.selectedSeason);
            } else {
                // Apply custom sorting if requested - work with pointsSortedArray to preserve position logic
                pointsSortedArray.sort((a, b) => {
                    let aVal = a[state.sortConfig.key];
                    let bVal = b[state.sortConfig.key];
                    
                    if (typeof aVal === 'string') {
                        return state.sortConfig.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    }
                    
                    return state.sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
                });
            }
            
            // Only apply position assignment logic when not using custom sorting
            if (!state.sortConfig.key) {
                // Add original position based on the final points/override ranking
                // Calculate positions properly handling ties and gaps
                
                // Step 1: Find all override positions and calculate blocked positions
                const overridePositions = [];
                const blockedPositions = new Set();
                
                pointsSortedArray.forEach(team => {
                    if (team.sharedPosition) {
                        overridePositions.push(team.sharedPosition);
                    }
                });
                
                // Group override positions and calculate blocked ranges
                const positionCounts = {};
                overridePositions.forEach(pos => {
                    positionCounts[pos] = (positionCounts[pos] || 0) + 1;
                });
                
                // Block positions based on ties (e.g., two 4s block positions 4 and 5)
                Object.keys(positionCounts).forEach(pos => {
                    const position = parseInt(pos);
                    const count = positionCounts[pos];
                    
                    // Block 'count' positions starting from 'position'
                    for (let i = 0; i < count; i++) {
                        blockedPositions.add(position + i);
                    }
                });
                
                // Step 2: Assign positions to regular teams (skip blocked positions)
                let currentPosition = 1;
                const regularTeams = pointsSortedArray.filter(team => !team.sharedPosition);
                
                regularTeams.forEach(team => {
                    // Find next available position (skip blocked ones)
                    while (blockedPositions.has(currentPosition)) {
                        currentPosition++;
                    }
                    
                    team.originalPosition = currentPosition;
                    currentPosition++;
                });
                
                // Step 3: Set override positions
                pointsSortedArray.forEach(team => {
                    if (team.sharedPosition) {
                        team.originalPosition = team.sharedPosition;
                    }
                });
                
                // Step 4: Sort teams by their final position for proper display order
                pointsSortedArray.sort((a, b) => {
                    if (a.originalPosition !== b.originalPosition) {
                        return a.originalPosition - b.originalPosition;
                    }
                    // If positions are equal, maintain original order (sub-order for tied teams)
                    return 0;
                });
            } else {
                // For custom sorting, just assign sequential positions based on current order
                pointsSortedArray.forEach((team, index) => {
                    team.originalPosition = index + 1;
                });
            }
            
            // Use the properly sorted array for display
            tableArray = pointsSortedArray;
            
            return { tableData: tableArray, matchCount: filtered.length };
        }

        // Calculate head-to-head stats (abbreviated - same logic as original)
        function calculateHeadToHead() {
            if (!state.selectedTeam1 || !state.selectedTeam2) return null;
            
            let filtered = [...state.data];
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const selectedDiv = leagueMapping[state.selectedLeague];
            filtered = filtered.filter(row => row.Div === selectedDiv);
            
            // Apply date filters
            if (state.dateFrom) {
                filtered = filtered.filter(row => {
                    const matchDateStr = new Date(row.dateObj).toISOString().split('T')[0];
                    return matchDateStr >= state.dateFrom;
                });
            }
            
            if (state.dateTo) {
                filtered = filtered.filter(row => {
                    const matchDateStr = new Date(row.dateObj).toISOString().split('T')[0];
                    return matchDateStr <= state.dateTo;
                });
            }
            
            // Day of week filter
            if (state.selectedDayOfWeek !== '') {
                filtered = filtered.filter(row => {
                    const dayOfWeek = row.dateObj.getDay();
                    return dayOfWeek.toString() === state.selectedDayOfWeek;
                });
            }
            
            // Filter for head-to-head matches
            let h2hMatches;
            if (state.selectedTeam2 === 'BIG_6' && state.big6Opponents) {
                // Filter for matches where Team 1 played against any Big 6 opponent
                h2hMatches = filtered.filter(row =>
                    (row.HomeTeam === state.selectedTeam1 && state.big6Opponents.includes(row.AwayTeam)) ||
                    (row.AwayTeam === state.selectedTeam1 && state.big6Opponents.includes(row.HomeTeam))
                ).sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj));
            } else {
                // Regular H2H matches
                h2hMatches = filtered.filter(row =>
                    (row.HomeTeam === state.selectedTeam1 && row.AwayTeam === state.selectedTeam2) ||
                    (row.HomeTeam === state.selectedTeam2 && row.AwayTeam === state.selectedTeam1)
                ).sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj));
            }
            
            // Apply home/away filtering first (same logic as in updateH2HMatchesTable)
            if (state.homeFilter && !state.awayFilter) {
                // Only include matches where Team 1 is home
                h2hMatches = h2hMatches.filter(match => match.HomeTeam === state.selectedTeam1);
            } else if (state.awayFilter && !state.homeFilter) {
                // Only include matches where Team 1 is away  
                h2hMatches = h2hMatches.filter(match => match.AwayTeam === state.selectedTeam1);
            }
            // If both are selected, show all matches (no additional filtering)
            
            // Then apply recent match count limit to the already filtered matches
            if (state.recentH2HCount !== 'All') {
                const limit = parseInt(state.recentH2HCount) || 0;
                h2hMatches = h2hMatches.slice(0, limit);
            }
            
            // Calculate stats (abbreviated logic)
            const team1Home = h2hMatches.filter(match => match.HomeTeam === state.selectedTeam1);
            const team1HomeStats = { wins: 0, draws: 0, losses: 0, total: team1Home.length };
            
            team1Home.forEach(match => {
                const homeGoals = parseInt(match.FTHG) || 0;
                const awayGoals = parseInt(match.FTAG) || 0;
                if (homeGoals > awayGoals) team1HomeStats.wins++;
                else if (homeGoals < awayGoals) team1HomeStats.losses++;
                else team1HomeStats.draws++;
            });
            
            let team2Home;
            if (state.selectedTeam2 === 'BIG_6' && state.big6Opponents) {
                // For Big 6, find matches where any Big 6 team is home vs Team 1 away
                team2Home = h2hMatches.filter(match =>
                    state.big6Opponents.includes(match.HomeTeam) && match.AwayTeam === state.selectedTeam1
                );
            } else {
                // Regular case: Team 2 playing at home
                team2Home = h2hMatches.filter(match => match.HomeTeam === state.selectedTeam2);
            }

            const team2HomeStats = { wins: 0, draws: 0, losses: 0, total: team2Home.length };

            team2Home.forEach(match => {
                const homeGoals = parseInt(match.FTHG) || 0;
                const awayGoals = parseInt(match.FTAG) || 0;
                if (homeGoals > awayGoals) team2HomeStats.wins++;
                else if (homeGoals < awayGoals) team2HomeStats.losses++;
                else team2HomeStats.draws++;
            });
            
            return { 
                team1HomeStats, 
                team2HomeStats, 
                totalMatches: h2hMatches.length,
                matches: h2hMatches,
                overallStats: {
                    team1Wins: team1HomeStats.wins + team2HomeStats.losses,
                    draws: team1HomeStats.draws + team2HomeStats.draws,
                    team2Wins: team1HomeStats.losses + team2HomeStats.wins,
                    total: h2hMatches.length
                }
            };
        }

        // Big 6 teams definition
        const BIG_6_TEAMS = [
            'Liverpool FC',
            'Arsenal FC',
            'Manchester United',
            'Manchester City',
            'Chelsea FC',
            'Tottenham Hotspur'
        ];

        // Get Big 6 opponents for a given team
        function getBig6Opponents(selectedTeam) {
            if (!selectedTeam) return [];

            // If selected team is one of Big 6, return the other 5
            if (BIG_6_TEAMS.includes(selectedTeam)) {
                return BIG_6_TEAMS.filter(team => team !== selectedTeam);
            } else {
                // If selected team is not Big 6, return all 6
                return [...BIG_6_TEAMS];
            }
        }

        // Get display name for team (handles Big 6 special case)
        function getTeamDisplayName(teamValue) {
            if (teamValue === 'BIG_6') {
                return 'Big 6';
            }
            return teamValue;
        }

        // Update table and all related UI
        function updateTable() {
            if (state.data.length === 0) return;
            
            const tableResult = calculateTable();
            const h2hResult = calculateHeadToHead();
            const matchHistoryResult = calculateMatchHistory();

            updateTableDisplay(tableResult);
            updateHeadToHeadDisplay(h2hResult);
            updateMatchHistoryDisplay(matchHistoryResult);
            updateTableInfo(tableResult);
            
            // Handle position colors for dark mode
            setTimeout(handlePositionColors, 50);
        }

        // Update table display
        function updateTableDisplay(tableResult) {
            const headers = [
                { key: 'position', label: 'Pos' },
                { key: 'team', label: 'Team' },
                { key: 'played', label: 'P' },
                { key: 'won', label: 'W' },
                { key: 'drawn', label: 'D' },
                { key: 'lost', label: 'L' },
                { key: 'goalsFor', label: 'GF' },
                { key: 'goalsAgainst', label: 'GA' },
                { key: 'goalDifference', label: 'GD' },
                { key: 'points', label: 'Pts' }
            ];
            
            elements.tableHeader.innerHTML = headers.map(header => `
                <th class="px-3 py-4 text-center font-bold text-sm cursor-pointer hover:bg-gray-600" 
                    onclick="handleSort('${header.key}')" 
                    style="text-align: ${header.key === 'team' ? 'left' : 'center'}">
                    ${header.label}${getSortIndicator(header.key)}
                </th>
            `).join('');
            
            // Update table body
            if (tableResult.tableData.length > 0) {
                // Add/remove class to enable transparent highlighting when Team 1 is selected
                if (state.selectedTeam1) {
                    elements.tableBody.classList.add('team1-selected');
                } else {
                    elements.tableBody.classList.remove('team1-selected');
                }

                elements.tableBody.innerHTML = tableResult.tableData.map((team, index) => {
                    // Only highlight when Team 1 is selected, or when both teams are selected
                    const isHighlighted = state.selectedTeam1 && (
                        state.selectedTeam1 === team.team ||
                        state.selectedTeam2 === team.team
                    );
                    // Note: For Big 6 scenarios, we don't treat Big 6 teams as "highlighted" for styling purposes

                    // Determine highlighting class - only assign explicit classes for selected teams
                    // CSS will automatically handle transparent highlighting for teams without classes
                    let highlightClass = '';
                    if (state.selectedTeam1) {
                        if (state.selectedTeam1 === team.team) {
                            highlightClass = 'team1-highlight';
                        } else if (state.selectedTeam2 && state.selectedTeam2 !== 'BIG_6' && state.selectedTeam2 === team.team) {
                            highlightClass = 'team2-highlight';
                        }
                        // Note: When Team 2 is Big 6, we DON'T give Big 6 teams explicit highlighting
                        // This allows the CSS transparent highlighting to apply to all non-Team1 teams
                        // Don't assign any class for other teams - CSS selector will handle transparent highlighting
                    }
                    
                    // Alternating row colors: only if 3+ teams, otherwise all white
                    const rowBackgroundClass = tableResult.tableData.length >= 3 && index % 2 === 1 ? 'bg-gray-100' : 'bg-gray-50';
                    
                    return `
                        <tr class="border-b hover:bg-gray-50 ${rowBackgroundClass}">
                            <td class="px-3 py-4 text-center font-bold text-gray-600">${team.sharedPosition || team.originalPosition}</td>
                            <td class="px-4 py-4 font-semibold ${isHighlighted ? 'text-black' : 'text-gray-900'}">
                                <div class="flex items-center cursor-pointer hover:bg-gray-100 rounded p-2 -m-2 team-clickable" data-team="${team.team}" title="Click to view ${team.team} history">
                                    ${(() => {
                                        const logoUrl = getTeamLogoUrl(team.team, state.selectedLeague);
                                        return logoUrl ? `<img src="${logoUrl}" alt="${team.team} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : '';
                                    })()}
                                    <span class="hover:underline team-name-text ${highlightClass}" ${isHighlighted ? `style="color: ${getTeamColor(team.team, state.selectedLeague)} !important; font-weight: bold;"` : ''}>${team.team}</span>
                                </div>
                            </td>
                            <td class="px-3 py-4 text-center">${team.played}</td>
                            <td class="px-3 py-4 text-center">${team.won}</td>
                            <td class="px-3 py-4 text-center">${team.drawn}</td>
                            <td class="px-3 py-4 text-center">${team.lost}</td>
                            <td class="px-3 py-4 text-center">${team.goalsFor}</td>
                            <td class="px-3 py-4 text-center">${team.goalsAgainst}</td>
                            <td class="px-3 py-4 text-center">
                                <span class="font-bold ${team.goalDifference > 0 ? 'text-green-700' : team.goalDifference < 0 ? 'text-red-600' : 'text-black'}">
                                    ${team.goalDifference > 0 ? '+' : ''}${team.goalDifference}
                                </span>
                            </td>
                            <td class="px-3 py-4 text-center">
                                <span class="points-badge">
                                    ${team.points}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Remove any existing event listeners to avoid duplicates
                elements.tableBody.removeEventListener('click', handleTeamClick);
                
                // Add event delegation for team clicks
                elements.tableBody.addEventListener('click', handleTeamClick);
                // Team click event listener added to table body
                
                // Only show table if we're on the League Filters tab
                const isLeagueFiltersActive = document.getElementById('leagueFiltersTab').classList.contains('active');
                if (isLeagueFiltersActive) {
                    elements.tableContainer.classList.remove('hidden');
                } else {
                    elements.tableContainer.classList.add('hidden');
                }
            } else {
                elements.tableContainer.classList.add('hidden');
            }
        }

        // Calculate match history data for single team
        function calculateMatchHistory() {
            if (!state.selectedTeam1 || (state.selectedTeam2 && state.selectedTeam2 !== '')) return null;

            // Apply all existing filters first
            let filtered = [...state.data];

            // Apply league filter
            if (state.selectedLeague) {
                const leagueMapping = {
                    'premier-league': 'E0',
                    'la-liga': 'SP1',
                    'serie-a': 'I1',
                    'bundesliga': 'D1',
                    'ligue-1': 'F1'
                };

                const divFilter = leagueMapping[state.selectedLeague];
                if (divFilter) {
                    filtered = filtered.filter(row => row.Div === divFilter);
                }
            }

            // Apply date filters
            if (state.dateFrom) {
                const fromDate = new Date(state.dateFrom);
                filtered = filtered.filter(row => row.dateObj >= fromDate);
            }

            if (state.dateTo) {
                const toDate = new Date(state.dateTo);
                filtered = filtered.filter(row => row.dateObj <= toDate);
            }

            // Apply season filter (but skip for era seasons as they use date range filtering)
            if (state.selectedSeason &&
                !state.selectedSeason.includes('-era-') &&
                !state.selectedSeason.includes('all-') &&
                !state.selectedSeason.includes('french-division-1')) {
                filtered = filtered.filter(row => row.Season === state.selectedSeason);
            }

            // Apply day of week filter
            if (state.selectedDayOfWeek) {
                filtered = filtered.filter(row => {
                    const dayIndex = row.dateObj.getDay();
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    return dayNames[dayIndex] === state.selectedDayOfWeek;
                });
            }

            // Filter for selected team matches
            let teamMatches = filtered.filter(row =>
                row.HomeTeam === state.selectedTeam1 || row.AwayTeam === state.selectedTeam1
            );

            // Apply home/away filter for match history
            if (state.matchHistoryHomeFilter && !state.matchHistoryAwayFilter) {
                teamMatches = teamMatches.filter(row => row.HomeTeam === state.selectedTeam1);
            } else if (!state.matchHistoryHomeFilter && state.matchHistoryAwayFilter) {
                teamMatches = teamMatches.filter(row => row.AwayTeam === state.selectedTeam1);
            }

            // Sort by date (most recent first)
            teamMatches.sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj));

            return {
                matches: teamMatches
            };
        }

        // Update match history display
        function updateMatchHistoryDisplay(matchHistoryResult) {
            if (matchHistoryResult && state.selectedTeam1 && !state.selectedTeam2) {
                elements.matchHistorySection.classList.remove('hidden');

                // Hide the team stats table since main league table is shown above by updateUI
                elements.matchHistoryStatsTable.classList.add('hidden');


                // Update the match history table and get filtered count
                const filteredCount = updateMatchHistoryTable(matchHistoryResult);

                // Get filtered matches for visualizations (same logic as in updateMatchHistoryTable)
                let filteredMatches = matchHistoryResult.matches.filter(match => {
                    const isHome = match.HomeTeam === state.selectedTeam1;
                    const isAway = match.AwayTeam === state.selectedTeam1;

                    // Apply home/away filter logic
                    if (!state.matchHistoryHomeFilter && isHome) return false;
                    if (!state.matchHistoryAwayFilter && isAway) return false;
                    return true;
                });

                // Apply recent matches count filter
                if (state.recentMatchesCount !== 'All') {
                    const count = parseInt(state.recentMatchesCount);
                    filteredMatches = filteredMatches.slice(0, count);
                }

                // Update Team Record visualizations with filtered matches
                updateMatchHistoryVisualizations(filteredMatches, state.selectedTeam1);

                // Update table subtitle with team name and match count
                const subtitleText = `${state.selectedTeam1} (${filteredCount} matches)`;
                elements.matchHistoryTableTitle.textContent = subtitleText;
                elements.matchHistoryMatchCount.textContent = `${filteredCount} matches`;
            } else {
                elements.matchHistorySection.classList.add('hidden');
                // Also hide stats table when section is hidden
                if (elements.matchHistoryStatsTable) {
                    elements.matchHistoryStatsTable.classList.add('hidden');
                }
            }
        }

        // Update match history table
        function updateMatchHistoryTable(matchHistoryResult) {
            if (!matchHistoryResult || !matchHistoryResult.matches || matchHistoryResult.matches.length === 0) {
                elements.matchHistoryTable.classList.add('hidden');
                return;
            }

            elements.matchHistoryTable.classList.remove('hidden');

            // Apply filters - first home/away filter, then recent matches count
            let filteredMatches = matchHistoryResult.matches.filter(match => {
                const isHome = match.HomeTeam === state.selectedTeam1;
                const isAway = match.AwayTeam === state.selectedTeam1;

                // Apply home/away filter logic
                if (!state.matchHistoryHomeFilter && isHome) return false;
                if (!state.matchHistoryAwayFilter && isAway) return false;
                return true;
            });

            // Apply recent matches count filter
            if (state.recentMatchesCount !== 'All') {
                const count = parseInt(state.recentMatchesCount);
                filteredMatches = filteredMatches.slice(0, count);
            }

            // Create table headers with sorting functionality
            elements.matchHistoryTableHeader.innerHTML = `
                <th class="text-center cursor-pointer hover:bg-gray-600" onclick="handleMatchHistorySort('date')">Date${getMatchHistorySortIndicator('date')}</th>
                <th class="text-center cursor-pointer hover:bg-gray-600" onclick="handleMatchHistorySort('homeTeam')">Home Team${getMatchHistorySortIndicator('homeTeam')}</th>
                <th class="text-center cursor-pointer hover:bg-gray-600" onclick="handleMatchHistorySort('homeScore')">Home Score${getMatchHistorySortIndicator('homeScore')}</th>
                <th class="text-center cursor-pointer hover:bg-gray-600" onclick="handleMatchHistorySort('awayTeam')">Away Team${getMatchHistorySortIndicator('awayTeam')}</th>
                <th class="text-center cursor-pointer hover:bg-gray-600" onclick="handleMatchHistorySort('awayScore')">Away Score${getMatchHistorySortIndicator('awayScore')}</th>
                <th class="text-center cursor-pointer hover:bg-gray-600" onclick="handleMatchHistorySort('result')">Result${getMatchHistorySortIndicator('result')}</th>
            `;

            // Create sorted matches data with H2H-style processing
            let matchesData = filteredMatches.map(match => {
                const homeScore = parseInt(match.FTHG) || 0;
                const awayScore = parseInt(match.FTAG) || 0;

                // Get team colors first
                const homeTeamColor = getTeamColor(match.HomeTeam, state.selectedLeague);
                const awayTeamColor = getTeamColor(match.AwayTeam, state.selectedLeague);

                // Determine winner and score colors (same logic as H2H)
                let winnerTeam = '';
                let homeScoreClass = '';
                let awayScoreClass = '';
                let resultStyle = '';

                if (homeScore > awayScore) {
                    // Home team wins
                    winnerTeam = match.HomeTeam;
                    homeScoreClass = 'font-bold win-score';
                    awayScoreClass = 'text-red-600 font-bold';
                    resultStyle = homeTeamColor ?
                        `color: ${homeTeamColor} !important; font-weight: bold;` :
                        'color: #059669 !important; font-weight: bold;'; // Default green
                } else if (awayScore > homeScore) {
                    // Away team wins
                    winnerTeam = match.AwayTeam;
                    homeScoreClass = 'text-red-600 font-bold';
                    awayScoreClass = 'font-bold win-score';
                    resultStyle = awayTeamColor ?
                        `color: ${awayTeamColor} !important; font-weight: bold;` :
                        'color: #059669 !important; font-weight: bold;'; // Default green
                } else {
                    // Draw
                    winnerTeam = 'Draw';
                    homeScoreClass = 'text-gray-400 font-bold draw-score';
                    awayScoreClass = 'text-gray-400 font-bold draw-score';
                    resultStyle = 'color: #9ca3af !important; font-weight: bold;'; // Lighter gray for draws
                }

                // Add team highlights - highlight selected team
                const isHomeSelected = match.HomeTeam === state.selectedTeam1;
                const isAwaySelected = match.AwayTeam === state.selectedTeam1;

                // Create subtle highlight classes similar to H2H
                const homeTeamClass = isHomeSelected ? 'team1-highlight' : '';
                const awayTeamClass = isAwaySelected ? 'team1-highlight' : '';

                // Combine team color with highlight classes for inline styles
                const homeTeamFinalStyle = homeTeamColor ? `color: ${homeTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
                const awayTeamFinalStyle = awayTeamColor ? `color: ${awayTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';

                // Result shows winning team name or "Draw"
                let resultText = '';
                let resultClass = '';
                if (winnerTeam === 'Draw') {
                    resultText = 'Draw';
                    resultStyle = 'color: #9ca3af !important; font-weight: bold;';
                } else {
                    resultText = winnerTeam;
                    // Add highlighting if the winning team is the selected team
                    if (winnerTeam === state.selectedTeam1) {
                        resultClass = 'team1-highlight';
                    }
                    // Keep the winner's team color style already set above
                }

                return {
                    date: match.dateObj.toLocaleDateString('en-US'),
                    dateSort: match.dateObj,
                    homeTeam: match.HomeTeam,
                    homeTeamColor: homeTeamColor,
                    homeTeamStyle: homeTeamFinalStyle,
                    homeTeamClass: homeTeamClass,
                    homeScore: homeScore,
                    homeScoreClass: homeScoreClass,
                    awayTeam: match.AwayTeam,
                    awayTeamColor: awayTeamColor,
                    awayTeamStyle: awayTeamFinalStyle,
                    awayTeamClass: awayTeamClass,
                    awayScore: awayScore,
                    awayScoreClass: awayScoreClass,
                    result: resultText,
                    resultStyle: resultStyle,
                    resultClass: resultClass
                };
            });

            // Apply sorting if configured
            if (state.matchHistorySortConfig.key && state.matchHistorySortConfig.direction) {
                const sortKey = state.matchHistorySortConfig.key;
                const sortDirection = state.matchHistorySortConfig.direction;

                matchesData.sort((a, b) => {
                    let aVal, bVal;

                    switch (sortKey) {
                        case 'date':
                            aVal = a.dateSort;
                            bVal = b.dateSort;
                            break;
                        case 'homeTeam':
                            aVal = a.homeTeam;
                            bVal = b.homeTeam;
                            break;
                        case 'awayTeam':
                            aVal = a.awayTeam;
                            bVal = b.awayTeam;
                            break;
                        case 'homeScore':
                            aVal = a.homeScore;
                            bVal = b.homeScore;
                            break;
                        case 'awayScore':
                            aVal = a.awayScore;
                            bVal = b.awayScore;
                            break;
                        case 'result':
                            aVal = a.result;
                            bVal = b.result;
                            break;
                        default:
                            return 0;
                    }

                    // Handle different data types
                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }

                    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Add/remove class to enable transparent highlighting when Team 1 is selected
            if (state.selectedTeam1) {
                elements.matchHistoryTableBody.classList.add('team1-selected');
            } else {
                elements.matchHistoryTableBody.classList.remove('team1-selected');
            }

            // Generate table rows with H2H-style formatting
            elements.matchHistoryTableBody.innerHTML = matchesData.map((match, index) => {
                const isSelectedTeamHome = match.homeTeam === state.selectedTeam1;
                const isSelectedTeamAway = match.awayTeam === state.selectedTeam1;

                // Get team logos
                const homeLogoUrl = getTeamLogoUrl(match.homeTeam, state.selectedLeague);
                const awayLogoUrl = getTeamLogoUrl(match.awayTeam, state.selectedLeague);

                // Get result logo for result column (shows winning team logo, no logo for Draw)
                const resultLogoUrl = match.result !== 'Draw' ?
                    getTeamLogoUrl(match.result, state.selectedLeague) : null;

                return `
                    <tr>
                        <td class="text-center text-sm">${match.date}</td>
                        <td class="text-center">
                            <div class="flex items-center justify-center">
                                ${homeLogoUrl ? `<img src="${homeLogoUrl}" alt="${match.homeTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="${match.homeTeamClass}" style="${match.homeTeamStyle}">${match.homeTeam}</span>
                            </div>
                        </td>
                        <td class="text-center text-lg ${match.homeScoreClass}" >${match.homeScore}</td>
                        <td class="text-center">
                            <div class="flex items-center justify-center">
                                ${awayLogoUrl ? `<img src="${awayLogoUrl}" alt="${match.awayTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="${match.awayTeamClass}" style="${match.awayTeamStyle}">${match.awayTeam}</span>
                            </div>
                        </td>
                        <td class="text-center text-lg ${match.awayScoreClass}" >${match.awayScore}</td>
                        <td class="text-center">
                            <div class="flex items-center justify-center">
                                ${resultLogoUrl ? `<img src="${resultLogoUrl}" alt="${state.selectedTeam1} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="${match.resultClass}" style="${match.resultStyle}">${match.result}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Return the filtered count for display updates
            return filteredMatches.length;
        }

        // Set recent matches input value
        function setRecentMatchesValue() {
            // Removed to show placeholder text instead of pre-filled 'All'
        }

        // Update match history visualizations (Team Record)
        function updateMatchHistoryVisualizations(matches, teamName) {
            if (!matches || matches.length === 0) {
                elements.matchHistoryVisualizations.innerHTML = '';
                return;
            }

            // Use the pre-filtered matches passed in (no additional filtering needed)
            const recentMatches = matches;

            // Calculate team record statistics
            let wins = 0, draws = 0, losses = 0;
            let homeWins = 0, homeDraws = 0, homeLosses = 0;
            let awayWins = 0, awayDraws = 0, awayLosses = 0;

            recentMatches.forEach(match => {
                const homeScore = parseInt(match.FTHG) || 0;
                const awayScore = parseInt(match.FTAG) || 0;
                const isHome = match.HomeTeam === teamName;

                if (homeScore > awayScore) {
                    if (isHome) {
                        wins++;
                        homeWins++;
                    } else {
                        losses++;
                        awayLosses++;
                    }
                } else if (homeScore < awayScore) {
                    if (isHome) {
                        losses++;
                        homeLosses++;
                    } else {
                        wins++;
                        awayWins++;
                    }
                } else {
                    draws++;
                    if (isHome) {
                        homeDraws++;
                    } else {
                        awayDraws++;
                    }
                }
            });

            const total = recentMatches.length;
            const teamColor = getTeamColor(teamName, state.selectedLeague);
            const teamBgStyle = teamColor ? `background: ${teamColor} !important; color: ${getContrastColor(teamColor)} !important;` : 'background: #059669 !important; color: white !important;';

            let visualizationHTML = '';

            // Show overall stats only if both home and away are selected
            if (state.matchHistoryHomeFilter && state.matchHistoryAwayFilter && total > 0) {
                visualizationHTML += `
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold">${teamName} - Overall Record</span>
                            <span class="text-sm text-gray-600">${wins}W - ${draws}D - ${losses}L</span>
                        </div>
                        <div class="h2h-viz-bar">
                            <div class="h2h-segment h2h-wins" style="width: ${(wins / total) * 100}%; ${teamBgStyle}">
                                ${wins > 0 ? wins : ''}
                            </div>
                            <div class="h2h-segment h2h-draws" style="width: ${(draws / total) * 100}%;">
                                ${draws > 0 ? draws : ''}
                            </div>
                            <div class="h2h-segment h2h-losses" style="width: ${(losses / total) * 100}%;">
                                ${losses > 0 ? losses : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Home Record (show if home filter is enabled)
            if (state.matchHistoryHomeFilter && (homeWins + homeDraws + homeLosses) > 0) {
                const homeTotal = homeWins + homeDraws + homeLosses;
                visualizationHTML += `
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold">${teamName} (Home)</span>
                            <span class="text-sm text-gray-600">${homeWins}W - ${homeDraws}D - ${homeLosses}L</span>
                        </div>
                        <div class="h2h-viz-bar">
                            <div class="h2h-segment h2h-wins" style="width: ${(homeWins / homeTotal) * 100}%; ${teamBgStyle}">
                                ${homeWins > 0 ? homeWins : ''}
                            </div>
                            <div class="h2h-segment h2h-draws" style="width: ${(homeDraws / homeTotal) * 100}%;">
                                ${homeDraws > 0 ? homeDraws : ''}
                            </div>
                            <div class="h2h-segment h2h-losses" style="width: ${(homeLosses / homeTotal) * 100}%;">
                                ${homeLosses > 0 ? homeLosses : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Away Record (show if away filter is enabled)
            if (state.matchHistoryAwayFilter && (awayWins + awayDraws + awayLosses) > 0) {
                const awayTotal = awayWins + awayDraws + awayLosses;
                visualizationHTML += `
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold">${teamName} (Away)</span>
                            <span class="text-sm text-gray-600">${awayWins}W - ${awayDraws}D - ${awayLosses}L</span>
                        </div>
                        <div class="h2h-viz-bar">
                            <div class="h2h-segment h2h-wins" style="width: ${(awayWins / awayTotal) * 100}%; ${teamBgStyle}">
                                ${awayWins > 0 ? awayWins : ''}
                            </div>
                            <div class="h2h-segment h2h-draws" style="width: ${(awayDraws / awayTotal) * 100}%;">
                                ${awayDraws > 0 ? awayDraws : ''}
                            </div>
                            <div class="h2h-segment h2h-losses" style="width: ${(awayLosses / awayTotal) * 100}%;">
                                ${awayLosses > 0 ? awayLosses : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            elements.matchHistoryVisualizations.innerHTML = visualizationHTML;
        }

        // Calculate team statistics for match history
        function calculateTeamStats(matches, teamName) {
            let stats = {
                played: 0,
                won: 0,
                drawn: 0,
                lost: 0,
                goalsFor: 0,
                goalsAgainst: 0,
                goalDifference: 0,
                points: 0
            };

            matches.forEach(match => {
                const homeScore = parseInt(match.FTHG) || 0;
                const awayScore = parseInt(match.FTAG) || 0;
                const isHome = match.HomeTeam === teamName;

                stats.played++;

                if (isHome) {
                    stats.goalsFor += homeScore;
                    stats.goalsAgainst += awayScore;

                    if (homeScore > awayScore) {
                        stats.won++;
                        stats.points += state.useThreePoints ? 3 : 2;
                    } else if (homeScore === awayScore) {
                        stats.drawn++;
                        stats.points += 1;
                    } else {
                        stats.lost++;
                    }
                } else {
                    stats.goalsFor += awayScore;
                    stats.goalsAgainst += homeScore;

                    if (awayScore > homeScore) {
                        stats.won++;
                        stats.points += state.useThreePoints ? 3 : 2;
                    } else if (awayScore === homeScore) {
                        stats.drawn++;
                        stats.points += 1;
                    } else {
                        stats.lost++;
                    }
                }
            });

            stats.goalDifference = stats.goalsFor - stats.goalsAgainst;
            return stats;
        }

        // Update match history stats table
        function updateMatchHistoryStatsTable(stats, teamName) {
            // Create stats table headers
            elements.matchHistoryStatsHeader.innerHTML = `
                <th class="text-center">Team</th>
                <th class="text-center">P</th>
                <th class="text-center">W</th>
                <th class="text-center">D</th>
                <th class="text-center">L</th>
                <th class="text-center">GF</th>
                <th class="text-center">GA</th>
                <th class="text-center">GD</th>
                <th class="text-center">Pts</th>
            `;

            // Get team color and logo
            const teamColor = getTeamColor(teamName, state.selectedLeague);
            const logoUrl = getTeamLogoUrl(teamName, state.selectedLeague);

            // Create stats table row
            elements.matchHistoryStatsBody.innerHTML = `
                <tr>
                    <td class="px-3 py-4 text-center">
                        <div class="flex items-center justify-center">
                            ${logoUrl ? `<img src="${logoUrl}" alt="${teamName} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="hover:underline team-name-text" style="color: ${teamColor} !important; font-weight: bold;">${teamName}</span>
                        </div>
                    </td>
                    <td class="px-3 py-4 text-center">${stats.played}</td>
                    <td class="px-3 py-4 text-center">${stats.won}</td>
                    <td class="px-3 py-4 text-center">${stats.drawn}</td>
                    <td class="px-3 py-4 text-center">${stats.lost}</td>
                    <td class="px-3 py-4 text-center">${stats.goalsFor}</td>
                    <td class="px-3 py-4 text-center">${stats.goalsAgainst}</td>
                    <td class="px-3 py-4 text-center">
                        <span class="font-bold ${stats.goalDifference > 0 ? 'text-green-700' : stats.goalDifference < 0 ? 'text-red-600' : 'text-black'}">
                            ${stats.goalDifference > 0 ? '+' : ''}${stats.goalDifference}
                        </span>
                    </td>
                    <td class="px-3 py-4 text-center">
                        <span class="points-badge">
                            ${stats.points}
                        </span>
                    </td>
                </tr>
            `;
        }

        // Update head-to-head display with custom team colors
        function updateHeadToHeadDisplay(h2hResult) {
            if (h2hResult && state.selectedTeam1 && state.selectedTeam2) {
                elements.h2hSection.classList.remove('hidden');
                
                // Get team colors
                const team1Color = getTeamColor(state.selectedTeam1, state.selectedLeague);
                const team2Color = state.selectedTeam2 === 'BIG_6' ? null : getTeamColor(state.selectedTeam2, state.selectedLeague);

                // Define Big 6 consistent color (dark blue/navy)
                const big6Color = '#1e3a8a'; // Dark blue
                const big6Style = `background: ${big6Color} !important; color: ${getContrastColor(big6Color)} !important;`;

                // Default colors if no custom color found
                const team1Style = team1Color ? `background: ${team1Color} !important; color: ${getContrastColor(team1Color)} !important;` : '';
                const team2Style = team2Color ? `background: ${team2Color} !important; color: ${getContrastColor(team2Color)} !important;` : '';

                // Determine which style to use for each team position
                const actualTeam1Style = team1Style;
                const actualTeam2Style = state.selectedTeam2 === 'BIG_6' ? big6Style : team2Style;
                
                // Create H2H visualizations based on home/away filter selection
                let visualizationHTML = '';
                
                // Show overall stats only if both home and away are selected
                if (state.homeFilter && state.awayFilter) {
                    visualizationHTML += `
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">${getTeamDisplayName(state.selectedTeam1)} vs ${getTeamDisplayName(state.selectedTeam2)} (Overall)</span>
                                <span class="text-sm text-gray-600">${h2hResult.overallStats.team1Wins}W - ${h2hResult.overallStats.draws}D - ${h2hResult.overallStats.team2Wins}W</span>
                            </div>
                            <div class="h2h-viz-bar">
                                <div class="h2h-segment h2h-wins" style="width: ${(h2hResult.overallStats.team1Wins / h2hResult.overallStats.total) * 100}%; ${actualTeam1Style}">
                                    ${h2hResult.overallStats.team1Wins > 0 ? h2hResult.overallStats.team1Wins : ''}
                                </div>
                                <div class="h2h-segment h2h-draws" style="width: ${(h2hResult.overallStats.draws / h2hResult.overallStats.total) * 100}%">
                                    ${h2hResult.overallStats.draws > 0 ? h2hResult.overallStats.draws : ''}
                                </div>
                                <div class="h2h-segment h2h-losses" style="width: ${(h2hResult.overallStats.team2Wins / h2hResult.overallStats.total) * 100}%; ${actualTeam2Style}">
                                    ${h2hResult.overallStats.team2Wins > 0 ? h2hResult.overallStats.team2Wins : ''}
                                </div>
                            </div>
                        </div>`;
                }
                
                // Show Team1 Home scenario if home is selected (when HOME button is checked, show Team1 home matches)
                if (state.homeFilter) {
                    visualizationHTML += `
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">${getTeamDisplayName(state.selectedTeam1)} (Home) vs ${getTeamDisplayName(state.selectedTeam2)} (Away)</span>
                                <span class="text-sm text-gray-600">${h2hResult.team1HomeStats.wins}W - ${h2hResult.team1HomeStats.draws}D - ${h2hResult.team1HomeStats.losses}W</span>
                            </div>
                            ${h2hResult.team1HomeStats.total > 0 ? `
                            <div class="h2h-viz-bar">
                                <div class="h2h-segment h2h-wins" style="width: ${(h2hResult.team1HomeStats.wins / h2hResult.team1HomeStats.total) * 100}%; ${actualTeam1Style}">
                                    ${h2hResult.team1HomeStats.wins > 0 ? h2hResult.team1HomeStats.wins : ''}
                                </div>
                                <div class="h2h-segment h2h-draws" style="width: ${(h2hResult.team1HomeStats.draws / h2hResult.team1HomeStats.total) * 100}%">
                                    ${h2hResult.team1HomeStats.draws > 0 ? h2hResult.team1HomeStats.draws : ''}
                                </div>
                                <div class="h2h-segment h2h-losses" style="width: ${(h2hResult.team1HomeStats.losses / h2hResult.team1HomeStats.total) * 100}%; ${actualTeam2Style}">
                                    ${h2hResult.team1HomeStats.losses > 0 ? h2hResult.team1HomeStats.losses : ''}
                                </div>
                            </div>
                            ` : '<div class="text-sm text-gray-500 italic">No matches found</div>'}
                        </div>`;
                }
                
                // Show Team2 Home scenario if away is selected (when AWAY button is checked, show Team2 home matches)
                if (state.awayFilter) {
                    visualizationHTML += `
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">${getTeamDisplayName(state.selectedTeam2)} (Home) vs ${getTeamDisplayName(state.selectedTeam1)} (Away)</span>
                                <span class="text-sm text-gray-600">${h2hResult.team2HomeStats.wins}W - ${h2hResult.team2HomeStats.draws}D - ${h2hResult.team2HomeStats.losses}W</span>
                            </div>
                            ${h2hResult.team2HomeStats.total > 0 ? `
                            <div class="h2h-viz-bar">
                                <div class="h2h-segment h2h-wins" style="width: ${(h2hResult.team2HomeStats.wins / h2hResult.team2HomeStats.total) * 100}%; ${actualTeam2Style}">
                                    ${h2hResult.team2HomeStats.wins > 0 ? h2hResult.team2HomeStats.wins : ''}
                                </div>
                                <div class="h2h-segment h2h-draws" style="width: ${(h2hResult.team2HomeStats.draws / h2hResult.team2HomeStats.total) * 100}%">
                                    ${h2hResult.team2HomeStats.draws > 0 ? h2hResult.team2HomeStats.draws : ''}
                                </div>
                                <div class="h2h-segment h2h-losses" style="width: ${(h2hResult.team2HomeStats.losses / h2hResult.team2HomeStats.total) * 100}%; ${actualTeam1Style}">
                                    ${h2hResult.team2HomeStats.losses > 0 ? h2hResult.team2HomeStats.losses : ''}
                                </div>
                            </div>
                            ` : '<div class="text-sm text-gray-500 italic">No matches found</div>'}
                        </div>`;
                }
                
                elements.h2hVisualizations.innerHTML = visualizationHTML;
                
                // Update H2H matches table based on filter state
                updateH2HMatchesTable(h2hResult);
            } else {
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
            }
        }

        // Update H2H matches table
        function updateH2HMatchesTable(h2hResult) {
            if (!h2hResult || !h2hResult.matches || h2hResult.matches.length === 0) {
                elements.h2hMatchesTable.classList.add('hidden');
                return;
            }

            // Hide the Match History table if both home and away filters are unchecked
            if (!state.homeFilter && !state.awayFilter) {
                elements.h2hMatchesTable.classList.add('hidden');
                return;
            }

            elements.h2hMatchesTable.classList.remove('hidden');
            elements.h2hTableTitle.textContent = `${getTeamDisplayName(state.selectedTeam1)} vs ${getTeamDisplayName(state.selectedTeam2)}`;

            // Create sorted matches data
            let matchesData = h2hResult.matches.map(match => {
                const homeScore = parseInt(match.FTHG) || 0;
                const awayScore = parseInt(match.FTAG) || 0;
                
                // Get team colors first
                const homeTeamColor = getTeamColor(match.HomeTeam, state.selectedLeague);
                const awayTeamColor = getTeamColor(match.AwayTeam, state.selectedLeague);
                
                // Determine winner and score colors
                let winnerTeam = '';
                let homeScoreClass = '';
                let awayScoreClass = '';
                let resultStyle = '';
                
                if (homeScore > awayScore) {
                    // Home team wins
                    winnerTeam = match.HomeTeam;
                    homeScoreClass = 'font-bold win-score';
                    awayScoreClass = 'text-red-600 font-bold';
                    resultStyle = homeTeamColor ? 
                        `color: ${homeTeamColor} !important; font-weight: bold;` : 
                        'color: #059669 !important; font-weight: bold;'; // Default green
                } else if (awayScore > homeScore) {
                    // Away team wins
                    winnerTeam = match.AwayTeam;
                    homeScoreClass = 'text-red-600 font-bold';
                    awayScoreClass = 'font-bold win-score';
                    resultStyle = awayTeamColor ? 
                        `color: ${awayTeamColor} !important; font-weight: bold;` : 
                        'color: #059669 !important; font-weight: bold;'; // Default green
                } else {
                    // Draw
                    winnerTeam = 'Draw';
                    homeScoreClass = 'text-gray-400 font-bold draw-score';
                    awayScoreClass = 'text-gray-400 font-bold draw-score';
                    resultStyle = 'color: #9ca3af !important; font-weight: bold;'; // Lighter gray for draws
                }

                // Add team highlights - blue for Team 1, green for Team 2 (subtle like points badge)
                const isHomeTeam1 = match.HomeTeam === state.selectedTeam1;
                const isHomeTeam2 = match.HomeTeam === state.selectedTeam2;
                const isAwayTeam1 = match.AwayTeam === state.selectedTeam1;
                const isAwayTeam2 = match.AwayTeam === state.selectedTeam2;
                
                // Create subtle highlight classes similar to points-badge
                const homeTeamClass = isHomeTeam1 ? 'team1-highlight' : 
                                    isHomeTeam2 ? 'team2-highlight' : '';
                const awayTeamClass = isAwayTeam1 ? 'team1-highlight' : 
                                    isAwayTeam2 ? 'team2-highlight' : '';
                
                // Combine team color with highlight classes for inline styles  
                const homeTeamFinalStyle = homeTeamColor ? `color: ${homeTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
                const awayTeamFinalStyle = awayTeamColor ? `color: ${awayTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
                
                // Update result style to include subtle highlight for winner (but not for draws)
                let finalResultStyle = resultStyle;
                let resultClass = '';
                if (winnerTeam !== 'Draw') {
                    if (winnerTeam === state.selectedTeam1) {
                        resultClass = 'team1-highlight';
                    } else if (winnerTeam === state.selectedTeam2) {
                        resultClass = 'team2-highlight';
                    }
                }

                return {
                    date: match.dateObj.toLocaleDateString('en-US'),
                    dateSort: match.dateObj,
                    homeTeam: match.HomeTeam,
                    homeTeamColor: homeTeamColor,
                    homeTeamStyle: homeTeamFinalStyle,
                    homeTeamClass: homeTeamClass,
                    homeScore: homeScore,
                    homeScoreClass: homeScoreClass,
                    awayTeam: match.AwayTeam,
                    awayTeamColor: awayTeamColor,
                    awayTeamStyle: awayTeamFinalStyle,
                    awayTeamClass: awayTeamClass,
                    awayScore: awayScore,
                    awayScoreClass: awayScoreClass,
                    result: winnerTeam,
                    resultStyle: finalResultStyle,
                    resultClass: resultClass
                };
            });

            // Note: Filtering and recent match count limiting is now done in calculateHeadToHead()
            // The matches passed here are already filtered and limited

            // Sort by current sort config
            if (state.h2hSortConfig.key) {
                matchesData.sort((a, b) => {
                    const key = state.h2hSortConfig.key;
                    let aVal = key === 'date' ? a.dateSort : a[key];
                    let bVal = key === 'date' ? b.dateSort : b[key];
                    
                    if (key === 'homeScore' || key === 'awayScore') {
                        aVal = parseInt(aVal) || 0;
                        bVal = parseInt(bVal) || 0;
                    }
                    
                    if (state.h2hSortConfig.direction === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });
            }

            // Update match count display with filtered count
            elements.h2hMatchCount.textContent = `(${matchesData.length} matches)`;

            // Create table headers
            const headers = [
                { key: 'date', label: 'Date' },
                { key: 'homeTeam', label: 'Home Team' },
                { key: 'homeScore', label: 'Home Score' },
                { key: 'awayTeam', label: 'Away Team' },
                { key: 'awayScore', label: 'Away Score' },
                { key: 'result', label: 'Result' }
            ];

            elements.h2hTableHeader.innerHTML = headers.map(header => `
                <th class="${header.key.includes('Team') ? 'text-center' : 'text-center'} cursor-pointer" 
                    onclick="handleH2hSort('${header.key}')">
                    ${header.label}${getH2hSortIndicator(header.key)}
                </th>
            `).join('');

            // Add/remove class to enable transparent highlighting when Team 1 is selected
            if (state.selectedTeam1) {
                elements.h2hTableBody.classList.add('team1-selected');
            } else {
                elements.h2hTableBody.classList.remove('team1-selected');
            }

            // Update table body
            elements.h2hTableBody.innerHTML = matchesData.map((match, index) => {
                const isTeam1Home = match.homeTeam === state.selectedTeam1;
                const isTeam1Away = match.awayTeam === state.selectedTeam1;
                
                // Get team logos
                const homeLogoUrl = getTeamLogoUrl(match.homeTeam, state.selectedLeague);
                const awayLogoUrl = getTeamLogoUrl(match.awayTeam, state.selectedLeague);
                
                // Get winner logo for result column (if not a draw)
                const winnerLogoUrl = match.result !== 'Draw' ? getTeamLogoUrl(match.result, state.selectedLeague) : null;
                
                return `
                    <tr>
                        <td class="text-center text-sm">${match.date}</td>
                        <td class="text-center">
                            <div class="flex items-center justify-center">
                                ${homeLogoUrl ? `<img src="${homeLogoUrl}" alt="${match.homeTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="${match.homeTeamClass}" style="${match.homeTeamStyle}">${match.homeTeam}</span>
                            </div>
                        </td>
                        <td class="text-center text-lg ${match.homeScoreClass}" >${match.homeScore}</td>
                        <td class="text-center">
                            <div class="flex items-center justify-center">
                                ${awayLogoUrl ? `<img src="${awayLogoUrl}" alt="${match.awayTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="${match.awayTeamClass}" style="${match.awayTeamStyle}">${match.awayTeam}</span>
                            </div>
                        </td>
                        <td class="text-center text-lg ${match.awayScoreClass}" >${match.awayScore}</td>
                        <td class="text-center">
                            <div class="flex items-center justify-center">
                                ${winnerLogoUrl ? `<img src="${winnerLogoUrl}" alt="${match.result} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="${match.resultClass}" style="${match.resultStyle}">${match.result}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Handle H2H table sorting
        function handleH2hSort(key) {
            let direction = 'desc';
            if (key === 'homeTeam' || key === 'awayTeam' || key === 'result') {
                direction = 'asc';
            }
            
            if (state.h2hSortConfig.key === key) {
                if (state.h2hSortConfig.direction === 'desc') {
                    state.h2hSortConfig.direction = 'asc';
                } else if (state.h2hSortConfig.direction === 'asc') {
                    state.h2hSortConfig.direction = 'desc';
                } else {
                    state.h2hSortConfig.direction = direction;
                }
            } else {
                state.h2hSortConfig.key = key;
                state.h2hSortConfig.direction = direction;
            }
            
            updateTable();
        }

        // Get H2H sort indicator
        function getH2hSortIndicator(key) {
            if (state.h2hSortConfig.key !== key) return ' ‚ÜïÔ∏è';
            return state.h2hSortConfig.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
        }

        // Update last data update based on most recent game
        function updateLastDataUpdate() {
            if (!state.data || state.data.length === 0) {
                elements.lastDataUpdate.textContent = 'Last Data Update: No data available';
                return;
            }

            // Find the most recent game date
            let mostRecentDate = null;

            state.data.forEach(match => {
                if (match.dateObj && match.dateObj instanceof Date && !isNaN(match.dateObj)) {
                    if (!mostRecentDate || match.dateObj > mostRecentDate) {
                        mostRecentDate = match.dateObj;
                    }
                }
            });

            if (mostRecentDate) {
                // Format the date as "Month Day, Year"
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = mostRecentDate.toLocaleDateString('en-US', options);
                elements.lastDataUpdate.textContent = `Last Data Update: ${formattedDate}`;
            } else {
                elements.lastDataUpdate.textContent = 'Last Data Update: Unknown';
            }
        }

        // Update table info display
        function updateTableInfo(tableResult) {
            if (state.data.length > 0) {
                const leagueNames = {
                    'premier-league': 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League',
                    'la-liga': 'üá™üá∏ La Liga',
                    'serie-a': 'üáÆüáπ Serie A',
                    'bundesliga': 'üá©üá™ Bundesliga',
                    'ligue-1': 'üá´üá∑ Ligue 1'
                };
                
                let text = leagueNames[state.selectedLeague];
                
                if (state.homeFilter && state.awayFilter) text += ' - All Results';
                else if (state.homeFilter) text += ' - Home Results Only';
                else if (state.awayFilter) text += ' - Away Results Only';
                else text += ' - No Results Selected';
                
                text += ` (${tableResult.matchCount} matches) ‚Ä¢ ${tableResult.tableData.length} teams`;
                
                elements.tableInfoText.textContent = text;
                
                // Only show table info if we're on the League Filters tab
                const isLeagueFiltersActive = document.getElementById('leagueFiltersTab').classList.contains('active');
                if (isLeagueFiltersActive) {
                    elements.tableInfo.classList.remove('hidden');
                } else {
                    elements.tableInfo.classList.add('hidden');
                }
            } else {
                elements.tableInfo.classList.add('hidden');
            }
        }

        // Get historical point system based on season and league
        function getHistoricalPointSystem(season, league) {
            // Extract starting year from season (e.g., "1994-95" -> 1994)
            const year = parseInt(season.split('-')[0]);
            
            // 3-point system introduction dates by league
            const threePointIntroduction = {
                'premier-league': 1981,  // English First Division introduced 3 points in 1981-82
                'la-liga': 1995,         // La Liga introduced 3 points in 1995-96
                'serie-a': 1994,         // Serie A introduced 3 points in 1994-95
                'bundesliga': 1995,      // Bundesliga introduced 3 points in 1995-96
                'ligue-1': 1994          // Ligue 1 introduced 3 points in 1994-95
            };
            
            const introYear = threePointIntroduction[league];
            
            // For Ligue 1, special handling for 1988-89 season
            if (league === 'ligue-1') {
                if (year >= introYear || year === 1988) {
                    return 3; // 3 points for a win (>=1994 or 1988)
                } else {
                    return 2; // 2 points for a win (<1994 and !=1988)
                }
            } else {
                // For other leagues, use standard logic
                if (introYear && year >= introYear) {
                    return 3; // 3 points for a win
                } else {
                    return 2; // 2 points for a win (historical system)
                }
            }
        }


        // Handle team click events
        function handleTeamClick(event) {
            // Team click event triggered
            const teamClickable = event.target.closest('.team-clickable');
            // Found team clickable element
            if (teamClickable) {
                event.preventDefault();
                event.stopPropagation();
                const teamName = teamClickable.getAttribute('data-team');
                // Team name found
                if (teamName) {
                    // Calling showTeamHistory without auto-detecting league
                    // This preserves the current league selection
                    showTeamHistory(teamName);
                } else {
                    // No team name found in data-team attribute
                }
            } else {
                // No team-clickable element found
            }
        }

        // Go back to League Tables with restored state
        function goBackToLeagueTables() {
            if (!state.previousLeagueTablesState) return;

            const savedState = state.previousLeagueTablesState;

            // Restore all League Tables state
            state.selectedLeague = savedState.selectedLeague;
            state.selectedTeam1 = savedState.selectedTeam1;
            state.selectedTeam2 = savedState.selectedTeam2;
            state.selectedSeason = savedState.selectedSeason;
            state.dateFrom = savedState.dateFrom;
            state.dateTo = savedState.dateTo;
            state.selectedDayOfWeek = savedState.selectedDayOfWeek;
            state.homeFilter = savedState.homeFilter;
            state.awayFilter = savedState.awayFilter;
            state.pointDeductionsEnabled = savedState.pointDeductionsEnabled;
            state.threePointSystem = savedState.threePointSystem;
            state.recentH2HCount = savedState.recentH2HCount;

            // Restore UI elements
            elements.team1Select.value = savedState.selectedTeam1;
            elements.team2Select.value = savedState.selectedTeam2;

            // Update comboboxes if they exist
            if (team1Combobox) {
                const team1Text = savedState.selectedTeam1 || 'All Teams';
                team1Combobox.setValue(savedState.selectedTeam1, team1Text);
            }
            if (team2Combobox) {
                const team2Text = savedState.selectedTeam2 || 'No Team';
                team2Combobox.setValue(savedState.selectedTeam2, team2Text);
            }
            if (teamSeasonsCombobox) {
                const teamSeasonsText = savedState.teamSeasonsSelectedTeam || 'Choose a team...';
                teamSeasonsCombobox.setValue(savedState.teamSeasonsSelectedTeam, teamSeasonsText);
            }
            if (lastTimeTeam1Combobox) {
                lastTimeTeam1Combobox.setValue('', 'Select Team 1');
            }
            if (lastTimeTeam2Combobox) {
                lastTimeTeam2Combobox.setValue('', 'Select Team 2');
            }
            if (teamStreaksTeam1Combobox) {
                teamStreaksTeam1Combobox.setValue('', 'Select Team 1');
            }
            if (teamStreaksTeam2Combobox) {
                teamStreaksTeam2Combobox.setValue('', 'Select Team 2');
            }
            elements.seasonSelect.value = savedState.selectedSeason;
            elements.dayOfWeekSelect.value = savedState.selectedDayOfWeek;

            // Restore checkboxes
            elements.homeCheckbox.className = `checkbox ${savedState.homeFilter ? 'checked' : ''}`;
            elements.awayCheckbox.className = `checkbox ${savedState.awayFilter ? 'checked' : ''}`;
            elements.deductionsCheckbox.className = `checkbox ${savedState.pointDeductionsEnabled ? 'checked' : ''}`;
            elements.threePointCheckbox.className = `checkbox ${savedState.threePointSystem ? 'checked' : ''}`;

            // Switch back to League Tables tab
            switchTab('league-filters');

            // Clear the saved state
            state.previousLeagueTablesState = null;
        }

        // Show team history across seasons
        function showTeamHistory(teamName, sourceLeague = null) {
            // showTeamHistory called
            // Current state.data length

            // Determine which league to use based on source
            let leagueToUse;
            if (sourceLeague) {
                // Called from Team Seasons dropdown - use the specified league
                leagueToUse = sourceLeague;
                state.teamSeasonsSelectedLeague = sourceLeague;
                // Hide back arrow when navigating from within Team Seasons
                elements.teamHistoryBackArrow.classList.add('hidden');
            } else {
                // Called from League Filters clicking - save current state and show back arrow
                leagueToUse = state.selectedLeague;
                // Update teamSeasonsSelectedLeague to match current league
                state.teamSeasonsSelectedLeague = state.selectedLeague;

                // Save current League Tables state for back navigation
                state.previousLeagueTablesState = {
                    selectedLeague: state.selectedLeague,
                    selectedTeam1: state.selectedTeam1,
                    selectedTeam2: state.selectedTeam2,
                    selectedSeason: state.selectedSeason,
                    dateFrom: state.dateFrom,
                    dateTo: state.dateTo,
                    selectedDayOfWeek: state.selectedDayOfWeek,
                    homeFilter: state.homeFilter,
                    awayFilter: state.awayFilter,
                    pointDeductionsEnabled: state.pointDeductionsEnabled,
                    threePointSystem: state.threePointSystem,
                    recentH2HCount: state.recentH2HCount
                };

                // Show back arrow when navigating from League Tables
                elements.teamHistoryBackArrow.classList.remove('hidden');
            }

            state.teamSeasonsSelectedTeam = teamName;
            // Using league
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const divCode = leagueMapping[leagueToUse];
            if (!divCode) return;
            
            // Get all available seasons for this league
            const availableSeasons = getAvailableSeasons(leagueToUse);
            // Available seasons found
            const teamHistoryData = [];
            
            // Filter seasons based on Team Seasons selection (if any)
            let seasonsToProcess = availableSeasons;
            if (sourceLeague && state.teamSeasonsSelectedSeason) {
                // For era seasons, filter individual seasons to only those within the era date range
                if (state.teamSeasonsSelectedSeason.includes('all-') || state.teamSeasonsSelectedSeason.includes('-era-') || state.teamSeasonsSelectedSeason.includes('french-division-1')) {
                    const originalSelectedLeague = state.selectedLeague;
                    state.selectedLeague = leagueToUse;
                    const eraSeasonDates = getSeasonDateRange(state.teamSeasonsSelectedSeason);
                    state.selectedLeague = originalSelectedLeague;
                    
                    if (eraSeasonDates) {
                        const eraStart = new Date(eraSeasonDates.start);
                        const eraEnd = new Date(eraSeasonDates.end);
                        
                        // Filter individual seasons to only those that fall within the era
                        seasonsToProcess = availableSeasons.filter(season => {
                            // Skip era seasons themselves in this filtering
                            if (season.includes('all-') || season.includes('-era-') || season.includes('french-division-1')) {
                                return false;
                            }

                            const originalSelectedLeague2 = state.selectedLeague;
                            state.selectedLeague = leagueToUse;
                            const seasonDates = getSeasonDateRange(season);
                            state.selectedLeague = originalSelectedLeague2;

                            if (!seasonDates) return false;

                            const seasonStart = new Date(seasonDates.start);
                            const seasonEnd = new Date(seasonDates.end);

                            // Include season if it starts on or after era start and ends before or on era end
                            return seasonStart >= eraStart && seasonEnd <= eraEnd;
                        });
                    }
                } else {
                    // For individual seasons (shouldn't happen in Team Seasons but keeping for safety)
                    seasonsToProcess = [state.teamSeasonsSelectedSeason];
                }
            }

            // Check each season for the team's data
            seasonsToProcess.forEach(seasonFilter => {
                // Skip special seasons like "all" seasons, era seasons, and french division 1
                if (seasonFilter.includes('all-') || seasonFilter.includes('-era-') || seasonFilter.includes('french-division-1')) {
                    return;
                }
                
                // Processing season for team
                
                // Get season date range
                const originalSelectedLeague = state.selectedLeague;
                state.selectedLeague = leagueToUse; // Temporarily set for date range lookup
                const seasonDates = getSeasonDateRange(seasonFilter);
                state.selectedLeague = originalSelectedLeague; // Restore original
                if (!seasonDates) {
                    // No season dates found
                    return;
                }
                // Season dates found
                
                // Filter data for this season - use date-only comparisons
                const seasonStart = new Date(seasonDates.start);
                seasonStart.setUTCHours(0, 0, 0, 0); // Start of day UTC
                const seasonEnd = new Date(seasonDates.end);
                seasonEnd.setUTCHours(23, 59, 59, 999); // End of day UTC
                
                // Extract the year from the season (e.g., "2019-20" -> 2019, "2020-21" -> 2020)
                const seasonYear = parseInt(seasonFilter.split('-')[0]);
                
                // Get ALL games for this season (not just for the selected team)
                const allSeasonData = state.data.filter(row => {
                    if (row.Div !== divCode) return false;
                    
                    const matchDate = new Date(row.dateObj);
                    const gameYear = matchDate.getFullYear();
                    
                    // Pre-filter: only consider games from years that could belong to this season
                    // For season "2019-20", only look at games from 2019 and 2020
                    if (gameYear < seasonYear || gameYear > seasonYear + 1) return false;
                    
                    const inRange = matchDate >= seasonStart && matchDate <= seasonEnd;
                    
                    
                    return inRange;
                });
                
                // Get games specifically for this team
                const teamMatches = allSeasonData.filter(row => 
                    row.HomeTeam === teamName || row.AwayTeam === teamName
                );
                
                if (teamMatches.length === 0) return; // Team not present in this season
                
                // Calculate team stats for this season
                let played = 0, won = 0, drawn = 0, lost = 0;
                let goalsFor = 0, goalsAgainst = 0;
                
                teamMatches.forEach(match => {
                    played++;
                    const homeGoals = parseInt(match.FTHG) || 0;
                    const awayGoals = parseInt(match.FTAG) || 0;
                    
                    
                    if (match.HomeTeam === teamName) {
                        goalsFor += homeGoals;
                        goalsAgainst += awayGoals;
                        if (homeGoals > awayGoals) won++;
                        else if (homeGoals === awayGoals) drawn++;
                        else lost++;
                    } else {
                        goalsFor += awayGoals;
                        goalsAgainst += homeGoals;
                        if (awayGoals > homeGoals) won++;
                        else if (awayGoals === homeGoals) drawn++;
                        else lost++;
                    }
                });
                
                const goalDifference = goalsFor - goalsAgainst;
                const winPoints = getHistoricalPointSystem(seasonFilter, leagueToUse);
                let points = won * winPoints + drawn;
                
                // Apply point deductions for this season
                if (seasonDates) {
                    const seasonStart = new Date(seasonDates.start);
                    const seasonEnd = new Date(seasonDates.end);
                    
                    pointDeductions.forEach(deduction => {
                        if (deduction.team === teamName && deduction.league === divCode) {
                            const deductionStart = new Date(deduction.startDate);
                            const deductionEnd = new Date(deduction.endDate);
                            
                            const hasOverlap = (seasonStart <= deductionEnd) && (seasonEnd >= deductionStart);
                            
                            if (hasOverlap && state.pointDeductionsEnabled) {
                                points -= deduction.points;
                            }
                        }
                    });
                }
                
                // Calculate position by building full league table for this season
                const leagueTeams = {};
                allSeasonData.forEach(match => {
                    [match.HomeTeam, match.AwayTeam].forEach(team => {
                        if (!leagueTeams[team]) {
                            leagueTeams[team] = { played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0 };
                        }
                    });
                });
                
                // Calculate stats for all teams
                allSeasonData.forEach(match => {
                    const homeGoals = parseInt(match.FTHG) || 0;
                    const awayGoals = parseInt(match.FTAG) || 0;
                    
                    leagueTeams[match.HomeTeam].played++;
                    leagueTeams[match.AwayTeam].played++;
                    
                    leagueTeams[match.HomeTeam].goalsFor += homeGoals;
                    leagueTeams[match.HomeTeam].goalsAgainst += awayGoals;
                    leagueTeams[match.AwayTeam].goalsFor += awayGoals;
                    leagueTeams[match.AwayTeam].goalsAgainst += homeGoals;
                    
                    if (homeGoals > awayGoals) {
                        leagueTeams[match.HomeTeam].won++;
                        leagueTeams[match.AwayTeam].lost++;
                    } else if (homeGoals === awayGoals) {
                        leagueTeams[match.HomeTeam].drawn++;
                        leagueTeams[match.AwayTeam].drawn++;
                    } else {
                        leagueTeams[match.HomeTeam].lost++;
                        leagueTeams[match.AwayTeam].won++;
                    }
                });
                
                // Convert to array and calculate points
                const winPointsForSeason = getHistoricalPointSystem(seasonFilter, leagueToUse);
                const seasonTable = Object.keys(leagueTeams).map(team => {
                    const stats = leagueTeams[team];
                    let teamPoints = stats.won * winPointsForSeason + stats.drawn;
                    
                    // Apply point deductions for each team
                    if (seasonDates) {
                        const seasonStart = new Date(seasonDates.start);
                        const seasonEnd = new Date(seasonDates.end);
                        
                        pointDeductions.forEach(deduction => {
                            if (deduction.team === team && deduction.league === divCode) {
                                const deductionStart = new Date(deduction.startDate);
                                const deductionEnd = new Date(deduction.endDate);
                                
                                const hasOverlap = (seasonStart <= deductionEnd) && (seasonEnd >= deductionStart);
                                
                                if (hasOverlap && state.pointDeductionsEnabled) {
                                    teamPoints -= deduction.points;
                                }
                            }
                        });
                    }
                    
                    return {
                        team,
                        ...stats,
                        goalDifference: stats.goalsFor - stats.goalsAgainst,
                        points: teamPoints
                    };
                });
                
                // Sort by points, then goal difference, then goals for
                seasonTable.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                    return b.goalsFor - a.goalsFor;
                });
                
                // Apply ranking overrides for this season
                const overriddenTable = applyRankingOverrides(seasonTable, leagueToUse, seasonFilter);
                
                // Note: Don't re-sort after overrides as it would undo the override positioning
                
                // Find team position (check for override position first)
                let position;
                const teamInTable = overriddenTable.find(team => team.team === teamName);
                if (teamInTable && teamInTable.sharedPosition) {
                    position = teamInTable.sharedPosition;
                } else {
                    position = overriddenTable.findIndex(team => team.team === teamName) + 1;
                }
                
                teamHistoryData.push({
                    season: seasonFilter,
                    position,
                    played,
                    won,
                    drawn,
                    lost,
                    goalsFor,
                    goalsAgainst,
                    goalDifference,
                    points
                });
            });

            // Add historic seasons data if enabled
            if (state.includeHistoricSeasons) {
                const historicData = getHistoricSeasonsData(teamName, null, leagueToUse);
                teamHistoryData.push(...historicData);
            }

            // Sort by season (most recent first)
            teamHistoryData.sort((a, b) => {
                // Extract year from season string (e.g., "2023-24" -> 2023)
                const yearA = parseInt(a.season.split('-')[0]);
                const yearB = parseInt(b.season.split('-')[0]);
                return yearB - yearA;
            });

            // Team history data found
            // Sample data processed

            displayTeamHistory(teamName, teamHistoryData, leagueToUse);
        }

        // Display team history table
        function displayTeamHistory(teamName, historyData, leagueToUse) {
            // displayTeamHistory called
            // History data processed
            
            // Filter by position if selected
            let filteredData = [...historyData];
            let positionInfo = '';
            
            if (state.teamSeasonsSelectedPosition) {
                const selectedPos = parseInt(state.teamSeasonsSelectedPosition);
                // Filter by position, excluding only current season if under 34 games
                filteredData = historyData.filter(season => {
                    // Apply position filtering with Include Better Results logic
                    let positionMatch;
                    if (state.includeBetterResults) {
                        // Include positions equal to or better than selected (lower numbers are better)
                        positionMatch = season.position <= selectedPos;
                    } else {
                        // Include only exact position match
                        positionMatch = season.position === selectedPos;
                    }
                    if (!positionMatch) return false;
                    
                    // Always include seasons with 34+ games
                    if (season.played >= 34) return true;
                    
                    // For seasons under 34 games, exclude only if it's the current season (2025-26)
                    const isCurrentSeason = season.season === '2025-26';
                    return !isCurrentSeason;
                }).filter(season => {
                    // Apply stripped champions filtering (both team and position are selected)
                    const leagueMapping = {
                        'premier-league': 'E0',
                        'la-liga': 'SP1',
                        'serie-a': 'I1',
                        'bundesliga': 'D1',
                        'ligue-1': 'F1'
                    };
                    const divCode = leagueMapping[leagueToUse];
                    return !isStrippedChampion(teamName, divCode, season.season, season.position, true, true);
                });
                
                // Calculate years since last occurrence
                if (filteredData.length > 0) {
                    // Sort by season to find most recent season
                    const sortedByYear = [...filteredData].sort((a, b) => {
                        const yearA = parseInt(a.season.split('-')[0]);
                        const yearB = parseInt(b.season.split('-')[0]);
                        return yearB - yearA;
                    });
                    
                    // Most recent season (already qualifies since we filtered for 34+ games)
                    const qualifyingSeason = sortedByYear[0];
                    
                    // Count total times finished at this position (34+ games only)
                    const totalCount = filteredData.length;
                    
                    const mostRecentYear = parseInt(qualifyingSeason.season.split('-')[0]);
                    const currentYear = new Date().getFullYear();
                    
                    // Calculate seasons since the qualifying season
                    const seasonsSince = currentYear - mostRecentYear;
                    
                    const seasonText = seasonsSince === 0 ? '0 Seasons Ago (Current Season)' : 
                                     seasonsSince === 1 ? '1 Season Ago' : `${seasonsSince} Seasons Ago`;
                    
                    const countText = totalCount === 1 ? 'Time' : 'Times';
                    const positionText = state.includeBetterResults ?
                        `${getOrdinal(selectedPos)} or better` :
                        getOrdinal(selectedPos);
                    positionInfo = `Most Recent: ${qualifyingSeason.season} Season, ${seasonText}. Finished ${positionText} a total of ${totalCount} ${countText}.`;
                } else {
                    const positionText = state.includeBetterResults ?
                        `${getOrdinal(selectedPos)} or better` :
                        getOrdinal(selectedPos);
                    positionInfo = `No seasons found where ${teamName} finished ${positionText} (excluding incomplete current season)`;
                }
            }
            
            // Update position info display and ensure it persists
            elements.teamSeasonsPositionInfo.innerHTML = positionInfo || 'NO POSITION INFO';

            // Apply proper subtle styling to match website design
            elements.teamSeasonsPositionInfo.style.cssText = 'margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280; line-height: 1.25;';
            elements.teamSeasonsPositionInfo.style.display = 'block';

            // Double-check and force the text to stay after a brief delay
            setTimeout(() => {
                if (positionInfo && positionInfo.trim() && (!elements.teamSeasonsPositionInfo.textContent || elements.teamSeasonsPositionInfo.textContent.trim() === '')) {
                    elements.teamSeasonsPositionInfo.innerHTML = positionInfo;
                }
            }, 100);
            
            // Store data globally for sorting
            window.currentTeamHistoryData = [...filteredData];
            window.currentTeamHistoryName = teamName;
            
            elements.teamHistoryTitle.textContent = `${teamName} - Season History`;
            
            // Apply sorting if active
            let sortedData = [...filteredData];
            if (state.teamHistorySortConfig.key && state.teamHistorySortConfig.direction) {
                const key = state.teamHistorySortConfig.key;
                const direction = state.teamHistorySortConfig.direction;
                
                sortedData.sort((a, b) => {
                    let aVal = a[key];
                    let bVal = b[key];
                    
                    // Handle season sorting specially
                    if (key === 'season') {
                        // Extract year from season string (e.g., "2023-24" -> 2023)
                        aVal = parseInt(aVal.split('-')[0]);
                        bVal = parseInt(bVal.split('-')[0]);
                    }
                    
                    // Convert to numbers for numerical columns
                    if (typeof aVal === 'string' && !isNaN(aVal)) aVal = parseFloat(aVal);
                    if (typeof bVal === 'string' && !isNaN(bVal)) bVal = parseFloat(bVal);
                    
                    if (direction === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });
            }
            
            const headers = [
                { key: 'season', label: 'Season' },
                { key: 'team', label: 'Team' },
                { key: 'played', label: 'P' },
                { key: 'won', label: 'W' },
                { key: 'drawn', label: 'D' },
                { key: 'lost', label: 'L' },
                { key: 'goalsFor', label: 'GF' },
                { key: 'goalsAgainst', label: 'GA' },
                { key: 'goalDifference', label: 'GD' },
                { key: 'points', label: 'Pts' },
                { key: 'position', label: 'Pos' }
            ];
            
            elements.teamHistoryHeader.innerHTML = headers.map(header => `
                <th class="px-3 py-4 text-center font-bold text-sm ${header.key !== 'team' ? 'cursor-pointer hover:bg-gray-600' : ''}" 
                    ${header.key !== 'team' ? `onclick="handleTeamHistorySort('${header.key}')"` : ''}
                    style="text-align: ${(header.key === 'season' || header.key === 'team') ? 'left' : 'center'}">
                    ${header.label}${header.key !== 'team' ? getTeamHistorySortIndicator(header.key) : ''}
                </th>
            `).join('');
            
            elements.teamHistoryBody.innerHTML = sortedData.map((season, index) => {
                const rowBackgroundClass = sortedData.length >= 3 && index % 2 === 1 ? 'bg-gray-100' : 'bg-gray-50';
                const logoUrl = getTeamLogoUrl(teamName, leagueToUse);
                
                return `
                    <tr class="border-b hover:bg-gray-50 ${rowBackgroundClass}">
                        <td class="px-3 py-4 font-semibold text-left">
                            ${season.season}
                            ${season.isHistoric ? '<span class="ml-2 px-2 py-1 text-xs bg-amber-100 text-amber-800 rounded-full">Historic</span>' : ''}
                        </td>
                        <td class="px-4 py-4 font-semibold text-gray-900">
                            <div class="flex items-center">
                                ${logoUrl ? `<img src="${logoUrl}" alt="${teamName} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span>${teamName}</span>
                            </div>
                        </td>
                        <td class="px-3 py-4 text-center">${season.played}</td>
                        <td class="px-3 py-4 text-center">${season.won}</td>
                        <td class="px-3 py-4 text-center">${season.drawn}</td>
                        <td class="px-3 py-4 text-center">${season.lost}</td>
                        <td class="px-3 py-4 text-center">${season.goalsFor}</td>
                        <td class="px-3 py-4 text-center">${season.goalsAgainst}</td>
                        <td class="px-3 py-4 text-center">
                            <span class="font-bold ${season.goalDifference > 0 ? 'text-green-700' : season.goalDifference < 0 ? 'text-red-600' : 'text-black'}">
                                ${season.goalDifference > 0 ? '+' : ''}${season.goalDifference}
                            </span>
                        </td>
                        <td class="px-3 py-4 text-center">
                            <span class="points-badge">
                                ${season.points}
                            </span>
                        </td>
                        <td class="px-3 py-4 text-center font-bold" style="${
                            season.position === 1 ? 'color: #d97706; background-color: #fef3c7;' : 
                            season.position === 2 ? 'color: #374151; background-color: #e5e7eb;' : 
                            season.position === 3 ? 'color: #b45309; background-color: #fef7ed;' : 
                            'color: #6b7280;'
                        }">${season.position}</td>
                    </tr>
                `;
            }).join('');
            
            // Switch to Team Seasons tab and show the table
            switchTab('team-seasons');
            
            // Update Team Seasons controls to reflect current selection
            createTeamSeasonsLeagueButtons();
            updateTeamSeasonsTeamSelect();
            
            // Final teamHistoryData processed
            elements.teamHistoryTable.classList.remove('hidden');
            // Team history table should now be visible
        }

        // Handle sorting
        function handleSort(key) {
            // Determine if this is a numerical column
            const numericalColumns = ['played', 'won', 'drawn', 'lost', 'goalsFor', 'goalsAgainst', 'goalDifference', 'points'];
            const isNumerical = numericalColumns.includes(key);
            
            // Set initial direction based on column type
            let direction = key === 'team' ? 'asc' : 'desc'; // Team: A-Z first, Numbers: high to low first
            
            if (state.sortConfig.key === key) {
                if (isNumerical) {
                    // Numerical columns: desc -> asc -> clear
                    if (state.sortConfig.direction === 'desc') {
                        direction = 'asc';
                    } else if (state.sortConfig.direction === 'asc') {
                        state.sortConfig = { key: null, direction: null };
                        updateTable();
                        return;
                    }
                } else {
                    // Team column: asc -> desc -> clear
                    if (state.sortConfig.direction === 'asc') {
                        direction = 'desc';
                    } else if (state.sortConfig.direction === 'desc') {
                        state.sortConfig = { key: null, direction: null };
                        updateTable();
                        return;
                    }
                }
            }
            
            state.sortConfig = { key, direction };
            updateTable();
        }

        // Handle team history sorting
        function handleTeamHistorySort(key) {
            // Determine if this is a numerical column
            const numericalColumns = ['position', 'count', 'played', 'won', 'drawn', 'lost', 'goalsFor', 'goalsAgainst', 'goalDifference', 'points'];
            const isNumerical = numericalColumns.includes(key);
            
            // Set initial direction based on column type
            let direction = key === 'season' ? 'desc' : 'desc'; // Season: newest first, Numbers: high to low first
            
            if (state.teamHistorySortConfig.key === key) {
                // Already sorting by this key, cycle through directions
                // 3-click cycle for ALL columns: desc -> asc -> null
                if (state.teamHistorySortConfig.direction === 'desc') {
                    direction = 'asc';
                } else if (state.teamHistorySortConfig.direction === 'asc') {
                    direction = null;
                } else {
                    direction = 'desc';
                }
            }
            
            state.teamHistorySortConfig = { key: direction ? key : null, direction };
            
            // Re-display the current team history with new sort
            if (window.currentTeamHistoryData) {
                // Check if we're in position-only mode (multi-team view)
                if (window.currentTeamHistoryName && window.currentTeamHistoryName.startsWith('All teams (Position ')) {
                    // Extract position from the name like "All teams (Position 1)"
                    const positionMatch = window.currentTeamHistoryName.match(/Position (\d+)/);
                    if (positionMatch) {
                        const selectedPos = parseInt(positionMatch[1]);
                        
                        // Sort the data based on direction, or restore default order if null
                        let sortedData = [...window.currentTeamHistoryData];
                        if (direction && key) {
                            const isNumerical = numericalColumns.includes(key);
                            
                            sortedData.sort((a, b) => {
                                let aVal, bVal;
                                
                                if (key === 'season') {
                                    // For seasons, extract year for comparison
                                    aVal = parseInt(a.season.split('-')[0]);
                                    bVal = parseInt(b.season.split('-')[0]);
                                } else if (isNumerical) {
                                    aVal = a[key];
                                    bVal = b[key];
                                } else {
                                    // For text fields like team name
                                    aVal = a[key];
                                    bVal = b[key];
                                }
                                
                                if (direction === 'asc') {
                                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                                        return aVal.localeCompare(bVal);
                                    }
                                    return aVal - bVal;
                                } else {
                                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                                        return bVal.localeCompare(aVal);
                                    }
                                    return bVal - aVal;
                                }
                            });
                        } else if (!direction) {
                            // Restore default order: most recent season first, then by team name
                            sortedData.sort((a, b) => {
                                const yearA = parseInt(a.season.split('-')[0]);
                                const yearB = parseInt(b.season.split('-')[0]);
                                if (yearB !== yearA) return yearB - yearA;
                                return a.team.localeCompare(b.team);
                            });
                        }
                        
                        // Update the stored data and re-render
                        window.currentTeamHistoryData = sortedData;
                        renderPositionOnlyTable(sortedData, selectedPos, state.teamSeasonsSelectedLeague);
                    }
                } else {
                    // Single team mode - use original display function
                    displayTeamHistory(window.currentTeamHistoryName, window.currentTeamHistoryData, state.teamSeasonsSelectedLeague);
                }
            }
        }

        // Get team history sort indicator
        function getTeamHistorySortIndicator(key) {
            if (state.teamHistorySortConfig.key !== key) return ' ‚ÜïÔ∏è';
            
            if (state.teamHistorySortConfig.direction === 'asc') {
                return ' ‚Üë';
            } else if (state.teamHistorySortConfig.direction === 'desc') {
                return ' ‚Üì';
            }
            return ' ‚ÜïÔ∏è';
        }

        // Get sort indicator
        function getSortIndicator(key) {
            if (state.sortConfig.key !== key) return ' ‚ÜïÔ∏è';
            return state.sortConfig.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
        }

        // Match history sorting functions
        function handleMatchHistorySort(key) {
            // Determine if this is a numerical column
            const numericalColumns = ['homeScore', 'awayScore'];
            const isNumerical = numericalColumns.includes(key);

            // Set initial direction based on column type
            let direction = (key === 'homeTeam' || key === 'awayTeam' || key === 'result') ? 'asc' : 'desc';

            if (state.matchHistorySortConfig.key === key) {
                if (isNumerical || key === 'date') {
                    // Numerical columns and date: desc -> asc -> clear
                    if (state.matchHistorySortConfig.direction === 'desc') {
                        direction = 'asc';
                    } else if (state.matchHistorySortConfig.direction === 'asc') {
                        state.matchHistorySortConfig = { key: null, direction: null };
                        // Re-update match history display to clear sort
                        if (state.selectedTeam1 && !state.selectedTeam2) {
                            const matchHistoryResult = calculateMatchHistory();
                            updateMatchHistoryDisplay(matchHistoryResult);
                        }
                        return;
                    }
                } else {
                    // Text columns: asc -> desc -> clear
                    if (state.matchHistorySortConfig.direction === 'asc') {
                        direction = 'desc';
                    } else if (state.matchHistorySortConfig.direction === 'desc') {
                        state.matchHistorySortConfig = { key: null, direction: null };
                        // Re-update match history display to clear sort
                        if (state.selectedTeam1 && !state.selectedTeam2) {
                            const matchHistoryResult = calculateMatchHistory();
                            updateMatchHistoryDisplay(matchHistoryResult);
                        }
                        return;
                    }
                }
            }

            state.matchHistorySortConfig = { key, direction };
            // Re-update match history display with new sort
            if (state.selectedTeam1 && !state.selectedTeam2) {
                const matchHistoryResult = calculateMatchHistory();
                updateMatchHistoryDisplay(matchHistoryResult);
            }
        }

        function getMatchHistorySortIndicator(key) {
            if (state.matchHistorySortConfig.key !== key) return ' ‚ÜïÔ∏è';
            return state.matchHistorySortConfig.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
        }

        // Clear filters
        function clearFilters() {
            if (state.data.length > 0) {
                const dates = state.data.map(row => row.dateObj);
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                state.dateFrom = minDate.toISOString().split('T')[0];
                state.dateTo = maxDate.toISOString().split('T')[0];
                elements.dateFrom.value = state.dateFrom;
                elements.dateTo.value = state.dateTo;
            }
            
            state.selectedTeam1 = '';
            state.selectedTeam2 = '';
            state.selectedSeason = '';
            state.selectedDayOfWeek = '';
            state.homeFilter = true;
            state.awayFilter = true;
            state.threePointSystem = true;
            state.pointDeductionsEnabled = true;
            // Preserve current league when clearing filters
            // state.selectedLeague should not be reset here
            state.sortConfig = { key: null, direction: null };
            state.recentH2HCount = 'All';
            
            // Update UI elements
            elements.team1Select.value = '';
            elements.team2Select.value = '';
            elements.seasonSelect.value = '';
            elements.dayOfWeekSelect.value = '';
            elements.homeCheckbox.className = 'checkbox checked';
            elements.awayCheckbox.className = 'checkbox checked';
            elements.deductionsCheckbox.className = 'checkbox checked';
            elements.threePointCheckbox.className = 'checkbox checked';
            
            createLeagueButtons();
            updateTeamSelects();
            updateTeamSeasonsTeamSelect();
            updateSeasonOptions();
            updateTable();
        }


        // Update UI based on current state
        function updateUI() {
            // UpdateUI called

            if (state.error) {
                elements.controlsSection.classList.add('hidden');
                elements.tableInfo.classList.add('hidden');
                elements.matchHistorySection.classList.add('hidden');
                elements.matchHistoryStatsTable.classList.add('hidden');
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
                elements.tableContainer.classList.add('hidden');
                elements.errorState.classList.remove('hidden');
                elements.errorMessage.textContent = state.error;
                return;
            }

            elements.errorState.classList.add('hidden');

            if (state.data.length > 0) {
                // Showing controls section
                elements.controlsSection.classList.remove('hidden');
                
                // Only show table-related sections if we're on the League Filters tab
                const isLeagueFiltersActive = document.getElementById('leagueFiltersTab').classList.contains('active');
                if (isLeagueFiltersActive) {
                    elements.tableContainer.classList.remove('hidden');
                    
                    // Show appropriate section based on team selection
                    if (state.selectedTeam1 && state.selectedTeam2) {
                        // Two teams selected: show H2H, hide match history
                        elements.h2hSection.classList.remove('hidden');
                        elements.matchHistorySection.classList.add('hidden');
                    } else if (state.selectedTeam1 && !state.selectedTeam2) {
                        // One team selected: show main table above match history, hide H2H
                        elements.tableContainer.classList.remove('hidden');  // Show main table above
                        elements.h2hSection.classList.add('hidden');
                        elements.matchHistorySection.classList.remove('hidden');
                        // Note: matchHistoryStatsTable visibility is managed in updateMatchHistoryDisplay
                    } else {
                        // No teams or invalid selection: hide both
                        elements.h2hSection.classList.add('hidden');
                        elements.matchHistorySection.classList.add('hidden');
                        elements.matchHistoryStatsTable.classList.add('hidden');
                    }
                } else {
                    // Keep table hidden on other tabs
                    elements.tableContainer.classList.add('hidden');
                    elements.h2hSection.classList.add('hidden');
                    elements.matchHistorySection.classList.add('hidden');
                    elements.matchHistoryStatsTable.classList.add('hidden');
                    elements.tableInfo.classList.add('hidden');
                }
            } else {
                // Data length is 0, keeping controls hidden
            }


            // Update form values
            elements.dateFrom.value = state.dateFrom;
            elements.dateTo.value = state.dateTo;
        }

        // Hamburger Menu Functionality
        function initHamburgerMenu() {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const sideMenu = document.getElementById('sideMenu');
            const menuOverlay = document.getElementById('menuOverlay');
            const closeBtn = document.getElementById('closeMenuBtn');
            const domesticFootballLink = document.getElementById('domesticFootballLink');
            
            // Toggle menu function
            function toggleMenu() {
                const isOpen = sideMenu.classList.contains('open');
                
                if (isOpen) {
                    // Close menu
                    sideMenu.classList.remove('open');
                    menuOverlay.classList.remove('active');
                    hamburgerBtn.classList.remove('active');
                    document.body.style.overflow = '';
                } else {
                    // Open menu
                    sideMenu.classList.add('open');
                    menuOverlay.classList.add('active');
                    hamburgerBtn.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            // Event listeners
            hamburgerBtn.addEventListener('click', toggleMenu);
            closeBtn.addEventListener('click', toggleMenu);
            menuOverlay.addEventListener('click', toggleMenu);
            
            // Handle domestic football link click - just close menu since we're already on the page
            domesticFootballLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleMenu(); // Close the menu
                // Since we're already on the domestic football page, no navigation needed
            });
            
            // Prevent menu from closing when clicking inside the menu
            sideMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // Close menu with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && sideMenu.classList.contains('open')) {
                    toggleMenu();
                }
            });
        }

        // Handle responsive tab text
        function updateTabText() {
            const tabButtons = document.querySelectorAll('.tab-button[data-mobile-text]');
            const isMobile = window.innerWidth <= 768;
            
            tabButtons.forEach(button => {
                const mobileText = button.getAttribute('data-mobile-text');
                const originalText = button.textContent.trim();
                
                if (isMobile && mobileText) {
                    if (!button.getAttribute('data-original-text')) {
                        button.setAttribute('data-original-text', originalText);
                    }
                    button.textContent = mobileText;
                } else {
                    const savedOriginalText = button.getAttribute('data-original-text');
                    if (savedOriginalText) {
                        button.textContent = savedOriginalText;
                    }
                }
            });
        }

        // Dark Mode Functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            
            // Check for saved dark mode preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                darkModeToggle.checked = true;
                setTimeout(handlePositionColors, 100); // Delay to ensure table is rendered
            }
            
            // Add event listener for toggle
            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    body.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                    handlePositionColors();
                } else {
                    body.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                    handlePositionColors();
                }
            });
        }
        
        // Handle table colors by specific column headers
        function handlePositionColors() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            if (!isDark) {
                // Remove all inline styles in light mode
                document.querySelectorAll('.league-table tbody tr td').forEach(cell => {
                    cell.style.color = '';
                });
                return;
            }
            
            const headers = document.querySelectorAll('.league-table thead th');
            const columnRules = {
                'Season': 'white',
                'Team': 'white', 
                'P': 'white',
                'W': 'white',
                'D': 'white',
                'L': 'white',
                'GF': 'white',
                'GA': 'white',
                'GD': 'white',
                'Pts': 'default',
                'Pos': 'special' // Special handling for 1,2,3
            };
            
            headers.forEach((header, columnIndex) => {
                const headerText = header.textContent.trim();
                const rule = columnRules[headerText];
                
                if (rule) {
                    const cells = document.querySelectorAll(`.league-table tbody tr td:nth-child(${columnIndex + 1})`);
                    cells.forEach(cell => {
                        if (rule === 'white') {
                            cell.style.color = 'white';
                        } else if (rule === 'default') {
                            cell.style.color = '';
                            cell.style.removeProperty('color');
                        } else if (rule === 'special' && headerText === 'Pos') {
                            const text = cell.textContent.trim();
                            if (text === '1' || text === '2' || text === '3') {
                                cell.style.color = '';
                                cell.style.removeProperty('color');
                            } else {
                                cell.style.color = 'white';
                            }
                        }
                    });
                }
            });
        }

        // Make functions global for onclick handlers
        window.handleSort = handleSort;
        window.handleH2hSort = handleH2hSort;
        window.handleTeamHistorySort = handleTeamHistorySort;

        // Initialize the application
        init();
        initHamburgerMenu();
        initDarkMode();
        updateTabText();

        // Initialize Historic Seasons toggle button
        updateHistoricSeasonsToggleButton();
        
        // Handle window resize for responsive tabs
        window.addEventListener('resize', updateTabText);
    </script>
</body>
</html>
