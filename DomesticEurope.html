<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domestic League Filters - Filter and Process Europe's Top 5</title>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="DomesticEurope.css">
<body>
    <!-- Hamburger Menu Button -->
    <button id="hamburgerBtn" class="hamburger-btn">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
    </button>

    <!-- Sidebar Overlay -->
    <div id="menuOverlay" class="menu-overlay hidden"></div>

    <!-- Sidebar Menu -->
    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
            <h2 class="text-xl font-bold text-gray-800">Navigation</h2>
            <button id="closeMenuBtn" class="close-btn">&times;</button>
        </div>
        <nav class="menu-nav">
            <!-- Home Section -->
            <div class="menu-section">
                <a href="index.html" class="menu-item">
                    <span class="menu-icon">üè†</span>
                    <span>Home Page</span>
                </a>
            </div>
            
            <!-- Football Section -->
            <div class="menu-section">
                <h3 class="menu-section-title">Football</h3>
                <a href="#" id="domesticFootballLink" class="menu-item active" data-page="domestic">
                    <span class="menu-icon">‚öΩ</span>
                    <span>Domestic Football - Top 5 Leagues</span>
                </a>
                <div class="menu-item disabled">
                    <span class="menu-icon">üèÜ</span>
                    <span>Continental Football - Coming Soon</span>
                </div>
                <div class="menu-item disabled">
                    <span class="menu-icon">üåç</span>
                    <span>International Football - Coming Soon</span>
                </div>
            </div>

            <!-- Other Sports Section -->
            <div class="menu-section">
                <h3 class="menu-section-title">Other Sports</h3>
                <div class="menu-item disabled">
                    <span class="menu-icon">üèà</span>
                    <span>NFL - Coming Soon</span>
                </div>
                <div class="menu-item disabled">
                    <span class="menu-icon">üèÄ</span>
                    <span>NBA - Coming Soon</span>
                </div>
            </div>

            <!-- Support Section -->
            <div class="menu-section">
                <a href="qa.html" class="menu-item">
                    <span class="menu-icon">‚ùì</span>
                    <span>Q&A</span>
                </a>
                <a href="contact.html" class="menu-item">
                    <span class="menu-icon">üìß</span>
                    <span>Contact & Support</span>
                </a>
            </div>
        </nav>
    </div>

    <div class="league-table-container">
        <div class="main-card">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div>
                        <h1 class="text-4xl font-bold mb-2">Domestic League Filters</h1>
                        <p class="text-lg opacity-90">Last Data Update: September 14th, 2025</p>
                    </div>
                    <div class="dark-mode-toggle">
                        <input type="checkbox" id="darkModeToggle" class="toggle-checkbox">
                        <label for="darkModeToggle" class="toggle-label">
                            <span class="toggle-button"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Controls Section -->
            <div id="controlsSection" class="controls-section hidden">
                
                <!-- Tab Container -->
                <div class="tab-container">
                    <button class="tab-button active" id="leagueFiltersTab" data-mobile-text="Tables & H2H">League Tables & Head to Head Stats</button>
                    <button class="tab-button" id="teamSeasonsTab" data-mobile-text="Team Seasons">Team Seasons</button>
                    <button class="tab-button" id="lastTimeWhenTab" data-mobile-text="Last Time">The Last Time When...</button>
                    <button class="tab-button" id="teamStreaksTab" data-mobile-text="Streaks">Team Streaks</button>
                </div>

                <!-- League Filters Tab Content -->
                <div id="leagueFiltersContent" class="tab-content active">
                    <!-- Description -->
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                        <p class="text-gray-700 text-sm leading-relaxed">
                            Filter and analyze league tables from the major 5 European leagues. Select prior seasons, custom date ranges, and specific teams to find and filter league standings and head-to-head records between teams.
                        </p>
                    </div>

                    <!-- League Selection -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Select League:</label>
                        <div class="league-buttons" id="leagueButtons">
                            <!-- League buttons will be populated here -->
                        </div>
                    </div>
                
                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-search mr-2"></span>Season
                        </label>
                        <select id="seasonSelect" class="form-input">
                            <option value="">Select Season</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-calendar mr-2"></span>Start Date (MM/DD/YYYY)
                        </label>
                        <input type="date" id="dateFrom" class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-calendar mr-2"></span>End Date (MM/DD/YYYY)
                        </label>
                        <input type="date" id="dateTo" class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-calendar mr-2"></span>Day of Week
                        </label>
                        <select id="dayOfWeekSelect" class="form-input">
                            <option value="">All Days</option>
                            <option value="0">Sunday</option>
                            <option value="1">Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                            <option value="6">Saturday</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-search mr-2"></span>Team 1
                        </label>
                        <select id="team1Select" class="form-input">
                            <option value="">All Teams</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-search mr-2"></span>Team 2
                        </label>
                        <select id="team2Select" class="form-input">
                            <option value="">No Team</option>
                        </select>
                    </div>
                </div>
                
                <!-- Match Type and Action Buttons -->
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-6">
                        <span class="text-sm font-semibold text-gray-700">Match Results:</span>
                        
                        <label class="flex items-center cursor-pointer">
                            <div id="homeCheckbox" class="checkbox checked"></div>
                            <span class="icon-home mr-1"></span>
                            <span class="text-sm font-medium">Home</span>
                        </label>
                        
                        <label class="flex items-center cursor-pointer">
                            <div id="awayCheckbox" class="checkbox checked"></div>
                            <span class="icon-plane mr-1"></span>
                            <span class="text-sm font-medium">Away</span>
                        </label>
                        
                        <label class="flex items-center cursor-pointer">
                            <div id="deductionsCheckbox" class="checkbox checked"></div>
                            <span class="icon-alert mr-1" style="color: #6b7280;"></span>
                            <span class="text-sm font-medium">Point Deductions</span>
                        </label>
                        
                        <label class="flex items-center cursor-pointer">
                            <div id="threePointCheckbox" class="checkbox"></div>
                            <span class="text-sm font-medium">3 Points for all Wins</span>
                        </label>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="reloadGistsBtn" class="btn btn-blue">
                            <span class="icon-link"></span>Reload Data
                        </button>
                        <button id="resetBtn" class="btn btn-secondary">Reset</button>
                    </div>
                </div>
                </div>

                <!-- Team Seasons Tab Content -->
                <div id="teamSeasonsContent" class="tab-content">
                    <!-- Description -->
                    <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-gray-700 text-sm leading-relaxed">
                            Select a league and team below to view a list of their top-flight seasons. You can find out how many times a team finished in a particular place or even find something like a list of every 2nd place team. 
                        </p>
                    </div>

                    <!-- League Selection for Team Seasons -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Select League:</label>
                        <div class="league-buttons" id="teamSeasonsLeagueButtons">
                            <!-- League buttons will be populated here -->
                        </div>
                    </div>

                    <!-- Team Selection -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Select Team:</label>
                        <select id="teamSeasonsTeamSelect" class="form-input w-full">
                            <option value="">Choose a team...</option>
                        </select>
                    </div>

                    <!-- Season Selection (only for Ligue 1 and Premier League) -->
                    <div id="teamSeasonsSeasonContainer" class="mb-8 hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="icon-search mr-2"></span>Season
                        </label>
                        <select id="teamSeasonsSeasonSelect" class="form-input w-full">
                            <option value="">Select Season</option>
                        </select>
                    </div>

                    <!-- Position Filter -->
                    <div id="teamSeasonsPositionContainer" class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Filter by Position:</label>
                        <select id="teamSeasonsPositionSelect" class="form-input w-full">
                            <option value="">All Positions</option>
                        </select>
                        <div id="teamSeasonsPositionInfo" class="mt-2 text-sm text-gray-600"></div>
                    </div>

                    <!-- Team History Table -->
                    <div id="teamHistoryTable" class="mt-8 hidden" style="border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <div class="league-table">
                            <div class="text-center py-4 bg-blue-50 border-b">
                                <h2 class="text-xl font-semibold text-blue-800 mb-1">üèÜ Team History</h2>
                                <p class="text-sm text-blue-600 font-medium" id="teamHistoryTitle"></p>
                            </div>
                            <table>
                                <thead>
                                    <tr id="teamHistoryHeader">
                                        <!-- Team history headers will be populated -->
                                    </tr>
                                </thead>
                                <tbody id="teamHistoryBody">
                                    <!-- Team history rows will be populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Last Time When Tab Content -->
                <div id="lastTimeWhenContent" class="tab-content">
                    <!-- Description -->
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                        <p class="text-gray-700 text-sm leading-relaxed">
                            This tool allows you to find out the last time a team won, drew, or lost against an opponent. At home or away. On the day of the week too, if you so choose.
                        </p>
                    </div>
                    
                    <!-- League Selection -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Select League:</label>
                        <div class="league-buttons" id="lastTimeLeagueButtons">
                            <!-- League buttons will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Day of Week</label>
                            <select id="lastTimeDayOfWeekSelect" class="form-input">
                                <option value="">All Days</option>
                                <option value="0">Sunday</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                            <select id="lastTimeLocationSelect" class="form-input">
                                <option value="">Both Home and Away</option>
                                <option value="home">Home</option>
                                <option value="away">Away</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Team 1</label>
                            <select id="lastTimeTeam1Select" class="form-input">
                                <option value="">Select Team 1</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Team 2</label>
                            <select id="lastTimeTeam2Select" class="form-input">
                                <option value="">Select Team 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Results Display -->
                    <div id="lastTimeResults" class="hidden">
                        <h3 class="text-xl font-bold text-gray-700 mb-6 text-center">Days Since Last Match Results</h3>
                        
                        <!-- Team 1 Won at Home -->
                        <div id="team1HomeWinSection" class="mb-8 hidden">
                            <h4 id="team1HomeWinTitle" class="text-lg font-semibold text-green-700 mb-3">Team 1 Won (at Home)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1HomeWinHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1HomeWinBody"></tbody>
                                </table>
                            </div>
                            <p id="team1HomeWinDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Won Away -->
                        <div id="team1AwayWinSection" class="mb-8 hidden">
                            <h4 id="team1AwayWinTitle" class="text-lg font-semibold text-green-700 mb-3">Team 1 Won (Away)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1AwayWinHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1AwayWinBody"></tbody>
                                </table>
                            </div>
                            <p id="team1AwayWinDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Drew at Home -->
                        <div id="team1HomeDrawSection" class="mb-8 hidden">
                            <h4 id="team1HomeDrawTitle" class="text-lg font-semibold text-gray-600 mb-3">Team 1 Drew (at Home)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1HomeDrawHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1HomeDrawBody"></tbody>
                                </table>
                            </div>
                            <p id="team1HomeDrawDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Drew Away -->
                        <div id="team1AwayDrawSection" class="mb-8 hidden">
                            <h4 id="team1AwayDrawTitle" class="text-lg font-semibold text-gray-600 mb-3">Team 1 Drew (Away)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1AwayDrawHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1AwayDrawBody"></tbody>
                                </table>
                            </div>
                            <p id="team1AwayDrawDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Lost at Home -->
                        <div id="team1HomeLossSection" class="mb-8 hidden">
                            <h4 id="team1HomeLossTitle" class="text-lg font-semibold text-red-600 mb-3">Team 1 Lost (at Home)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1HomeLossHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1HomeLossBody"></tbody>
                                </table>
                            </div>
                            <p id="team1HomeLossDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>

                        <!-- Team 1 Lost Away -->
                        <div id="team1AwayLossSection" class="mb-8 hidden">
                            <h4 id="team1AwayLossTitle" class="text-lg font-semibold text-red-600 mb-3">Team 1 Lost (Away)</h4>
                            <div class="league-table">
                                <table>
                                    <thead>
                                        <tr id="team1AwayLossHeader">
                                            <th class="px-3 py-4 text-center font-bold text-sm">Date</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Home Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Team</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Away Score</th>
                                            <th class="px-3 py-4 text-center font-bold text-sm">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team1AwayLossBody"></tbody>
                                </table>
                            </div>
                            <p id="team1AwayLossDays" class="text-center text-sm text-gray-600 mt-2"></p>
                        </div>
                    </div>
                </div>

                <!-- Team Streaks Tab Content -->
                <div id="teamStreaksContent" class="tab-content">
                    <!-- Description -->
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                        <p class="text-gray-700 text-sm leading-relaxed">
                            Discover active streaks between clubs and find out the last time your club defeated their rival. Filter between league, location, and streak type.
                        </p>
                    </div>

                    <!-- League Selection -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Select League:</label>
                        <div class="league-buttons" id="teamStreaksLeagueButtons">
                            <!-- League buttons will be populated here -->
                        </div>
                    </div>

                    <!-- Status Selection -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Status:</label>
                        <select id="teamStreaksStatusSelect" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none">
                            <option value="active">Active Streak</option>
                            <option value="historic">Historic Streaks</option>
                        </select>
                    </div>
                    <!-- Location Selection -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Location:</label>
                        <select id="teamStreaksLocationSelect" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none">
                            <option value="both">Both Home and Away</option>
                            <option value="home">Home</option>
                            <option value="away">Away</option>
                        </select>
                    </div>

                    <!-- Streak Type Selection -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Streak Type:</label>
                        <select id="teamStreaksTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none">
                            <option value="winning">Winning Streak (Wins Only)</option>
                            <option value="unbeaten">Unbeaten Streak (Wins + Draws)</option>
                            <option value="draw">Draw Streak (Draws Only)</option>
                            <option value="winless">Winless Streak (Draws + Losses)</option>
                            <option value="losing">Losing Streak (Losses Only)</option>
                        </select>
                    </div>

                    <!-- Team Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Team 1:</label>
                            <select id="teamStreaksTeam1Select" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none">
                                <option value="">Select Team 1</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Team 2 (Optional):</label>
                            <select id="teamStreaksTeam2Select" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-green-500 focus:outline-none">
                                <option value="">Select Team 2</option>
                            </select>
                        </div>
                    </div>

                    <!-- Results will be populated here -->
                    <div id="teamStreaksResults" class="hidden">
                        <!-- Team streaks content will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Table Info -->
            <div id="tableInfo" class="text-center py-4 bg-white border-b hidden">
                <span class="text-lg font-semibold text-gray-700" id="tableInfoText"></span>
            </div>

            <!-- Head-to-Head Section -->
            <div id="h2hSection" class="mt-8 mx-8 p-8 bg-white border-b rounded-xl hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Head-to-Head Record</h3>
                    <div class="flex items-center gap-4">
                        <label class="text-sm font-medium text-gray-700">Most Recent Head-to-Head</label>
                        <select id="recentH2HSelect" class="px-3 py-1 border border-gray-300 rounded focus:border-green-500 focus:outline-none text-sm">
                            <!-- Options will be populated -->
                        </select>
                        <span class="text-sm text-gray-600" id="h2hMatchCount"></span>
                    </div>
                </div>
                <div id="h2hVisualizations">
                    <!-- H2H visualizations will be populated here -->
                </div>
            </div>
            
            <!-- Table Section -->
            <div class="table-section">

                <div id="errorState" class="text-center text-black hidden">
                    <div class="icon-loading w-16 h-16 mx-auto mb-4" style="font-size: 4rem;"></div>
                    <div class="text-2xl mb-4">Loading Data</div>
                    <div class="text-lg mb-6 text-black" id="errorMessage"></div>
                    <button id="retryBtn" class="px-6 py-3 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-all">
                        Try Again
                    </button>
                </div>

                <div id="tableContainer" class="hidden">
                    <div class="league-table">
                        <table>
                            <thead>
                                <tr id="tableHeader">
                                    <!-- Headers will be populated -->
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Rows will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Head-to-Head Matches Table -->
                <div id="h2hMatchesTable" class="mt-8 hidden">
                    <div class="league-table">
                        <div class="text-center py-4 bg-white border-b">
                            <h2 class="text-xl font-semibold text-gray-700 mb-1">Head-to-Head Match History</h2>
                            <p class="text-sm text-gray-600" id="h2hTableTitle"></p>
                        </div>
                        <table>
                            <thead>
                                <tr id="h2hTableHeader">
                                    <!-- H2H headers will be populated -->
                                </tr>
                            </thead>
                            <tbody id="h2hTableBody">
                                <!-- H2H rows will be populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Pre-configured Gist URLs (Single Base64 Encoded)
        // Updated GIST URLs with single base64 encoding (encoded with new user-provided URLs)
        const GIST_URLS = [
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy85OTg4YTEzMzNjNDMwYWFkNTE4ZWJiNDM4YzVkOGRiMS9yYXcvYjliNTM1MGIzZTY3NGE3ODMwY2I3ZDczOWU2MGZhYjQyYjZkNmZlNC9idW5kZXNsaWdhLmNzdg==',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy83NDM1ZmE2OWY1YTYzZDVmM2NjY2E1M2I0ZDA0OWZkZi9yYXcvOGUxNzRlMTJmMjU5YWJiNmY5ZWFlODcxYzY4NGU4OTk2NGIzYjA3My9sYWxpZ2EuY3N2',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy85NDhlMTMwNTYyMGFmM2ExNzJiNDMzOWFiYmEzMWU2Ny9yYXcvYjI0ZjQ3ZTI2ZTUyMDdiYjFkZTM5YTFhZjZkMzg0OThlN2MxNmYzMi9saWd1ZS5jc3Y=',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy9iZWFhMWNhYzhmYjM3MDlkYzdjMmY0YmIzZDc5OWI0MS9yYXcvMjk1YmM1ZGI5ZWFjNzcxY2Q3MTdlZmRjZjdmM2JlNWMzNzI0YTE3Yy9zZXJpZWEuY3N2',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy9jODk1ZGM3Zjg4MTdiZjM3Y2ZmN2FlOTBjZGEzMWZlMS9yYXcvOTA3OWJkYjZhYWMwNTgzYTM4MGUyYzVhZWNkZDlkNmY5Yjk5OGUzNC9wcmVtLmNzdg==',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy9mYTM1M2RmYTExZTE4Mzk1ZmY2NTdmMjE5NmE0NTEyOS9yYXcvNjFiZTg2OWJmOTY5ZDc4NDc0MjRkZmJlOTU5NTQzNGUyNzhiOGI0OC8yNTI2cHJlbS5jc3Y=',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy8wMzkyOGU0YThlYTE4OTk4MjZmYTg1MDdkZTdhNzc1My9yYXcvNzQxNTY4ZmE4Njc3YjBlN2M3NDM2YWU4YjNlMzVkZjU0YWY0NmExNy8yNTI2bGFsaWdhLmNzdg==',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy9iY2Y2NmE4NzMzMThmODI4NzM2MjE5NGJmNTRlMWM5Yi9yYXcvODEyZDRjNjY3ZDE2YmJiYzE1NGRhZGUyODFhZDk4Yjk4M2U3Yzg5ZS8yNTI2c2VyaWVhLmNzdg==',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy84MTc4MDM4ODc0YzgzMjgwNDI1MjdkNDYwYjA2NzdlZC9yYXcvOTBlYTg0ZTk5ODg3NjhiZTZjY2JlZTkxNWNjNWQ5MjdmMjg3MmZiNi8yNTI2YnVuZGVzbGlnYS5jc3Y=',
            'aHR0cHM6Ly9naXN0LmdpdGh1YnVzZXJjb250ZW50LmNvbS81Uy01Uy8xZjMyODJmNmYwMjQyMjYyMmM0N2I3YTdhNzUxMmM5MS9yYXcvYTM5NzQ2ZjE2OWUwMWZiODgzYTg0ZDQyN2RhMWQyMTRjMjI1ZDQ1OC8yNTI2bGlndWUuY3N2'
        ];
        
        // League code mapping for filtering data
        const LEAGUE_CODES = {
            'serie-a': 'I1',
            'premier-league': 'E0',
            'la-liga': 'SP1',
            'bundesliga': 'D1',
            'ligue-1': 'F1'
        };

        // Application state
        const state = {
            data: [],
            teams: [],
            error: '',
            
            // Filter states
            dateFrom: '',
            dateTo: '',
            selectedDayOfWeek: '',
            selectedTeam1: '',
            selectedTeam2: '',
            selectedSeason: '',
            homeFilter: true,
            awayFilter: true,
            pointDeductionsEnabled: true,
            threePointSystem: false,
            selectedLeague: 'premier-league',
            sortConfig: { key: null, direction: null },
            teamHistorySortConfig: { key: null, direction: null },
            recentH2HCount: 'All',
            
            // H2H sort config
            h2hSortConfig: { key: 'date', direction: 'desc' },
            
            // Last Time When state
            lastTimeTeam1: '',
            lastTimeTeam2: '',
            lastTimeDayOfWeek: '',
            lastTimeLocation: '',
            
            // Team Seasons state
            teamSeasonsSelectedLeague: 'premier-league',
            teamSeasonsSelectedTeam: '',
            teamSeasonsSelectedSeason: '',
            teamSeasonsSelectedPosition: '',
            
            // Historic Streaks sort state
            historicStreaksSortConfig: { key: null, direction: null },
            lastHistoricStreaksParams: null
        };

        // Ranking overrides for historic seasons
        function getRankingOverrides() {
            return [
                // Italy
                ["Pro Vercelli", "I1", "1930-31", 10, 1],
                ["Modena FC", "I1", "1930-31", 10, 2],
                ["ACF Fiorentina", "I1", "1931-32", 4, 1],
                ["AC Milan", "I1", "1931-32", 4, 2],                
                ["Inter", "I1", "1931-32", 6, 1],
                ["US Alessandria 1912", "I1", "1931-32", 6, 2],    
                ["Lazio Roma", "I1", "1931-32", 13, 1],    
                ["US Triestina", "I1", "1931-32", 13, 2],    
                ["Pro Vercelli", "I1", "1931-32", 13, 3],   
                ["Bologna FC", "I1", "1932-33", 3, 1],   
                ["SSC Napoli", "I1", "1932-33", 3, 2],   
                ["AS Roma", "I1", "1932-33", 5, 1],   
                ["ACF Fiorentina", "I1", "1932-33", 5, 2],   
                ["Genoa CFC", "I1", "1932-33", 8, 1],   
                ["US Triestina", "I1", "1932-33", 8, 2],   
                ["Pro Vercelli", "I1", "1932-33", 12, 1],   
                ["Palermo FC", "I1", "1932-33", 12, 2],   
                ["Calcio Padova", "I1", "1932-33", 14, 1],   
                ["US Alessandria 1912", "I1", "1932-33", 14, 2],   
                ["Pro Vercelli", "I1", "1933-34", 7, 1],   
                ["AS Livorno", "I1", "1933-34", 7, 2],   
                ["Brescia Calcio", "I1", "1933-34", 12, 1],   
                ["Torino FC", "I1", "1933-34", 12, 2],   
                ["US Alessandria 1912", "I1", "1933-34", 12, 3],   
                ["Palermo FC", "I1", "1933-34", 12, 4],   
                ["SSC Napoli", "I1", "1934-35", 7, 1],   
                ["US Alessandria 1912", "I1", "1934-35", 7, 2],   
                ["Palermo FC", "I1", "1934-35", 7, 3],   
                ["AC Milan", "I1", "1934-35", 10, 1],   
                ["US Triestina", "I1", "1934-35", 10, 2],   
                ["Brescia Calcio", "I1", "1934-35", 10, 3],   
                ["AC Milan", "I1", "1935-36", 8, 1],   
                ["SSC Napoli", "I1", "1935-36", 8, 2],   
                ["US Alessandria 1912", "I1", "1935-36", 8, 3],   
                ["Genoa CFC", "I1", "1935-36", 8, 4],   
                ["ACF Fiorentina", "I1", "1935-36", 12, 1],   
                ["Sampierdarenese", "I1", "1935-36", 12, 2],   
                ["Inter", "I1", "1936-37", 7, 1],   
                ["Lucchese", "I1", "1936-37", 7, 2],   
                ["AS Roma", "I1", "1936-37", 10, 1],   
                ["SSC Bari", "I1", "1936-37", 10, 2],
                ["Genoa CFC", "I1", "1937-38", 3],
                ["US Triestina", "I1", "1937-38", 6, 1],
                ["AS Roma", "I1", "1937-38", 6, 2],
                ["Lazio Roma", "I1", "1937-38", 8, 1],
                ["Torino FC", "I1", "1937-38", 8, 2],
                ["AC Liguria", "I1", "1937-38", 11, 1],
                ["AS Livorno", "I1", "1937-38", 11, 2],
                ["Genoa CFC", "I1", "1940-41", 10],
                ["AS Roma", "I1", "1940-41", 11],
                ["Genoa CFC", "I1", "1941-42", 4],
                ["Lazio Roma", "I1", "1941-42", 5],
                ["Juventus", "I1", "1941-42", 6],
                ["Bologna FC", "I1", "1942-43", 6, 1],
                ["ACF Fiorentina", "I1", "1942-43", 6, 2],
                ["AC Milan", "I1", "1942-43", 6, 3],
                ["Lazio Roma", "I1", "1942-43", 9, 1],
                ["Atalanta", "I1", "1942-43", 9, 2],
                ["AS Roma", "I1", "1942-43", 9, 3],
                ["Bologna FC", "I1", "1946-47", 5, 1],
                ["L.R. Vicenza", "I1", "1946-47", 5, 2],
                ["Inter", "I1", "1946-47", 10, 1],
                ["Sampdoria", "I1", "1946-47", 10, 2],
                ["Genoa CFC", "I1", "1946-47", 10, 3],
                ["Lazio Roma", "I1", "1946-47", 10, 4],
                ["AS Livorno", "I1", "1946-47", 15, 1],
                ["AS Roma", "I1", "1946-47", 15, 2],
                ["Atalanta", "I1", "1947-48", 5, 1],
                ["Modena FC", "I1", "1947-48", 5, 2],
                ["Aurora Pro Patria", "I1", "1947-48", 8, 1],
                ["Bologna FC", "I1", "1947-48", 8, 2],
                ["Inter", "I1", "1947-48", 12, 1],
                ["Genoa CFC", "I1", "1947-48", 12, 2],
                ["Sampdoria", "I1", "1947-48", 14, 1],
                ["AS Livorno", "I1", "1947-48", 14, 2],
                ["Lucchese", "I1", "1947-48", 14, 3],
                ["Sampdoria", "I1", "1948-49", 5, 1],
                ["Bologna FC", "I1", "1948-49", 5, 2],
                ["Lucchese", "I1", "1948-49", 8, 1],
                ["US Triestina", "I1", "1948-49", 8, 2],
                ["ACF Fiorentina", "I1", "1948-49", 8, 3],
                ["Palermo FC", "I1", "1948-49", 11, 1],
                ["Calcio Padova", "I1", "1948-49", 11, 2],
                ["Novara Calcio", "I1", "1948-49", 15, 1],
                ["Atalanta", "I1", "1948-49", 15, 2],
                ["Aurora Pro Patria", "I1", "1948-49", 17, 1],
                ["SSC Bari", "I1", "1948-49", 17, 2],
                ["Torino FC", "I1", "1949-50", 6, 1],
                ["Como 1907", "I1", "1949-50", 6, 2],
                ["Atalanta", "I1", "1949-50", 8, 1],
                ["US Triestina", "I1", "1949-50", 8, 2],
                ["Aurora Pro Patria", "I1", "1949-50", 11, 1],
                ["Genoa CFC", "I1", "1949-50", 11, 2],
                ["Sampdoria", "I1", "1949-50", 13, 1],
                ["Palermo FC", "I1", "1949-50", 13, 2],
                ["Bologna FC", "I1", "1949-50", 15, 1],
                ["Lucchese", "I1", "1949-50", 15, 2],
                ["Novara Calcio", "I1", "1949-50", 17, 1],
                ["AS Roma", "I1", "1949-50", 17, 2],
                ["SSC Napoli", "I1", "1950-51", 6, 1],
                ["Bologna FC", "I1", "1950-51", 6, 2],
                ["Palermo FC", "I1", "1950-51", 10, 1],
                ["Aurora Pro Patria", "I1", "1950-51", 10, 2],
                ["Novara Calcio", "I1", "1950-51", 12, 1],
                ["Sampdoria", "I1", "1950-51", 12, 2],
                ["Lucchese", "I1", "1950-51", 15, 1],
                ["US Triestina", "I1", "1950-51", 15, 2],
                ["Torino FC", "I1", "1950-51", 15, 3],
                ["ACF Fiorentina", "I1", "1951-52", 4, 1],
                ["Lazio Roma", "I1", "1951-52", 4, 2],
                ["SPAL 2013 Ferrara", "I1", "1951-52", 9, 1],
                ["Aurora Pro Patria", "I1", "1951-52", 9, 2],
                ["Atalanta", "I1", "1951-52", 12, 1],
                ["Como 1907", "I1", "1951-52", 12, 2],
                ["Udinese Calcio", "I1", "1951-52", 12, 3],
                ["Torino FC", "I1", "1951-52", 12, 4],
                ["Lucchese", "I1", "1951-52", 18],
                ["SPAL 2013 Ferrara", "I1", "1952-53", 8, 1],
                ["Atalanta", "I1", "1952-53", 8, 2],
                ["Torino FC", "I1", "1952-53", 10, 1],
                ["Lazio Roma", "I1", "1952-53", 10, 2],
                ["Sampdoria", "I1", "1952-53", 10, 3],
                ["Novara Calcio", "I1", "1952-53", 10, 4],
                ["Udinese Calcio", "I1", "1952-53", 10, 5],
                ["US Triestina", "I1", "1952-53", 15, 1],
                ["Palermo FC", "I1", "1952-53", 15, 2],
                ["AC Milan", "I1", "1953-54", 3, 1],
                ["ACF Fiorentina", "I1", "1953-54", 3, 2],
                ["Genoa CFC", "I1", "1953-54", 12, 1],
                ["US Triestina", "I1", "1953-54", 12, 2],
                ["Sampdoria", "I1", "1954-55", 9, 1],
                ["Torino FC", "I1", "1954-55", 9, 2],
                ["Calcio Catania", "I1", "1954-55", 12, 1],
                ["Lazio Roma", "I1", "1954-55", 12, 2],
                ["US Triestina", "I1", "1954-55", 12, 3],
                ["Atalanta", "I1", "1954-55", 15, 1],
                ["Novara Calcio", "I1", "1954-55", 15, 2],
                ["Inter", "I1", "1955-56", 3, 1],
                ["Lazio Roma", "I1", "1955-56", 3, 2],
                ["AS Roma", "I1", "1955-56", 6, 1],
                ["Sampdoria", "I1", "1955-56", 6, 2],
                ["SPAL 2013 Ferrara", "I1", "1955-56", 9, 1],
                ["Genoa CFC", "I1", "1955-56", 9, 2],
                ["Torino FC", "I1", "1955-56", 9, 3],
                ["Juventus", "I1", "1955-56", 9, 4],
                ["L.R. Vicenza", "I1", "1955-56", 9, 5],
                ["Inter", "I1", "1956-57", 5, 1],
                ["Bologna FC", "I1", "1956-57", 5, 2],
                ["Torino FC", "I1", "1956-57", 5, 3],
                ["Sampdoria", "I1", "1956-57", 5, 4],
                ["Juventus", "I1", "1956-57", 9, 1],
                ["SPAL 2013 Ferrara", "I1", "1956-57", 9, 2],
                ["L.R. Vicenza", "I1", "1956-57", 11, 1],
                ["SSC Napoli", "I1", "1956-57", 11, 2],
                ["Calcio Padova", "I1", "1956-57", 11, 3],
                ["AS Roma", "I1", "1956-57", 14, 1],
                ["Atalanta", "I1", "1956-57", 14, 2],
                ["L.R. Vicenza", "I1", "1957-58", 7, 1],
                ["Torino FC", "I1", "1957-58", 7, 2],
                ["AC Milan", "I1", "1957-58", 9, 1],
                ["Udinese Calcio", "I1", "1957-58", 9, 2],
                ["Inter", "I1", "1957-58", 9, 3],
                ["Genoa CFC", "I1", "1957-58", 12, 1],
                ["Sampdoria", "I1", "1957-58", 12, 2],
                ["US Alessandria 1912", "I1", "1957-58", 12, 3],
                ["Lazio Roma", "I1", "1957-58", 12, 4],
                ["SPAL 2013 Ferrara", "I1", "1957-58", 12, 5],
                ["L.R. Vicenza", "I1", "1958-59", 7, 1],
                ["Calcio Padova", "I1", "1958-59", 7, 2],
                ["SSC Napoli", "I1", "1958-59", 7, 3],
                ["SSC Bari", "I1", "1958-59", 11, 1],
                ["Genoa CFC", "I1", "1958-59", 11, 2],
                ["Lazio Roma", "I1", "1958-59", 11, 3],
                ["US Triestina", "I1", "1958-59", 17, 1],
                ["Torino FC", "I1", "1958-59", 17, 2],
                ["Bologna FC", "I1", "1959-60", 5, 1],
                ["Calcio Padova", "I1", "1959-60", 5, 2],
                ["SPAL 2013 Ferrara", "I1", "1959-60", 5, 3],
                ["SSC Bari", "I1", "1959-60", 13, 1],
                ["SSC Napoli", "I1", "1959-60", 13, 2],
                ["Bologna FC", "I1", "1960-61", 9, 1],
                ["Atalanta", "I1", "1960-61", 9, 3],
                ["L.R. Vicenza", "I1", "1960-61", 9, 3],
                ["Torino FC", "I1", "1960-61", 12, 1],
                ["SPAL 2013 Ferrara", "I1", "1960-61", 12, 2],
                ["Calcio Lecco 1912", "I1", "1960-61", 14],
                ["SSC Bari", "I1", "1960-61", 16],
                ["Sampdoria", "I1", "1961-62", 10, 1],
                ["Calcio Catania", "I1", "1961-62", 10, 2],
                ["Venezia FC", "I1", "1961-62", 12, 1],
                ["Juventus", "I1", "1961-62", 12, 2],
                ["L.R. Vicenza", "I1", "1961-62", 14, 1],
                ["SPAL 2013 Ferrara", "I1", "1961-62", 14, 2],
                ["Calcio Padova", "I1", "1961-62", 16, 1],
                ["Calcio Lecco 1912", "I1", "1961-62", 16, 2],
                ["Atalanta", "I1", "1962-63", 8, 1],
                ["SPAL 2013 Ferrara", "I1", "1962-63", 8, 2],
                ["Torino FC", "I1", "1962-63", 8, 3],
                ["Sampdoria", "I1", "1962-63", 11, 1],
                ["Modena FC", "I1", "1962-63", 11, 2],
                ["Mantova 1911 SSD", "I1", "1962-63", 11, 3],
                ["Calcio Catania", "I1", "1962-63", 11, 4],
                ["ACF Fiorentina", "I1", "1963-64", 4, 1],
                ["Juventus", "I1", "1963-64", 4, 2],
                ["Genoa CFC", "I1", "1963-64", 8, 1],
                ["Lazio Roma", "I1", "1963-64", 8, 2],
                ["Calcio Catania", "I1", "1963-64", 8, 3],
                ["Atalanta", "I1", "1963-64", 8, 4],
                ["AS Roma", "I1", "1963-64", 12, 1],
                ["Mantova 1911 SSD", "I1", "1963-64", 12, 2],
                ["ACF Fiorentina", "I1", "1964-65", 4, 1],
                ["Juventus", "I1", "1964-65", 4, 2],
                ["Bologna FC", "I1", "1964-65", 6, 1],
                ["Cagliari Calcio", "I1", "1964-65", 6, 2],
                ["Foggia Calcio", "I1", "1964-65", 9, 1],
                ["AS Roma", "I1", "1964-65", 9, 2],
                ["AS Varese 1910", "I1", "1964-65", 11, 1],
                ["L.R. Vicenza", "I1", "1964-65", 11, 2],
                ["Atalanta", "I1", "1964-65", 11, 3],
                ["Lazio Roma", "I1", "1964-65", 14, 1],
                ["Sampdoria", "I1", "1964-65", 14, 2],
                ["Foggia Calcio", "I1", "1965-66", 12, 1],
                ["Lazio Roma", "I1", "1965-66", 12, 2],
                ["Atalanta", "I1", "1965-66", 12, 3],
                ["L.R. Vicenza", "I1", "1966-67", 13, 1],
                ["Brescia Calcio", "I1", "1966-67", 13, 2],
                ["Venezia FC", "I1", "1966-67", 17, 1],
                ["Calcio Lecco 1912", "I1", "1966-67", 17, 2],
                ["Inter", "I1", "1967-68", 5, 1],
                ["Bologna FC", "I1", "1967-68", 5, 2],
                ["Torino FC", "I1", "1967-68", 7, 1],
                ["AS Varese 1910", "I1", "1967-68", 7, 2],
                ["Sampdoria", "I1", "1967-68", 10, 1],
                ["AS Roma", "I1", "1967-68", 10, 2],
                ["L.R. Vicenza", "I1", "1967-68", 12, 1],
                ["Atalanta", "I1", "1967-68", 12, 2],
                ["SPAL 2013 Ferrara", "I1", "1967-68", 14, 1],
                ["Brescia Calcio", "I1", "1967-68", 14, 2],
                ["AC Milan", "I1", "1969-70", 4, 1],
                ["ACF Fiorentina", "I1", "1969-70", 4, 2],
                ["Lazio Roma", "I1", "1969-70", 8, 1],
                ["L.R. Vicenza", "I1", "1969-70", 8, 2],
                ["Hellas Verona", "I1", "1973-74", 16],
                ["AC Milan", "I1", "1979-80", 15],
                ["Lazio Roma", "I1", "1979-80", 16],
                ["Brescia Calcio", "I1", "1980-81", 14],
                ["Como 1907", "I1", "1980-81", 13],
                ["Udinese Calcio", "I1", "1980-81", 12],
                ["Ascoli Calcio", "I1", "1980-81", 11],
                ["AC Milan", "I1", "1983-84", 6],
                ["Sampdoria", "I1", "1983-84", 7],
                ["Hellas Verona", "I1", "1983-84", 8],
                ["SSC Napoli", "I1", "1983-84", 11],
                ["US Avellino", "I1", "1983-84", 12],
                ["Lazio Roma", "I1", "1983-84", 13],
                ["AC Milan", "I1", "1984-85", 5],
                ["Udinese Calcio", "I1", "1984-85", 12],
                ["Como 1907", "I1", "1984-85", 11],
                ["Lazio Roma", "I1", "1984-85", 15],
                ["Torino FC", "I1", "1985-86", 4],
                ["Sampdoria", "I1", "1985-86", 12],
                ["AC Milan", "I1", "1986-87", 5],
                ["ACF Fiorentina", "I1", "1992-93", 16],
                ["Lazio Roma", "I1", "1993-94", 3],
                ["Parma Calcio 1913", "I1", "1994-95", 2],
                ["Genoa CFC", "I1", "1994-95", 15],
                ["Piacenza Calcio", "I1", "1996-97", 14],
                ["Empoli FC", "I1", "1997-98", 13],
                ["Udinese Calcio", "I1", "1998-99", 6],
                ["Cagliari Calcio", "I1", "1998-99", 13],
                ["Hellas Verona", "I1", "2000-01", 14],
                ["Modena FC", "I1", "2002-03", 12],
                ["Empoli FC", "I1", "2002-03", 13],
                ["Reggina 1914", "I1", "2002-03", 14],
                ["ACN Siena 1904", "I1", "2003-04", 14],
                ["Reggina 1914", "I1", "2004-05", 10],
                ["US Lecce", "I1", "2004-05", 11],
                ["Cagliari Calcio", "I1", "2004-05", 12],
                ["Lazio Roma", "I1", "2004-05", 13],
                ["Bologna FC", "I1", "2004-05", 18],
                ["Parma Calcio 1913", "I1", "2005-06", 7],
                ["Juventus", "I1", "2005-06", 20],
                ["Palermo FC", "I1", "2006-07", 5],
                ["Torino FC", "I1", "2006-07", 16],
                ["Juventus", "I1", "2008-09", 2],
                ["ACF Fiorentina", "I1", "2008-09", 4],
                ["Chievo Verona", "I1", "2009-10", 14],
                ["Udinese Calcio", "I1", "2009-10", 15],
                ["Cagliari Calcio", "I1", "2009-10", 16],
                ["Empoli FC", "I1", "2015-16", 10],
                ["Palermo FC", "I1", "2015-16", 16],
                ["Udinese Calcio", "I1", "2017-18", 14],
                ["Parma Calcio 1913", "I1", "2018-19", 14],
                ["Cagliari Calcio", "I1", "2018-19", 15],
                ["ACF Fiorentina", "I1", "2018-19", 16],
                ["Hellas Verona", "I1", "2019-20", 9],
                ["Spezia Calcio", "I1", "2022-23", 17],
                ["Torino FC", "I1", "2023-24", 9],
                ["Cagliari Calcio", "I1", "2023-24", 16],
                ["Cagliari Calcio", "I1", "2024-25", 15],

                // Germany
                ["MSV Duisburg", "D1", "1963-64", 2],
                ["Fortuna D√ºsseldorf", "D1", "1966-67", 17],
                ["1. FC K√∂ln", "D1", "1968-69", 13],

                // Spain
                ["CD Alav√©s", "SP1", "1930-31", 8],
                ["CD Alav√©s", "SP1", "1931-32", 9],
                ["Real Sociedad", "SP1", "1933-34", 5],
                ["Valencia CF", "SP1", "1933-34", 7],
                ["Espanyol Barcelona", "SP1", "1934-35", 8],
                ["Real Zaragoza", "SP1", "1939-40", 7],
                ["FC Barcelona", "SP1", "1939-40", 9],
                ["Valencia CF", "SP1", "1940-41", 3],
                ["Sevilla FC", "SP1", "1941-42", 6],
                ["CD Castell√≥n", "SP1", "1941-42", 8],
                ["CE Sabadell", "SP1", "1943-44", 9],
                ["Real Murcia", "SP1", "1944-45", 11],
                ["CE Sabadell", "SP1", "1944-45", 13],
                ["Valencia CF", "SP1", "1946-47", 1],
                ["Real Madrid", "SP1", "1946-47", 7],
                ["Athletic Club", "SP1", "1948-49", 6],
                ["Real Valladolid", "SP1", "1950-51", 6],
                ["Deportivo La Coru√±a", "SP1", "1950-51", 12],
                ["Racing Santander", "SP1", "1950-51", 10],
                ["Deportivo La Coru√±a", "SP1", "1951-52", 11],
                ["Racing Santander", "SP1", "1951-52", 14],
                ["Sporting Gij√≥n", "SP1", "1952-53", 7],
                ["Sevilla FC", "SP1", "1953-54", 5],
                ["Real Sociedad", "SP1", "1953-54", 9],
                ["RC Celta", "SP1", "1953-54", 10],
                ["Real Valladolid", "SP1", "1954-55", 9],
                ["CD Alav√©s", "SP1", "1954-55", 10],
                ["Real Sociedad", "SP1", "1955-56", 8],
                ["Sevilla FC", "SP1", "1956-57", 2],
                ["UD Las Palmas", "SP1", "1956-57", 10],
                ["Granada CF", "SP1", "1957-58", 13],
                ["CA Osasuna", "SP1", "1958-59", 8],
                ["Real Zaragoza", "SP1", "1958-59", 9],
                ["Sevilla FC", "SP1", "1958-59", 12],
                ["Real Oviedo", "SP1", "1959-60", 6],
                ["Elche CF", "SP1", "1960-61", 14],
                ["Real Betis", "SP1", "1960-61", 6],
                ["Real Oviedo", "SP1", "1961-62", 10],
                ["FC Barcelona", "SP1", "1962-63", 6],
                ["Real Betis", "SP1", "1962-63", 9],
                ["Sevilla FC", "SP1", "1962-63", 11],
                ["CE Sabadell", "SP1", "1965-66", 14],
                ["Espanyol Barcelona", "SP1", "1965-66", 12],
                ["Sevilla FC", "SP1", "1965-66", 8],
                ["Elche CF", "SP1", "1966-67", 9],
                ["Elche CF", "SP1", "1967-68", 10],
                ["Granada CF", "SP1", "1968-69", 8],
                ["Athletic Club", "SP1", "1968-69", 11],
                ["Sevilla FC", "SP1", "1969-70", 3],
                ["FC Barcelona", "SP1", "1969-70", 4],
                ["Elche CF", "SP1", "1969-70", 11],
                ["Valencia CF", "SP1", "1970-71", 1],
                ["Granada CF", "SP1", "1970-71", 10],
                ["Real Sociedad", "SP1", "1971-72", 8],
                ["Real Betis", "SP1", "1971-72", 13],
                ["Real Sociedad", "SP1", "1972-73", 7],
                ["Athletic Club", "SP1", "1972-73", 9],
                ["Granada CF", "SP1", "1972-73", 13],
                ["Sporting Gij√≥n", "SP1", "1972-73", 14],
                ["Elche CF", "SP1", "1974-75", 8],
                ["Granada CF", "SP1", "1974-75", 15],
                ["UD Las Palmas", "SP1", "1975-76", 13],
                ["UD Las Palmas", "SP1", "1976-77", 4],
                ["Real Betis", "SP1", "1976-77", 5],
                ["Espanyol Barcelona", "SP1", "1976-77", 6],
                ["Burgos CF", "SP1", "1976-77", 14],
                ["Sevilla FC", "SP1", "1977-78", 8],
                ["Rayo Vallecano", "SP1", "1977-78", 10],
                ["Espanyol Barcelona", "SP1", "1977-78", 14],
                ["Real Betis", "SP1", "1977-78", 16],
                ["Real Betis", "SP1", "1979-80", 5],
                ["Real Zaragoza", "SP1", "1979-80", 11],
                ["Real Sociedad", "SP1", "1980-81", 1],
                ["Real Madrid", "SP1", "1980-81", 2],
                ["Atl√©tico Madrid", "SP1", "1980-81", 3],
                ["Valencia", "SP1", "1980-81", 4],
                ["Atl√©tico Madrid", "SP1", "1981-82", 8],
                ["Real Valladolid", "SP1", "1981-82", 9],
                ["CA Osasuna", "SP1", "1981-82", 10],
                ["Real Zaragoza", "SP1", "1981-82", 11],
                ["Racing Santander", "SP1", "1981-82", 12],
                ["Espanyol Barcelona", "SP1", "1981-82", 13],
                ["M√°laga CF", "SP1", "1982-83", 10],
                ["CA Osasuna", "SP1", "1984-85", 6],
                ["UD Las Palmas", "SP1", "1985-86", 13],
                ["Sporting Gij√≥n", "SP1", "1986-87", 4],
                ["Real Zaragoza", "SP1", "1986-87", 5],
                ["RCD Mallorca", "SP1", "1986-87", 6],
                ["Atl√©tico Madrid", "SP1", "1986-87", 7],
                ["Real Valladolid", "SP1", "1986-87", 10],
                ["Real Murcia", "SP1", "1986-87", 11],
                ["Sevilla FC", "SP1", "1986-87", 12],
                ["CE Sabadell", "SP1", "1986-87", 15],
                ["CD Logro√±√©s", "SP1", "1987-88", 13],
                ["Real Zaragoza", "SP1", "1988-89", 5],
                ["Real Oviedo", "SP1", "1988-89", 12],
                ["CA Osasuna", "SP1", "1989-90", 8],
                ["C√°diz CF", "SP1", "1989-90", 15],
                ["Burgos CF", "SP1", "1990-91", 11],
                ["Athletic Club", "SP1", "1990-91", 12],
                ["RCD Mallorca", "SP1", "1990-91", 15],
                ["CD Logro√±√©s", "SP1", "1991-92", 10],
                ["Athletic Club", "SP1", "1991-92", 14],
                ["Real Valladolid", "SP1", "1991-92", 19],
                ["Sporting Gij√≥n", "SP1", "1992-93", 12],
                ["Sevilla FC", "SP1", "1994-95", 5],
                ["Valencia CF", "SP1", "1994-95", 10],
                ["Real Zaragoza", "SP1", "1995-96", 13],
                ["Athletic Club", "SP1", "1995-96", 15],
                ["Albacete", "SP1", "1995-96", 20],
                ["Deportivo La Coru√±a", "SP1", "1996-97", 3],
                ["Atl√©tico Madrid", "SP1", "1997-98", 7],
                ["UD Salamanca", "SP1", "1997-98", 15],
                ["Espanyol Barcelona", "SP1", "1999-00", 14],
                ["Real Oviedo", "SP1", "1999-00", 16],
                ["Athletic Club", "SP1", "2000-01", 12],
                ["Rayo Vallecano", "SP1", "2000-01", 14],
                ["CA Osasuna", "SP1", "2000-01", 15],
                ["Real Valladolid", "SP1", "2000-01", 16],
                ["M√°laga CF", "SP1", "2001-02", 10],
                ["CA Osasuna", "SP1", "2002-03", 11],
                ["M√°laga CF", "SP1", "2002-03", 13],
                ["Real Zaragoza", "SP1", "2003-04", 12],
                ["Deportivo La Coru√±a", "SP1", "2004-05", 8],
                ["CA Osasuna", "SP1", "2005-06",4],
                ["Real Sociedad", "SP1", "2005-06", 16],
                ["Real Madrid", "SP1", "2006-07", 1],
                ["Espanyol Barcelona", "SP1", "2006-07", 11],
                ["Atl√©tico Madrid", "SP1", "2007-08", 4],
                ["UD Almer√≠a", "SP1", "2007-08", 8],
                ["Real Betis", "SP1", "2007-08", 13],
                ["UD Almer√≠a", "SP1", "2008-09", 11],
                ["Sporting Gij√≥n", "SP1", "2008-09", 14],
                ["CA Osasuna", "SP1", "2008-09", 15],
                ["Sevilla FC", "SP1", "2010-11", 5],
                ["Athletic Club", "SP1", "2010-11", 6],
                ["Real Zaragoza", "SP1", "2010-11", 13],
                ["Getafe CF", "SP1", "2011-12", 11],
                ["Getafe CF", "SP1", "2013-14", 13],
                ["Levante UD", "SP1", "2014-15", 14],
                ["SD Eibar", "SP1", "2014-15", 18],
                ["UD Las Palmas", "SP1", "2015-16", 11],
                ["Espanyol Barcelona", "SP1", "2015-16", 13],
                ["Granada CF", "SP1", "2015-16", 16],
                ["Espanyol Barcelona", "SP1", "2017-18", 11],
                ["Getafe CF", "SP1", "2018-19", 5],
                ["Real Valladolid", "SP1", "2018-19", 16],
                ["Granada CF", "SP1", "2020-21", 9],
                ["RCD Mallorca", "SP1", "2021-22", 16],
                ["Rayo Vallecano", "SP1", "2022-23", 11],
                ["C√°diz CF", "SP1", "2022-23", 14],
                ["Getafe CF", "SP1", "2022-23", 15],
                ["RC Celta", "SP1", "2023-24", 13],
                ["Rayo Vallecano", "SP1", "2024-25", 8],
                ["Real Sociedad", "SP1", "2024-25", 11],
                ["Espanyol Barcelona", "SP1", "2024-25", 14],
                ["Girona FC", "SP1", "2024-25", 16],

                // England
                ["Burnley FC", "E0", "1891-92", 7],
                ["Sheffield United", "E0", "1896-97", 2],
                ["Aston Villa", "E0", "1897-98", 6],
                ["Middlesbrough FC", "E0", "1904-05", 15],
                ["Bradford City", "E0", "1914-15", 11],
                ["Huddersfield Town", "E0", "1923-24", 1],
                ["Birmingham City", "E0", "1936-37", 11],
                ["Bolton Wanderers", "E0", "1948-49", 14],
                ["Bolton Wanderers", "E0", "1949-50", 16],
                ["Sunderland AFC", "E0", "1950-51", 12],
                ["Fulham FC", "E0", "1950-51", 18],
                ["Manchester United", "E0", "1953-54", 4],
                ["Blackpool FC", "E0", "1955-56", 2],
                ["Chelsea FC", "E0", "1956-57", 13],
                ["Leicester City", "E0", "1964-65", 18],
                ["Aston Villa", "E0", "1965-66", 16],
                ["Nottingham Forest", "E0", "1966-67", 2],
                ["Burnley FC", "E0", "1966-67", 14],
                ["Nottingham Forest", "E0", "1971-72", 21],
                ["Liverpool FC", "E0", "1974-75", 2],

                // France
                // Add ranking overrides here as needed
                ["Olympique Lillois Lille", "F1", "1932-33", 1],
                ["AS Cannes", "F1", "1932-33", 2],
                ["Olympique Marseille", "F1", "1934-35", 9],
                ["FC Sochaux", "F1", "1938-39", 6],
                ["SC S√®te", "F1", "1948-49", 14],
                ["Olympique Marseille", "F1", "1955-56", 5],
                ["AS Monaco", "F1", "1957-58", 3],
                ["RC Strasbourg", "F1", "1959-60", 18],
                ["Stade de Reims", "F1", "1961-62", 1],
                ["FC Rouen 1899", "F1", "1961-62", 9],
                ["Stade Fran√ßais", "F1", "1961-62", 10],
                ["FC Metz", "F1", "2023-24", 16]


            ];
        }

        // Apply ranking overrides for historic seasons
        function applyRankingOverrides(tableArray, selectedLeague, selectedSeason) {
            // Only apply overrides for historic season filters
            if (!selectedSeason) return tableArray;
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const selectedDiv = leagueMapping[selectedLeague];
            const overrides = getRankingOverrides().filter(override => 
                override[1] === selectedDiv && override[2] === selectedSeason
            );
            
            if (overrides.length === 0) return tableArray;
            
            // Create a copy of the array to work with
            let result = [...tableArray];
            
            // Separate teams with overrides from those without
            const teamsWithOverrides = [];
            const teamsWithoutOverrides = [];
            
            overrides.forEach(override => {
                const [teamName, , , overridePosition, subOrder] = override;
                const teamIndex = result.findIndex(team => team.team === teamName);
                if (teamIndex !== -1) {
                    const team = result[teamIndex];
                    team.sharedPosition = parseInt(overridePosition);
                    team.subOrder = subOrder || 1;
                    teamsWithOverrides.push(team);
                }
            });
            
            // Get teams without overrides
            result.forEach(team => {
                const hasOverride = teamsWithOverrides.some(overrideTeam => overrideTeam.team === team.team);
                if (!hasOverride) {
                    teamsWithoutOverrides.push(team);
                }
            });
            
            // Sort teams with overrides by position, then by sub-order
            teamsWithOverrides.sort((a, b) => {
                if (a.sharedPosition !== b.sharedPosition) return a.sharedPosition - b.sharedPosition;
                return a.subOrder - b.subOrder;
            });
            
            // Build final result by filling positions
            const finalResult = [];
            const overridePositions = new Set(teamsWithOverrides.map(t => t.sharedPosition));
            
            let nonOverrideIndex = 0;
            for (let position = 1; position <= tableArray.length; position++) {
                if (overridePositions.has(position)) {
                    // Fill with override teams at this position
                    const overrideTeamsAtThisPosition = teamsWithOverrides.filter(t => t.sharedPosition === position);
                    finalResult.push(...overrideTeamsAtThisPosition);
                } else {
                    // Fill with next non-override team
                    if (nonOverrideIndex < teamsWithoutOverrides.length) {
                        finalResult.push(teamsWithoutOverrides[nonOverrideIndex]);
                        nonOverrideIndex++;
                    }
                }
            }
            
            return finalResult;
        }

        // Team colors for head-to-head visualizations
        function getTeamColors() {
            return {
                // Premier League
                'premier-league': [
                    ['Liverpool FC', '#D10022', 550],                    
                    ['Arsenal FC', '#EF0107', 555],
                    ['Everton FC', '#0052CC', 560],                    
                    ['Manchester United', '#D9020D', 543],
                    ['Aston Villa', '#670E36', 559],
                    ['Manchester City', '#84BBFF', 750],
                    ['Chelsea FC', '#004793', 544],
                    ['Tottenham Hotspur', '#001C58', 552],
                    ['Newcastle United', '#000000', 546],
                    ['Sunderland AFC', '#EB172C', 547],
                    ['West Bromwich Albion', '#000080', 748],
                    ['Wolverhampton Wanderers', '#FDB913', 749],
                    ['Blackburn Rovers', '#009ee0', 557],
                    ['Bolton Wanderers', '#263c7e', 554],
                    ['Sheffield Wednesday', '#4681cf', 745],
                    ['West Ham United', '#660033', 553],
                    ['Derby County', '#000000', 542],
                    ['Sheffield United', '#EC2227', 2309], 
                    ['Leeds United', '#FFE100', 541],
                    ['Burnley FC', '#660808', 3185],                    
                    ['Nottingham Forest', '#C8102E', 743],
                    ['Middlesbrough FC', '#FF0000', 548],
                    ['Stoke City', '#FF0033', 2807],
                    ['Leicester City', '#0053A0', 549],
                    ['Birmingham City', '#0000FF', 2244],
                    ['Preston North End', '#002156', 2249],     
                    ['Southampton FC', '#FF0033', 545],
                    ['Huddersfield Town', '#0072CE', 3017],                    
                    ['Portsmouth FC', '#0754ED', 2220],
                    ['Coventry City', '#059DD9', 2240],
                    ['Blackpool FC', '#FF8C00', 2873],
                    ['Ipswich Town', '#3a64a3', 556],
                    ['Fulham FC', '#000000', 558],
                    ['Charlton Athletic', '#D6011D', 551],
                    ['Notts County', '#000000', 3106],
                    ['Norwich City', '#009900', 744],
                    ['Queens Park Rangers', '#0066FF', 746],
                    ['Crystal Palace', '#1B458F', 2242],
                    ['Bury FC', '#032AF0', 2238],
                    ['Cardiff City', '#0070B5', 3182],
                    ['Luton Town', '#2E1C94', 3123],
                    ['Wimbledon FC', '#0000FF', 37530],
                    ['Watford FC', '#FFF71C', 747],
                    ['Oldham Athletic', '#004A97', 2897],
                    ['Grimsby Town', '#000000', 3180],
                    ['Bradford City', '#990033', 2241],
                    ['Brighton & Hove Albion', '#0054A6', 3050],
                    ['Brentford FC', '#FF0000', 3271],
                    ['Bristol City', '#E21A23', 3277],
                    ['Swansea City', '#000000', 3183],
                    ['AFC Bournemouth', '#BF0C10', 2248],
                    ['Wigan Athletic', '#1d59af', 3116],
                    ['Hull City', '#F5A12D', 3111],
                    ['Bradford Park Avenue', '#FB090B', 4195],
                    ['Accrington FC', '#FF0000', 0],
                    ['Reading FC', '#0000FF', 3285],
                    ['Oxford United', '#FFFF00', 3272],
                    ['Millwall FC', '#00194A', 2250],
                    ['Northampton Town', '#990000', 3184],
                    ['Carlisle United', '#1F47BF', 3118],
                    ['Darwen', '#FF0000', 4245],
                    ['Barnsley FC', '#D71921', 3181],
                    ['Swindon Town', '#FF0000', 2237],
                    ['Leyton Orient', '#FF0000', 3121],
                    ['Glossop North End', '#002156', 4243]
                ],
                
                // Serie A
                'serie-a': [
                    ['Juventus', '#000000', 511],
                    ['Inter', '#010E80', 507],
                    ['AC Milan', '#FB090B', 514],
                    ['AS Roma', '#8E1F2F', 520],
                    ['ACF Fiorentina', '#482E92', 3021],
                    ['Lazio Roma', '#87D8F7', 505],
                    ['SSC Napoli', '#12A0D7', 732],
                    ['Torino FC', '#8A1E03', 734],
                    ['Bologna FC', '#1A2F48', 503],
                    ['Sampdoria', '#1B5497', 731],
                    ['Atalanta', '#1E71B8', 504],
                    ['Udinese Calcio', '#000000', 517],
                    ['Genoa CFC', '#05232F', 735],
                    ['Cagliari Calcio', '#002350', 733],
                    ['Parma Calcio 1913', '#1B4094', 516],
                    ['Hellas Verona', '#FFE74A', 519],
                    ['Palermo FC', '#F7B7D3', 2831],
                    ['L.R. Vicenza', '#FF0003', 2219],
                    ['SSC Bari', '#F03030', 2734],
                    ['US Triestina', '#FF0000', 2837],
                    ['Brescia Calcio', '#007FFF', 513],
                    ['Chievo Verona', '#F0F027', 510],
                    ['SPAL 2013 Ferrara', '#0470C2', 2833],
                    ['AS Livorno', '#853138', 2841],
                    ['Calcio Padova', '#FF0000', 2821],
                    ['Calcio Catania', '#E03636', 2826],
                    ['US Lecce', '#E80000', 515],
                    ['Empoli FC', '#175EEB', 2729],
                    ['Ascoli Calcio', '#030000', 2757],
                    ['US Alessandria 1912', '#808080', 2836],
                    ['Modena FC', '#1616CC', 2727],
                    ['Sassuolo Calcio', '#099902', 5843],
                    ['AC Perugia', '#D91515', 508],
                    ['Como 1907', '#007FFF', 2726],
                    ['Novara Calcio', '#007FFF', 2839],
                    ['Aurora Pro Patria', '#122AFF', 2838],
                    ['Venezia FC', '#FF8000', 512],
                    ['Foggia Calcio', '#BD0B0B', 2211],
                    ['Cesena FC', '#080808', 2824],
                    ['ACN Siena 1904', '#000000', 2843],
                    ['Reggina 1914', '#6B1111', 2728],
                    ['US Avellino', '#0C6912', 2825],
                    ['Lucchese', '#D13636', 2740],
                    ['Piacenza Calcio', '#FF0000', 506],
                    ['Pro Vercelli', '#000000', 2848],
                    ['US Cremonese', '#FF0000', 2822],
                    ['Mantova 1911 SSD', '#FF0000', 2832],
                    ['Pisa SC', '#100778', 2210],
                    ['US Catanzaro', '#FFE226', 2827],
                    ['AS Varese 1910', '#FF0000', 2830],
                    ['US Salernitana 1919', '#831D1C', 2820],
                    ['AC Liguria', '#FB090B', 0],
                    ['ACR Messina', '#C70808', 2834],
                    ['Delfino Pescara', '#59A9E6', 2823],
                    ['Casale', '#030303', 2849],
                    ['AC Monza', '#FF0000', 3012],
                    ['Spezia Calcio', '#6C93BA', 3128],
                    ['Sampierdarenese', '#515EE8', 2845],
                    ['Calcio Lecco 1912', '#0E0EC7', 2835],
                    ['FC Crotone', '#D43333', 3980],
                    ['Frosinone Calcio', '#FFDD00', 5633],
                    ['AC Reggiana', '#821D1C', 2789],
                    ['Legnano', '#C1C4E0', 2840],
                    ['Benevento Calcio', '#F0CA0E', 4180],
                    ['Ternana Calcio', '#E01D1D', 2829],
                    ['AC Carpi', '#DE1616', 4820],
                    ['AC Ancona', '#FB090B', 2262],
                    ['US Pistoiese', '#BD6615', 2828],
                    ['ACD Treviso', '#D4EFFC', 5225]
                ],
                
                // La Liga
                'la-liga': [
                    ['Real Madrid', '#FEBE10', 532],
                    ['FC Barcelona', '#A60042', 530],
                    ['Atl√©tico Madrid', '#212B61', 737],
                    ['Athletic Club', '#FF0000', 528],
                    ['Valencia CF', '#000000', 531],
                    ['Sevilla FC', '#FF0000', 529],
                    ['Espanyol Barcelona', '#007FC8', 525],
                    ['Real Sociedad', '#0000FF', 527],
                    ['Real Betis', '#00954C', 540],
                    ['RC Celta', '#99CCFF', 536],
                    ['Real Zaragoza', '#ff0000', 526],
                    ['Deportivo La Coru√±a', '#57175E', 523],
                    ['Real Valladolid', '#921B88', 524],                    
                    ['CA Osasuna', '#0A346F', 738],
                    ['Sporting Gij√≥n', '#FF0000', 739],
                    ['Racing Santander', '#009900', 2287],
                    ['Real Oviedo', '#0066FF', 2193],
                    ['M√°laga CF', '#3399FF', 539],
                    ['RCD Mallorca', '#FF0000', 521],
                    ['Villarreal CF', '#FFE135', 538],
                    ['UD Las Palmas', '#FFFF00', 522],
                    ['Granada CF', '#FF0000', 3192],
                    ['Rayo Vallecano', '#FF0000', 537],
                    ['Getafe CF', '#0000FF', 3689],
                    ['Elche CF', '#00CC33', 3190],
                    ['CD Alav√©s', '#048FD9', 534],
                    ['H√©rcules CF', '#242EFC', 2870],
                    ['Levante UD', '#0000CC', 2809],
                    ['C√°diz CF', '#FFFF00', 3188],
                    ['CD Tenerife', '#0000FF', 533],
                    ['Real Murcia', '#EB0707', 3140],
                    ['CE Sabadell', '#100DDB', 3191],
                    ['UD Salamanca', '#000000', 3754],
                    ['CD Castell√≥n', '#F6D70D', 3189],
                    ['CD Logro√±√©s', '#FF0000', 2887],
                    ['Burgos CF', '#000000', 3015],
                    ['C√≥rdoba CF', '#009933', 3078],
                    ['Albacete', '#000000', 2394],
                    ['UD Almer√≠a', '#EE1119', 3194],
                    ['SD Eibar', '#E01212', 3569],
                    ['Girona FC', '#FF0000', 5264],
                    ['Pontevedra CF', '#FF0000', 3193],
                    ['SD Compostela', '#66CCFF', 2731],
                    ['CD Legan√©s', '#0000FF', 3668],
                    ['Recreativo Huelva', '#205081', 2448],
                    ['Arenas de Getxo', '#000000', 742],
                    ['CD Numancia', '#FF0000', 2308],
                    ['Gimn√†stic de Tarragona', '#DD2430', 3199],
                    ['CD Alcoyano', '#2596BE', 6336],
                    ['Real Ja√©n', '#9900CC', 2776],
                    ['CF Extremadura', '#800000', 2305],
                    ['M√©rida AD', '#000000', 3186],
                    ['Real Uni√≥n', '#000000', 741],
                    ['AD Almer√≠a', '#EE1119', 0],
                    ['SD Huesca', '#CF122D', 9659],
                    ['CE Europa', '#2596BE', 3200],
                    ['Lleida Esportiu', '#76B5C5', 3112],
                    ['Xerez CD', '#0033FF', 2813],
                    ['CD Condal', '#1E81B0', 3195],
                    ['Atl√©tico Tetu√°n', '#FF0000', 3197],
                    ['Cultural Leonesa', '#FF0000', 3196]
                ],
                
                // Bundesliga
                'bundesliga': [
                    ['Bayern M√ºnchen', '#DB072D', 222],
                    ['Borussia Dortmund', '#FDE100', 210],
                    ['Werder Bremen', '#00924A', 202],
                    ['VfB Stuttgart', '#FF0000', 215],
                    ['Bor. M√∂nchengladbach', '#000000', 221],
                    ['Hamburger SV', '#014495', 211],
                    ['Eintracht Frankfurt', '#FF0000', 205],
                    ['FC Schalke 04', '#025FAC', 206],
                    ['Bayer Leverkusen', '#FF0000', 236],
                    ['1. FC K√∂ln', '#ED1C23', 213],
                    ['1. FC Kaiserslautern', '#F50505', 214],
                    ['Hertha BSC', '#004CFF', 209],
                    ['VfL Bochum', '#2B579E', 229],
                    ['VfL Wolfsburg', '#0C4011', 246],
                    ['1. FC N√ºrnberg', '#990000', 212],                    
                    ['Hannover 96', '#009932', 218],
                    ['MSV Duisburg', '#3C4E99', 216],
                    ['SC Freiburg', '#FF0000', 245],
                    ['Fortuna D√ºsseldorf', '#FF0000', 223],
                    ['Karlsruher SC', '#0033CC', 208],
                    ['Eintracht Braunschweig', '#025FAC', 217],
                    ['TSV 1860 M√ºnchen', '#5D9AF5', 204],
                    ['1. FSV Mainz 05', '#FF0000', 337],
                    ['1899 Hoffenheim', '#0033CC', 442],
                    ['Arminia Bielefeld', '#0000FF', 228],
                    ['RB Leipzig', '#DD0741', 13247],
                    ['FC Augsburg', '#BB3532', 342],
                    ['KFC Uerdingen 05', '#004FED', 233],
                    ['Hansa Rostock', '#0033CC', 243],
                    ['FC St. Pauli', '#8B4513', 234],
                    ['1. FC Union Berlin', '#E40019', 330],
                    ['Waldhof Mannheim', '#004292', 338],
                    ['Kickers Offenbach', '#FF0000', 226],
                    ['Rot-Weiss Essen', '#FF0000', 224],
                    ['Energie Cottbus', '#FF0000', 249],
                    ['Alemannia Aachen', '#FFFF00', 225],
                    ['SG Wattenscheid 09', '#000000', 241],
                    ['1. FC Saarbr√ºcken', '#0033FF', 203],
                    ['Dynamo Dresden', '#FFFF00', 242],
                    ['Rot-Wei√ü Oberhausen', '#E72D33', 336],
                    ['SV Darmstadt 98', '#6796C6', 235],
                    ['Wuppertaler SV', '#FF0000', 230],
                    ['Borussia Neunkirchen', '#000000', 219],
                    ['FC 08 Homburg', '#0C4011', 238],
                    ['SpVgg Unterhaching', '#BA1111', 248],
                    ['Stuttgarter Kickers', '#0BB1DB', 240],
                    ['FC Ingolstadt 04', '#FF0000', 4856],
                    ['1. FC Heidenheim 1846', '#003B79', 4497],
                    ['SC Paderborn 07', '#2B429C', 422],
                    ['TeBe Berlin', '#5B1A73', 356],
                    ['SpVgg Greuther F√ºrth', '#009933', 331],
                    ['SSV Ulm 1846', '#1F1D1D', 368],
                    ['Fortuna K√∂ln', '#E80000', 231],
                    ['Preu√üen M√ºnster', '#000000', 207],
                    ['Holstein Kiel', '#0F5787', 385],
                    ['Blau-Wei√ü 90 Berlin', '#1709DB', 239],
                    ['1. FC Lok Leipzig', '#1F357F', 244],
                    ['SV Tasmania Berlin', '#0000FF', 688]
                ],
                
                // Ligue 1
                'ligue-1': [
                    ['Olympique Marseille', '#099FFF', 576],
                    ['AS Monaco', '#FF0000', 562],
                    ['Girondins Bordeaux', '#000979', 565],
                    ['AS Saint-√âtienne', '#40B848', 757],
                    ['Olympique Lyonnais', '#003781', 567],
                    ['Lille OSC', '#F20505', 577],
                    ['Paris Saint-Germain', '#00093F', 563],
                    ['OGC Nice', '#ED1C24', 774],
                    ['Stade Rennais', '#E13327', 570],
                    ['FC Nantes', '#FCD405', 574],
                    ['FC Sochaux', '#034A97', 564],
                    ['RC Lens', '#FFDF00', 568],
                    ['RC Strasbourg', '#009FE3', 752],
                    ['FC Metz', '#6E0F12', 569],
                    ['Stade de Reims', '#EE2223', 776],
                    ['Montpellier HSC', '#344575', 572],
                    ['AJ Auxerre', '#1C4F9C', 571],   
                    ['Toulouse FC', '#8D42D4', 755],  
                    ['N√Æmes Olympique', '#E40613', 784],    
                    ['SC Bastia', '#0053A1', 566],    
                    ['Racing Club de France', '#78ACE4', 772],
                    ['Valenciennes FC', '#D91920', 3036],                    
                    ['Angers SCO', '#000000', 2234],                    
                    ['AS Nancy Lorraine', '#FF0000', 783],
                    ['CS Sedan', '#008006', 578],
                    ['Havre AC', '#11A4D9', 760],
                    ['AS Cannes', '#F4141C', 753],
                    ['FC Rouen 1899', '#FF0000', 773],
                    ['Stade Brestois 29', '#ED1C24', 3306],
                    ['SM Caen', '#26355D', 754],
                    ['FC Lorient', '#F58113', 575],
                    ['Toulouse FC (old)', '#EA0046', 69609],
                    ['SC S√®te', '#2D7A09', 771],
                    ['FC Nancy', '#123163', 9704],
                    ['Stade Fran√ßais', '#EB5195', 769],
                    ['Stade Lavallois', '#EC6608', 756],
                    ['ESTAC Troyes', '#006EB2', 573],
                    ['EA Guingamp', '#ED1C24', 561],
                    ['Red Star FC', '#32D181', 775],
                    ['AC Ajaccio', '#E3272C', 2410],
                    ['SC Toulon', '#FFCC00', 3035],
                    ['CO Roubaix-Tourcoing', '#003781', 779],
                    ['Olympique Lillois Lille', '#FF0000', 768],
                    ['Excelsior Roubaix', '#000000', 3348],
                    ['SC Fives Lille', '#24216A', 4027],
                    ['Le Mans FC', '#BE081A', 3401],
                    ['FC Antibes', '#003781', 7419],
                    ['Dijon FCO', '#D3072A', 5121],
                    ['FC Mulhouse', '#3300FF', 770],
                    ['Thonon √âvian GGFC', '#123163', 5726],
                    ['Tours FC', '#099FFF', 3307],
                    ['Olympique Al√®s', '#003781', 3098],
                    ['Grenoble Foot 38', '#014898', 2236],
                    ['Limoges FC', '#FF0000', 5753],
                    ['Paris FC', '#00093F', 6723],
                    ['Angoul√™me CFC', '#003781', 3995],
                    ['Clermont Foot 63', '#C50C46', 4383],
                    ['FC Martigues', '#FF0000', 2316],
                    ['Amiens SC', '#000000', 3349],
                    ['RC Roubaix (old)', '#000000', 761],
                    ['Troyes AF', '#00A0E4', 69591],
                    ['SC N√Æmes', '#FF0000', 70035],
                    ['Chamois Niortais', '#005CB9', 4130],
                    ['SR Colmar', '#32D181', 7418],
                    ['CA Paris (old)', '#FF0000', 767],
                    ['Lyon OU', '#FF0000', 69513],
                    ['FC Gueugnon', '#FFEE00', 751],
                    ['Gaz√©lec FC Ajaccio', '#FF0000', 4325],
                    ['AS B√©ziers (old)', '#FF0000', 70137],
                    ['FC Istres', '#8D42D4', 3518],
                    ['LB Ch√¢teauroux', '#00458E', 3269],
                    ['US Boulogne', '#E2001A', 9329],
                    ['Avenir Club Avignonnais', '#000000', 6936],
                    ['AS Aix-en-Provence', '#3D84FF', 7416],
                    ['AC Arles-Avignon', '#0033FF', 11030],
                    ['Club Francais Paris', '#FF0000', 759],
                    ['Hy√®res FC', '#9C824A', 7420]
                ]
            };
        }

        // Get team color for H2H visualization
        function getTeamColor(teamName, league) {
            const teamColors = getTeamColors();
            const leagueColors = teamColors[league] || [];
            
            const teamColorEntry = leagueColors.find(([name, color]) => name === teamName);
            return teamColorEntry ? teamColorEntry[1] : null;
        }

        // Get team logo number
        function getTeamLogoNumber(teamName, league) {
            const teamColors = getTeamColors();
            const leagueColors = teamColors[league] || [];
            
            const teamColorEntry = leagueColors.find(([name, color, logoNum]) => name === teamName);
            return teamColorEntry ? teamColorEntry[2] : null;
        }

        // Get team logo URL
        function getTeamLogoUrl(teamName, league) {
            const logoNumber = getTeamLogoNumber(teamName, league);
            return logoNumber ? `https://s.hs-data.com/bilder/wappen/mittel/${logoNumber}.gif?fallback=png` : null;
        }

        // Get contrasting text color (white or black) based on background color
        function getContrastColor(hexColor) {
            // Remove # if present
            const hex = hexColor.replace('#', '');
            
            // Convert to RGB
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return black for light colors, white for dark colors
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }

        // Stripped Champions data - entries that should be hidden when position filtering is involved
        const strippedChampions = [
            ["Juventus", "I1", "2004-05", 1],
            ["Olympique Marseille", "F1", "1992-93", 1],
            ["Arminia Bielefeld", "E1", "1971-72", 18]

            // Add more entries as needed: [teamName, leagueDiv, season, position]
        ];

        // Check if an entry should be filtered out due to stripped champion rules
        function isStrippedChampion(teamName, leagueDiv, season, position, hasTeamFilter, hasPositionFilter) {
            // Only apply filtering when position is involved in the filter
            if (!hasPositionFilter) {
                return false; // Show everything when no position filter is active
            }

            // Check if this entry matches any stripped champion record
            return strippedChampions.some(([team, league, seasonStr, pos]) => {
                return team === teamName && 
                       league === leagueDiv && 
                       seasonStr === season && 
                       pos === position;
            });
        }

        // Point deductions data
        const pointDeductions = [
            { team: 'Genoa CFC', points: 18, startDate: '1959-09-20', endDate: '1960-06-05', league: 'I1' },
            { team: 'Foggia Calcio', points: 6, startDate: '1973-10-07', endDate: '1974-05-19', league: 'I1' },
            { team: 'Sampdoria', points: 3, startDate: '1973-10-07', endDate: '1974-05-19', league: 'I1' },
            { team: 'SSC Napoli', points: 1, startDate: '1976-10-03', endDate: '1977-05-22', league: 'I1' },
            { team: 'Bologna FC', points: 5, startDate: '1980-09-14', endDate: '1981-05-24', league: 'I1' },
            { team: 'US Avellino', points: 5, startDate: '1980-09-14', endDate: '1981-05-24', league: 'I1' },
            { team: 'AC Perugia', points: 5, startDate: '1980-09-14', endDate: '1981-05-24', league: 'I1' },
            { team: 'Udinese Calcio', points: 9, startDate: '1986-09-14', endDate: '1987-05-17', league: 'I1' },
            { team: 'Empoli FC', points: 5, startDate: '1987-09-13', endDate: '1988-05-15', league: 'I1' },
            { team: 'Empoli FC', points: 2, startDate: '1998-09-12', endDate: '1999-05-23', league: 'I1' },
            { team: 'AC Milan', points: 30, startDate: '2005-08-27', endDate: '2006-05-14', league: 'I1' },
            { team: 'Lazio Roma', points: 30, startDate: '2005-08-27', endDate: '2006-05-14', league: 'I1' },
            { team: 'ACF Fiorentina', points: 30, startDate: '2005-08-27', endDate: '2006-05-14', league: 'I1' },
            { team: 'ACN Siena 1904', points: 1, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'ACF Fiorentina', points: 15, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'Reggina 1914', points: 11, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'AC Milan', points: 8, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'Lazio Roma', points: 3, startDate: '2006-09-09', endDate: '2007-05-26', league: 'I1' },
            { team: 'Bologna FC', points: 3, startDate: '2010-08-28', endDate: '2011-05-22', league: 'I1' },
            { team: 'Atalanta', points: 6, startDate: '2011-09-09', endDate: '2012-05-13', league: 'I1' },
            { team: 'Sampdoria', points: 1, startDate: '2012-08-25', endDate: '2013-05-19', league: 'I1' },
            { team: 'Torino FC', points: 1, startDate: '2012-08-25', endDate: '2013-05-19', league: 'I1' },
            { team: 'Atalanta', points: 2, startDate: '2012-08-25', endDate: '2013-05-19', league: 'I1' },
            { team: 'ACN Siena 1904', points: 6, startDate: '2012-08-25', endDate: '2013-05-19', league: 'I1' },
            { team: 'Parma Calcio 1913', points: 7, startDate: '2014-08-30', endDate: '2015-05-31', league: 'I1' },
            { team: 'Lazio Roma', points: 1, startDate: '2017-08-19', endDate: '2018-05-20', league: 'I1' },
            { team: 'Lazio Roma', points: 2, startDate: '2018-08-18', endDate: '2019-05-26', league: 'I1' },
            { team: 'Chievo Verona', points: 3, startDate: '2018-08-18', endDate: '2019-05-26', league: 'I1' },
            { team: 'Juventus', points: 10, startDate: '2022-08-13', endDate: '2023-06-04', league: 'I1' },
            
            // Other leagues deductions...
            { team: '1. FC Kaiserslautern', points: 3, startDate: '2003-08-01', endDate: '2004-05-22', league: 'D1' },
            { team: 'Eintracht Frankfurt', points: 2, startDate: '1999-08-13', endDate: '2000-05-20', league: 'D1' },
            { team: 'Dynamo Dresden', points: 4, startDate: '1993-08-06', endDate: '1994-05-07', league: 'D1' },
            { team: 'Sunderland AFC', points: 2, startDate: '1890-08-01', endDate: '1891-05-31', league: 'E0' },
            { team: 'Arsenal FC', points: 2, startDate: '1990-08-01', endDate: '1991-05-31', league: 'E0' },
            { team: 'Manchester United', points: 1, startDate: '1990-08-01', endDate: '1991-05-31', league: 'E0' },
            { team: 'Middlesbrough FC', points: 3, startDate: '1996-08-17', endDate: '1997-05-11', league: 'E0' },
            { team: 'Portsmouth FC', points: 9, startDate: '2009-08-15', endDate: '2010-05-09', league: 'E0' },
            { team: 'Everton FC', points: 6, startDate: '2023-08-11', endDate: '2024-05-19', league: 'E0' },
            { team: 'Nottingham Forest', points: 4, startDate: '2023-08-11', endDate: '2024-05-19', league: 'E0' },
            { team: 'Olympique Marseille', points: 1, startDate: '1992-08-08', endDate: '1993-06-02', league: 'F1' },
            { team: 'Valenciennes FC', points: 1, startDate: '1992-08-08', endDate: '1993-06-02', league: 'F1' },
            { team: 'FC Metz', points: 1, startDate: '2007-08-04', endDate: '2008-05-17', league: 'F1' },
            { team: 'AC Ajaccio', points: 2, startDate: '2012-08-10', endDate: '2013-05-26', league: 'F1' },
            { team: 'OGC Nice', points: 1, startDate: '2021-08-06', endDate: '2022-05-21', league: 'F1' },
            { team: 'Olympique Lyonnais', points: 1, startDate: '2021-08-06', endDate: '2022-05-21', league: 'F1' },
            { team: 'Montpellier HSC', points: 1, startDate: '2023-07-01', endDate: '2024-06-30', league: 'F1' },
            { team: 'UD Almer√≠a', points: 3, startDate: '2014-08-23', endDate: '2015-05-23', league: 'SP1' },
            { team: 'Racing Santander', points: 1, startDate: '2003-08-30', endDate: '2004-05-23', league: 'SP1' },
            { team: 'M√°laga CF', points: 3, startDate: '1979-07-01', endDate: '1980-06-30', league: 'SP1' }
        ];

        // Season mappings
        const seasons = {
            'serie-a': {
                '2025-26': { start: '2025-08-01', end: '2026-06-30' },
                '2024-25': { start: '2024-08-01', end: '2025-06-30' },
                '2023-24': { start: '2023-08-01', end: '2024-06-30' },
                '2022-23': { start: '2022-08-01', end: '2023-06-30' },
                '2021-22': { start: '2021-08-01', end: '2022-06-30' },
                '2020-21': { start: '2020-09-14', end: '2021-06-04' }, // Extended by 5 days each side
                '2019-20': { start: '2019-08-19', end: '2020-08-10' }, // Extended by 5 days each side
            },
            'premier-league': {
                '2020-21': { start: '2020-09-07', end: '2021-05-28' }, // Extended by 5 days each side
                '2019-20': { start: '2019-07-31', end: '2020-07-31' }, // Extended by 5 days each side
                '1946-47': { start: '1946-07-01', end: '1947-07-31' }, // Extended range for post-war season
            },
            'la-liga': {
                '2020-21': { start: '2020-09-07', end: '2021-05-28' }, // Extended by 5 days each side
                '2019-20': { start: '2019-08-11', end: '2020-07-24' }, // Extended by 5 days each side
                '1929-30': { start: '1929-12-01', end: '1930-03-30' }, // Historical early La Liga season
                '1928-29': { start: '1929-02-02', end: '1929-06-30' }, // Historical early La Liga season
            },
        };

        // Generate seasons for all leagues
        function generateSeasons() {
            // Serie A seasons - comprehensive historical coverage
            seasons['serie-a']['1929-30'] = { start: '1929-10-06', end: '1930-08-06' };
            seasons['serie-a']['1930-31'] = { start: '1930-09-28', end: '1931-06-30' };
            seasons['serie-a']['1931-32'] = { start: '1931-09-05', end: '1932-06-16' };
            seasons['serie-a']['1932-33'] = { start: '1932-09-18', end: '1933-06-26' };
            seasons['serie-a']['1933-34'] = { start: '1933-09-10', end: '1934-05-30' };
            seasons['serie-a']['1934-35'] = { start: '1934-09-30', end: '1935-06-05' };
            seasons['serie-a']['1935-36'] = { start: '1935-09-22', end: '1936-05-17' };
            seasons['serie-a']['1936-37'] = { start: '1936-09-13', end: '1937-05-30' };
            seasons['serie-a']['1937-38'] = { start: '1937-09-12', end: '1938-05-30' };
            seasons['serie-a']['1938-39'] = { start: '1938-09-18', end: '1939-06-05' };
            seasons['serie-a']['1939-40'] = { start: '1939-09-17', end: '1940-06-05' };
            seasons['serie-a']['1940-41'] = { start: '1940-10-06', end: '1941-05-11' };
            seasons['serie-a']['1941-42'] = { start: '1941-10-26', end: '1942-06-30' };
            seasons['serie-a']['1942-43'] = { start: '1942-10-04', end: '1943-05-30' };
            seasons['serie-a']['1946-47'] = { start: '1946-09-22', end: '1947-07-10' };
            seasons['serie-a']['1947-48'] = { start: '1947-09-14', end: '1948-07-05' };
            seasons['serie-a']['1948-49'] = { start: '1948-09-19', end: '1949-06-15' };
            seasons['serie-a']['1949-50'] = { start: '1949-09-11', end: '1950-06-05' };
            
            // Generate standard seasons 1950-2018
            for (let year = 1950; year <= 2018; year++) {
                const seasonName = `${year}-${(year + 1).toString().slice(2)}`;
                seasons['serie-a'][seasonName] = {
                    start: `${year}-08-01`,
                    end: `${year + 1}-06-30`
                };
            }

            // Premier League and English First Division seasons
            for (let year = 1888; year <= 2025; year++) {
                if (year === 2019 || year === 2020) continue; // Skip COVID seasons
                
                // Skip WWI seasons: 1915-16, 1916-17, 1917-18, 1918-19
                if (year === 1915 || year === 1916 || year === 1917 || year === 1918) continue;
                
                // Skip WWII seasons: 1940-41, 1941-42, 1942-43, 1943-44, 1944-45, 1945-46
                if (year >= 1939 && year <= 1945) continue;
                
                const seasonName = `${year}-${(year + 1).toString().slice(2)}`;
                if (!seasons['premier-league']) seasons['premier-league'] = {};
                
                // Different start dates for different eras
                let startDate, endDate;
                if (year < 1992) {
                    // Special case for 1946-47 season
                    if (year === 1946) {
                        startDate = `${year}-08-01`;
                        endDate = `${year + 1}-06-30`;
                    } else {
                        // English First Division era - seasons typically started earlier
                        startDate = `${year}-08-01`;
                        endDate = `${year + 1}-05-31`;
                    }
                } else {
                    // Premier League era
                    startDate = `${year}-08-01`;
                    endDate = `${year + 1}-06-30`;
                }
                
                seasons['premier-league'][seasonName] = {
                    start: startDate,
                    end: endDate
                };
            }

            // Add other leagues
            ['bundesliga', 'la-liga', 'ligue-1'].forEach(league => {
                seasons[league] = seasons[league] || {};
                const startYear = league === 'bundesliga' ? 1963 : league === 'la-liga' ? 1928 : 1932;
                for (let year = startYear; year <= 2025; year++) {
                    if (league === 'la-liga' && year >= 1936 && year <= 1938) continue;
                    if (league === 'la-liga' && (year === 2019 || year === 2020)) continue; // Skip COVID seasons
                    if (league === 'ligue-1' && year >= 1939 && year <= 1944) continue;
                    const seasonName = `${year}-${(year + 1).toString().slice(2)}`;
                    
                    // Special cases for Ligue 1 seasons
                    let startDate, endDate;
                    if (league === 'ligue-1' && year === 1967) {
                        startDate = `${year}-07-01`;
                        endDate = `${year + 1}-07-06`;
                    } else if (league === 'ligue-1' && year === 1968) {
                        startDate = `${year}-07-15`;
                        endDate = `${year + 1}-06-30`;
                    } else {
                        startDate = `${year}-07-01`;
                        endDate = `${year + 1}-06-30`;
                    }
                    
                    seasons[league][seasonName] = {
                        start: startDate,
                        end: endDate
                    };
                }
            });
        }

        // Initialize seasons
        generateSeasons();

        // DOM elements
        const elements = {
            controlsSection: document.getElementById('controlsSection'),
            reloadGistsBtn: document.getElementById('reloadGistsBtn'),
            errorState: document.getElementById('errorState'),
            errorMessage: document.getElementById('errorMessage'),
            tableContainer: document.getElementById('tableContainer'),
            tableInfo: document.getElementById('tableInfo'),
            tableInfoText: document.getElementById('tableInfoText'),
            tableHeader: document.getElementById('tableHeader'),
            tableBody: document.getElementById('tableBody'),
            leagueButtons: document.getElementById('leagueButtons'),
            seasonSelect: document.getElementById('seasonSelect'),
            dateFrom: document.getElementById('dateFrom'),
            dateTo: document.getElementById('dateTo'),
            dayOfWeekSelect: document.getElementById('dayOfWeekSelect'),
            team1Select: document.getElementById('team1Select'),
            team2Select: document.getElementById('team2Select'),
            homeCheckbox: document.getElementById('homeCheckbox'),
            awayCheckbox: document.getElementById('awayCheckbox'),
            deductionsCheckbox: document.getElementById('deductionsCheckbox'),
            threePointCheckbox: document.getElementById('threePointCheckbox'),
            resetBtn: document.getElementById('resetBtn'),
            retryBtn: document.getElementById('retryBtn'),
            h2hSection: document.getElementById('h2hSection'),
            recentH2HSelect: document.getElementById('recentH2HSelect'),
            h2hMatchCount: document.getElementById('h2hMatchCount'),
            h2hVisualizations: document.getElementById('h2hVisualizations'),
            h2hMatchesTable: document.getElementById('h2hMatchesTable'),
            h2hTableTitle: document.getElementById('h2hTableTitle'),
            h2hTableHeader: document.getElementById('h2hTableHeader'),
            h2hTableBody: document.getElementById('h2hTableBody'),
            lastTimeLeagueButtons: document.getElementById('lastTimeLeagueButtons'),
            lastTimeDayOfWeekSelect: document.getElementById('lastTimeDayOfWeekSelect'),
            lastTimeLocationSelect: document.getElementById('lastTimeLocationSelect'),
            lastTimeTeam1Select: document.getElementById('lastTimeTeam1Select'),
            lastTimeTeam2Select: document.getElementById('lastTimeTeam2Select'),
            lastTimeResults: document.getElementById('lastTimeResults'),
            // Table sections
            team1HomeWinSection: document.getElementById('team1HomeWinSection'),
            team1AwayWinSection: document.getElementById('team1AwayWinSection'),
            team1HomeDrawSection: document.getElementById('team1HomeDrawSection'),
            team1AwayDrawSection: document.getElementById('team1AwayDrawSection'),
            team1HomeLossSection: document.getElementById('team1HomeLossSection'),
            team1AwayLossSection: document.getElementById('team1AwayLossSection'),
            // Table bodies
            team1HomeWinBody: document.getElementById('team1HomeWinBody'),
            team1AwayWinBody: document.getElementById('team1AwayWinBody'),
            team1HomeDrawBody: document.getElementById('team1HomeDrawBody'),
            team1AwayDrawBody: document.getElementById('team1AwayDrawBody'),
            team1HomeLossBody: document.getElementById('team1HomeLossBody'),
            team1AwayLossBody: document.getElementById('team1AwayLossBody'),
            // Day counters
            team1HomeWinDays: document.getElementById('team1HomeWinDays'),
            team1AwayWinDays: document.getElementById('team1AwayWinDays'),
            team1HomeDrawDays: document.getElementById('team1HomeDrawDays'),
            team1AwayDrawDays: document.getElementById('team1AwayDrawDays'),
            team1HomeLossDays: document.getElementById('team1HomeLossDays'),
            team1AwayLossDays: document.getElementById('team1AwayLossDays'),
            // Titles
            team1HomeWinTitle: document.getElementById('team1HomeWinTitle'),
            team1AwayWinTitle: document.getElementById('team1AwayWinTitle'),
            team1HomeDrawTitle: document.getElementById('team1HomeDrawTitle'),
            team1AwayDrawTitle: document.getElementById('team1AwayDrawTitle'),
            team1HomeLossTitle: document.getElementById('team1HomeLossTitle'),
            team1AwayLossTitle: document.getElementById('team1AwayLossTitle'),
            teamHistoryTable: document.getElementById('teamHistoryTable'),
            teamHistoryTitle: document.getElementById('teamHistoryTitle'),
            teamHistoryHeader: document.getElementById('teamHistoryHeader'),
            teamHistoryBody: document.getElementById('teamHistoryBody'),
            teamSeasonsLeagueButtons: document.getElementById('teamSeasonsLeagueButtons'),
            teamSeasonsTeamSelect: document.getElementById('teamSeasonsTeamSelect'),
            teamSeasonsSeasonContainer: document.getElementById('teamSeasonsSeasonContainer'),
            teamSeasonsSeasonSelect: document.getElementById('teamSeasonsSeasonSelect'),
            teamSeasonsPositionContainer: document.getElementById('teamSeasonsPositionContainer'),
            teamSeasonsPositionSelect: document.getElementById('teamSeasonsPositionSelect'),
            teamSeasonsPositionInfo: document.getElementById('teamSeasonsPositionInfo'),
            // Team Streaks elements
            teamStreaksLeagueButtons: document.getElementById('teamStreaksLeagueButtons'),
            teamStreaksStatusSelect: document.getElementById('teamStreaksStatusSelect'),
            teamStreaksLocationSelect: document.getElementById('teamStreaksLocationSelect'),
            teamStreaksTypeSelect: document.getElementById('teamStreaksTypeSelect'),
            teamStreaksTeam1Select: document.getElementById('teamStreaksTeam1Select'),
            teamStreaksTeam2Select: document.getElementById('teamStreaksTeam2Select'),
            teamStreaksResults: document.getElementById('teamStreaksResults')
        };

        // Create Team Streaks league buttons
        function createTeamStreaksLeagueButtons() {
            const leagues = [
                { id: 'premier-league', name: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League' },
                { id: 'la-liga', name: 'üá™üá∏ La Liga' },
                { id: 'serie-a', name: 'üáÆüáπ Serie A' },
                { id: 'bundesliga', name: 'üá©üá™ Bundesliga' },
                { id: 'ligue-1', name: 'üá´üá∑ Ligue 1' }
            ];

            const leagueButtonsHTML = leagues.map(league => `
                <label class="league-button ${state.selectedLeague === league.id ? 'active' : ''}" data-league="${league.id}">
                    <div class="radio-dot ${state.selectedLeague === league.id ? 'active' : ''}"></div>
                    <span class="text-sm font-medium ${state.selectedLeague === league.id ? 'text-green-700' : 'text-gray-700'}">
                        ${league.name}
                    </span>
                </label>
            `).join('');
            
            elements.teamStreaksLeagueButtons.innerHTML = leagueButtonsHTML;
        }

        // Update Team Streaks team dropdowns
        function updateTeamStreaksSelects() {
            const leagueTeams = getLeagueTeams(state.selectedLeague);
            
            const teamOptions = ['<option value="">Select Team</option>']
                .concat(leagueTeams.map(team => `<option value="${team}">${team}</option>`))
                .join('');
            
            elements.teamStreaksTeam1Select.innerHTML = teamOptions;
            elements.teamStreaksTeam2Select.innerHTML = '<option value="">Select Team 2 (Optional)</option>' + 
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');
        }

        // Handle Team Streaks league change
        async function handleTeamStreaksLeagueChange(newLeague) {
            state.selectedLeague = newLeague;
            
            // Load league data if not already loaded
            if (!state.loadedLeagues || !state.loadedLeagues.has(newLeague)) {
                await loadLeagueDataForDevice(newLeague);
            } else {
                // If already loaded, just filter/update UI
                filterDataForCurrentLeague(newLeague);
            }
            
            createTeamStreaksLeagueButtons();
            updateTeamStreaksSelects();
        }

        // Handle Team Streaks status change
        function handleTeamStreaksStatusChange(status) {
            calculateTeamStreaks();
        }
        // Handle Team Streaks location change
        function handleTeamStreaksLocationChange(location) {
            calculateTeamStreaks();
        }

        // Handle Team Streaks type change
        function handleTeamStreaksTypeChange(type) {
            calculateTeamStreaks();
        }

        // Handle Team Streaks Team 1 selection
        function handleTeamStreaksTeam1Change(team) {
            calculateTeamStreaks();
        }

        // Handle Team Streaks Team 2 selection  
        function handleTeamStreaksTeam2Change(team) {
            calculateTeamStreaks();
        }

        // Calculate and display team streaks
        function calculateTeamStreaks() {
            const team1 = elements.teamStreaksTeam1Select.value;
            const team2 = elements.teamStreaksTeam2Select.value;
            const status = elements.teamStreaksStatusSelect.value;
            const location = elements.teamStreaksLocationSelect.value;
            const streakType = elements.teamStreaksTypeSelect.value;
            
            if (!team1) {
                elements.teamStreaksResults.classList.add('hidden');
                return;
            }
            
            // Handle different status modes
            if (status === 'active') {
                calculateActiveStreaks(team1, team2, location, streakType);
            } else if (status === 'historic') {
                calculateHistoricStreaks(team1, team2, location, streakType);
            }
        }
        
        // Calculate active streaks (original logic)
        function calculateActiveStreaks(team1, team2, location, streakType) {

            // Get league mapping
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };

            // Filter matches by league
            let matches = state.data.filter(row => row.Div === leagueMapping[state.selectedLeague]);
            
            // Filter by teams
            if (team2) {
                // Two teams selected - head-to-head matches only
                matches = matches.filter(row => 
                    (row.HomeTeam === team1 && row.AwayTeam === team2) ||
                    (row.HomeTeam === team2 && row.AwayTeam === team1)
                );
            } else {
                // One team selected - matches against all opponents
                matches = matches.filter(row => 
                    row.HomeTeam === team1 || row.AwayTeam === team1
                );
            }

            // Filter by location
            if (location === 'home') {
                matches = matches.filter(row => row.HomeTeam === team1);
            } else if (location === 'away') {
                matches = matches.filter(row => row.AwayTeam === team1);
            }
            // 'both' requires no additional filtering

            // Sort matches by date (most recent first)
            matches.sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj));

            // Calculate streak based on type
            const streak = calculateStreak(matches, team1, streakType);
            
            // Display results
            displayStreakResults(streak, team1, team2, streakType, location);
        }
        
        // Calculate historic streaks - find all streaks of 3+ games throughout history
        function calculateHistoricStreaks(team1, team2, location, streakType) {
            // Check if data is loaded
            if (!state.data || state.data.length === 0) {
                elements.teamStreaksResults.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-600">Loading data...</p>
                    </div>
                `;
                elements.teamStreaksResults.classList.remove('hidden');
                return;
            }
            
            // Reset sort config when parameters change (except when called from sort handler)
            const currentParams = `${team1}-${team2}-${location}-${streakType}`;
            if (!state.lastHistoricStreaksParams || state.lastHistoricStreaksParams !== currentParams) {
                state.historicStreaksSortConfig = { key: null, direction: null };
                state.lastHistoricStreaksParams = currentParams;
            }
            
            // Get league mapping
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };

            // Filter matches by league
            let matches = state.data.filter(row => row.Div === leagueMapping[state.selectedLeague]);
            
            // Filter by teams
            if (team2) {
                // Two teams selected - head-to-head matches only
                matches = matches.filter(row => 
                    (row.HomeTeam === team1 && row.AwayTeam === team2) ||
                    (row.HomeTeam === team2 && row.AwayTeam === team1)
                );
            } else {
                // One team selected - matches against all opponents
                matches = matches.filter(row => 
                    row.HomeTeam === team1 || row.AwayTeam === team1
                );
            }

            // Filter by location
            if (location === 'home') {
                matches = matches.filter(row => row.HomeTeam === team1);
            } else if (location === 'away') {
                matches = matches.filter(row => row.AwayTeam === team1);
            }

            // Sort matches by date (oldest first for historic analysis)
            matches.sort((a, b) => new Date(a.dateObj) - new Date(b.dateObj));

            // Find all historic streaks
            const allStreaks = findAllHistoricStreaks(matches, team1, streakType);
            
            // Filter streaks to only include those with 3+ games
            const significantStreaks = allStreaks.filter(streak => streak.count >= 3);
            
            // Display results
            displayHistoricStreaksResults(significantStreaks, team1, team2, streakType, location);
        }
        
        // Find all historic streaks throughout the data
        function findAllHistoricStreaks(matches, team, streakType) {
            if (matches.length === 0) return [];
            
            const allStreaks = [];
            let currentStreak = [];
            
            for (const match of matches) {
                const isHome = match.HomeTeam === team;
                const teamScore = isHome ? parseInt(match.FTHG) || 0 : parseInt(match.FTAG) || 0;
                const opponentScore = isHome ? parseInt(match.FTAG) || 0 : parseInt(match.FTHG) || 0;
                
                let result;
                if (teamScore > opponentScore) {
                    result = 'win';
                } else if (teamScore === opponentScore) {
                    result = 'draw';
                } else {
                    result = 'loss';
                }

                // Check if this match continues the current streak
                const continuesStreak = checkStreakContinuation(result, streakType);
                
                if (continuesStreak) {
                    currentStreak.push({
                        ...match,
                        result: result,
                        teamScore: teamScore,
                        opponentScore: opponentScore,
                        isHome: isHome
                    });
                } else {
                    // Current streak ends, save it if it exists
                    if (currentStreak.length > 0) {
                        const startDate = currentStreak[0].dateObj;
                        const endDate = currentStreak[currentStreak.length - 1].dateObj;
                        const lengthInDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                        
                        allStreaks.push({
                            matches: [...currentStreak],
                            count: currentStreak.length,
                            startDate: startDate,
                            endDate: endDate,
                            lengthInDays: lengthInDays,
                            streakType: streakType
                        });
                    }
                    
                    // Reset current streak since this match doesn't continue it
                    currentStreak = [];
                }
            }
            
            // Don't forget the last streak if it exists
            if (currentStreak.length > 0) {
                const startDate = currentStreak[0].dateObj;
                const endDate = currentStreak[currentStreak.length - 1].dateObj;
                const lengthInDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                
                allStreaks.push({
                    matches: [...currentStreak],
                    count: currentStreak.length,
                    startDate: startDate,
                    endDate: endDate,
                    lengthInDays: lengthInDays,
                    streakType: streakType
                });
            }
            
            return allStreaks;
        }
        
        // Get sort icon for historic streaks columns
        function getSortIcon(columnKey) {
            if (state.historicStreaksSortConfig.key !== columnKey) {
                return ' ‚ÜïÔ∏è'; // Up-down arrows when not sorted (sortable indicator)
            }
            
            switch (state.historicStreaksSortConfig.direction) {
                case 'desc': return ' ‚Üì';
                case 'asc': return ' ‚Üë';
                default: return ' ‚ÜïÔ∏è';
            }
        }
        
        // Handle historic streaks table sorting
        function handleHistoricStreaksSort(columnKey) {
            // Determine next sort direction (tri-state: desc ‚Üí asc ‚Üí reset)
            let nextDirection;
            if (state.historicStreaksSortConfig.key !== columnKey || state.historicStreaksSortConfig.direction === null) {
                nextDirection = 'desc'; // First click: descending (largest/most recent first)
            } else if (state.historicStreaksSortConfig.direction === 'desc') {
                nextDirection = 'asc';  // Second click: ascending (smallest/oldest first)
            } else {
                nextDirection = null;   // Third click: reset to original order
            }
            
            // Update sort config
            state.historicStreaksSortConfig.key = nextDirection ? columnKey : null;
            state.historicStreaksSortConfig.direction = nextDirection;
            
            // Re-trigger the calculation to refresh the display with new sorting
            calculateTeamStreaks();
        }
        
        // Display historic streaks results in table format
        function displayHistoricStreaksResults(streaks, team1, team2, streakType, location) {
            if (streaks.length === 0) {
                elements.teamStreaksResults.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-600">No historic ${streakType.replace('-', ' ')} streaks of 3+ games found for the selected criteria.</p>
                    </div>
                `;
                elements.teamStreaksResults.classList.remove('hidden');
                return;
            }

            // Apply custom sorting if requested, otherwise use default sorting
            if (state.historicStreaksSortConfig.key && state.historicStreaksSortConfig.direction) {
                const sortKey = state.historicStreaksSortConfig.key;
                const sortDirection = state.historicStreaksSortConfig.direction;
                
                streaks.sort((a, b) => {
                    let aVal = a[sortKey];
                    let bVal = b[sortKey];
                    
                    // Handle date sorting
                    if (sortKey === 'startDate' || sortKey === 'endDate') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    // Sort based on direction
                    if (sortDirection === 'desc') {
                        return bVal > aVal ? 1 : bVal < aVal ? -1 : 0;
                    } else {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    }
                });
            } else {
                // Default sorting: by count (longest first), then by end date (most recent first)
                streaks.sort((a, b) => {
                    if (b.count !== a.count) return b.count - a.count;
                    return new Date(b.endDate) - new Date(a.endDate);
                });
            }

            // Create title
            const streakName = getStreakDisplayName(streakType);
            const locationText = location === 'both' ? '' : ` (${location.charAt(0).toUpperCase() + location.slice(1)})`;
            const team1Color = getTeamColor(team1, state.selectedLeague);
            const team2Color = team2 ? getTeamColor(team2, state.selectedLeague) : null;
            
            let title;
            if (team2) {
                title = `Historic ${streakName}s${locationText}: <span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span> vs <span style="color: ${team2Color || '#374151'}; font-weight: bold;">${team2}</span>`;
            } else {
                title = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>'s Historic ${streakName}s${locationText}`;
            }

            // Create table headers based on mode (single team vs head-to-head)
            let tableHeaders;
            if (team2) {
                // Head-to-head mode
                tableHeaders = `
                    <th class="text-center">Team 1</th>
                    <th class="text-center">Team 2</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('startDate')">Start Date ${getSortIcon('startDate')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('endDate')">End Date ${getSortIcon('endDate')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('count')">Count ${getSortIcon('count')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('lengthInDays')">Length (Days) ${getSortIcon('lengthInDays')}</th>
                `;
            } else {
                // Single team mode - adjust header based on location
                let teamColumnHeader;
                if (location === 'home') {
                    teamColumnHeader = 'Home Team';
                } else if (location === 'away') {
                    teamColumnHeader = 'Away Team';
                } else {
                    teamColumnHeader = 'Team';
                }
                
                tableHeaders = `
                    <th class="text-center">${teamColumnHeader}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('startDate')">Start Date ${getSortIcon('startDate')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('endDate')">End Date ${getSortIcon('endDate')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('count')">Count ${getSortIcon('count')}</th>
                    <th class="text-center cursor-pointer" onclick="handleHistoricStreaksSort('lengthInDays')">Length (Days) ${getSortIcon('lengthInDays')}</th>
                `;
            }

            // Create table rows
            const tableRows = streaks.map(streak => {
                const startDateStr = streak.startDate.toLocaleDateString('en-US');
                const endDateStr = streak.endDate.toLocaleDateString('en-US');
                
                if (team2) {
                    // Head-to-head mode
                    const team1Logo = getTeamLogoUrl(team1, state.selectedLeague);
                    const team2Logo = getTeamLogoUrl(team2, state.selectedLeague);
                    
                    return `
                        <tr>
                            <td class="text-center">
                                <div class="flex items-center justify-center">
                                    ${team1Logo ? `<img src="${team1Logo}" alt="${team1}" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                    <span class="team1-highlight" style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="flex items-center justify-center">
                                    ${team2Logo ? `<img src="${team2Logo}" alt="${team2}" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                    <span class="team2-highlight" style="color: ${team2Color || '#374151'}; font-weight: bold;">${team2}</span>
                                </div>
                            </td>
                            <td class="text-center">${startDateStr}</td>
                            <td class="text-center">${endDateStr}</td>
                            <td class="text-center font-bold">${streak.count}</td>
                            <td class="text-center">${streak.lengthInDays}</td>
                        </tr>
                    `;
                } else {
                    // Single team mode - show team name with logo
                    const teamName = team1;
                    const teamLogo = getTeamLogoUrl(teamName, state.selectedLeague);
                    const teamColor = getTeamColor(teamName, state.selectedLeague);
                    
                    return `
                        <tr>
                            <td class="text-center">
                                <div class="flex items-center justify-center">
                                    ${teamLogo ? `<img src="${teamLogo}" alt="${teamName}" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                    <span class="team1-highlight" style="color: ${teamColor || '#374151'}; font-weight: bold;">${teamName}</span>
                                </div>
                            </td>
                            <td class="text-center">${startDateStr}</td>
                            <td class="text-center">${endDateStr}</td>
                            <td class="text-center font-bold">${streak.count}</td>
                            <td class="text-center">${streak.lengthInDays}</td>
                        </tr>
                    `;
                }
            }).join('');

            const tableHTML = `
                <div class="league-table">
                    <div class="text-center py-4 bg-white border-b">
                        <h2 class="text-xl font-semibold text-gray-700 mb-1">${title}</h2>
                        <p class="text-sm text-gray-600">${streaks.length} streak${streaks.length === 1 ? '' : 's'} of 3+ games found</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                ${tableHeaders}
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;

            elements.teamStreaksResults.innerHTML = tableHTML;
            elements.teamStreaksResults.classList.remove('hidden');
        }

        // Calculate streak based on type and team
        function calculateStreak(matches, team, streakType) {
            if (matches.length === 0) return [];

            const streak = [];
            
            for (const match of matches) {
                const isHome = match.HomeTeam === team;
                const teamScore = isHome ? parseInt(match.FTHG) || 0 : parseInt(match.FTAG) || 0;
                const opponentScore = isHome ? parseInt(match.FTAG) || 0 : parseInt(match.FTHG) || 0;
                
                let result;
                if (teamScore > opponentScore) {
                    result = 'win';
                } else if (teamScore === opponentScore) {
                    result = 'draw';
                } else {
                    result = 'loss';
                }

                // Check if this match continues the streak
                const continuesStreak = checkStreakContinuation(result, streakType);
                
                if (continuesStreak) {
                    streak.push({
                        ...match,
                        result: result,
                        teamScore: teamScore,
                        opponentScore: opponentScore,
                        isHome: isHome
                    });
                } else {
                    // Streak ends here
                    break;
                }
            }

            return streak;
        }

        // Check if a result continues the current streak type
        function checkStreakContinuation(result, streakType) {
            switch (streakType) {
                case 'winning':
                    return result === 'win';
                case 'unbeaten':
                    return result === 'win' || result === 'draw';
                case 'draw':
                    return result === 'draw';
                case 'winless':
                    return result === 'draw' || result === 'loss';
                case 'losing':
                    return result === 'loss';
                default:
                    return false;
            }
        }

        // Display streak results in table format
        function displayStreakResults(streak, team1, team2, streakType, location) {
            if (streak.length === 0) {
                elements.teamStreaksResults.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-600">No current ${streakType.replace('-', ' ')} streak found for the selected criteria.</p>
                    </div>
                `;
                elements.teamStreaksResults.classList.remove('hidden');
                return;
            }

            // Find the opposite result match
            const oppositeMatch = findOppositeResultMatch(team1, team2, streakType, location);

            // Create title with team colors
            const streakLength = streak.length;
            const streakName = getStreakDisplayName(streakType);
            const locationText = location === 'both' ? '' : ` (${location.charAt(0).toUpperCase() + location.slice(1)})`;
            
            // Get team colors
            const team1Color = getTeamColor(team1, state.selectedLeague);
            const team2Color = team2 ? getTeamColor(team2, state.selectedLeague) : null;
            
            let title;
            if (team2) {
                // Two-team mode: Both teams with their colors
                title = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>'s Current ${streakName}${locationText} vs <span style="color: ${team2Color || '#374151'}; font-weight: bold;">${team2}</span>: ${streakLength} ${streakLength === 1 ? 'match' : 'matches'}`;
            } else {
                // Single-team mode: Just Team 1 with color
                title = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>'s Current ${streakName}${locationText}: ${streakLength} ${streakLength === 1 ? 'match' : 'matches'}`;
            }

            // Calculate days since streak started (oldest match in streak)
            const streakStartDate = streak[streak.length - 1].dateObj;
            const daysSinceStreakStart = Math.floor((new Date() - streakStartDate) / (1000 * 60 * 60 * 24));

            // Create main streak table
            let tableHTML = `
                <div class="league-table mb-4">
                    <div class="text-center py-4 bg-white border-b">
                        <h2 class="text-xl font-semibold text-gray-700 mb-1">${title}</h2>
                        <p class="text-sm text-gray-600">Most recent matches first</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th class="text-center cursor-pointer">Date</th>
                                <th class="text-center cursor-pointer">Home Team</th>
                                <th class="text-center cursor-pointer">Home Score</th>
                                <th class="text-center cursor-pointer">Away Team</th>
                                <th class="text-center cursor-pointer">Away Score</th>
                                <th class="text-center cursor-pointer">Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${streak.map(match => createStreakTableRow(match, team1)).join('')}
                        </tbody>
                    </table>
                </div>
                <p class="text-center text-sm text-gray-600 mb-8">This streak started: ${daysSinceStreakStart} days ago</p>
            `;

            // Add opposite result table if found
            if (oppositeMatch) {
                const oppositeResultName = getOppositeResultDisplayName(streakType);
                
                // Create opposite title with team colors
                let oppositeTitle;
                if (team2) {
                    // Two-team mode: Both teams with their colors
                    oppositeTitle = `Last ${oppositeResultName} Result${locationText} (<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span> vs <span style="color: ${team2Color || '#374151'}; font-weight: bold;">${team2}</span>)`;
                } else {
                    // Single-team mode: Just Team 1 with color
                    oppositeTitle = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1}</span>'s Last ${oppositeResultName} Result${locationText}`;
                }
                
                // Calculate days since opposite result
                const daysSinceOpposite = Math.floor((new Date() - oppositeMatch.dateObj) / (1000 * 60 * 60 * 24));

                tableHTML += `
                    <div class="league-table mb-4">
                        <div class="text-center py-4 bg-white border-b">
                            <h2 class="text-xl font-semibold text-gray-700 mb-1">${oppositeTitle}</h2>
                            <p class="text-sm text-gray-600">The match that ended the previous streak</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th class="text-center cursor-pointer">Date</th>
                                    <th class="text-center cursor-pointer">Home Team</th>
                                    <th class="text-center cursor-pointer">Home Score</th>
                                    <th class="text-center cursor-pointer">Away Team</th>
                                    <th class="text-center cursor-pointer">Away Score</th>
                                    <th class="text-center cursor-pointer">Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${createStreakTableRow(oppositeMatch, team1)}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-center text-sm text-gray-600">The last time the opposite happened was: ${daysSinceOpposite} days ago</p>
                `;
            } else {
                tableHTML += `<p class="text-center text-sm text-gray-600">No previous opposite result found in available data</p>`;
            }

            elements.teamStreaksResults.innerHTML = tableHTML;
            elements.teamStreaksResults.classList.remove('hidden');
        }

        // Find the match where the opposite result occurred
        function findOppositeResultMatch(team1, team2, streakType, location) {
            // Get league mapping
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };

            // Filter matches by league
            let matches = state.data.filter(row => row.Div === leagueMapping[state.selectedLeague]);
            
            // Filter by teams
            if (team2) {
                matches = matches.filter(row => 
                    (row.HomeTeam === team1 && row.AwayTeam === team2) ||
                    (row.HomeTeam === team2 && row.AwayTeam === team1)
                );
            } else {
                matches = matches.filter(row => 
                    row.HomeTeam === team1 || row.AwayTeam === team1
                );
            }

            // Filter by location
            if (location === 'home') {
                matches = matches.filter(row => row.HomeTeam === team1);
            } else if (location === 'away') {
                matches = matches.filter(row => row.AwayTeam === team1);
            }

            // Sort matches by date (most recent first)
            matches.sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj));

            // Find the first match that doesn't continue the current streak
            for (const match of matches) {
                const isHome = match.HomeTeam === team1;
                const teamScore = isHome ? parseInt(match.FTHG) || 0 : parseInt(match.FTAG) || 0;
                const opponentScore = isHome ? parseInt(match.FTAG) || 0 : parseInt(match.FTHG) || 0;
                
                let result;
                if (teamScore > opponentScore) {
                    result = 'win';
                } else if (teamScore === opponentScore) {
                    result = 'draw';
                } else {
                    result = 'loss';
                }

                // Check if this is an opposite result
                const isOppositeResult = checkOppositeResult(result, streakType);
                
                if (isOppositeResult) {
                    return match;
                }
            }

            return null;
        }

        // Check if a result is opposite to the current streak type
        function checkOppositeResult(result, streakType) {
            switch (streakType) {
                case 'winning':
                    return result === 'draw' || result === 'loss'; // Non-win
                case 'unbeaten':
                    return result === 'loss'; // Loss
                case 'draw':
                    return result === 'win' || result === 'loss'; // Non-draw
                case 'winless':
                    return result === 'win'; // Win
                case 'losing':
                    return result === 'draw' || result === 'win'; // Non-loss
                default:
                    return false;
            }
        }

        // Get display name for opposite result
        function getOppositeResultDisplayName(streakType) {
            switch (streakType) {
                case 'winning': return 'Non-Win (Draw/Loss)';
                case 'unbeaten': return 'Loss';
                case 'draw': return 'Non-Draw (Win/Loss)';
                case 'winless': return 'Win';
                case 'losing': return 'Non-Loss (Draw/Win)';
                default: return 'Opposite';
            }
        }

        // Get display name for streak type
        function getStreakDisplayName(streakType) {
            switch (streakType) {
                case 'winning': return 'Winning Streak';
                case 'unbeaten': return 'Unbeaten Streak';
                case 'draw': return 'Draw Streak';
                case 'winless': return 'Winless Streak';
                case 'losing': return 'Losing Streak';
                default: return 'Streak';
            }
        }

        // Create table row for streak display (similar to Head-to-Head format)
        function createStreakTableRow(match, focusTeam) {
            const homeScore = parseInt(match.FTHG) || 0;
            const awayScore = parseInt(match.FTAG) || 0;
            
            // Get team colors and logos
            const homeTeamColor = getTeamColor(match.HomeTeam, state.selectedLeague);
            const awayTeamColor = getTeamColor(match.AwayTeam, state.selectedLeague);
            const homeLogoUrl = getTeamLogoUrl(match.HomeTeam, state.selectedLeague);
            const awayLogoUrl = getTeamLogoUrl(match.AwayTeam, state.selectedLeague);
            
            // Determine winner and highlighting
            let homeScoreClass = '';
            let awayScoreClass = '';
            let resultStyle = '';
            let winnerTeam = '';
            
            if (homeScore > awayScore) {
                winnerTeam = match.HomeTeam;
                homeScoreClass = 'font-bold';
                awayScoreClass = 'text-red-600 font-bold';
                resultStyle = homeTeamColor ? 
                    `color: ${homeTeamColor} !important; font-weight: bold;` : 
                    'color: #059669 !important; font-weight: bold;';
            } else if (awayScore > homeScore) {
                winnerTeam = match.AwayTeam;
                homeScoreClass = 'text-red-600 font-bold';
                awayScoreClass = 'font-bold';
                resultStyle = awayTeamColor ? 
                    `color: ${awayTeamColor} !important; font-weight: bold;` : 
                    'color: #059669 !important; font-weight: bold;';
            } else {
                winnerTeam = 'Draw';
                homeScoreClass = 'text-gray-400 font-bold';
                awayScoreClass = 'text-gray-400 font-bold';
                resultStyle = 'color: #9ca3af !important; font-weight: bold;';
            }

            // Get selected teams for highlighting
            const team1 = elements.teamStreaksTeam1Select.value;
            const team2 = elements.teamStreaksTeam2Select.value;

            // Team highlighting based on selected teams (same as Head-to-Head)
            const isHomeTeam1 = match.HomeTeam === team1;
            const isHomeTeam2 = team2 && match.HomeTeam === team2;
            const isAwayTeam1 = match.AwayTeam === team1;
            const isAwayTeam2 = team2 && match.AwayTeam === team2;
            
            const homeTeamClass = isHomeTeam1 ? 'team1-highlight' : 
                                isHomeTeam2 ? 'team2-highlight' : '';
            const awayTeamClass = isAwayTeam1 ? 'team1-highlight' : 
                                isAwayTeam2 ? 'team2-highlight' : '';
            
            // Winner logo for result column
            const winnerLogoUrl = winnerTeam !== 'Draw' ? getTeamLogoUrl(winnerTeam, state.selectedLeague) : null;
            
            // Result highlighting for winner (if it's one of the selected teams)
            let resultClass = '';
            if (winnerTeam !== 'Draw') {
                if (winnerTeam === team1) {
                    resultClass = 'team1-highlight';
                } else if (team2 && winnerTeam === team2) {
                    resultClass = 'team2-highlight';
                }
            }
            
            // Team styling
            const homeTeamStyle = homeTeamColor ? `color: ${homeTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
            const awayTeamStyle = awayTeamColor ? `color: ${awayTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
            
            return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="text-center text-sm">${match.dateObj.toLocaleDateString()}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${homeLogoUrl ? `<img src="${homeLogoUrl}" alt="${match.HomeTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${homeTeamClass}" style="${homeTeamStyle}">${match.HomeTeam}</span>
                        </div>
                    </td>
                    <td class="text-center text-lg ${homeScoreClass}" ${homeScoreClass === 'font-bold' ? 'style="color: #047857;"' : ''}>${homeScore}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${awayLogoUrl ? `<img src="${awayLogoUrl}" alt="${match.AwayTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${awayTeamClass}" style="${awayTeamStyle}">${match.AwayTeam}</span>
                        </div>
                    </td>
                    <td class="text-center text-lg ${awayScoreClass}" ${awayScoreClass === 'font-bold' ? 'style="color: #047857;"' : ''}>${awayScore}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${winnerLogoUrl ? `<img src="${winnerLogoUrl}" alt="${winnerTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${resultClass}" style="${resultStyle}">${winnerTeam}</span>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Initialize the application
        function init() {
            setupEventListeners();
            createLeagueButtons();
            createTeamSeasonsLeagueButtons();
            populateRecentH2HOptions();
            updateUI();
            // Auto-load data on page load
            loadGistData();
        }

        // Decode base64 encoded URL with backward compatibility for double encoding
        function decodeSingleBase64Url(encodedUrl) {
            try {
                // Validate input
                if (!encodedUrl || typeof encodedUrl !== 'string') {
                    console.warn('Invalid encoded URL provided');
                    return null;
                }
                
                // Clean the input
                const cleanedInput = encodedUrl.trim().replace(/\s/g, '');
                
                // Try single decode first
                let decoded;
                try {
                    decoded = atob(cleanedInput);
                } catch (atobError) {
                    console.error('Base64 decode failed:', atobError.message);
                    return null;
                }
                
                // Check if the result is a valid URL (single encoding)
                if (decoded && decoded.startsWith('https://gist.githubusercontent.com')) {
                    // Successfully decoded single base64 URL
                    return decoded;
                }
                
                // If not a valid URL, try double decode (backward compatibility)
                try {
                    const doubleDecoded = atob(decoded);
                    if (doubleDecoded && doubleDecoded.startsWith('https://gist.githubusercontent.com')) {
                        // Successfully decoded double base64 URL
                        return doubleDecoded;
                    }
                } catch (error) {
                    // Ignore double decode errors
                }
                
                console.warn('Could not decode URL as single or double base64:', encodedUrl.substring(0, 50) + '...');
                return null;
                
            } catch (error) {
                console.error('Error in decodeSingleBase64Url:', error);
                console.error('Stack trace:', error.stack);
                return null;
            }
        }

        // Mobile device detection
        function isMobileDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const screenWidth = window.innerWidth;
            
            // Check for explicit mobile indicators (excluding just 'chrome' to avoid false positives)
            const mobileKeywords = ['android', 'iphone', 'ipad', 'ipod', 'tablet', 'phone', 'mobile'];
            const hasMobileUA = mobileKeywords.some(keyword => userAgent.includes(keyword));
            
            // Check for small screen size (less than 768px typically indicates mobile/tablet)
            const hasSmallScreen = screenWidth < 768;
            
            // Touch device detection (more accurate for mobile)
            const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            // Only consider mobile if we have explicit mobile UA AND (small screen OR touch)
            return hasMobileUA && (hasSmallScreen || hasTouchScreen);
        }
        
        // Load data from GitHub Gists - now uses league-specific loading for all devices
        async function loadGistData() {
            // Using league-specific loading for optimal performance
            await loadLeagueDataForDevice(state.selectedLeague);
        }
        
        // Universal league-specific loading for all devices
        async function loadLeagueDataForDevice(leagueId) {
            // Loading data for league
            
            // Check if already loaded
            if (state.loadedLeagues && state.loadedLeagues.has(leagueId)) {
                // League already loaded, filtering existing data
                filterDataForCurrentLeague(leagueId);
                return;
            }
            
            // Initialize loadedLeagues if not exists
            if (!state.loadedLeagues) {
                state.loadedLeagues = new Set();
            }
            
            // Initialize allLeagueData to store all data if not exists
            if (!state.allLeagueData) {
                state.allLeagueData = [];
            }
            
            // Prevent double loading
            if (state.currentlyLoadingLeague === leagueId) {
                // League already loading, please wait
                return;
            }
            
            state.currentlyLoadingLeague = leagueId;
            state.error = '';
            
            // Show loading indicator
            const leagueName = getLeagueName(leagueId);
            state.error = `‚öΩ Loading ${leagueName} data...`;
            updateUI();
            
            try {
                // Load ALL gist URLs since each contains data for all leagues
                const gistUrls = GIST_URLS;
                
                // Fetching files (contains all leagues)
                const allData = [];
                
                for (let i = 0; i < gistUrls.length; i++) {
                    const encodedUrl = gistUrls[i];
                    
                    try {
                        const url = decodeSingleBase64Url(encodedUrl);
                        if (!url) {
                            console.warn(`Skipping invalid URL at index ${i}`);
                            continue;
                        }
                        
                        // Check for obviously malformed URLs
                        if (!url.startsWith('http')) {
                            console.warn(`Skipping malformed URL at index ${i}: ${url.substring(0, 50)}...`);
                            continue;
                        }
                        
                        // Fetching URL
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000);
                        
                        const response = await fetch(url, { 
                            signal: controller.signal,
                            headers: { 'Accept': 'text/csv,text/plain,*/*' }
                        });
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const text = await response.text();
                        if (!text || text.length === 0) {
                            throw new Error('Empty response from server');
                        }
                        
                        const parsed = Papa.parse(text, { 
                            header: true, 
                            dynamicTyping: false,
                            skipEmptyLines: true,
                            transformHeader: (header) => header.trim().replace(/\r/g, ''),
                            transform: (value) => typeof value === 'string' ? value.trim().replace(/\r/g, '') : value
                        });
                        
                        if (parsed.errors && parsed.errors.length > 0) {
                            console.warn('CSV parsing errors:', parsed.errors);
                        }
                        
                        if (parsed.data && parsed.data.length > 0) {
                            // Successfully parsed rows
                            allData.push(...parsed.data);
                        }
                        
                        // Update progress
                        const progress = Math.round(((i + 1) / gistUrls.length) * 100);
                        state.error = `‚öΩ Loading data... ${progress}%`;
                        updateUI();
                        
                        // Small delay to keep UI responsive
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                    } catch (fileError) {
                        console.warn(`Failed to load file ${i}:`, fileError.message);
                    }
                }
                
                // Process all the raw data
                // Processing all league data
                const cleanedData = processRawData(allData);
                
                if (cleanedData.length === 0) {
                    throw new Error(`No valid match data found`);
                }
                
                // Store all data for future league switches
                state.allLeagueData = cleanedData;
                
                // Mark all leagues as loaded since we loaded everything
                state.loadedLeagues.add('serie-a');
                state.loadedLeagues.add('premier-league');
                state.loadedLeagues.add('la-liga');
                state.loadedLeagues.add('bundesliga');
                state.loadedLeagues.add('ligue-1');
                
                state.currentlyLoadingLeague = null;
                state.error = '';
                
                // Filter data for the requested league
                filterDataForCurrentLeague(leagueId);
                
                // All data loaded successfully
                
            } catch (error) {
                console.error(`Error loading data:`, error);
                state.error = `Failed to load data: ${error.message}`;
                state.currentlyLoadingLeague = null;
                updateUI();
            }
        }
        
        // Get human-readable league name
        function getLeagueName(leagueId) {
            const leagueMap = {
                'serie-a': 'Serie A',
                'premier-league': 'Premier League',
                'la-liga': 'La Liga',
                'bundesliga': 'Bundesliga',
                'ligue-1': 'Ligue 1'
            };
            return leagueMap[leagueId] || leagueId;
        }
        
        // Filter existing data for current league (when switching between loaded leagues)
        function filterDataForCurrentLeague(leagueId) {
            if (!state.allLeagueData || state.allLeagueData.length === 0) return;
            
            const leagueCode = LEAGUE_CODES[leagueId];
            if (!leagueCode) {
                console.warn(`Unknown league ID: ${leagueId}`);
                return;
            }
            
            // Filter data for the specific league
            const filteredData = state.allLeagueData.filter(row => row.Div === leagueCode);
            
            // Filtered matches for league
            
            // Update state with filtered data
            state.data = filteredData;
            
            // Update teams list for this league
            const allTeams = [...new Set([
                ...filteredData.map(row => row.HomeTeam),
                ...filteredData.map(row => row.AwayTeam)
            ])].filter(team => team && team.length > 1).sort();
            
            state.teams = allTeams;
            
            // Update date range for this league
            if (filteredData.length > 0) {
                const dates = filteredData.map(row => row.dateObj);
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                state.dateFrom = minDate.toISOString().split('T')[0];
                state.dateTo = maxDate.toISOString().split('T')[0];
            }
            
            // Update the UI with filtered data
            updateUI();
            updateTeamSelects();
            updateTeamSeasonsTeamSelect();
            updateSeasonOptions();
            updateTable();
        }
        
        // Chunked loading for desktop browsers (prevents stack overflow)
        async function loadGistDataChunked() {
            const gistUrls = GIST_URLS;
            
            state.error = '';
            // Starting chunked data load

            try {
                const allData = [];
                let loadedGists = 0;
                
                // Process files in smaller batches to prevent stack overflow
                const batchSize = 5; // Process 5 files at a time
                
                for (let batchStart = 0; batchStart < gistUrls.length; batchStart += batchSize) {
                    const batchEnd = Math.min(batchStart + batchSize, gistUrls.length);
                    // Processing batch
                    
                    // Process batch of files
                    for (let i = batchStart; i < batchEnd; i++) {
                    const encodedUrl = gistUrls[i];
                    // Processing URL
                    
                    const url = decodeSingleBase64Url(encodedUrl);
                    
                    // Skip if URL decoding failed
                    if (!url) {
                        console.warn(`Skipping invalid URL at index ${i}`);
                        continue;
                    }
                    
                    try {
                        // Fetching URL
                        
                        // Add timeout to fetch
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                        
                        const response = await fetch(url, { 
                            signal: controller.signal,
                            headers: {
                                'Accept': 'text/csv,text/plain,*/*'
                            }
                        });
                        clearTimeout(timeoutId);
                        if (!response.ok) {
                            if (response.status === 404) {
                                console.warn(`File not found (404) at index ${i}, skipping: ${url.substring(url.lastIndexOf('/') + 1)}`);
                                continue;
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const text = await response.text();
                        // Received CSV data
                        
                        if (!text || text.length === 0) {
                            throw new Error('Empty response from server');
                        }
                        
                        const parsed = Papa.parse(text, { 
                            header: true, 
                            dynamicTyping: false,
                            skipEmptyLines: true,
                            transformHeader: (header) => header.trim().replace(/\r/g, ''),
                            transform: (value) => typeof value === 'string' ? value.trim().replace(/\r/g, '') : value
                        });
                        
                        if (parsed.errors && parsed.errors.length > 0) {
                            console.warn('CSV parsing errors:', parsed.errors);
                        }
                        
                        if (parsed.data && parsed.data.length > 0) {
                            // Successfully parsed rows from file
                            
                            // Always use chunked processing for desktop stability
                            if (parsed.data.length > 500) {
                                // Process in chunks for all browsers
                                const chunkSize = 300;
                                for (let i = 0; i < parsed.data.length; i += chunkSize) {
                                    const chunk = parsed.data.slice(i, i + chunkSize);
                                    allData.push(...chunk);
                                    
                                    // Small delay to prevent stack overflow
                                    if (i + chunkSize < parsed.data.length) {
                                        await new Promise(resolve => setTimeout(resolve, 25));
                                    }
                                }
                            } else {
                                allData.push(...parsed.data);
                            }
                            loadedGists++;
                        } else {
                            console.warn('No data found in parsed CSV');
                        }
                    } catch (gistError) {
                        console.warn(`Failed to load ${url}:`, gistError.message);
                    }
                    
                    // Small delay between files within batch
                    if (i < batchEnd - 1) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                    }
                    
                    // Delay between batches to prevent stack overflow  
                    if (batchEnd < gistUrls.length) {
                        const progress = Math.round((batchEnd / gistUrls.length) * 100);
                        state.error = `üîÑ Loading data... ${progress}% complete (${loadedGists} files processed)`;
                        updateUI();
                        // Batch complete
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                if (loadedGists === 0) {
                    throw new Error('No valid data could be loaded from any Gist');
                }
                
                // Clear loading message and show processing status
                state.error = '‚öôÔ∏è Processing data...';
                updateUI();
                
                // Process the data
                // Starting data processing
                const cleanedData = processRawData(allData);
                // Data processing completed
                
                if (cleanedData.length === 0) {
                    throw new Error('No valid match data found in the loaded Gists');
                }
                
                const allTeams = [...new Set([
                    ...cleanedData.map(row => row.HomeTeam), 
                    ...cleanedData.map(row => row.AwayTeam)
                ])]
                    .filter(team => team && team.length > 1)
                    .sort();
                
                const dates = cleanedData.map(row => row.dateObj);
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                state.data = cleanedData;
                state.teams = allTeams;
                state.dateFrom = minDate.toISOString().split('T')[0];
                state.dateTo = maxDate.toISOString().split('T')[0];
                state.error = ''; // Clear loading message
                
                // Data loaded successfully
                updateUI();
                updateTeamSelects();
                updateTeamSeasonsTeamSelect();
                updateSeasonOptions();
                updateTable();
                
            } catch (error) {
                console.error('Error loading Gist data:', error);
                state.error = error.message;
            } finally {
                updateUI();
            }
        }

        // Process raw CSV data
        function processRawData(allData) {
            return allData
                .filter(row => {
                    return row && 
                           row.HomeTeam && 
                           row.AwayTeam && 
                           row.Date &&
                           row.Div &&
                           typeof row.HomeTeam === 'string' &&
                           typeof row.AwayTeam === 'string' &&
                           row.HomeTeam.length > 0 &&
                           row.AwayTeam.length > 0 &&
                           row.Div.length > 0;
                })
                .map(row => {
                    try {
                        let dateStr = String(row.Date).trim().replace(/\r/g, '');
                        let dateObj;
                        
                        if (dateStr.includes('/')) {
                            const parts = dateStr.split('/');
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]);
                                let year = parseInt(parts[2]);
                                
                                if (year < 100) {
                                    year = year <= 30 ? 2000 + year : 1900 + year;
                                }
                                
                                dateObj = new Date(year, month - 1, day);
                            }
                        } else if (dateStr.includes('-')) {
                            dateObj = new Date(dateStr);
                        }
                        
                        if (!dateObj || isNaN(dateObj.getTime())) {
                            return null;
                        }
                        
                        dateObj.setHours(0, 0, 0, 0);
                        
                        let homeGoals = 0;
                        let awayGoals = 0;
                        
                        if (row.FTHG !== undefined && row.FTHG !== null && row.FTHG !== '') {
                            homeGoals = parseInt(String(row.FTHG)) || 0;
                        }
                        if (row.FTAG !== undefined && row.FTAG !== null && row.FTAG !== '') {
                            awayGoals = parseInt(String(row.FTAG)) || 0;
                        }
                        
                        return {
                            ...row,
                            dateObj: dateObj,
                            HomeTeam: String(row.HomeTeam).trim().replace(/\r/g, ''),
                            AwayTeam: String(row.AwayTeam).trim().replace(/\r/g, ''),
                            FTHG: homeGoals,
                            FTAG: awayGoals,
                            Div: String(row.Div || '').trim().replace(/\r/g, '')
                        };
                    } catch (parseError) {
                        return null;
                    }
                })
                .filter(row => row !== null);
        }

        // Create league selection buttons
        function createLeagueButtons() {
            const leagues = [
                { id: 'premier-league', name: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League' },
                { id: 'la-liga', name: 'üá™üá∏ La Liga' },
                { id: 'serie-a', name: 'üáÆüáπ Serie A' },
                { id: 'bundesliga', name: 'üá©üá™ Bundesliga' },
                { id: 'ligue-1', name: 'üá´üá∑ Ligue 1' }
            ];

            const leagueButtonsHTML = leagues.map(league => `
                <label class="league-button ${state.selectedLeague === league.id ? 'active' : ''}" data-league="${league.id}">
                    <div class="radio-dot ${state.selectedLeague === league.id ? 'active' : ''}"></div>
                    <span class="text-sm font-medium ${state.selectedLeague === league.id ? 'text-green-700' : 'text-gray-700'}">
                        ${league.name}
                    </span>
                </label>
            `).join('');
            
            elements.leagueButtons.innerHTML = leagueButtonsHTML;
            elements.lastTimeLeagueButtons.innerHTML = leagueButtonsHTML;
        }

        // Populate Recent H2H dropdown options
        function populateRecentH2HOptions() {
            const options = [];
            for (let i = 2; i <= 20; i++) {
                options.push(`<option value="${i}">${i}</option>`);
            }
            options.push('<option value="All">All</option>');
            elements.recentH2HSelect.innerHTML = options.join('');
            elements.recentH2HSelect.value = state.recentH2HCount;
        }

        // Create league buttons for Team Seasons tab
        function createTeamSeasonsLeagueButtons() {
            const leagues = [
                { id: 'premier-league', name: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League' },
                { id: 'la-liga', name: 'üá™üá∏ La Liga' },
                { id: 'serie-a', name: 'üáÆüáπ Serie A' },
                { id: 'bundesliga', name: 'üá©üá™ Bundesliga' },
                { id: 'ligue-1', name: 'üá´üá∑ Ligue 1' }
            ];

            const leagueButtonsHTML = leagues.map(league => `
                <label class="league-button ${state.teamSeasonsSelectedLeague === league.id ? 'active' : ''}" data-league="${league.id}">
                    <div class="radio-dot ${state.teamSeasonsSelectedLeague === league.id ? 'active' : ''}"></div>
                    <span class="text-sm font-medium ${state.teamSeasonsSelectedLeague === league.id ? 'text-green-700' : 'text-gray-700'}">
                        ${league.name}
                    </span>
                </label>
            `).join('');
            
            elements.teamSeasonsLeagueButtons.innerHTML = leagueButtonsHTML;
        }

        // Update team seasons team dropdown
        function updateTeamSeasonsTeamSelect() {
            const leagueTeams = getLeagueTeams(state.teamSeasonsSelectedLeague);
            
            const teamOptions = '<option value="">Choose a team...</option>' + 
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');
            
            elements.teamSeasonsTeamSelect.innerHTML = teamOptions;
            elements.teamSeasonsTeamSelect.value = state.teamSeasonsSelectedTeam;
        }

        // Update team seasons season select
        function updateTeamSeasonsSeasonSelect() {
            if (state.teamSeasonsSelectedLeague !== 'ligue-1' && state.teamSeasonsSelectedLeague !== 'premier-league') {
                return; // No season dropdown for other leagues
            }
            
            let seasonOptions = '<option value="">Select Season</option>';
            
            if (state.teamSeasonsSelectedLeague === 'premier-league') {
                // Only show era seasons for Premier League
                seasonOptions += `
                    <option value="premier-league-era-1992-2025">Premier League Era (1992-2025)</option>
                    <option value="english-first-division-era-1888-1992">English First Division Era (1888-1992)</option>
                    <option value="all-english-seasons-1888-2025">All English Seasons (1888-2025)</option>
                `;
            } else if (state.teamSeasonsSelectedLeague === 'ligue-1') {
                // Only show era seasons for Ligue 1
                seasonOptions += `
                    <option value="ligue-1-era-2002-2025">Ligue 1 Era (2002-2025)</option>
                    <option value="french-division-1-1932-2002">French Division 1 (1932-2002)</option>
                    <option value="all-french-seasons-1932-2025">All French Seasons (1932-2025)</option>
                `;
            }
            
            elements.teamSeasonsSeasonSelect.innerHTML = seasonOptions;
            elements.teamSeasonsSeasonSelect.value = state.teamSeasonsSelectedSeason;
        }

        // Handle team seasons league change
        async function handleTeamSeasonsLeagueChange(newLeague) {
            state.teamSeasonsSelectedLeague = newLeague;
            state.teamSeasonsSelectedTeam = '';
            state.teamSeasonsSelectedSeason = '';
            state.teamSeasonsSelectedPosition = '';
            
            // Load league data if not already loaded
            if (!state.loadedLeagues || !state.loadedLeagues.has(newLeague)) {
                await loadLeagueDataForDevice(newLeague);
            } else {
                // If already loaded, just filter/update UI
                filterDataForCurrentLeague(newLeague);
            }
            
            createTeamSeasonsLeagueButtons();
            updateTeamSeasonsTeamSelect();
            updateTeamSeasonsSeasonSelect();
            updateTeamSeasonsPositionSelect();
            
            // Clear the table and reset UI
            elements.teamHistoryTable.classList.add('hidden');
            elements.teamSeasonsPositionInfo.textContent = '';
            
            // Reset dropdown values
            elements.teamSeasonsTeamSelect.value = '';
            elements.teamSeasonsSeasonSelect.value = '';
            elements.teamSeasonsPositionSelect.value = '';
            
            // Clear stored team history data and name
            window.currentTeamHistoryData = null;
            window.currentTeamHistoryName = null;
            
            // Show/hide season dropdown for Ligue 1 and Premier League
            if (newLeague === 'ligue-1' || newLeague === 'premier-league') {
                elements.teamSeasonsSeasonContainer.classList.remove('hidden');
            } else {
                elements.teamSeasonsSeasonContainer.classList.add('hidden');
            }
            
            // Hide team history table until team is selected
            elements.teamHistoryTable.classList.add('hidden');
        }

        // Helper function to get ordinal numbers (1st, 2nd, 3rd, etc.)
        function getOrdinal(num) {
            const suffixes = ["th", "st", "nd", "rd"];
            const v = num % 100;
            return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        // Update team seasons position select
        function updateTeamSeasonsPositionSelect() {
            let positionOptions = '<option value="">All Positions</option>';
            for (let i = 1; i <= 24; i++) {
                positionOptions += `<option value="${i}">${i}</option>`;
            }
            elements.teamSeasonsPositionSelect.innerHTML = positionOptions;
            elements.teamSeasonsPositionSelect.value = state.teamSeasonsSelectedPosition;
        }

        // Handle team seasons season selection
        function handleTeamSeasonsSeasonChange(selectedSeason) {
            state.teamSeasonsSelectedSeason = selectedSeason;
            
            // If a team is already selected, refresh the team history with the new season filter
            if (state.teamSeasonsSelectedTeam) {
                showTeamHistory(state.teamSeasonsSelectedTeam, state.teamSeasonsSelectedLeague);
            }
        }

        // Handle team seasons position selection
        function handleTeamSeasonsPositionChange(selectedPosition) {
            state.teamSeasonsSelectedPosition = selectedPosition;
            
            if (state.teamSeasonsSelectedTeam) {
                // If a team is selected, refresh the team history with the new position filter
                showTeamHistory(state.teamSeasonsSelectedTeam, state.teamSeasonsSelectedLeague);
            } else if (selectedPosition) {
                // If no team selected but position is selected, show all teams at that position
                // Reset team selection to ensure clean position-only view
                state.teamSeasonsSelectedTeam = '';
                elements.teamSeasonsTeamSelect.value = '';
                showAllTeamsAtPosition(selectedPosition, state.teamSeasonsSelectedLeague);
            } else {
                // Clear the table if no filters are selected
                elements.teamHistoryTable.classList.add('hidden');
                elements.teamSeasonsPositionInfo.textContent = '';
            }
        }

        // Show all teams that finished at a specific position
        function showAllTeamsAtPosition(position, league) {
            const selectedPos = parseInt(position);
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const divCode = leagueMapping[league];
            if (!divCode) return;
            
            const availableSeasons = getAvailableSeasons(league);
            const allPositionData = [];
            
            // Process each season to build complete league tables
            availableSeasons.forEach(seasonFilter => {
                // Skip special seasons
                if (seasonFilter.includes('all-') || seasonFilter.includes('-era-') || seasonFilter.includes('french-division-1')) {
                    return;
                }
                
                // Get season date range
                const originalSelectedLeague = state.selectedLeague;
                state.selectedLeague = league;
                const seasonDates = getSeasonDateRange(seasonFilter);
                state.selectedLeague = originalSelectedLeague;
                
                if (!seasonDates) return;
                
                // Filter data for this season
                const seasonStart = new Date(seasonDates.start);
                seasonStart.setUTCHours(0, 0, 0, 0);
                const seasonEnd = new Date(seasonDates.end);
                seasonEnd.setUTCHours(23, 59, 59, 999);
                
                const seasonData = state.data.filter(match => 
                    match.Div === divCode &&
                    match.dateObj >= seasonStart &&
                    match.dateObj <= seasonEnd
                );
                
                if (seasonData.length === 0) return;
                
                // Build complete league table for this season
                const teams = [...new Set([
                    ...seasonData.map(row => row.HomeTeam),
                    ...seasonData.map(row => row.AwayTeam)
                ])].filter(team => team && team.length > 1);
                
                const seasonTable = teams.map(team => {
                    const stats = { played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0 };
                    
                    seasonData.forEach(match => {
                        if (match.HomeTeam === team || match.AwayTeam === team) {
                            const isHome = match.HomeTeam === team;
                            const teamScore = isHome ? match.FTHG : match.FTAG;
                            const opponentScore = isHome ? match.FTAG : match.FTHG;
                            
                            if (teamScore !== undefined && opponentScore !== undefined) {
                                stats.played++;
                                stats.goalsFor += teamScore;
                                stats.goalsAgainst += opponentScore;
                                
                                if (teamScore > opponentScore) stats.won++;
                                else if (teamScore === opponentScore) stats.drawn++;
                                else stats.lost++;
                            }
                        }
                    });
                    
                    const pointsPerWin = getHistoricalPointSystem(seasonFilter, league);
                    let teamPoints = stats.won * pointsPerWin + stats.drawn;
                    
                    // Apply point deductions for this team and season
                    if (seasonDates) {
                        const seasonStart = new Date(seasonDates.start);
                        const seasonEnd = new Date(seasonDates.end);
                        
                        pointDeductions.forEach(deduction => {
                            if (deduction.team === team && deduction.league === divCode) {
                                const deductionStart = new Date(deduction.startDate);
                                const deductionEnd = new Date(deduction.endDate);
                                
                                const hasOverlap = (seasonStart <= deductionEnd) && (seasonEnd >= deductionStart);
                                if (hasOverlap && state.pointDeductionsEnabled) {
                                    teamPoints -= deduction.points;
                                }
                            }
                        });
                    }
                    
                    return {
                        team,
                        ...stats,
                        goalDifference: stats.goalsFor - stats.goalsAgainst,
                        points: teamPoints
                    };
                });
                
                // Sort table by points, goal difference, goals for
                seasonTable.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                    return b.goalsFor - a.goalsFor;
                });
                
                // Apply ranking overrides
                const overriddenTable = applyRankingOverrides(seasonTable, league, seasonFilter);
                
                // Extract all teams at the requested position (handle shared positions)
                if (overriddenTable.length >= selectedPos) {
                    // Find all teams that share the same position or have sharedPosition property
                    const teamsAtPosition = [];
                    
                    // First, check if there are teams with sharedPosition matching our target
                    overriddenTable.forEach((team, index) => {
                        if (team.sharedPosition === selectedPos) {
                            teamsAtPosition.push(team);
                        }
                    });
                    
                    // If no shared positions found, get the team at the array index
                    if (teamsAtPosition.length === 0) {
                        const teamAtIndex = overriddenTable[selectedPos - 1];
                        if (teamAtIndex) {
                            teamsAtPosition.push(teamAtIndex);
                            
                            // Check for other teams with the same points/stats (tied positions)
                            overriddenTable.forEach((team, index) => {
                                if (index !== selectedPos - 1 && 
                                    team.points === teamAtIndex.points && 
                                    team.goalDifference === teamAtIndex.goalDifference &&
                                    team.goalsFor === teamAtIndex.goalsFor) {
                                    // Check if this tied team would be in the same position range
                                    const teamActualPosition = index + 1;
                                    if (Math.abs(teamActualPosition - selectedPos) < teamsAtPosition.length) {
                                        teamsAtPosition.push(team);
                                    }
                                }
                            });
                        }
                    }
                    
                    // Process each team at this position
                    teamsAtPosition.forEach(teamAtPosition => {
                        // Check if this season should be included (34+ games or historical incomplete season)
                        const shouldInclude = teamAtPosition.played >= 34 || seasonFilter !== '2025-26';
                        
                        // Check for stripped champions (position-only filtering, no team filter)
                        const isStripped = isStrippedChampion(teamAtPosition.team, divCode, seasonFilter, selectedPos, false, true);
                        
                        if (shouldInclude && !isStripped) {
                            allPositionData.push({
                                season: seasonFilter,
                                team: teamAtPosition.team,
                                position: selectedPos,
                                played: teamAtPosition.played,
                                won: teamAtPosition.won,
                                drawn: teamAtPosition.drawn,
                                lost: teamAtPosition.lost,
                                goalsFor: teamAtPosition.goalsFor,
                                goalsAgainst: teamAtPosition.goalsAgainst,
                                goalDifference: teamAtPosition.goalDifference,
                                points: teamAtPosition.points
                            });
                        }
                    });
                }
            });
            
            // Sort by season (most recent first), then by team name
            allPositionData.sort((a, b) => {
                const yearA = parseInt(a.season.split('-')[0]);
                const yearB = parseInt(b.season.split('-')[0]);
                if (yearB !== yearA) return yearB - yearA;
                return a.team.localeCompare(b.team);
            });
            
            // Add count column - count chronologically from oldest to most recent
            const teamCounts = {};
            // First sort by oldest to count chronologically
            const chronologicalData = [...allPositionData].sort((a, b) => {
                const yearA = parseInt(a.season.split('-')[0]);
                const yearB = parseInt(b.season.split('-')[0]);
                return yearA - yearB; // oldest first for counting
            });
            
            // Assign count numbers chronologically
            chronologicalData.forEach(season => {
                if (!teamCounts[season.team]) {
                    teamCounts[season.team] = 0;
                }
                teamCounts[season.team]++;
                season.count = teamCounts[season.team];
            });
            
            // Update position info
            const ordinalPosition = getOrdinal(selectedPos);
            const totalCount = allPositionData.length;
            const countText = totalCount === 1 ? 'time' : 'times';
            elements.teamSeasonsPositionInfo.textContent = `${totalCount} teams finished ${ordinalPosition} a total of ${totalCount} ${countText}`;
            
            // Display the results
            displayAllTeamsAtPosition(allPositionData, selectedPos, league);
        }


        // Render position-only table without recalculating data (for sorting)
        function renderPositionOnlyTable(allPositionData, selectedPos, league) {
            if (!allPositionData || allPositionData.length === 0) {
                elements.teamHistoryTable.classList.add('hidden');
                return;
            }
            
            // Show table
            elements.teamHistoryTable.classList.remove('hidden');
            
            // Update title for position-only view with medal styling
            const ordinalPosition = getOrdinal(selectedPos);
            const medalStyle = selectedPos === 1 ? 'color: #d97706; font-weight: bold;' : selectedPos === 2 ? 'color: #374151; font-weight: bold;' : selectedPos === 3 ? 'color: #b45309; font-weight: bold;' : 'color: #374151; font-weight: bold;';
            elements.teamHistoryTitle.innerHTML = `All teams (Position <span style="${medalStyle}">${selectedPos}</span>) - ${ordinalPosition} Place Finishes`;
            
            // Update headers for multi-team view
            const headers = [
                { key: 'season', label: 'Season' },
                { key: 'count', label: 'Count' },
                { key: 'team', label: 'Team' },
                { key: 'played', label: 'P' },
                { key: 'won', label: 'W' },
                { key: 'drawn', label: 'D' },
                { key: 'lost', label: 'L' },
                { key: 'goalsFor', label: 'GF' },
                { key: 'goalsAgainst', label: 'GA' },
                { key: 'goalDifference', label: 'GD' },
                { key: 'points', label: 'Pts' }
            ];
            
            // In position-only mode, make ALL columns sortable (including team)
            elements.teamHistoryHeader.innerHTML = headers.map(header => `
                <th class="px-3 py-4 text-center font-bold text-sm cursor-pointer hover:bg-gray-600" 
                    onclick="handleTeamHistorySort('${header.key}')"
                    style="text-align: ${(header.key === 'season' || header.key === 'team') ? 'left' : 'center'}">
                    ${header.label}${getTeamHistorySortIndicator(header.key)}
                </th>
            `).join('');
            
            // Create table rows
            elements.teamHistoryBody.innerHTML = allPositionData.map((season, index) => {
                const rowBackgroundClass = index % 2 === 1 ? 'bg-gray-50' : 'bg-white';
                const logoUrl = getTeamLogoUrl(season.team, league);
                
                return `
                    <tr class="border-b hover:bg-gray-50 ${rowBackgroundClass}">
                        <td class="px-3 py-4 font-semibold text-left">${season.season}</td>
                        <td class="px-3 py-4 text-center font-semibold">${season.count}</td>
                        <td class="px-4 py-4 font-semibold text-gray-900">
                            <div class="flex items-center">
                                ${logoUrl ? `<img src="${logoUrl}" alt="${season.team} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="cursor-pointer hover:text-blue-600" onclick="handleTeamClick('${season.team}')">${season.team}</span>
                            </div>
                        </td>
                        <td class="px-3 py-4 text-center">${season.played}</td>
                        <td class="px-3 py-4 text-center">${season.won}</td>
                        <td class="px-3 py-4 text-center">${season.drawn}</td>
                        <td class="px-3 py-4 text-center">${season.lost}</td>
                        <td class="px-3 py-4 text-center">${season.goalsFor}</td>
                        <td class="px-3 py-4 text-center">${season.goalsAgainst}</td>
                        <td class="px-3 py-4 text-center ${season.goalDifference >= 0 ? 'text-green-600' : 'text-red-600'}">${season.goalDifference > 0 ? '+' : ''}${season.goalDifference}</td>
                        <td class="px-3 py-4 text-center">
                            <span class="points-badge">
                                ${season.points}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Display all teams at specific position
        function displayAllTeamsAtPosition(allPositionData, selectedPos, league) {
            // Clear any previous team-specific data first
            window.currentTeamHistoryData = null;
            window.currentTeamHistoryName = null;
            
            // Just call the render function
            renderPositionOnlyTable(allPositionData, selectedPos, league);
            
            // Store data for potential sorting
            window.currentTeamHistoryData = allPositionData;
            window.currentTeamHistoryName = `All teams (Position ${selectedPos})`;
        }

        // Handle team seasons team selection
        function handleTeamSeasonsTeamChange(selectedTeam) {
            // handleTeamSeasonsTeamChange called
            state.teamSeasonsSelectedTeam = selectedTeam;
            state.teamSeasonsSelectedPosition = ''; // Reset position filter
            
            if (selectedTeam) {
                // Reset position dropdown UI when team is selected
                elements.teamSeasonsPositionSelect.value = '';
                showTeamHistory(selectedTeam, state.teamSeasonsSelectedLeague);
            } else {
                // Team unselected - clear everything
                elements.teamHistoryTable.classList.add('hidden');
                elements.teamSeasonsPositionInfo.textContent = '';
                elements.teamHistoryTitle.textContent = '';
                
                // Clear stored team history data and name to prevent contamination
                window.currentTeamHistoryData = null;
                window.currentTeamHistoryName = null;
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Store the current league before switching
            let preservedLeague = state.selectedLeague;
            
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            if (tabName === 'league-filters') {
                document.getElementById('leagueFiltersTab').classList.add('active');
                document.getElementById('leagueFiltersContent').classList.add('active');
                
                // Preserve league selection
                state.selectedLeague = preservedLeague;
                
                // Reset Last Time When state
                state.lastTimeTeam1 = '';
                state.lastTimeTeam2 = '';
                state.lastTimeDayOfWeek = '';
                state.lastTimeLocation = '';
                elements.lastTimeTeam1Select.value = '';
                elements.lastTimeTeam2Select.value = '';
                elements.lastTimeDayOfWeekSelect.value = '';
                elements.lastTimeLocationSelect.value = '';
                elements.lastTimeResults.classList.add('hidden');
                
                // Show league table and related sections
                elements.tableContainer.classList.remove('hidden');
                elements.h2hSection.classList.remove('hidden');
                
                // Update league buttons and table
                createLeagueButtons();
                updateTable();
                
            } else if (tabName === 'team-seasons') {
                document.getElementById('teamSeasonsTab').classList.add('active');
                document.getElementById('teamSeasonsContent').classList.add('active');
                
                // Preserve current Team Seasons league selection - don't overwrite
                // state.teamSeasonsSelectedLeague should maintain its current value
                
                // Reset both other tab states
                state.selectedTeam1 = '';
                state.selectedTeam2 = '';
                state.selectedSeason = '';
                state.selectedDayOfWeek = '';
                state.lastTimeTeam1 = '';
                state.lastTimeTeam2 = '';
                state.lastTimeDayOfWeek = '';
                elements.team1Select.value = '';
                elements.team2Select.value = '';
                elements.seasonSelect.value = '';
                elements.dayOfWeekSelect.value = '';
                elements.lastTimeTeam1Select.value = '';
                elements.lastTimeTeam2Select.value = '';
                elements.lastTimeDayOfWeekSelect.value = '';
                elements.lastTimeLocationSelect.value = '';
                
                // Hide other tab sections
                elements.tableContainer.classList.add('hidden');
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
                elements.tableInfo.classList.add('hidden');
                elements.lastTimeResults.classList.add('hidden');
                
                // Initialize Team Seasons controls with preserved league
                createTeamSeasonsLeagueButtons();
                updateTeamSeasonsTeamSelect();
                updateTeamSeasonsPositionSelect();
                
            } else if (tabName === 'last-time-when') {
                document.getElementById('lastTimeWhenTab').classList.add('active');
                document.getElementById('lastTimeWhenContent').classList.add('active');
                
                // Simple approach: just set the league and update
                state.selectedLeague = preservedLeague;
                
                // Reset League Filters state  
                state.selectedTeam1 = '';
                state.selectedTeam2 = '';
                state.selectedSeason = '';
                state.selectedDayOfWeek = '';
                elements.team1Select.value = '';
                elements.team2Select.value = '';
                elements.seasonSelect.value = '';
                elements.dayOfWeekSelect.value = '';
                
                // Hide league table and related sections
                elements.tableContainer.classList.add('hidden');
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
                elements.tableInfo.classList.add('hidden');
                
                // Update league buttons and team selects for Last Time When
                createLeagueButtons(); // This will update the league buttons with correct selection
                updateTeamSelects();
                
            } else if (tabName === 'team-streaks') {
                document.getElementById('teamStreaksTab').classList.add('active');
                document.getElementById('teamStreaksContent').classList.add('active');
                
                // Simple approach: just set the league and update
                state.selectedLeague = preservedLeague;
                
                // Reset other tab states
                state.selectedTeam1 = '';
                state.selectedTeam2 = '';
                state.selectedSeason = '';
                state.selectedDayOfWeek = '';
                state.lastTimeTeam1 = '';
                state.lastTimeTeam2 = '';
                state.lastTimeDayOfWeek = '';
                elements.team1Select.value = '';
                elements.team2Select.value = '';
                elements.seasonSelect.value = '';
                elements.dayOfWeekSelect.value = '';
                elements.lastTimeTeam1Select.value = '';
                elements.lastTimeTeam2Select.value = '';
                elements.lastTimeDayOfWeekSelect.value = '';
                elements.lastTimeLocationSelect.value = '';
                
                // Hide other tab sections
                elements.tableContainer.classList.add('hidden');
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
                elements.tableInfo.classList.add('hidden');
                elements.lastTimeResults.classList.add('hidden');
                
                // Initialize Team Streaks controls with correct league selected
                createTeamStreaksLeagueButtons();
                updateTeamStreaksSelects();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.getElementById('leagueFiltersTab').addEventListener('click', () => switchTab('league-filters'));
            document.getElementById('teamSeasonsTab').addEventListener('click', () => switchTab('team-seasons'));
            document.getElementById('lastTimeWhenTab').addEventListener('click', () => switchTab('last-time-when'));
            document.getElementById('teamStreaksTab').addEventListener('click', () => switchTab('team-streaks'));
            
            // Gist loading
            elements.reloadGistsBtn.addEventListener('click', loadGistData);
            
            // League selection
            elements.leagueButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.league-button');
                if (button) {
                    handleLeagueChange(button.dataset.league);
                }
            });
            
            // Last Time When league selection
            elements.lastTimeLeagueButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.league-button');
                if (button) {
                    handleLeagueChange(button.dataset.league);
                }
            });

            // Filter controls
            elements.seasonSelect.addEventListener('change', (e) => handleSeasonChange(e.target.value));
            elements.dateFrom.addEventListener('change', (e) => { state.dateFrom = e.target.value; updateTable(); });
            elements.dateTo.addEventListener('change', (e) => { state.dateTo = e.target.value; updateTable(); });
            elements.dayOfWeekSelect.addEventListener('change', (e) => { state.selectedDayOfWeek = e.target.value; updateTable(); });
            elements.team1Select.addEventListener('change', (e) => { 
                state.selectedTeam1 = e.target.value; 
                checkAndDisablePointDeductions();
                updateTable(); 
            });
            elements.team2Select.addEventListener('change', (e) => { 
                state.selectedTeam2 = e.target.value; 
                checkAndDisablePointDeductions();
                updateTable(); 
            });
            
            // Checkboxes
            elements.homeCheckbox.addEventListener('click', () => {
                state.homeFilter = !state.homeFilter;
                elements.homeCheckbox.className = `checkbox ${state.homeFilter ? 'checked' : ''}`;
                updateTable();
            });
            
            elements.awayCheckbox.addEventListener('click', () => {
                state.awayFilter = !state.awayFilter;
                elements.awayCheckbox.className = `checkbox ${state.awayFilter ? 'checked' : ''}`;
                updateTable();
            });
            
            elements.deductionsCheckbox.addEventListener('click', () => {
                state.pointDeductionsEnabled = !state.pointDeductionsEnabled;
                elements.deductionsCheckbox.className = `checkbox ${state.pointDeductionsEnabled ? 'checked' : ''}`;
                updateTable();
                
                // Also refresh Team Seasons data if currently displayed
                if (state.teamSeasonsSelectedTeam) {
                    // Refresh single team view
                    showTeamHistory(state.teamSeasonsSelectedTeam, state.teamSeasonsSelectedLeague);
                } else if (state.teamSeasonsSelectedPosition) {
                    // Refresh position-only view
                    showAllTeamsAtPosition(state.teamSeasonsSelectedPosition, state.teamSeasonsSelectedLeague);
                }
            });
            
            elements.threePointCheckbox.addEventListener('click', () => {
                state.threePointSystem = !state.threePointSystem;
                elements.threePointCheckbox.className = `checkbox ${state.threePointSystem ? 'checked' : ''}`;
                updateTable();
            });

            // Buttons
            elements.resetBtn.addEventListener('click', clearFilters);
            
            // Last Time When controls
            elements.lastTimeTeam1Select.addEventListener('change', (e) => {
                state.lastTimeTeam1 = e.target.value;
                calculateLastTimeWhen();
            });
            
            elements.lastTimeTeam2Select.addEventListener('change', (e) => {
                state.lastTimeTeam2 = e.target.value;
                calculateLastTimeWhen();
            });
            
            elements.lastTimeDayOfWeekSelect.addEventListener('change', (e) => {
                state.lastTimeDayOfWeek = e.target.value;
                calculateLastTimeWhen();
            });
            
            elements.lastTimeLocationSelect.addEventListener('change', (e) => {
                // Location dropdown changed
                state.lastTimeLocation = e.target.value;
                // State updated
                calculateLastTimeWhen();
            });
            elements.retryBtn.addEventListener('click', () => {
                state.error = '';
                loadGistData();
            });

            // H2H controls
            elements.recentH2HSelect.addEventListener('change', (e) => {
                state.recentH2HCount = e.target.value;
                updateTable();
            });
            
            // Team Seasons controls
            elements.teamSeasonsLeagueButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.league-button');
                if (button) {
                    handleTeamSeasonsLeagueChange(button.dataset.league);
                }
            });
            
            elements.teamSeasonsTeamSelect.addEventListener('change', (e) => {
                handleTeamSeasonsTeamChange(e.target.value);
            });
            
            elements.teamSeasonsSeasonSelect.addEventListener('change', (e) => {
                handleTeamSeasonsSeasonChange(e.target.value);
            });
            
            elements.teamSeasonsPositionSelect.addEventListener('change', (e) => {
                handleTeamSeasonsPositionChange(e.target.value);
            });
            
            // Team Streaks controls
            elements.teamStreaksLeagueButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.league-button');
                if (button) {
                    handleTeamStreaksLeagueChange(button.dataset.league);
                }
            });
            
            elements.teamStreaksStatusSelect.addEventListener('change', (e) => {
                handleTeamStreaksStatusChange(e.target.value);
            });
            
            elements.teamStreaksLocationSelect.addEventListener('change', (e) => {
                handleTeamStreaksLocationChange(e.target.value);
            });
            
            elements.teamStreaksTypeSelect.addEventListener('change', (e) => {
                handleTeamStreaksTypeChange(e.target.value);
            });
            
            elements.teamStreaksTeam1Select.addEventListener('change', (e) => {
                handleTeamStreaksTeam1Change(e.target.value);
            });
            
            elements.teamStreaksTeam2Select.addEventListener('change', (e) => {
                handleTeamStreaksTeam2Change(e.target.value);
            });
        }

        // Check if both teams are selected and auto-disable point deductions
        function checkAndDisablePointDeductions() {
            if (state.selectedTeam1 && state.selectedTeam2) {
                // Both teams selected - disable point deductions
                state.pointDeductionsEnabled = false;
                elements.deductionsCheckbox.className = 'checkbox';
            }
        }

        // Handle league change
        async function handleLeagueChange(newLeague) {
            state.selectedLeague = newLeague;
            state.selectedTeam1 = '';
            state.selectedTeam2 = '';
            state.selectedSeason = '';
            
            // Load league data if not already loaded
            if (!state.loadedLeagues || !state.loadedLeagues.has(newLeague)) {
                await loadLeagueDataForDevice(newLeague);
            } else {
                // If already loaded, just filter/update UI
                filterDataForCurrentLeague(newLeague);
            }
            
            // Reset Last Time When state
            state.lastTimeTeam1 = '';
            state.lastTimeTeam2 = '';
            state.lastTimeDayOfWeek = '';
            state.lastTimeLocation = '';
            
            // Reset Last Time When UI elements
            if (elements.lastTimeTeam1Select) elements.lastTimeTeam1Select.value = '';
            if (elements.lastTimeTeam2Select) elements.lastTimeTeam2Select.value = '';
            if (elements.lastTimeDayOfWeekSelect) elements.lastTimeDayOfWeekSelect.value = '';
            if (elements.lastTimeLocationSelect) elements.lastTimeLocationSelect.value = '';
            
            // Hide Last Time When results
            if (elements.lastTimeResults) elements.lastTimeResults.classList.add('hidden');
            hideAllLastTimeSections();
            
            createLeagueButtons();
            updateTeamSelects();
            updateTeamSeasonsTeamSelect();
            updateSeasonOptions();
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1', 
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            // Set default date ranges for specific leagues
            if (newLeague === 'premier-league') {
                state.dateFrom = '1992-08-01';
                state.dateTo = '2026-06-30';
            } else if (newLeague === 'ligue-1') {
                state.dateFrom = '2002-07-01';
                state.dateTo = '2026-06-30';
            } else {
                // For other leagues, use the full data range
                const leagueData = state.data.filter(row => row.Div === leagueMapping[newLeague]);
                if (leagueData.length > 0) {
                    const dates = leagueData.map(row => row.dateObj);
                    const minDate = new Date(Math.min(...dates));
                    const maxDate = new Date(Math.max(...dates));
                    state.dateFrom = minDate.toISOString().split('T')[0];
                    state.dateTo = maxDate.toISOString().split('T')[0];
                }
            }
            
            elements.dateFrom.value = state.dateFrom;
            elements.dateTo.value = state.dateTo;
            
            updateTable();
        }

        // Handle season change
        function handleSeasonChange(seasonKey) {
            state.selectedSeason = seasonKey;
            const seasonData = getSeasonDateRange(seasonKey);
            if (seasonData) {
                state.dateFrom = seasonData.start;
                state.dateTo = seasonData.end;
                elements.dateFrom.value = state.dateFrom;
                elements.dateTo.value = state.dateTo;
                updateTable();
            }
        }

        // Get season date range
        function getSeasonDateRange(seasonKey) {
            if (seasonKey === 'ligue-1-era-2002-2025') {
                return { start: '2002-07-01', end: '2026-06-30' };
            }
            if (seasonKey === 'french-division-1-1932-2002') {
                return { start: '1932-07-01', end: '2002-06-30' };
            }
            if (seasonKey === 'all-french-seasons-1932-2025') {
                return { start: '1932-07-01', end: '2026-06-30' };
            }
            if (seasonKey === 'premier-league-era-1992-2025') {
                return { start: '1992-08-01', end: '2026-06-30' };
            }
            if (seasonKey === 'english-first-division-era-1888-1992') {
                return { start: '1888-09-08', end: '1992-05-25' };
            }
            if (seasonKey === 'all-english-seasons-1888-2025') {
                return { start: '1888-09-08', end: '2026-06-30' };
            }
            if (seasonKey === 'all-spanish-seasons-1928-2025') {
                return { start: '1929-01-01', end: '2026-06-30' };
            }
            if (seasonKey === 'all-italian-seasons-1929-2025') {
                return { start: '1929-07-01', end: '2026-06-30' };
            }
            if (seasonKey === 'all-german-seasons-1963-2025') {
                return { start: '1963-07-01', end: '2026-06-30' };
            }
            
            if (seasons[state.selectedLeague] && seasons[state.selectedLeague][seasonKey]) {
                return seasons[state.selectedLeague][seasonKey];
            }
            return null;
        }

        // Update team selects
        function updateTeamSelects() {
            const leagueTeams = getLeagueTeams();
            
            const team1Options = '<option value="">All Teams</option>' + 
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');
            const team2Options = '<option value="">No Team</option>' + 
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');
            
            elements.team1Select.innerHTML = team1Options;
            elements.team2Select.innerHTML = team2Options;
            
            // Also populate Last Time When team selects
            const lastTimeTeam1Options = '<option value="">Select Team 1</option>' + 
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');
            const lastTimeTeam2Options = '<option value="">Select Team 2</option>' + 
                leagueTeams.map(team => `<option value="${team}">${team}</option>`).join('');
            
            elements.lastTimeTeam1Select.innerHTML = lastTimeTeam1Options;
            elements.lastTimeTeam2Select.innerHTML = lastTimeTeam2Options;
            
            elements.team1Select.value = state.selectedTeam1;
            elements.team2Select.value = state.selectedTeam2;
        }

        // Helper function to hide all Last Time sections
        function hideAllLastTimeSections() {
            elements.team1HomeWinSection.classList.add('hidden');
            elements.team1AwayWinSection.classList.add('hidden');
            elements.team1HomeDrawSection.classList.add('hidden');
            elements.team1AwayDrawSection.classList.add('hidden');
            elements.team1HomeLossSection.classList.add('hidden');
            elements.team1AwayLossSection.classList.add('hidden');
        }

        // Helper function to create match table row (matching Head-to-Head format)
        function createMatchTableRow(match) {
            const homeTeamColor = getTeamColor(match.HomeTeam, state.selectedLeague);
            const awayTeamColor = getTeamColor(match.AwayTeam, state.selectedLeague);
            
            const homeScore = parseInt(match.FTHG) || 0;
            const awayScore = parseInt(match.FTAG) || 0;
            
            // Determine winner and apply highlighting like Head-to-Head tables
            let homeScoreClass = '';
            let awayScoreClass = '';
            let resultStyle = '';
            let winnerTeam = '';
            
            if (homeScore > awayScore) {
                // Home team wins
                winnerTeam = match.HomeTeam;
                homeScoreClass = 'font-bold';
                awayScoreClass = 'text-red-600 font-bold';
                resultStyle = homeTeamColor ? 
                    `color: ${homeTeamColor} !important; font-weight: bold;` : 
                    'color: #059669 !important; font-weight: bold;';
            } else if (awayScore > homeScore) {
                // Away team wins
                winnerTeam = match.AwayTeam;
                homeScoreClass = 'text-red-600 font-bold';
                awayScoreClass = 'font-bold';
                resultStyle = awayTeamColor ? 
                    `color: ${awayTeamColor} !important; font-weight: bold;` : 
                    'color: #059669 !important; font-weight: bold;';
            } else {
                // Draw
                winnerTeam = 'Draw';
                homeScoreClass = 'text-gray-400 font-bold';
                awayScoreClass = 'text-gray-400 font-bold';
                resultStyle = 'color: #9ca3af !important; font-weight: bold;';
            }

            // Add team highlights - Team 1 green, Team 2 blue (like Head-to-Head)
            const isHomeTeam1 = match.HomeTeam === state.lastTimeTeam1;
            const isHomeTeam2 = match.HomeTeam === state.lastTimeTeam2;
            const isAwayTeam1 = match.AwayTeam === state.lastTimeTeam1;
            const isAwayTeam2 = match.AwayTeam === state.lastTimeTeam2;
            
            const homeTeamClass = isHomeTeam1 ? 'team1-highlight' : 
                                isHomeTeam2 ? 'team2-highlight' : '';
            const awayTeamClass = isAwayTeam1 ? 'team1-highlight' : 
                                isAwayTeam2 ? 'team2-highlight' : '';

            // Team styling (matching Head-to-Head format)
            const homeTeamStyle = homeTeamColor ? `color: ${homeTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
            const awayTeamStyle = awayTeamColor ? `color: ${awayTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
            
            // Result highlighting for winner
            let resultClass = '';
            if (winnerTeam !== 'Draw') {
                if (winnerTeam === state.lastTimeTeam1) {
                    resultClass = 'team1-highlight';
                } else if (winnerTeam === state.lastTimeTeam2) {
                    resultClass = 'team2-highlight';
                }
            }
            
            // Get team logos
            const homeLogoUrl = getTeamLogoUrl(match.HomeTeam, state.selectedLeague);
            const awayLogoUrl = getTeamLogoUrl(match.AwayTeam, state.selectedLeague);
            
            // Get winner logo for result column (if not a draw)
            const winnerLogoUrl = winnerTeam !== 'Draw' ? getTeamLogoUrl(winnerTeam, state.selectedLeague) : null;
            
            return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="text-center text-sm">${match.dateObj.toLocaleDateString()}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${homeLogoUrl ? `<img src="${homeLogoUrl}" alt="${match.HomeTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${homeTeamClass}" style="${homeTeamStyle}">${match.HomeTeam}</span>
                        </div>
                    </td>
                    <td class="text-center text-lg ${homeScoreClass}" ${homeScoreClass === 'font-bold' ? 'style="color: #047857;"' : ''}>${homeScore}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${awayLogoUrl ? `<img src="${awayLogoUrl}" alt="${match.AwayTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${awayTeamClass}" style="${awayTeamStyle}">${match.AwayTeam}</span>
                        </div>
                    </td>
                    <td class="text-center text-lg ${awayScoreClass}" ${awayScoreClass === 'font-bold' ? 'style="color: #047857;"' : ''}>${awayScore}</td>
                    <td class="text-center">
                        <div class="flex items-center justify-center">
                            ${winnerLogoUrl ? `<img src="${winnerLogoUrl}" alt="${winnerTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                            <span class="${resultClass}" style="${resultStyle}">${winnerTeam}</span>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Helper function to populate a result section
        function populateResultSection(sectionElement, bodyElement, daysElement, titleElement, result, team1Name, team2Name, resultType, isHome) {
            if (result) {
                sectionElement.classList.remove('hidden');
                bodyElement.innerHTML = createMatchTableRow(result);
                
                const daysSince = Math.floor((new Date() - result.dateObj) / (1000 * 60 * 60 * 24));
                daysElement.textContent = `${daysSince} days ago`;
                
                const location = isHome ? 'at Home' : 'Away';
                const color = resultType === 'Won' ? 'text-green-700' : resultType === 'Drew' ? 'text-gray-600' : 'text-red-600';
                titleElement.className = `text-lg font-semibold ${color} mb-3`;
                
                // Get team colors
                const team1Color = getTeamColor(team1Name, state.selectedLeague);
                const team2Color = team2Name ? getTeamColor(team2Name, state.selectedLeague) : null;
                
                // Use different title format for single-team vs two-team mode
                if (team2Name && team2Name !== team1Name) {
                    // Two-team mode: Last [Result] [Location] vs [Team2]
                    const resultWord = resultType === 'Won' ? 'Win' : resultType === 'Drew' ? 'Draw' : 'Loss';
                    titleElement.innerHTML = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1Name}</span> Last ${resultWord} ${location} vs <span style="color: ${team2Color || '#374151'}; font-weight: bold;">${team2Name}</span>`;
                } else {
                    // Single-team mode: simple format
                    const resultWord = resultType === 'Won' ? 'Win' : resultType === 'Drew' ? 'Draw' : 'Loss';
                    titleElement.innerHTML = `<span style="color: ${team1Color || '#374151'}; font-weight: bold;">${team1Name}</span> Last ${resultWord} ${location}`;
                }
            }
        }

        // Calculate last time when results
        function calculateLastTimeWhen() {
            if (!state.lastTimeTeam1) {
                elements.lastTimeResults.classList.add('hidden');
                return;
            }
            
            // Handle single team scenario (Team 1 only selected)
            if (!state.lastTimeTeam2) {
                calculateSingleTeamResults();
                return;
            }
            
            if (state.lastTimeTeam1 === state.lastTimeTeam2) {
                elements.lastTimeResults.classList.add('hidden');
                return;
            }
            
            // Hide all sections initially
            hideAllLastTimeSections();
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1', 
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            let matches = state.data.filter(row => 
                row.Div === leagueMapping[state.selectedLeague] &&
                ((row.HomeTeam === state.lastTimeTeam1 && row.AwayTeam === state.lastTimeTeam2) ||
                 (row.HomeTeam === state.lastTimeTeam2 && row.AwayTeam === state.lastTimeTeam1))
            );
            
            // Apply day of week filter if selected
            if (state.lastTimeDayOfWeek !== '') {
                matches = matches.filter(row => {
                    const dayOfWeek = row.dateObj.getDay();
                    return dayOfWeek.toString() === state.lastTimeDayOfWeek;
                });
            }
            
            // Apply location filter if selected
            // Location filter state
            // Matches before location filter
            if (state.lastTimeLocation !== '') {
                matches = matches.filter(row => {
                    if (state.lastTimeLocation === 'home') {
                        // Only show matches where Team 1 was playing at home
                        // Filtering for home matches
                        return row.HomeTeam === state.lastTimeTeam1;
                    } else if (state.lastTimeLocation === 'away') {
                        // Only show matches where Team 1 was playing away
                        // Filtering for away matches
                        return row.AwayTeam === state.lastTimeTeam1;
                    }
                    // If 'Both Home and Away' or empty, show all matches (no filtering)
                    return true;
                });
                // Matches after location filter
            }
            
            // Sort matches by date (most recent first)
            matches.sort((a, b) => b.dateObj - a.dateObj);
            
            // Find last occurrence of each result type
            const results = {
                team1HomeWin: null,    // Team 1 won at home
                team1AwayWin: null,    // Team 1 won away
                team1HomeDraw: null,   // Team 1 drew at home
                team1AwayDraw: null,   // Team 1 drew away
                team1HomeLoss: null,   // Team 1 lost at home
                team1AwayLoss: null    // Team 1 lost away
            };
            
            matches.forEach(match => {
                const homeScore = parseInt(match.FTHG) || 0;
                const awayScore = parseInt(match.FTAG) || 0;
                
                if (match.HomeTeam === state.lastTimeTeam1 && match.AwayTeam === state.lastTimeTeam2) {
                    // Team 1 is home, Team 2 is away
                    if (homeScore > awayScore && !results.team1HomeWin) {
                        results.team1HomeWin = match;
                    } else if (homeScore === awayScore && !results.team1HomeDraw) {
                        results.team1HomeDraw = match;
                    } else if (homeScore < awayScore && !results.team1HomeLoss) {
                        results.team1HomeLoss = match;
                    }
                } else if (match.HomeTeam === state.lastTimeTeam2 && match.AwayTeam === state.lastTimeTeam1) {
                    // Team 1 is away, Team 2 is home
                    if (awayScore > homeScore && !results.team1AwayWin) {
                        results.team1AwayWin = match;
                    } else if (homeScore === awayScore && !results.team1AwayDraw) {
                        results.team1AwayDraw = match;
                    } else if (homeScore > awayScore && !results.team1AwayLoss) {
                        results.team1AwayLoss = match;
                    }
                }
            });
            
            // Populate the 6 result sections
            populateResultSection(
                elements.team1HomeWinSection, elements.team1HomeWinBody, elements.team1HomeWinDays,
                elements.team1HomeWinTitle, results.team1HomeWin, state.lastTimeTeam1, state.lastTimeTeam2, 'Won', true
            );
            
            populateResultSection(
                elements.team1AwayWinSection, elements.team1AwayWinBody, elements.team1AwayWinDays,
                elements.team1AwayWinTitle, results.team1AwayWin, state.lastTimeTeam1, state.lastTimeTeam2, 'Won', false
            );
            
            populateResultSection(
                elements.team1HomeDrawSection, elements.team1HomeDrawBody, elements.team1HomeDrawDays,
                elements.team1HomeDrawTitle, results.team1HomeDraw, state.lastTimeTeam1, state.lastTimeTeam2, 'Drew', true
            );
            
            populateResultSection(
                elements.team1AwayDrawSection, elements.team1AwayDrawBody, elements.team1AwayDrawDays,
                elements.team1AwayDrawTitle, results.team1AwayDraw, state.lastTimeTeam1, state.lastTimeTeam2, 'Drew', false
            );
            
            populateResultSection(
                elements.team1HomeLossSection, elements.team1HomeLossBody, elements.team1HomeLossDays,
                elements.team1HomeLossTitle, results.team1HomeLoss, state.lastTimeTeam1, state.lastTimeTeam2, 'Lost', true
            );
            
            populateResultSection(
                elements.team1AwayLossSection, elements.team1AwayLossBody, elements.team1AwayLossDays,
                elements.team1AwayLossTitle, results.team1AwayLoss, state.lastTimeTeam1, state.lastTimeTeam2, 'Lost', false
            );
            
            // Show results
            elements.lastTimeResults.classList.remove('hidden');
        }

        // Calculate single team results (Team 1 vs all opponents)
        function calculateSingleTeamResults() {
            // Hide all sections initially
            hideAllLastTimeSections();
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1', 
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            let matches = state.data.filter(row => 
                row.Div === leagueMapping[state.selectedLeague] &&
                (row.HomeTeam === state.lastTimeTeam1 || row.AwayTeam === state.lastTimeTeam1)
            );
            
            // Apply day of week filter if selected
            if (state.lastTimeDayOfWeek !== '') {
                matches = matches.filter(row => {
                    const dayOfWeek = row.dateObj.getDay();
                    return dayOfWeek.toString() === state.lastTimeDayOfWeek;
                });
            }
            
            // Apply location filter if selected
            // Single team - Location filter state
            // Single team - Matches before location filter
            if (state.lastTimeLocation !== '') {
                matches = matches.filter(row => {
                    if (state.lastTimeLocation === 'home') {
                        // Only show matches where Team 1 was playing at home
                        // Single team - Filtering for home matches
                        return row.HomeTeam === state.lastTimeTeam1;
                    } else if (state.lastTimeLocation === 'away') {
                        // Only show matches where Team 1 was playing away
                        // Single team - Filtering for away matches
                        return row.AwayTeam === state.lastTimeTeam1;
                    }
                    // If 'Both Home and Away' or empty, show all matches (no filtering)
                    return true;
                });
                // Single team - Matches after location filter
            }
            
            // Sort matches by date (most recent first)
            matches.sort((a, b) => b.dateObj - a.dateObj);
            
            const today = new Date();
            
            // Find last occurrence of each result type
            const results = {
                team1HomeWin: null,
                team1HomeDraw: null,
                team1HomeLoss: null,
                team1AwayWin: null,
                team1AwayDraw: null,
                team1AwayLoss: null
            };
            
            matches.forEach(match => {
                const homeScore = parseInt(match.FTHG) || 0;
                const awayScore = parseInt(match.FTAG) || 0;
                
                if (match.HomeTeam === state.lastTimeTeam1) {
                    // Team 1 is home
                    if (homeScore > awayScore && !results.team1HomeWin) {
                        results.team1HomeWin = match;
                    } else if (homeScore === awayScore && !results.team1HomeDraw) {
                        results.team1HomeDraw = match;
                    } else if (homeScore < awayScore && !results.team1HomeLoss) {
                        results.team1HomeLoss = match;
                    }
                } else if (match.AwayTeam === state.lastTimeTeam1) {
                    // Team 1 is away
                    if (awayScore > homeScore && !results.team1AwayWin) {
                        results.team1AwayWin = match;
                    } else if (homeScore === awayScore && !results.team1AwayDraw) {
                        results.team1AwayDraw = match;
                    } else if (homeScore > awayScore && !results.team1AwayLoss) {
                        results.team1AwayLoss = match;
                    }
                }
            });
            
            // For single team, we get opponent team names from the matches
            function getSingleTeamOpponentName(match) {
                return match.HomeTeam === state.lastTimeTeam1 ? match.AwayTeam : match.HomeTeam;
            }
            
            // Populate the 6 result sections for single team
            if (results.team1HomeWin) {
                populateResultSection(
                    elements.team1HomeWinSection, elements.team1HomeWinBody, elements.team1HomeWinDays,
                    elements.team1HomeWinTitle, results.team1HomeWin, state.lastTimeTeam1, 
                    null, 'Won', true
                );
            }
            
            if (results.team1AwayWin) {
                populateResultSection(
                    elements.team1AwayWinSection, elements.team1AwayWinBody, elements.team1AwayWinDays,
                    elements.team1AwayWinTitle, results.team1AwayWin, state.lastTimeTeam1, 
                    null, 'Won', false
                );
            }
            
            if (results.team1HomeDraw) {
                populateResultSection(
                    elements.team1HomeDrawSection, elements.team1HomeDrawBody, elements.team1HomeDrawDays,
                    elements.team1HomeDrawTitle, results.team1HomeDraw, state.lastTimeTeam1, 
                    null, 'Drew', true
                );
            }
            
            if (results.team1AwayDraw) {
                populateResultSection(
                    elements.team1AwayDrawSection, elements.team1AwayDrawBody, elements.team1AwayDrawDays,
                    elements.team1AwayDrawTitle, results.team1AwayDraw, state.lastTimeTeam1, 
                    null, 'Drew', false
                );
            }
            
            if (results.team1HomeLoss) {
                populateResultSection(
                    elements.team1HomeLossSection, elements.team1HomeLossBody, elements.team1HomeLossDays,
                    elements.team1HomeLossTitle, results.team1HomeLoss, state.lastTimeTeam1, 
                    null, 'Lost', true
                );
            }
            
            if (results.team1AwayLoss) {
                populateResultSection(
                    elements.team1AwayLossSection, elements.team1AwayLossBody, elements.team1AwayLossDays,
                    elements.team1AwayLossTitle, results.team1AwayLoss, state.lastTimeTeam1, 
                    null, 'Lost', false
                );
            }
            
            // Show results
            elements.lastTimeResults.classList.remove('hidden');
        }

        // Get teams for selected league
        function getLeagueTeams(league = null) {
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const selectedDiv = leagueMapping[league || state.selectedLeague];
            const leagueData = state.data.filter(row => row.Div === selectedDiv);
            const leagueTeams = [...new Set([
                ...leagueData.map(row => row.HomeTeam), 
                ...leagueData.map(row => row.AwayTeam)
            ])]
                .filter(team => team && team.length > 1)
                .sort();
            
            return leagueTeams;
        }

        // Update season options
        function updateSeasonOptions() {
            const availableSeasons = getAvailableSeasons();
            const options = '<option value="">Select Season</option>' + 
                availableSeasons.map(season => {
                    let label = season;
                    if (season === 'ligue-1-era-2002-2025') label = 'Ligue 1 Era (2002-2025)';
                    if (season === 'french-division-1-1932-2002') label = 'French Division 1 (1932-2002)';
                    if (season === 'all-french-seasons-1932-2025') label = 'All French Seasons (1932-2025)';
                    if (season === 'premier-league-era-1992-2025') label = 'Premier League Era (1992-2025)';
                    if (season === 'english-first-division-era-1888-1992') label = 'English First Division Era (1888-1992)';
                    if (season === 'all-english-seasons-1888-2025') label = 'All English Seasons (1888-2025)';
                    if (season === 'all-spanish-seasons-1928-2025') label = 'All Spanish Seasons (1928-2025)';
                    if (season === 'all-italian-seasons-1929-2025') label = 'All Italian Seasons (1929-2025)';
                    if (season === 'all-german-seasons-1963-2025') label = 'All German Seasons (1963-2025)';
                    return `<option value="${season}">${label}</option>`;
                }).join('');
            
            elements.seasonSelect.innerHTML = options;
            elements.seasonSelect.value = state.selectedSeason;
        }

        // Get available seasons
        function getAvailableSeasons(league = null) {
            const leagueToUse = league || state.selectedLeague;
            if (!seasons[leagueToUse]) return [];
            
            const seasonsList = Object.keys(seasons[leagueToUse]).sort().reverse();
            
            if (leagueToUse === 'ligue-1') {
                return ['ligue-1-era-2002-2025', 'french-division-1-1932-2002', 'all-french-seasons-1932-2025', ...seasonsList];
            }
            
            if (leagueToUse === 'premier-league') {
                return ['premier-league-era-1992-2025', 'english-first-division-era-1888-1992', 'all-english-seasons-1888-2025', ...seasonsList];
            }
            
            if (leagueToUse === 'la-liga') {
                return ['all-spanish-seasons-1928-2025', ...seasonsList];
            }
            
            if (leagueToUse === 'serie-a') {
                return ['all-italian-seasons-1929-2025', ...seasonsList];
            }
            
            if (leagueToUse === 'bundesliga') {
                return ['all-german-seasons-1963-2025', ...seasonsList];
            }
            
            return seasonsList;
        }

        // Apply point deductions
        function applyPointDeductions(tableArray, filteredMatches, selectedLeagueDiv) {
            if (pointDeductions.length === 0 || !state.pointDeductionsEnabled) return tableArray;
            
            if (filteredMatches.length === 0) return tableArray;
            
            const matchDates = filteredMatches.map(match => match.dateObj);
            const filterStartDate = new Date(Math.min(...matchDates));
            const filterEndDate = new Date(Math.max(...matchDates));
            
            return tableArray.map(team => {
                let adjustedPoints = team.points;
                
                pointDeductions.forEach(deduction => {
                    if (deduction.team === team.team && deduction.league === selectedLeagueDiv) {
                        const deductionStart = new Date(deduction.startDate);
                        const deductionEnd = new Date(deduction.endDate);
                        
                        const hasOverlap = (filterStartDate <= deductionEnd) && (filterEndDate >= deductionStart);
                        
                        if (hasOverlap) {
                            adjustedPoints -= deduction.points;
                        }
                    }
                });
                
                return {
                    ...team,
                    points: Math.max(0, adjustedPoints),
                    originalPoints: team.points
                };
            });
        }

        // Calculate table (abbreviated - same logic as original)
        function calculateTable() {
            let filtered = [...state.data];
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const selectedDiv = leagueMapping[state.selectedLeague];
            filtered = filtered.filter(row => row.Div === selectedDiv);
            
            // Date filters
            if (state.dateFrom) {
                filtered = filtered.filter(row => {
                    const matchDateStr = new Date(row.dateObj).toISOString().split('T')[0];
                    return matchDateStr >= state.dateFrom;
                });
            }
            
            if (state.dateTo) {
                filtered = filtered.filter(row => {
                    const matchDateStr = new Date(row.dateObj).toISOString().split('T')[0];
                    return matchDateStr <= state.dateTo;
                });
            }
            
            // Day of week filter
            if (state.selectedDayOfWeek !== '') {
                filtered = filtered.filter(row => {
                    const dayOfWeek = row.dateObj.getDay();
                    return dayOfWeek.toString() === state.selectedDayOfWeek;
                });
            }
            
            if (state.selectedTeam1 && state.selectedTeam2) {
                // First filter for H2H matches
                filtered = filtered.filter(row => 
                    (row.HomeTeam === state.selectedTeam1 && row.AwayTeam === state.selectedTeam2) ||
                    (row.HomeTeam === state.selectedTeam2 && row.AwayTeam === state.selectedTeam1)
                );
                
                // Apply home/away filtering based on state (same logic as calculateHeadToHead)
                if (state.homeFilter && !state.awayFilter) {
                    // Show only matches where Team 1 is home
                    filtered = filtered.filter(row => row.HomeTeam === state.selectedTeam1);
                } else if (state.awayFilter && !state.homeFilter) {
                    // Show only matches where Team 1 is away
                    filtered = filtered.filter(row => row.AwayTeam === state.selectedTeam1);
                }
                // If both are checked or both unchecked, show all H2H matches
                
                // Apply recent H2H filter if specified
                if (state.recentH2HCount !== 'All') {
                    // Sort by date (most recent first) and take the specified number
                    filtered = filtered
                        .sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj))
                        .slice(0, parseInt(state.recentH2HCount));
                }
            } else if (state.selectedTeam1) {
                filtered = filtered.filter(row => row.HomeTeam === state.selectedTeam1 || row.AwayTeam === state.selectedTeam1);
            }
            
            // Determine teams to show
            let teamsToShow;
            if (state.selectedTeam1 && state.selectedTeam2) {
                teamsToShow = [state.selectedTeam1, state.selectedTeam2];
            } else if (state.selectedTeam1) {
                teamsToShow = [state.selectedTeam1];
            } else {
                teamsToShow = [...new Set([
                    ...filtered.map(row => row.HomeTeam),
                    ...filtered.map(row => row.AwayTeam)
                ])];
            }
            
            const table = {};
            teamsToShow.forEach(team => {
                table[team] = {
                    team: team,
                    played: 0,
                    won: 0,
                    drawn: 0,
                    lost: 0,
                    goalsFor: 0,
                    goalsAgainst: 0,
                    goalDifference: 0,
                    points: 0
                };
            });
            
            // Process matches with historical point systems
            filtered.forEach(match => {
                const homeTeam = table[match.HomeTeam];
                const awayTeam = table[match.AwayTeam];
                
                const homeGoals = parseInt(match.FTHG) || 0;
                const awayGoals = parseInt(match.FTAG) || 0;
                
                // Determine points system based on league and date
                let winPoints = 3;
                
                // If 3-point system is enabled, always use 3 points for wins
                if (state.threePointSystem) {
                    winPoints = 3;
                } else {
                    // Use historical point system
                    if (match.Div === 'I1' && match.dateObj <= new Date('1994-06-30')) {
                        winPoints = 2;
                    } else if (match.Div === 'SP1' && match.dateObj <= new Date('1995-06-30')) {
                        winPoints = 2;
                    } else if (match.Div === 'D1' && match.dateObj <= new Date('1995-06-30')) {
                        winPoints = 2;
                    } else if (match.Div === 'F1' && match.dateObj <= new Date('1994-06-30')) {
                        // Special case: 1988-89 season uses 3 points
                        if (match.dateObj >= new Date('1988-07-01') && match.dateObj <= new Date('1989-06-30')) {
                            winPoints = 3;
                        } else {
                            winPoints = 2;
                        }
                    } else if (match.Div === 'E0' && match.dateObj <= new Date('1981-06-30')) {
                        winPoints = 2;
                    }
                }
                
                // Home team stats
                if (homeTeam && (state.homeFilter || (state.selectedTeam1 && state.selectedTeam2))) {
                    homeTeam.played++;
                    homeTeam.goalsFor += homeGoals;
                    homeTeam.goalsAgainst += awayGoals;
                    
                    if (homeGoals > awayGoals) {
                        homeTeam.won++;
                        homeTeam.points += winPoints;
                    } else if (homeGoals < awayGoals) {
                        homeTeam.lost++;
                    } else {
                        homeTeam.drawn++;
                        homeTeam.points += 1;
                    }
                }
                
                // Away team stats
                if (awayTeam && (state.awayFilter || (state.selectedTeam1 && state.selectedTeam2))) {
                    awayTeam.played++;
                    awayTeam.goalsFor += awayGoals;
                    awayTeam.goalsAgainst += homeGoals;
                    
                    if (awayGoals > homeGoals) {
                        awayTeam.won++;
                        awayTeam.points += winPoints;
                    } else if (awayGoals < homeGoals) {
                        awayTeam.lost++;
                    } else {
                        awayTeam.drawn++;
                        awayTeam.points += 1;
                    }
                }
            });
            
            let tableArray = Object.values(table)
                .filter(team => team.played > 0)
                .map(team => ({
                    ...team,
                    goalDifference: team.goalsFor - team.goalsAgainst
                }));
            
            tableArray = applyPointDeductions(tableArray, filtered, selectedDiv);
            
            // First, sort by points to establish the base ranking
            let pointsSortedArray = [...tableArray].sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                return b.goalsFor - a.goalsFor;
            });
            
            // Apply ranking overrides for historic seasons to the points-sorted array
            if (!state.sortConfig.key) {
                pointsSortedArray = applyRankingOverrides(pointsSortedArray, state.selectedLeague, state.selectedSeason);
            } else {
                // Apply custom sorting if requested - work with pointsSortedArray to preserve position logic
                pointsSortedArray.sort((a, b) => {
                    let aVal = a[state.sortConfig.key];
                    let bVal = b[state.sortConfig.key];
                    
                    if (typeof aVal === 'string') {
                        return state.sortConfig.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    }
                    
                    return state.sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
                });
            }
            
            // Only apply position assignment logic when not using custom sorting
            if (!state.sortConfig.key) {
                // Add original position based on the final points/override ranking
                // Calculate positions properly handling ties and gaps
                
                // Step 1: Find all override positions and calculate blocked positions
                const overridePositions = [];
                const blockedPositions = new Set();
                
                pointsSortedArray.forEach(team => {
                    if (team.sharedPosition) {
                        overridePositions.push(team.sharedPosition);
                    }
                });
                
                // Group override positions and calculate blocked ranges
                const positionCounts = {};
                overridePositions.forEach(pos => {
                    positionCounts[pos] = (positionCounts[pos] || 0) + 1;
                });
                
                // Block positions based on ties (e.g., two 4s block positions 4 and 5)
                Object.keys(positionCounts).forEach(pos => {
                    const position = parseInt(pos);
                    const count = positionCounts[pos];
                    
                    // Block 'count' positions starting from 'position'
                    for (let i = 0; i < count; i++) {
                        blockedPositions.add(position + i);
                    }
                });
                
                // Step 2: Assign positions to regular teams (skip blocked positions)
                let currentPosition = 1;
                const regularTeams = pointsSortedArray.filter(team => !team.sharedPosition);
                
                regularTeams.forEach(team => {
                    // Find next available position (skip blocked ones)
                    while (blockedPositions.has(currentPosition)) {
                        currentPosition++;
                    }
                    
                    team.originalPosition = currentPosition;
                    currentPosition++;
                });
                
                // Step 3: Set override positions
                pointsSortedArray.forEach(team => {
                    if (team.sharedPosition) {
                        team.originalPosition = team.sharedPosition;
                    }
                });
                
                // Step 4: Sort teams by their final position for proper display order
                pointsSortedArray.sort((a, b) => {
                    if (a.originalPosition !== b.originalPosition) {
                        return a.originalPosition - b.originalPosition;
                    }
                    // If positions are equal, maintain original order (sub-order for tied teams)
                    return 0;
                });
            } else {
                // For custom sorting, just assign sequential positions based on current order
                pointsSortedArray.forEach((team, index) => {
                    team.originalPosition = index + 1;
                });
            }
            
            // Use the properly sorted array for display
            tableArray = pointsSortedArray;
            
            return { tableData: tableArray, matchCount: filtered.length };
        }

        // Calculate head-to-head stats (abbreviated - same logic as original)
        function calculateHeadToHead() {
            if (!state.selectedTeam1 || !state.selectedTeam2) return null;
            
            let filtered = [...state.data];
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const selectedDiv = leagueMapping[state.selectedLeague];
            filtered = filtered.filter(row => row.Div === selectedDiv);
            
            // Apply date filters
            if (state.dateFrom) {
                filtered = filtered.filter(row => {
                    const matchDateStr = new Date(row.dateObj).toISOString().split('T')[0];
                    return matchDateStr >= state.dateFrom;
                });
            }
            
            if (state.dateTo) {
                filtered = filtered.filter(row => {
                    const matchDateStr = new Date(row.dateObj).toISOString().split('T')[0];
                    return matchDateStr <= state.dateTo;
                });
            }
            
            // Day of week filter
            if (state.selectedDayOfWeek !== '') {
                filtered = filtered.filter(row => {
                    const dayOfWeek = row.dateObj.getDay();
                    return dayOfWeek.toString() === state.selectedDayOfWeek;
                });
            }
            
            // Filter for head-to-head matches
            let h2hMatches = filtered.filter(row => 
                (row.HomeTeam === state.selectedTeam1 && row.AwayTeam === state.selectedTeam2) ||
                (row.HomeTeam === state.selectedTeam2 && row.AwayTeam === state.selectedTeam1)
            ).sort((a, b) => new Date(b.dateObj) - new Date(a.dateObj));
            
            // Apply home/away filtering first (same logic as in updateH2HMatchesTable)
            if (state.homeFilter && !state.awayFilter) {
                // Only include matches where Team 1 is home
                h2hMatches = h2hMatches.filter(match => match.HomeTeam === state.selectedTeam1);
            } else if (state.awayFilter && !state.homeFilter) {
                // Only include matches where Team 1 is away  
                h2hMatches = h2hMatches.filter(match => match.AwayTeam === state.selectedTeam1);
            }
            // If both are selected, show all matches (no additional filtering)
            
            // Then apply recent match count limit to the already filtered matches
            if (state.recentH2HCount !== 'All') {
                const limit = parseInt(state.recentH2HCount) || 0;
                h2hMatches = h2hMatches.slice(0, limit);
            }
            
            // Calculate stats (abbreviated logic)
            const team1Home = h2hMatches.filter(match => match.HomeTeam === state.selectedTeam1);
            const team1HomeStats = { wins: 0, draws: 0, losses: 0, total: team1Home.length };
            
            team1Home.forEach(match => {
                const homeGoals = parseInt(match.FTHG) || 0;
                const awayGoals = parseInt(match.FTAG) || 0;
                if (homeGoals > awayGoals) team1HomeStats.wins++;
                else if (homeGoals < awayGoals) team1HomeStats.losses++;
                else team1HomeStats.draws++;
            });
            
            const team2Home = h2hMatches.filter(match => match.HomeTeam === state.selectedTeam2);
            const team2HomeStats = { wins: 0, draws: 0, losses: 0, total: team2Home.length };
            
            team2Home.forEach(match => {
                const homeGoals = parseInt(match.FTHG) || 0;
                const awayGoals = parseInt(match.FTAG) || 0;
                if (homeGoals > awayGoals) team2HomeStats.wins++;
                else if (homeGoals < awayGoals) team2HomeStats.losses++;
                else team2HomeStats.draws++;
            });
            
            return { 
                team1HomeStats, 
                team2HomeStats, 
                totalMatches: h2hMatches.length,
                matches: h2hMatches,
                overallStats: {
                    team1Wins: team1HomeStats.wins + team2HomeStats.losses,
                    draws: team1HomeStats.draws + team2HomeStats.draws,
                    team2Wins: team1HomeStats.losses + team2HomeStats.wins,
                    total: h2hMatches.length
                }
            };
        }

        // Update table and all related UI
        function updateTable() {
            if (state.data.length === 0) return;
            
            const tableResult = calculateTable();
            const h2hResult = calculateHeadToHead();
            
            updateTableDisplay(tableResult);
            updateHeadToHeadDisplay(h2hResult);
            updateTableInfo(tableResult);
            
            // Handle position colors for dark mode
            setTimeout(handlePositionColors, 50);
        }

        // Update table display
        function updateTableDisplay(tableResult) {
            const headers = [
                { key: 'position', label: 'Pos' },
                { key: 'team', label: 'Team' },
                { key: 'played', label: 'P' },
                { key: 'won', label: 'W' },
                { key: 'drawn', label: 'D' },
                { key: 'lost', label: 'L' },
                { key: 'goalsFor', label: 'GF' },
                { key: 'goalsAgainst', label: 'GA' },
                { key: 'goalDifference', label: 'GD' },
                { key: 'points', label: 'Pts' }
            ];
            
            elements.tableHeader.innerHTML = headers.map(header => `
                <th class="px-3 py-4 text-center font-bold text-sm cursor-pointer hover:bg-gray-600" 
                    onclick="handleSort('${header.key}')" 
                    style="text-align: ${header.key === 'team' ? 'left' : 'center'}">
                    ${header.label}${getSortIndicator(header.key)}
                </th>
            `).join('');
            
            // Update table body
            if (tableResult.tableData.length > 0) {
                elements.tableBody.innerHTML = tableResult.tableData.map((team, index) => {
                    const isHighlighted = (state.selectedTeam1 === team.team || state.selectedTeam2 === team.team);
                    
                    // Alternating row colors: only if 3+ teams, otherwise all white
                    const rowBackgroundClass = tableResult.tableData.length >= 3 && index % 2 === 1 ? 'bg-gray-50' : 'bg-white';
                    
                    return `
                        <tr class="border-b hover:bg-gray-50 ${isHighlighted ? 'highlight' : ''} ${rowBackgroundClass}">
                            <td class="px-3 py-4 text-center font-bold text-gray-600">${team.sharedPosition || team.originalPosition}</td>
                            <td class="px-4 py-4 font-semibold ${isHighlighted ? 'text-black' : 'text-gray-900'}">
                                <div class="flex items-center cursor-pointer hover:bg-gray-100 rounded p-2 -m-2 team-clickable" data-team="${team.team}" title="Click to view ${team.team} history">
                                    ${(() => {
                                        const logoUrl = getTeamLogoUrl(team.team, state.selectedLeague);
                                        return logoUrl ? `<img src="${logoUrl}" alt="${team.team} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : '';
                                    })()}
                                    <span class="hover:underline team-name-text">${team.team}</span>
                                </div>
                            </td>
                            <td class="px-3 py-4 text-center">${team.played}</td>
                            <td class="px-3 py-4 text-center">${team.won}</td>
                            <td class="px-3 py-4 text-center">${team.drawn}</td>
                            <td class="px-3 py-4 text-center">${team.lost}</td>
                            <td class="px-3 py-4 text-center">${team.goalsFor}</td>
                            <td class="px-3 py-4 text-center">${team.goalsAgainst}</td>
                            <td class="px-3 py-4 text-center">
                                <span class="font-bold ${team.goalDifference > 0 ? 'text-green-700' : team.goalDifference < 0 ? 'text-red-600' : 'text-black'}">
                                    ${team.goalDifference > 0 ? '+' : ''}${team.goalDifference}
                                </span>
                            </td>
                            <td class="px-3 py-4 text-center">
                                <span class="points-badge">
                                    ${team.points}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Remove any existing event listeners to avoid duplicates
                elements.tableBody.removeEventListener('click', handleTeamClick);
                
                // Add event delegation for team clicks
                elements.tableBody.addEventListener('click', handleTeamClick);
                // Team click event listener added to table body
                
                // Only show table if we're on the League Filters tab
                const isLeagueFiltersActive = document.getElementById('leagueFiltersTab').classList.contains('active');
                if (isLeagueFiltersActive) {
                    elements.tableContainer.classList.remove('hidden');
                } else {
                    elements.tableContainer.classList.add('hidden');
                }
            } else {
                elements.tableContainer.classList.add('hidden');
            }
        }

        // Update head-to-head display with custom team colors
        function updateHeadToHeadDisplay(h2hResult) {
            if (h2hResult && state.selectedTeam1 && state.selectedTeam2) {
                elements.h2hSection.classList.remove('hidden');
                
                // Get team colors
                const team1Color = getTeamColor(state.selectedTeam1, state.selectedLeague);
                const team2Color = getTeamColor(state.selectedTeam2, state.selectedLeague);
                
                // Default colors if no custom color found
                const team1Style = team1Color ? `background: ${team1Color} !important; color: ${getContrastColor(team1Color)} !important;` : '';
                const team2Style = team2Color ? `background: ${team2Color} !important; color: ${getContrastColor(team2Color)} !important;` : '';
                
                // Create H2H visualizations based on home/away filter selection
                let visualizationHTML = '';
                
                // Show overall stats only if both home and away are selected
                if (state.homeFilter && state.awayFilter) {
                    visualizationHTML += `
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">${state.selectedTeam1} vs ${state.selectedTeam2} (Overall)</span>
                                <span class="text-sm text-gray-600">${h2hResult.overallStats.team1Wins}W - ${h2hResult.overallStats.draws}D - ${h2hResult.overallStats.team2Wins}W</span>
                            </div>
                            <div class="h2h-viz-bar">
                                <div class="h2h-segment h2h-wins" style="width: ${(h2hResult.overallStats.team1Wins / h2hResult.overallStats.total) * 100}%; ${team1Style}">
                                    ${h2hResult.overallStats.team1Wins > 0 ? h2hResult.overallStats.team1Wins : ''}
                                </div>
                                <div class="h2h-segment h2h-draws" style="width: ${(h2hResult.overallStats.draws / h2hResult.overallStats.total) * 100}%">
                                    ${h2hResult.overallStats.draws > 0 ? h2hResult.overallStats.draws : ''}
                                </div>
                                <div class="h2h-segment h2h-losses" style="width: ${(h2hResult.overallStats.team2Wins / h2hResult.overallStats.total) * 100}%; ${team2Style}">
                                    ${h2hResult.overallStats.team2Wins > 0 ? h2hResult.overallStats.team2Wins : ''}
                                </div>
                            </div>
                        </div>`;
                }
                
                // Show Team1 Home scenario if home is selected (when HOME button is checked, show Team1 home matches)
                if (state.homeFilter) {
                    visualizationHTML += `
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">${state.selectedTeam1} (Home) vs ${state.selectedTeam2} (Away)</span>
                                <span class="text-sm text-gray-600">${h2hResult.team1HomeStats.wins}W - ${h2hResult.team1HomeStats.draws}D - ${h2hResult.team1HomeStats.losses}W</span>
                            </div>
                            ${h2hResult.team1HomeStats.total > 0 ? `
                            <div class="h2h-viz-bar">
                                <div class="h2h-segment h2h-wins" style="width: ${(h2hResult.team1HomeStats.wins / h2hResult.team1HomeStats.total) * 100}%; ${team1Style}">
                                    ${h2hResult.team1HomeStats.wins > 0 ? h2hResult.team1HomeStats.wins : ''}
                                </div>
                                <div class="h2h-segment h2h-draws" style="width: ${(h2hResult.team1HomeStats.draws / h2hResult.team1HomeStats.total) * 100}%">
                                    ${h2hResult.team1HomeStats.draws > 0 ? h2hResult.team1HomeStats.draws : ''}
                                </div>
                                <div class="h2h-segment h2h-losses" style="width: ${(h2hResult.team1HomeStats.losses / h2hResult.team1HomeStats.total) * 100}%; ${team2Style}">
                                    ${h2hResult.team1HomeStats.losses > 0 ? h2hResult.team1HomeStats.losses : ''}
                                </div>
                            </div>
                            ` : '<div class="text-sm text-gray-500 italic">No matches found</div>'}
                        </div>`;
                }
                
                // Show Team2 Home scenario if away is selected (when AWAY button is checked, show Team2 home matches)
                if (state.awayFilter) {
                    visualizationHTML += `
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">${state.selectedTeam2} (Home) vs ${state.selectedTeam1} (Away)</span>
                                <span class="text-sm text-gray-600">${h2hResult.team2HomeStats.wins}W - ${h2hResult.team2HomeStats.draws}D - ${h2hResult.team2HomeStats.losses}W</span>
                            </div>
                            ${h2hResult.team2HomeStats.total > 0 ? `
                            <div class="h2h-viz-bar">
                                <div class="h2h-segment h2h-wins" style="width: ${(h2hResult.team2HomeStats.wins / h2hResult.team2HomeStats.total) * 100}%; ${team2Style}">
                                    ${h2hResult.team2HomeStats.wins > 0 ? h2hResult.team2HomeStats.wins : ''}
                                </div>
                                <div class="h2h-segment h2h-draws" style="width: ${(h2hResult.team2HomeStats.draws / h2hResult.team2HomeStats.total) * 100}%">
                                    ${h2hResult.team2HomeStats.draws > 0 ? h2hResult.team2HomeStats.draws : ''}
                                </div>
                                <div class="h2h-segment h2h-losses" style="width: ${(h2hResult.team2HomeStats.losses / h2hResult.team2HomeStats.total) * 100}%; ${team1Style}">
                                    ${h2hResult.team2HomeStats.losses > 0 ? h2hResult.team2HomeStats.losses : ''}
                                </div>
                            </div>
                            ` : '<div class="text-sm text-gray-500 italic">No matches found</div>'}
                        </div>`;
                }
                
                elements.h2hVisualizations.innerHTML = visualizationHTML;
                
                // Update H2H matches table based on filter state
                updateH2HMatchesTable(h2hResult);
            } else {
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
            }
        }

        // Update H2H matches table
        function updateH2HMatchesTable(h2hResult) {
            if (!h2hResult || !h2hResult.matches || h2hResult.matches.length === 0) {
                elements.h2hMatchesTable.classList.add('hidden');
                return;
            }

            // Hide the Match History table if both home and away filters are unchecked
            if (!state.homeFilter && !state.awayFilter) {
                elements.h2hMatchesTable.classList.add('hidden');
                return;
            }

            elements.h2hMatchesTable.classList.remove('hidden');
            elements.h2hTableTitle.textContent = `${state.selectedTeam1} vs ${state.selectedTeam2}`;

            // Create sorted matches data
            let matchesData = h2hResult.matches.map(match => {
                const homeScore = parseInt(match.FTHG) || 0;
                const awayScore = parseInt(match.FTAG) || 0;
                
                // Get team colors first
                const homeTeamColor = getTeamColor(match.HomeTeam, state.selectedLeague);
                const awayTeamColor = getTeamColor(match.AwayTeam, state.selectedLeague);
                
                // Determine winner and score colors
                let winnerTeam = '';
                let homeScoreClass = '';
                let awayScoreClass = '';
                let resultStyle = '';
                
                if (homeScore > awayScore) {
                    // Home team wins
                    winnerTeam = match.HomeTeam;
                    homeScoreClass = 'font-bold';
                    awayScoreClass = 'text-red-600 font-bold';
                    resultStyle = homeTeamColor ? 
                        `color: ${homeTeamColor} !important; font-weight: bold;` : 
                        'color: #059669 !important; font-weight: bold;'; // Default green
                } else if (awayScore > homeScore) {
                    // Away team wins
                    winnerTeam = match.AwayTeam;
                    homeScoreClass = 'text-red-600 font-bold';
                    awayScoreClass = 'font-bold';
                    resultStyle = awayTeamColor ? 
                        `color: ${awayTeamColor} !important; font-weight: bold;` : 
                        'color: #059669 !important; font-weight: bold;'; // Default green
                } else {
                    // Draw
                    winnerTeam = 'Draw';
                    homeScoreClass = 'text-gray-400 font-bold';
                    awayScoreClass = 'text-gray-400 font-bold';
                    resultStyle = 'color: #9ca3af !important; font-weight: bold;'; // Lighter gray for draws
                }

                // Add team highlights - blue for Team 1, green for Team 2 (subtle like points badge)
                const isHomeTeam1 = match.HomeTeam === state.selectedTeam1;
                const isHomeTeam2 = match.HomeTeam === state.selectedTeam2;
                const isAwayTeam1 = match.AwayTeam === state.selectedTeam1;
                const isAwayTeam2 = match.AwayTeam === state.selectedTeam2;
                
                // Create subtle highlight classes similar to points-badge
                const homeTeamClass = isHomeTeam1 ? 'team1-highlight' : 
                                    isHomeTeam2 ? 'team2-highlight' : '';
                const awayTeamClass = isAwayTeam1 ? 'team1-highlight' : 
                                    isAwayTeam2 ? 'team2-highlight' : '';
                
                // Combine team color with highlight classes for inline styles  
                const homeTeamFinalStyle = homeTeamColor ? `color: ${homeTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
                const awayTeamFinalStyle = awayTeamColor ? `color: ${awayTeamColor} !important; font-weight: bold;` : 'font-weight: bold;';
                
                // Update result style to include subtle highlight for winner (but not for draws)
                let finalResultStyle = resultStyle;
                let resultClass = '';
                if (winnerTeam !== 'Draw') {
                    if (winnerTeam === state.selectedTeam1) {
                        resultClass = 'team1-highlight';
                    } else if (winnerTeam === state.selectedTeam2) {
                        resultClass = 'team2-highlight';
                    }
                }

                return {
                    date: match.dateObj.toLocaleDateString(),
                    dateSort: match.dateObj,
                    homeTeam: match.HomeTeam,
                    homeTeamColor: homeTeamColor,
                    homeTeamStyle: homeTeamFinalStyle,
                    homeTeamClass: homeTeamClass,
                    homeScore: homeScore,
                    homeScoreClass: homeScoreClass,
                    awayTeam: match.AwayTeam,
                    awayTeamColor: awayTeamColor,
                    awayTeamStyle: awayTeamFinalStyle,
                    awayTeamClass: awayTeamClass,
                    awayScore: awayScore,
                    awayScoreClass: awayScoreClass,
                    result: winnerTeam,
                    resultStyle: finalResultStyle,
                    resultClass: resultClass
                };
            });

            // Note: Filtering and recent match count limiting is now done in calculateHeadToHead()
            // The matches passed here are already filtered and limited

            // Sort by current sort config
            if (state.h2hSortConfig.key) {
                matchesData.sort((a, b) => {
                    const key = state.h2hSortConfig.key;
                    let aVal = key === 'date' ? a.dateSort : a[key];
                    let bVal = key === 'date' ? b.dateSort : b[key];
                    
                    if (key === 'homeScore' || key === 'awayScore') {
                        aVal = parseInt(aVal) || 0;
                        bVal = parseInt(bVal) || 0;
                    }
                    
                    if (state.h2hSortConfig.direction === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });
            }

            // Update match count display with filtered count
            elements.h2hMatchCount.textContent = `(${matchesData.length} matches)`;

            // Create table headers
            const headers = [
                { key: 'date', label: 'Date' },
                { key: 'homeTeam', label: 'Home Team' },
                { key: 'homeScore', label: 'Home Score' },
                { key: 'awayTeam', label: 'Away Team' },
                { key: 'awayScore', label: 'Away Score' },
                { key: 'result', label: 'Result' }
            ];

            elements.h2hTableHeader.innerHTML = headers.map(header => `
                <th class="${header.key.includes('Team') ? 'text-center' : 'text-center'} cursor-pointer" 
                    onclick="handleH2hSort('${header.key}')">
                    ${header.label}${getH2hSortIndicator(header.key)}
                </th>
            `).join('');

            // Update table body
            elements.h2hTableBody.innerHTML = matchesData.map((match, index) => {
                const isTeam1Home = match.homeTeam === state.selectedTeam1;
                const isTeam1Away = match.awayTeam === state.selectedTeam1;
                
                // Get team logos
                const homeLogoUrl = getTeamLogoUrl(match.homeTeam, state.selectedLeague);
                const awayLogoUrl = getTeamLogoUrl(match.awayTeam, state.selectedLeague);
                
                // Get winner logo for result column (if not a draw)
                const winnerLogoUrl = match.result !== 'Draw' ? getTeamLogoUrl(match.result, state.selectedLeague) : null;
                
                return `
                    <tr class="${(isTeam1Home || isTeam1Away) ? 'highlight' : ''}">
                        <td class="text-center text-sm">${match.date}</td>
                        <td class="text-center">
                            <div class="flex items-center justify-center">
                                ${homeLogoUrl ? `<img src="${homeLogoUrl}" alt="${match.homeTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="${match.homeTeamClass}" style="${match.homeTeamStyle}">${match.homeTeam}</span>
                            </div>
                        </td>
                        <td class="text-center text-lg ${match.homeScoreClass}" ${match.homeScoreClass === 'font-bold' ? 'style="color: #047857;"' : ''}>${match.homeScore}</td>
                        <td class="text-center">
                            <div class="flex items-center justify-center">
                                ${awayLogoUrl ? `<img src="${awayLogoUrl}" alt="${match.awayTeam} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="${match.awayTeamClass}" style="${match.awayTeamStyle}">${match.awayTeam}</span>
                            </div>
                        </td>
                        <td class="text-center text-lg ${match.awayScoreClass}" ${match.awayScoreClass === 'font-bold' ? 'style="color: #047857;"' : ''}>${match.awayScore}</td>
                        <td class="text-center">
                            <div class="flex items-center justify-center">
                                ${winnerLogoUrl ? `<img src="${winnerLogoUrl}" alt="${match.result} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span class="${match.resultClass}" style="${match.resultStyle}">${match.result}</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Handle H2H table sorting
        function handleH2hSort(key) {
            let direction = 'desc';
            if (key === 'homeTeam' || key === 'awayTeam' || key === 'result') {
                direction = 'asc';
            }
            
            if (state.h2hSortConfig.key === key) {
                if (state.h2hSortConfig.direction === 'desc') {
                    state.h2hSortConfig.direction = 'asc';
                } else if (state.h2hSortConfig.direction === 'asc') {
                    state.h2hSortConfig.direction = 'desc';
                } else {
                    state.h2hSortConfig.direction = direction;
                }
            } else {
                state.h2hSortConfig.key = key;
                state.h2hSortConfig.direction = direction;
            }
            
            updateTable();
        }

        // Get H2H sort indicator
        function getH2hSortIndicator(key) {
            if (state.h2hSortConfig.key !== key) return ' ‚ÜïÔ∏è';
            return state.h2hSortConfig.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
        }

        // Update table info display
        function updateTableInfo(tableResult) {
            if (state.data.length > 0) {
                const leagueNames = {
                    'premier-league': 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League',
                    'la-liga': 'üá™üá∏ La Liga',
                    'serie-a': 'üáÆüáπ Serie A',
                    'bundesliga': 'üá©üá™ Bundesliga',
                    'ligue-1': 'üá´üá∑ Ligue 1'
                };
                
                let text = leagueNames[state.selectedLeague];
                
                if (state.homeFilter && state.awayFilter) text += ' - All Results';
                else if (state.homeFilter) text += ' - Home Results Only';
                else if (state.awayFilter) text += ' - Away Results Only';
                else text += ' - No Results Selected';
                
                text += ` (${tableResult.matchCount} matches) ‚Ä¢ ${tableResult.tableData.length} teams`;
                
                elements.tableInfoText.textContent = text;
                
                // Only show table info if we're on the League Filters tab
                const isLeagueFiltersActive = document.getElementById('leagueFiltersTab').classList.contains('active');
                if (isLeagueFiltersActive) {
                    elements.tableInfo.classList.remove('hidden');
                } else {
                    elements.tableInfo.classList.add('hidden');
                }
            } else {
                elements.tableInfo.classList.add('hidden');
            }
        }

        // Get historical point system based on season and league
        function getHistoricalPointSystem(season, league) {
            // Extract starting year from season (e.g., "1994-95" -> 1994)
            const year = parseInt(season.split('-')[0]);
            
            // 3-point system introduction dates by league
            const threePointIntroduction = {
                'premier-league': 1981,  // English First Division introduced 3 points in 1981-82
                'la-liga': 1995,         // La Liga introduced 3 points in 1995-96
                'serie-a': 1994,         // Serie A introduced 3 points in 1994-95
                'bundesliga': 1995,      // Bundesliga introduced 3 points in 1995-96
                'ligue-1': 1994          // Ligue 1 introduced 3 points in 1994-95
            };
            
            const introYear = threePointIntroduction[league];
            
            // For Ligue 1, special handling for 1988-89 season
            if (league === 'ligue-1') {
                if (year >= introYear || year === 1988) {
                    return 3; // 3 points for a win (>=1994 or 1988)
                } else {
                    return 2; // 2 points for a win (<1994 and !=1988)
                }
            } else {
                // For other leagues, use standard logic
                if (introYear && year >= introYear) {
                    return 3; // 3 points for a win
                } else {
                    return 2; // 2 points for a win (historical system)
                }
            }
        }


        // Handle team click events
        function handleTeamClick(event) {
            // Team click event triggered
            const teamClickable = event.target.closest('.team-clickable');
            // Found team clickable element
            if (teamClickable) {
                event.preventDefault();
                event.stopPropagation();
                const teamName = teamClickable.getAttribute('data-team');
                // Team name found
                if (teamName) {
                    // Calling showTeamHistory without auto-detecting league
                    // This preserves the current league selection
                    showTeamHistory(teamName);
                } else {
                    // No team name found in data-team attribute
                }
            } else {
                // No team-clickable element found
            }
        }

        // Show team history across seasons
        function showTeamHistory(teamName, sourceLeague = null) {
            // showTeamHistory called
            // Current state.data length
            
            // Determine which league to use based on source
            let leagueToUse;
            if (sourceLeague) {
                // Called from Team Seasons dropdown - use the specified league
                leagueToUse = sourceLeague;
                state.teamSeasonsSelectedLeague = sourceLeague;
            } else {
                // Called from team click - preserve current Team Seasons league state
                // Don't sync with main state to avoid unwanted league switching
                leagueToUse = state.teamSeasonsSelectedLeague || state.selectedLeague;
                // Keep current teamSeasonsSelectedLeague, don't change it
            }
            
            state.teamSeasonsSelectedTeam = teamName;
            // Using league
            
            const leagueMapping = {
                'premier-league': 'E0',
                'la-liga': 'SP1',
                'serie-a': 'I1',
                'bundesliga': 'D1',
                'ligue-1': 'F1'
            };
            
            const divCode = leagueMapping[leagueToUse];
            if (!divCode) return;
            
            // Get all available seasons for this league
            const availableSeasons = getAvailableSeasons(leagueToUse);
            // Available seasons found
            const teamHistoryData = [];
            
            // Filter seasons based on Team Seasons selection (if any)
            let seasonsToProcess = availableSeasons;
            if (sourceLeague && state.teamSeasonsSelectedSeason) {
                // For era seasons, filter individual seasons to only those within the era date range
                if (state.teamSeasonsSelectedSeason.includes('all-') || state.teamSeasonsSelectedSeason.includes('-era-') || state.teamSeasonsSelectedSeason.includes('french-division-1')) {
                    const originalSelectedLeague = state.selectedLeague;
                    state.selectedLeague = leagueToUse;
                    const eraSeasonDates = getSeasonDateRange(state.teamSeasonsSelectedSeason);
                    state.selectedLeague = originalSelectedLeague;
                    
                    if (eraSeasonDates) {
                        const eraStart = new Date(eraSeasonDates.start);
                        const eraEnd = new Date(eraSeasonDates.end);
                        
                        // Filter individual seasons to only those that fall within the era
                        seasonsToProcess = availableSeasons.filter(season => {
                            // Skip era seasons themselves in this filtering
                            if (season.includes('all-') || season.includes('-era-') || season.includes('french-division-1')) {
                                return false;
                            }
                            
                            const originalSelectedLeague2 = state.selectedLeague;
                            state.selectedLeague = leagueToUse;
                            const seasonDates = getSeasonDateRange(season);
                            state.selectedLeague = originalSelectedLeague2;
                            
                            if (!seasonDates) return false;
                            
                            const seasonStart = new Date(seasonDates.start);
                            const seasonEnd = new Date(seasonDates.end);
                            
                            // Include season if it starts on or after era start and ends before or on era end
                            return seasonStart >= eraStart && seasonEnd <= eraEnd;
                        });
                    }
                } else {
                    // For individual seasons (shouldn't happen in Team Seasons but keeping for safety)
                    seasonsToProcess = [state.teamSeasonsSelectedSeason];
                }
            }

            // Check each season for the team's data
            seasonsToProcess.forEach(seasonFilter => {
                // Skip special seasons like "all" seasons, era seasons, and french division 1
                if (seasonFilter.includes('all-') || seasonFilter.includes('-era-') || seasonFilter.includes('french-division-1')) {
                    return;
                }
                
                // Processing season for team
                
                // Get season date range
                const originalSelectedLeague = state.selectedLeague;
                state.selectedLeague = leagueToUse; // Temporarily set for date range lookup
                const seasonDates = getSeasonDateRange(seasonFilter);
                state.selectedLeague = originalSelectedLeague; // Restore original
                if (!seasonDates) {
                    // No season dates found
                    return;
                }
                // Season dates found
                
                // Filter data for this season - use date-only comparisons
                const seasonStart = new Date(seasonDates.start);
                seasonStart.setUTCHours(0, 0, 0, 0); // Start of day UTC
                const seasonEnd = new Date(seasonDates.end);
                seasonEnd.setUTCHours(23, 59, 59, 999); // End of day UTC
                
                // Extract the year from the season (e.g., "2019-20" -> 2019, "2020-21" -> 2020)
                const seasonYear = parseInt(seasonFilter.split('-')[0]);
                
                // Get ALL games for this season (not just for the selected team)
                const allSeasonData = state.data.filter(row => {
                    if (row.Div !== divCode) return false;
                    
                    const matchDate = new Date(row.dateObj);
                    const gameYear = matchDate.getFullYear();
                    
                    // Pre-filter: only consider games from years that could belong to this season
                    // For season "2019-20", only look at games from 2019 and 2020
                    if (gameYear < seasonYear || gameYear > seasonYear + 1) return false;
                    
                    const inRange = matchDate >= seasonStart && matchDate <= seasonEnd;
                    
                    
                    return inRange;
                });
                
                // Get games specifically for this team
                const teamMatches = allSeasonData.filter(row => 
                    row.HomeTeam === teamName || row.AwayTeam === teamName
                );
                
                if (teamMatches.length === 0) return; // Team not present in this season
                
                // Calculate team stats for this season
                let played = 0, won = 0, drawn = 0, lost = 0;
                let goalsFor = 0, goalsAgainst = 0;
                
                teamMatches.forEach(match => {
                    played++;
                    const homeGoals = parseInt(match.FTHG) || 0;
                    const awayGoals = parseInt(match.FTAG) || 0;
                    
                    
                    if (match.HomeTeam === teamName) {
                        goalsFor += homeGoals;
                        goalsAgainst += awayGoals;
                        if (homeGoals > awayGoals) won++;
                        else if (homeGoals === awayGoals) drawn++;
                        else lost++;
                    } else {
                        goalsFor += awayGoals;
                        goalsAgainst += homeGoals;
                        if (awayGoals > homeGoals) won++;
                        else if (awayGoals === homeGoals) drawn++;
                        else lost++;
                    }
                });
                
                const goalDifference = goalsFor - goalsAgainst;
                const winPoints = getHistoricalPointSystem(seasonFilter, leagueToUse);
                let points = won * winPoints + drawn;
                
                // Apply point deductions for this season
                if (seasonDates) {
                    const seasonStart = new Date(seasonDates.start);
                    const seasonEnd = new Date(seasonDates.end);
                    
                    pointDeductions.forEach(deduction => {
                        if (deduction.team === teamName && deduction.league === divCode) {
                            const deductionStart = new Date(deduction.startDate);
                            const deductionEnd = new Date(deduction.endDate);
                            
                            const hasOverlap = (seasonStart <= deductionEnd) && (seasonEnd >= deductionStart);
                            
                            if (hasOverlap && state.pointDeductionsEnabled) {
                                points -= deduction.points;
                            }
                        }
                    });
                }
                
                // Calculate position by building full league table for this season
                const leagueTeams = {};
                allSeasonData.forEach(match => {
                    [match.HomeTeam, match.AwayTeam].forEach(team => {
                        if (!leagueTeams[team]) {
                            leagueTeams[team] = { played: 0, won: 0, drawn: 0, lost: 0, goalsFor: 0, goalsAgainst: 0 };
                        }
                    });
                });
                
                // Calculate stats for all teams
                allSeasonData.forEach(match => {
                    const homeGoals = parseInt(match.FTHG) || 0;
                    const awayGoals = parseInt(match.FTAG) || 0;
                    
                    leagueTeams[match.HomeTeam].played++;
                    leagueTeams[match.AwayTeam].played++;
                    
                    leagueTeams[match.HomeTeam].goalsFor += homeGoals;
                    leagueTeams[match.HomeTeam].goalsAgainst += awayGoals;
                    leagueTeams[match.AwayTeam].goalsFor += awayGoals;
                    leagueTeams[match.AwayTeam].goalsAgainst += homeGoals;
                    
                    if (homeGoals > awayGoals) {
                        leagueTeams[match.HomeTeam].won++;
                        leagueTeams[match.AwayTeam].lost++;
                    } else if (homeGoals === awayGoals) {
                        leagueTeams[match.HomeTeam].drawn++;
                        leagueTeams[match.AwayTeam].drawn++;
                    } else {
                        leagueTeams[match.HomeTeam].lost++;
                        leagueTeams[match.AwayTeam].won++;
                    }
                });
                
                // Convert to array and calculate points
                const winPointsForSeason = getHistoricalPointSystem(seasonFilter, leagueToUse);
                const seasonTable = Object.keys(leagueTeams).map(team => {
                    const stats = leagueTeams[team];
                    let teamPoints = stats.won * winPointsForSeason + stats.drawn;
                    
                    // Apply point deductions for each team
                    if (seasonDates) {
                        const seasonStart = new Date(seasonDates.start);
                        const seasonEnd = new Date(seasonDates.end);
                        
                        pointDeductions.forEach(deduction => {
                            if (deduction.team === team && deduction.league === divCode) {
                                const deductionStart = new Date(deduction.startDate);
                                const deductionEnd = new Date(deduction.endDate);
                                
                                const hasOverlap = (seasonStart <= deductionEnd) && (seasonEnd >= deductionStart);
                                
                                if (hasOverlap && state.pointDeductionsEnabled) {
                                    teamPoints -= deduction.points;
                                }
                            }
                        });
                    }
                    
                    return {
                        team,
                        ...stats,
                        goalDifference: stats.goalsFor - stats.goalsAgainst,
                        points: teamPoints
                    };
                });
                
                // Sort by points, then goal difference, then goals for
                seasonTable.sort((a, b) => {
                    if (b.points !== a.points) return b.points - a.points;
                    if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                    return b.goalsFor - a.goalsFor;
                });
                
                // Apply ranking overrides for this season
                const overriddenTable = applyRankingOverrides(seasonTable, leagueToUse, seasonFilter);
                
                // Note: Don't re-sort after overrides as it would undo the override positioning
                
                // Find team position (check for override position first)
                let position;
                const teamInTable = overriddenTable.find(team => team.team === teamName);
                if (teamInTable && teamInTable.sharedPosition) {
                    position = teamInTable.sharedPosition;
                } else {
                    position = overriddenTable.findIndex(team => team.team === teamName) + 1;
                }
                
                teamHistoryData.push({
                    season: seasonFilter,
                    position,
                    played,
                    won,
                    drawn,
                    lost,
                    goalsFor,
                    goalsAgainst,
                    goalDifference,
                    points
                });
            });
            
            // Sort by season (most recent first)
            teamHistoryData.sort((a, b) => {
                // Extract year from season string (e.g., "2023-24" -> 2023)
                const yearA = parseInt(a.season.split('-')[0]);
                const yearB = parseInt(b.season.split('-')[0]);
                return yearB - yearA;
            });
            
            // Team history data found
            // Sample data processed
            
            displayTeamHistory(teamName, teamHistoryData, leagueToUse);
        }

        // Display team history table
        function displayTeamHistory(teamName, historyData, leagueToUse) {
            // displayTeamHistory called
            // History data processed
            
            // Filter by position if selected
            let filteredData = [...historyData];
            let positionInfo = '';
            
            if (state.teamSeasonsSelectedPosition) {
                const selectedPos = parseInt(state.teamSeasonsSelectedPosition);
                // Filter by position, excluding only current season if under 34 games
                filteredData = historyData.filter(season => {
                    if (season.position !== selectedPos) return false;
                    
                    // Always include seasons with 34+ games
                    if (season.played >= 34) return true;
                    
                    // For seasons under 34 games, exclude only if it's the current season (2025-26)
                    const isCurrentSeason = season.season === '2025-26';
                    return !isCurrentSeason;
                }).filter(season => {
                    // Apply stripped champions filtering (both team and position are selected)
                    const leagueMapping = {
                        'premier-league': 'E0',
                        'la-liga': 'SP1',
                        'serie-a': 'I1',
                        'bundesliga': 'D1',
                        'ligue-1': 'F1'
                    };
                    const divCode = leagueMapping[leagueToUse];
                    return !isStrippedChampion(teamName, divCode, season.season, season.position, true, true);
                });
                
                // Calculate years since last occurrence
                if (filteredData.length > 0) {
                    // Sort by season to find most recent season
                    const sortedByYear = [...filteredData].sort((a, b) => {
                        const yearA = parseInt(a.season.split('-')[0]);
                        const yearB = parseInt(b.season.split('-')[0]);
                        return yearB - yearA;
                    });
                    
                    // Most recent season (already qualifies since we filtered for 34+ games)
                    const qualifyingSeason = sortedByYear[0];
                    
                    // Count total times finished at this position (34+ games only)
                    const totalCount = filteredData.length;
                    
                    const mostRecentYear = parseInt(qualifyingSeason.season.split('-')[0]);
                    const currentYear = new Date().getFullYear();
                    
                    // Calculate seasons since the qualifying season
                    const seasonsSince = currentYear - mostRecentYear;
                    
                    const seasonText = seasonsSince === 0 ? '0 Seasons Ago (Current Season)' : 
                                     seasonsSince === 1 ? '1 Season Ago' : `${seasonsSince} Seasons Ago`;
                    
                    const countText = totalCount === 1 ? 'Time' : 'Times';
                    positionInfo = `Most Recent: ${qualifyingSeason.season} Season, ${seasonText}. Finished ${getOrdinal(selectedPos)} a total of ${totalCount} ${countText}.`;
                } else {
                    positionInfo = `No seasons found where ${teamName} finished ${getOrdinal(selectedPos)} (excluding incomplete current season)`;
                }
            }
            
            // Update position info display
            elements.teamSeasonsPositionInfo.textContent = positionInfo;
            
            // Store data globally for sorting
            window.currentTeamHistoryData = [...filteredData];
            window.currentTeamHistoryName = teamName;
            
            elements.teamHistoryTitle.textContent = `${teamName} - Season History`;
            
            // Apply sorting if active
            let sortedData = [...filteredData];
            if (state.teamHistorySortConfig.key && state.teamHistorySortConfig.direction) {
                const key = state.teamHistorySortConfig.key;
                const direction = state.teamHistorySortConfig.direction;
                
                sortedData.sort((a, b) => {
                    let aVal = a[key];
                    let bVal = b[key];
                    
                    // Handle season sorting specially
                    if (key === 'season') {
                        // Extract year from season string (e.g., "2023-24" -> 2023)
                        aVal = parseInt(aVal.split('-')[0]);
                        bVal = parseInt(bVal.split('-')[0]);
                    }
                    
                    // Convert to numbers for numerical columns
                    if (typeof aVal === 'string' && !isNaN(aVal)) aVal = parseFloat(aVal);
                    if (typeof bVal === 'string' && !isNaN(bVal)) bVal = parseFloat(bVal);
                    
                    if (direction === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });
            }
            
            const headers = [
                { key: 'season', label: 'Season' },
                { key: 'team', label: 'Team' },
                { key: 'played', label: 'P' },
                { key: 'won', label: 'W' },
                { key: 'drawn', label: 'D' },
                { key: 'lost', label: 'L' },
                { key: 'goalsFor', label: 'GF' },
                { key: 'goalsAgainst', label: 'GA' },
                { key: 'goalDifference', label: 'GD' },
                { key: 'points', label: 'Pts' },
                { key: 'position', label: 'Pos' }
            ];
            
            elements.teamHistoryHeader.innerHTML = headers.map(header => `
                <th class="px-3 py-4 text-center font-bold text-sm ${header.key !== 'team' ? 'cursor-pointer hover:bg-gray-600' : ''}" 
                    ${header.key !== 'team' ? `onclick="handleTeamHistorySort('${header.key}')"` : ''}
                    style="text-align: ${(header.key === 'season' || header.key === 'team') ? 'left' : 'center'}">
                    ${header.label}${header.key !== 'team' ? getTeamHistorySortIndicator(header.key) : ''}
                </th>
            `).join('');
            
            elements.teamHistoryBody.innerHTML = sortedData.map((season, index) => {
                const rowBackgroundClass = sortedData.length >= 3 && index % 2 === 1 ? 'bg-gray-50' : 'bg-white';
                const logoUrl = getTeamLogoUrl(teamName, leagueToUse);
                
                return `
                    <tr class="border-b hover:bg-gray-50 ${rowBackgroundClass}">
                        <td class="px-3 py-4 font-semibold text-left">${season.season}</td>
                        <td class="px-4 py-4 font-semibold text-gray-900">
                            <div class="flex items-center">
                                ${logoUrl ? `<img src="${logoUrl}" alt="${teamName} logo" class="w-5 h-5 mr-2 object-contain" onerror="this.style.display='none'">` : ''}
                                <span>${teamName}</span>
                            </div>
                        </td>
                        <td class="px-3 py-4 text-center">${season.played}</td>
                        <td class="px-3 py-4 text-center">${season.won}</td>
                        <td class="px-3 py-4 text-center">${season.drawn}</td>
                        <td class="px-3 py-4 text-center">${season.lost}</td>
                        <td class="px-3 py-4 text-center">${season.goalsFor}</td>
                        <td class="px-3 py-4 text-center">${season.goalsAgainst}</td>
                        <td class="px-3 py-4 text-center">
                            <span class="font-bold ${season.goalDifference > 0 ? 'text-green-700' : season.goalDifference < 0 ? 'text-red-600' : 'text-black'}">
                                ${season.goalDifference > 0 ? '+' : ''}${season.goalDifference}
                            </span>
                        </td>
                        <td class="px-3 py-4 text-center">
                            <span class="points-badge">
                                ${season.points}
                            </span>
                        </td>
                        <td class="px-3 py-4 text-center font-bold" style="${
                            season.position === 1 ? 'color: #d97706; background-color: #fef3c7;' : 
                            season.position === 2 ? 'color: #374151; background-color: #e5e7eb;' : 
                            season.position === 3 ? 'color: #b45309; background-color: #fef7ed;' : 
                            'color: #6b7280;'
                        }">${season.position}</td>
                    </tr>
                `;
            }).join('');
            
            // Switch to Team Seasons tab and show the table
            switchTab('team-seasons');
            
            // Update Team Seasons controls to reflect current selection
            createTeamSeasonsLeagueButtons();
            updateTeamSeasonsTeamSelect();
            
            // Final teamHistoryData processed
            elements.teamHistoryTable.classList.remove('hidden');
            // Team history table should now be visible
        }

        // Handle sorting
        function handleSort(key) {
            // Determine if this is a numerical column
            const numericalColumns = ['played', 'won', 'drawn', 'lost', 'goalsFor', 'goalsAgainst', 'goalDifference', 'points'];
            const isNumerical = numericalColumns.includes(key);
            
            // Set initial direction based on column type
            let direction = key === 'team' ? 'asc' : 'desc'; // Team: A-Z first, Numbers: high to low first
            
            if (state.sortConfig.key === key) {
                if (isNumerical) {
                    // Numerical columns: desc -> asc -> clear
                    if (state.sortConfig.direction === 'desc') {
                        direction = 'asc';
                    } else if (state.sortConfig.direction === 'asc') {
                        state.sortConfig = { key: null, direction: null };
                        updateTable();
                        return;
                    }
                } else {
                    // Team column: asc -> desc -> clear
                    if (state.sortConfig.direction === 'asc') {
                        direction = 'desc';
                    } else if (state.sortConfig.direction === 'desc') {
                        state.sortConfig = { key: null, direction: null };
                        updateTable();
                        return;
                    }
                }
            }
            
            state.sortConfig = { key, direction };
            updateTable();
        }

        // Handle team history sorting
        function handleTeamHistorySort(key) {
            // Determine if this is a numerical column
            const numericalColumns = ['position', 'count', 'played', 'won', 'drawn', 'lost', 'goalsFor', 'goalsAgainst', 'goalDifference', 'points'];
            const isNumerical = numericalColumns.includes(key);
            
            // Set initial direction based on column type
            let direction = key === 'season' ? 'desc' : 'desc'; // Season: newest first, Numbers: high to low first
            
            if (state.teamHistorySortConfig.key === key) {
                // Already sorting by this key, cycle through directions
                // 3-click cycle for ALL columns: desc -> asc -> null
                if (state.teamHistorySortConfig.direction === 'desc') {
                    direction = 'asc';
                } else if (state.teamHistorySortConfig.direction === 'asc') {
                    direction = null;
                } else {
                    direction = 'desc';
                }
            }
            
            state.teamHistorySortConfig = { key: direction ? key : null, direction };
            
            // Re-display the current team history with new sort
            if (window.currentTeamHistoryData) {
                // Check if we're in position-only mode (multi-team view)
                if (window.currentTeamHistoryName && window.currentTeamHistoryName.startsWith('All teams (Position ')) {
                    // Extract position from the name like "All teams (Position 1)"
                    const positionMatch = window.currentTeamHistoryName.match(/Position (\d+)/);
                    if (positionMatch) {
                        const selectedPos = parseInt(positionMatch[1]);
                        
                        // Sort the data based on direction, or restore default order if null
                        let sortedData = [...window.currentTeamHistoryData];
                        if (direction && key) {
                            const isNumerical = numericalColumns.includes(key);
                            
                            sortedData.sort((a, b) => {
                                let aVal, bVal;
                                
                                if (key === 'season') {
                                    // For seasons, extract year for comparison
                                    aVal = parseInt(a.season.split('-')[0]);
                                    bVal = parseInt(b.season.split('-')[0]);
                                } else if (isNumerical) {
                                    aVal = a[key];
                                    bVal = b[key];
                                } else {
                                    // For text fields like team name
                                    aVal = a[key];
                                    bVal = b[key];
                                }
                                
                                if (direction === 'asc') {
                                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                                        return aVal.localeCompare(bVal);
                                    }
                                    return aVal - bVal;
                                } else {
                                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                                        return bVal.localeCompare(aVal);
                                    }
                                    return bVal - aVal;
                                }
                            });
                        } else if (!direction) {
                            // Restore default order: most recent season first, then by team name
                            sortedData.sort((a, b) => {
                                const yearA = parseInt(a.season.split('-')[0]);
                                const yearB = parseInt(b.season.split('-')[0]);
                                if (yearB !== yearA) return yearB - yearA;
                                return a.team.localeCompare(b.team);
                            });
                        }
                        
                        // Update the stored data and re-render
                        window.currentTeamHistoryData = sortedData;
                        renderPositionOnlyTable(sortedData, selectedPos, state.teamSeasonsSelectedLeague);
                    }
                } else {
                    // Single team mode - use original display function
                    displayTeamHistory(window.currentTeamHistoryName, window.currentTeamHistoryData, state.teamSeasonsSelectedLeague);
                }
            }
        }

        // Get team history sort indicator
        function getTeamHistorySortIndicator(key) {
            if (state.teamHistorySortConfig.key !== key) return ' ‚ÜïÔ∏è';
            
            if (state.teamHistorySortConfig.direction === 'asc') {
                return ' ‚Üë';
            } else if (state.teamHistorySortConfig.direction === 'desc') {
                return ' ‚Üì';
            }
            return ' ‚ÜïÔ∏è';
        }

        // Get sort indicator
        function getSortIndicator(key) {
            if (state.sortConfig.key !== key) return ' ‚ÜïÔ∏è';
            return state.sortConfig.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
        }

        // Clear filters
        function clearFilters() {
            if (state.data.length > 0) {
                const dates = state.data.map(row => row.dateObj);
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                state.dateFrom = minDate.toISOString().split('T')[0];
                state.dateTo = maxDate.toISOString().split('T')[0];
                elements.dateFrom.value = state.dateFrom;
                elements.dateTo.value = state.dateTo;
            }
            
            state.selectedTeam1 = '';
            state.selectedTeam2 = '';
            state.selectedSeason = '';
            state.selectedDayOfWeek = '';
            state.homeFilter = true;
            state.awayFilter = true;
            state.threePointSystem = false;
            state.pointDeductionsEnabled = true;
            // Preserve current league when clearing filters
            // state.selectedLeague should not be reset here
            state.sortConfig = { key: null, direction: null };
            state.recentH2HCount = 'All';
            
            // Update UI elements
            elements.team1Select.value = '';
            elements.team2Select.value = '';
            elements.seasonSelect.value = '';
            elements.dayOfWeekSelect.value = '';
            elements.recentH2HSelect.value = 'All';
            elements.homeCheckbox.className = 'checkbox checked';
            elements.awayCheckbox.className = 'checkbox checked';
            elements.deductionsCheckbox.className = 'checkbox checked';
            elements.threePointCheckbox.className = 'checkbox';
            
            createLeagueButtons();
            updateTeamSelects();
            updateTeamSeasonsTeamSelect();
            updateSeasonOptions();
            updateTable();
        }


        // Update UI based on current state
        function updateUI() {
            // UpdateUI called

            if (state.error) {
                elements.controlsSection.classList.add('hidden');
                elements.tableInfo.classList.add('hidden');
                elements.h2hSection.classList.add('hidden');
                elements.h2hMatchesTable.classList.add('hidden');
                elements.tableContainer.classList.add('hidden');
                elements.errorState.classList.remove('hidden');
                elements.errorMessage.textContent = state.error;
                return;
            }

            elements.errorState.classList.add('hidden');

            if (state.data.length > 0) {
                // Showing controls section
                elements.controlsSection.classList.remove('hidden');
                
                // Only show table-related sections if we're on the League Filters tab
                const isLeagueFiltersActive = document.getElementById('leagueFiltersTab').classList.contains('active');
                if (isLeagueFiltersActive) {
                    elements.tableContainer.classList.remove('hidden');
                    
                    // Only show H2H section when both teams are selected
                    if (state.selectedTeam1 && state.selectedTeam2) {
                        elements.h2hSection.classList.remove('hidden');
                    } else {
                        elements.h2hSection.classList.add('hidden');
                    }
                } else {
                    // Keep table hidden on Last Time When tab
                    elements.tableContainer.classList.add('hidden');
                    elements.h2hSection.classList.add('hidden');
                    elements.tableInfo.classList.add('hidden');
                }
            } else {
                // Data length is 0, keeping controls hidden
            }


            // Update form values
            elements.dateFrom.value = state.dateFrom;
            elements.dateTo.value = state.dateTo;
        }

        // Hamburger Menu Functionality
        function initHamburgerMenu() {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const sideMenu = document.getElementById('sideMenu');
            const menuOverlay = document.getElementById('menuOverlay');
            const closeBtn = document.getElementById('closeMenuBtn');
            const domesticFootballLink = document.getElementById('domesticFootballLink');
            
            // Toggle menu function
            function toggleMenu() {
                const isOpen = sideMenu.classList.contains('open');
                
                if (isOpen) {
                    // Close menu
                    sideMenu.classList.remove('open');
                    menuOverlay.classList.remove('active');
                    hamburgerBtn.classList.remove('active');
                    document.body.style.overflow = '';
                } else {
                    // Open menu
                    sideMenu.classList.add('open');
                    menuOverlay.classList.add('active');
                    hamburgerBtn.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            // Event listeners
            hamburgerBtn.addEventListener('click', toggleMenu);
            closeBtn.addEventListener('click', toggleMenu);
            menuOverlay.addEventListener('click', toggleMenu);
            
            // Handle domestic football link click - just close menu since we're already on the page
            domesticFootballLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleMenu(); // Close the menu
                // Since we're already on the domestic football page, no navigation needed
            });
            
            // Prevent menu from closing when clicking inside the menu
            sideMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // Close menu with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && sideMenu.classList.contains('open')) {
                    toggleMenu();
                }
            });
        }

        // Handle responsive tab text
        function updateTabText() {
            const tabButtons = document.querySelectorAll('.tab-button[data-mobile-text]');
            const isMobile = window.innerWidth <= 768;
            
            tabButtons.forEach(button => {
                const mobileText = button.getAttribute('data-mobile-text');
                const originalText = button.textContent.trim();
                
                if (isMobile && mobileText) {
                    if (!button.getAttribute('data-original-text')) {
                        button.setAttribute('data-original-text', originalText);
                    }
                    button.textContent = mobileText;
                } else {
                    const savedOriginalText = button.getAttribute('data-original-text');
                    if (savedOriginalText) {
                        button.textContent = savedOriginalText;
                    }
                }
            });
        }

        // Dark Mode Functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            
            // Check for saved dark mode preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                darkModeToggle.checked = true;
                setTimeout(handlePositionColors, 100); // Delay to ensure table is rendered
            }
            
            // Add event listener for toggle
            darkModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    body.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                    handlePositionColors();
                } else {
                    body.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                    handlePositionColors();
                }
            });
        }
        
        // Handle table colors by specific column headers
        function handlePositionColors() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            if (!isDark) {
                // Remove all inline styles in light mode
                document.querySelectorAll('.league-table tbody tr td').forEach(cell => {
                    cell.style.color = '';
                });
                return;
            }
            
            const headers = document.querySelectorAll('.league-table thead th');
            const columnRules = {
                'Season': 'white',
                'Team': 'white', 
                'P': 'white',
                'W': 'white',
                'D': 'white',
                'L': 'white',
                'GF': 'white',
                'GA': 'white',
                'GD': 'white',
                'Pts': 'default',
                'Pos': 'special' // Special handling for 1,2,3
            };
            
            headers.forEach((header, columnIndex) => {
                const headerText = header.textContent.trim();
                const rule = columnRules[headerText];
                
                if (rule) {
                    const cells = document.querySelectorAll(`.league-table tbody tr td:nth-child(${columnIndex + 1})`);
                    cells.forEach(cell => {
                        if (rule === 'white') {
                            cell.style.color = 'white';
                        } else if (rule === 'default') {
                            cell.style.color = '';
                            cell.style.removeProperty('color');
                        } else if (rule === 'special' && headerText === 'Pos') {
                            const text = cell.textContent.trim();
                            if (text === '1' || text === '2' || text === '3') {
                                cell.style.color = '';
                                cell.style.removeProperty('color');
                            } else {
                                cell.style.color = 'white';
                            }
                        }
                    });
                }
            });
        }

        // Make functions global for onclick handlers
        window.handleSort = handleSort;
        window.handleH2hSort = handleH2hSort;
        window.handleTeamHistorySort = handleTeamHistorySort;

        // Initialize the application
        init();
        initHamburgerMenu();
        initDarkMode();
        updateTabText();
        
        // Handle window resize for responsive tabs
        window.addEventListener('resize', updateTabText);
    </script>
</body>
</html>